"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[787],{26588:function(t,e,i){i.r(e),i.d(e,{AbstractMetadata:function(){return tk},Aes256cbc:function(){return ox},BASE64:function(){return eP},Base58:function(){return oT},Claims:function(){return tY},CredentialBiography:function(){return oK},CredentialBiographyStatus:function(){return oj},CredentialMetadata:function(){return tZ},CredentialRequest:function(){return oY},CredentialTransaction:function(){return oH},DID:function(){return tz},DIDBackend:function(){return o2},DIDBiography:function(){return oQ},DIDBiographyStatus:function(){return oZ},DIDDocument:function(){return ee},DIDEntity:function(){return tP},DIDMetadata:function(){return tN},DIDRequest:function(){return oz},DIDStore:function(){return e_},DIDStoreMetadata:function(){return tC},DIDTransaction:function(){return oV},DIDURL:function(){return tV},DecryptionStream:function(){return t3},DefaultDIDAdapter:function(){return o3},EcdsaSigner:function(){return eO},EncryptionStream:function(){return t5},Exceptions:function(){return tO},Features:function(){return tq},File:function(){return oP},HDKey:function(){return oA},IDChainRequest:function(){return ok},IDTransaction:function(){return oB},Issuer:function(){return eD},JWT:function(){return tJ},JWTBuilder:function(){return tH},JWTHeader:function(){return tW},JWTParser:function(){return tX},JWTParserBuilder:function(){return tG},Logger:function(){return b},Mnemonic:function(){return oO},RootIdentity:function(){return er},SimulatedIDChainAdapter:function(){return o6},TransferTicket:function(){return es},VerifiableCredential:function(){return t0},VerifiablePresentation:function(){return el},VerificationEventListener:function(){return tF}});var r,n,o=i(67133),s=i(49197),a=i(68870),l=i(56662),u=i(46963),c=i(53258),h=i(21016),d=i(11575),f=i(74548),p=i(54642),y=i(9575),g=i(62074),v=i(25245),m=i(81630),w=i(67133).Buffer;/*
  @license
    DID.js v2.3.2
    Tue, 10 Oct 2023 06:13:41 GMT - commit unknown

    Released under the MIT License.
*/class S{constructor(t){this.LevelType=["ERROR","WARN","INFO","DEBUG","TRACE"],this.id=t,this.name=this.LevelType[t]}getLevel(){return this.id}}class b{constructor(t){this.context=t||""}static setLevel(t){t<=b.TRACE&&t>=b.INFO&&(b.logLevel=t)}static getLevel(){return b.logLevel}static levelIs(t){return t<=b.logLevel}log(...t){b.logLevel.id>=b.INFO.id&&console.log(this.format(b.INFO,t))}info(...t){b.logLevel.id>=b.INFO.id&&console.log(this.format(b.INFO,t))}debug(...t){b.logLevel.id>=b.DEBUG.id&&console.log(this.format(b.DEBUG,t))}trace(...t){b.logLevel.id>=b.TRACE.id&&console.log(this.format(b.TRACE,t))}warn(...t){b.logLevel.id>=b.WARNING.id&&console.log(this.format(b.WARNING,t))}error(...t){b.logLevel.id>=b.ERROR.id&&console.log(this.format(b.ERROR,t))}format(t,e){let i=(new Date).toISOString()+" "+t.name.toUpperCase()+" "+this.context+" ";if(!e||e.length<1)return i;let r=String(e[0]);for(let t=1;t<e.length;t++)r=r.replace(/\{\}/,String(e[t]));return i+" "+r}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function E(t,e,i,r){return new(i||(i=Promise))(function(n,o){function s(t){try{l(r.next(t))}catch(t){o(t)}}function a(t){try{l(r.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?n(t.value):((e=t.value)instanceof i?e:new i(function(t){t(e)})).then(s,a)}l((r=r.apply(t,e||[])).next())})}b.TRACE=new S(4),b.DEBUG=new S(3),b.INFO=new S(2),b.WARNING=new S(1),b.ERROR=new S(0),b.logLevel=b.WARNING;class I extends Error{constructor(t,e){super(t+(e?"\nCaused by: "+e.message+(e.stack?"\nCaused by: "+e.stack:""):"")),this.causedBy=e,Object.setPrototypeOf(this,new.target.prototype)}from(t){return this.message+=" Caused by "+t.message,this}}class _ extends I{}class D extends I{}class T extends I{}class A extends I{}class x extends I{}class O extends I{}class P extends I{}class R extends I{}class k extends I{}class N extends I{}class C extends I{}class F extends I{}class L extends I{}class M extends I{}class j extends I{}class K extends I{}class U extends I{}class B extends I{}class z extends I{}class V extends I{}class q extends I{}class W extends I{}class Y extends I{}class H extends I{}class J extends I{}class X extends I{}class G extends I{}class Z extends I{}class Q extends I{}class $ extends I{}class tt extends I{}class te extends I{}class ti extends I{}class tr extends I{}class tn extends I{}class to extends I{}class ts extends I{}class ta extends I{}class tl extends I{}class tu extends I{}class tc extends I{}class th extends I{}class td extends I{}class tf extends I{}class tp extends I{}class ty extends I{}class tg extends I{}class tv extends I{}class tm extends I{}class tw extends I{}class tS extends I{}class tb extends I{}class tE extends I{}class tI extends I{}class t_ extends I{}var tD,tT,tA,tx,tO=Object.freeze({__proto__:null,ParentException:I,IllegalArgumentException:_,WrongPasswordException:D,DIDStoreException:T,DIDResolveException:A,MnemonicException:x,DIDDeactivatedException:O,DIDAlreadyExistException:P,RootIdentityAlreadyExistException:R,UnknownInternalException:k,DIDStoreCryptoException:N,MalformedDocumentException:C,NotCustomizedDIDException:F,NotAttachedWithStoreException:L,NotPrimitiveDIDException:M,NoEffectiveControllerException:j,NotControllerException:K,AlreadySignedException:U,MalformedTransferTicketException:B,MalformedCredentialException:z,MalformedIDChainRequestException:V,InvalidKeyException:q,MalformedIDChainTransactionException:W,MalformedResolveResultException:Y,DIDSyntaxException:H,MalformedResolveRequestException:J,MalformedResolveResponseException:X,DIDNotFoundException:G,MalformedDIDURLException:Z,AlreadySealedException:Q,CredentialNotGenuineException:$,CredentialExpiredException:tt,CredentialRevokedException:te,CredentialAlreadyExistException:ti,DIDNotGenuineException:tr,DIDExpiredException:tn,DIDNotUpToDateException:to,DIDObjectAlreadyExistException:ts,IllegalUsage:ta,DIDObjectNotExistException:tl,CanNotRemoveEffectiveController:tu,DIDObjectHasReference:tc,MalformedPresentationException:th,UnsupportedOperationException:td,NetworkException:tf,ResolveException:tp,DIDStorageException:ty,InvalidDateFormat:tg,OutOfBoundException:tv,DIDTransactionException:tm,MalformedExportDataException:tw,DIDControllersChangedException:tS,MalformedMetadataException:tb,JWTException:tE,MalformedDIDException:tI,IOException:t_});class tP{getSerializeContextDid(){return null}clone(){let t=Object.assign({},this);return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}static deserialize(t,e,i=null){let r;tj(t&&""!==t,"Invalid JSON content"),r="string"==typeof t?JSON.parse(t):t;let n=new e;return n.fromJSON(r,i),n}static deserializeAsync(t,e,i=null){return E(this,void 0,void 0,function*(){let r;tj(t&&""!==t,"Invalid JSON content"),r="string"==typeof t?JSON.parse(t):t;let n=new e;return yield n.fromJSON(r,i),n})}serialize(t=tP.NORMALIZED_DEFAULT){var e;try{let i=t?null:null===(e=this.getSerializeContextDid())||void 0===e?void 0:e.toString();return JSON.stringify(this.toJSON(i)).normalize("NFC")}catch(t){throw new k(t)}}toString(t=tP.NORMALIZED_DEFAULT){return this.serialize(t)}dateToString(t){return t?t.toISOString().split(".")[0]+"Z":null}dateFromString(t){if(t&&isNaN(Date.parse(t)))throw new tg(t);return t?new Date(t+("Z"==t.slice(t.length-1)?"":"Z")):null}getString(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if("string"!=typeof e)throw new H("Invalid property value: "+t+", type error");return e}getNumber(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if("number"!=typeof e)throw new H("Invalid property value: "+t+", type error");return e}getBoolean(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if("boolean"!=typeof e)throw new H("Invalid property value: "+t+", type error");return e}getStrings(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if("string"==typeof e)return[e];if(Array.isArray(e))return Array.from(e,e=>("string"!=typeof e&&new H("Invalid property value: "+t+", type error"),e)).sort();throw new H("Invalid property value: "+t+", type error")}getContext(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if(Array.isArray(e))return Array.from(e,e=>("string"!=typeof e&&new H("Invalid property value: "+t+", type error"),e));throw new H("Invalid property value: "+t+", type error")}getDids(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if("string"==typeof e)try{return[new tz(e)]}catch(e){new H("Invalid property value: "+t+", "+e,e)}if(Array.isArray(e))return Array.from(e,e=>{"string"!=typeof e&&new H("Invalid property value: "+t+", type error");try{return new tz(e)}catch(e){new H("Invalid property value: "+t+", "+e,e)}}).sort((t,e)=>t.compareTo(e));throw new H("Invalid property value: "+t+", type error")}getDate(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if("string"!=typeof e)throw new H("Invalid property value: "+t+", type error");try{return this.dateFromString(e)}catch(e){throw new H("Invalid property value: "+t+", "+e,e)}}getDid(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if("string"!=typeof e)throw new H("Invalid property value: "+t+", type error");try{return new tz(e)}catch(e){throw new H("Invalid property value: "+t+", "+e,e)}}getDidUrl(t,e,i={}){if(void 0===e){if(i.mandatory)throw new H("Missing property: "+t);return i.defaultValue?i.defaultValue:null}if(null===e){if(!i.defaultValue&&!i.nullable)throw new H("Invalid property: "+t+", can not be null");return i.defaultValue?i.defaultValue:null}if("string"!=typeof e)throw new H("Invalid property value: "+t+", type error");try{return new tV(e,i.context)}catch(e){throw new H("Invalid property value: "+t+", "+e,e)}}}function tR(t){let e=Object.keys(t);e.sort((t,e)=>t<e?-1:t>e?1:0);let i={};for(var r in e){let n=e[r],o=t[n];"object"==typeof o&&Object.keys(o).length>0&&!Array.isArray(o)?i[n]=tR(o):Array.isArray(o)&&o.length>0?i[n]=function t(e){return e&&0!=e.length?Array.from(e,i=>"object"==typeof i&&Object.keys(i).length>0&&!Array.isArray(i)?tR(i):Array.isArray(i)&&e.length>0?t(i):i):e}(o):i[n]=o}return i}tP.NORMALIZED_DEFAULT=!0;class tk extends tP{constructor(t){super(),this.props={},this.store=t,this.props={}}attachStore(t){tj(null!=t,"Invalid store"),this.store=t}detachStore(){this.store=null}getStore(){return this.store}attachedStore(){return null!=this.store}get(t){return this.props[t]}put(t,e){null==e?delete this.props[t]:this.props[t]=e instanceof Date?e.toISOString():e,this.save()}getBoolean(t,e=!1){let i=this.get(t);return null!=i?new Boolean(i).valueOf():e}getInteger(t,e=-1){let i=this.get(t),r=e;if(null!=i)try{r=new Number(i).valueOf()}catch(t){}return r}getDate(t,e=null){let i=this.get(t),r=e;if(null!=i)try{r=new Date(i)}catch(t){}return r}remove(t){let e=this.props[t];return delete this.props[t],this.save(),e}isEmpty(){return 0==this.props.size}setAlias(t){this.put(tk.ALIAS,t)}getAlias(){return this.get(tk.ALIAS)}setExtra(t,e){tj(null!=t&&""!=t,"Invalid key"),this.put(tk.USER_EXTRA_PREFIX+t,e)}getExtra(t){return tj(t&&null!=t,"Invalid key"),this.get(tk.USER_EXTRA_PREFIX+t)}getExtraBoolean(t,e=!1){return tj(t&&null!=t,"Invalid key"),this.getBoolean(tk.USER_EXTRA_PREFIX+t,e)}getExtraInteger(t,e=-1){return tj(t&&null!=t,"Invalid key"),this.getInteger(tk.USER_EXTRA_PREFIX+t,e)}getExtraDate(t,e=null){return tj(t&&null!=t,"Invalid key"),this.getDate(tk.USER_EXTRA_PREFIX+t,e)}removeExtra(t){return tj(t&&null!=t,"Invalid key"),this.remove(tk.USER_EXTRA_PREFIX+t)}merge(t){t!=this&&null!=t&&(this.props=Object.assign(Object.assign({},t.props),this.props))}clone(){let t=super.clone();return t.store=this.store,t.props=this.props,t}toJSON(t=null){return tR(this.props)}fromJSON(t,e=null){this.props=JSON.parse(JSON.stringify(t))}}tk.ALIAS="alias",tk.USER_EXTRA_PREFIX="UX-";class tN extends tk{constructor(t=null,e=null){super(e),this.did=null,this.did=t}setDid(t){this.did=t}setRootIdentityId(t){this.put(tN.ROOT_IDENTITY,t)}getRootIdentityId(){return this.get(tN.ROOT_IDENTITY)}setIndex(t){this.put(tN.INDEX,t)}getIndex(){return this.getInteger(tN.INDEX,-1)}setTransactionId(t){this.put(tN.TXID,t)}getTransactionId(){return this.get(tN.TXID)}setPreviousSignature(t){this.put(tN.PREV_SIGNATURE,t)}getPreviousSignature(){return this.get(tN.PREV_SIGNATURE)}setSignature(t){this.put(tN.SIGNATURE,t)}getSignature(){return this.get(tN.SIGNATURE)}setPublished(t){this.put(tN.PUBLISHED,t)}getPublished(){try{return this.getDate(tN.PUBLISHED,null)}catch(t){return null}}setDeactivated(t){this.put(tN.DEACTIVATED,t)}isDeactivated(){return this.getBoolean(tN.DEACTIVATED,!1)}clone(){let t=new tN;return t.props=this.props,t.did=this.did,t.store=this.store,t}save(){return E(this,void 0,void 0,function*(){if(this.attachedStore())try{yield this.getStore().storeDidMetadata(this.did,this)}catch(t){throw t instanceof T&&console.log("INTERNAL - error store metadata for DID {}",this.did),t}})}static parse(t,e=null){try{return tP.deserialize(t,tN,e)}catch(t){throw t instanceof tb?t:new tb(t)}}}tN.ROOT_IDENTITY="rootIdentity",tN.INDEX="index",tN.TXID="txid",tN.PREV_SIGNATURE="prevSignature",tN.SIGNATURE="signature",tN.PUBLISHED="published",tN.DEACTIVATED="deactivated";class tC extends tk{constructor(t=null){super(t),this.put(tC.TYPE,tC.DID_STORE_TYPE),this.put(tC.VERSION,tC.DID_STORE_VERSION)}getType(){return this.get(tC.TYPE)}getVersion(){return this.getInteger(tC.VERSION,-1)}setFingerprint(t){tj(null!=t&&""!=t,"Invalid fingerprint"),this.put(tC.FINGERPRINT,t)}getFingerprint(){return this.get(tC.FINGERPRINT)}setDefaultRootIdentity(t){this.put(tC.DEFAULT_ROOT_IDENTITY,t)}getDefaultRootIdentity(){return this.get(tC.DEFAULT_ROOT_IDENTITY)}save(){return E(this,void 0,void 0,function*(){if(this.attachedStore())try{yield this.getStore().storage.storeMetadata(this)}catch(t){throw t instanceof T&&tC.log.error("INTERNAL - error store metadata for DIDStore"),t}})}static parse(t,e=null){try{return tP.deserialize(t,tC,e)}catch(t){throw t instanceof tb?t:new tb(t)}}}tC.DID_STORE_TYPE="did:elastos:store",tC.DID_STORE_VERSION=3,tC.TYPE="type",tC.VERSION="version",tC.FINGERPRINT="fingerprint",tC.DEFAULT_ROOT_IDENTITY="defaultRootIdentity",tC.log=new b("DIDStoreMetadata");class tF{done(t,e,i){}reset(){}eprintf(t,e){let i=String(t);for(let t=0;t<e.length;t++)i=i.replace(/\{\}/,String(e[t]));return i}succeeded(t,e,...i){let r=this.eprintf(e,i);this.done(t,!0,r)}failed(t,e,...i){let r=this.eprintf(e,i);this.done(t,!1,r)}static getDefault(t,e,i){return new tM(t,e,i)}static getDefaultWithIdent(t){return new tM(t,null,null)}}class tL{constructor(t,e,i){this.context=t,this.succeeded=e,this.message=i}}class tM extends tF{constructor(t,e,i){super(),this.ident=null==t?tM.EMPTY:t,this.succeededPrefix=null==e?tM.EMPTY:e,this.failedPrefix=null==i?tM.EMPTY:i,this.records=[]}done(t,e,i){this.records.unshift(new tL(t,e,i))}reset(){this.records=[]}toString(){let t="";for(let e of this.records)t=t.concat(this.ident,e.succeeded?this.succeededPrefix:this.failedPrefix,e.message,"\n");return t}}function tj(t,e){if(!t)throw Error(e)}function tK(t,e){tj(null!=t&&""!==t,e)}function tU(t,e){if(null===t)throw Error(e)}function tB(t){if("string"==typeof t){for(var e=0,i=t.length;i>0;)e=(e<<5)-e+t.charCodeAt(--i)|0;return e}if("number"==typeof t)return t;if("boolean"==typeof t)return!0===t?1231:1237;throw new _("Unsupported type "+typeof t)}tM.EMPTY="";class tz{constructor(t,e=null,i,r){(this.repr=null,this.parser=new class{constructor(t){this.superThis=t}isTokenChar(t,e){return t>="A"&&t<="Z"||t>="a"&&t<="z"||t>="0"&&t<="9"||!e&&("."==t||"_"==t||"-"==t)}scanNextPart(t,e,i,r){let n=i,o=!0;for(let s=e;s<i;s++){let e=t.charAt(s);if("string"==typeof e){if(e==r){n=s;break}}else for(let t=0;t<r.length;t++)if(e==r[t]){n=t;break}if(!this.isTokenChar(e,o))throw new tI("Invalid char at: "+s);o=!1}return n}parse(t,e=0,i){if(null==t)throw new tI("null DID string");for(null==i&&(i=t.length);i>e&&" ">=t.charAt(i-1);)i--;for(;e<i&&" ">=t.charAt(e);)e++;if(e==i)throw new tI("Empty DID string");let r=e,n=this.scanNextPart(t,r,i,":"),o=t.substring(r,n);if(o!=tz.SCHEMA)throw new tI("Invalid DID schema: '"+o+"', at: "+r);if((r=n)+1>=i||":"!=t.charAt(r))throw new tI("Missing method and id string at: "+r);n=this.scanNextPart(t,++r,i,":");let s=t.substring(r,n);if(s!=tz.METHOD)throw new tI("Unknown DID method: '"+s+"', at: "+r);if(this.superThis.method=tz.METHOD,(r=n)+1>=i||":"!=t.charAt(r))throw new tI("Missing id string at: "+(r+1>i?r:r+1));n=this.scanNextPart(t,++r,i,"\x00"),this.superThis.methodSpecificId=t.substring(r,n)}}(this),this.metadata=null,e)?(tK(t,"Invalid method"),tK(e,"Invalid methodSpecificId"),this.method=t,this.methodSpecificId=e):(i||(i=0),r||(r=t.length),tK(t,"Invalid DID string"),this.parser.parse(t,i,r))}static createFrom(t,e,i){return tj(null!=t&&""!=t,"Invalid DID string"),tj(e<i,"Invalid offsets"),new tz(t,null,e,i)}static from(t){return t?"string"==typeof t?new tz(t):t:null}getMethod(){return this.method}getMethodSpecificId(){return this.methodSpecificId}setMetadata(t){this.metadata=t}toJSON(t=null){return this.toString()}getMetadata(){return E(this,void 0,void 0,function*(){if(null==this.metadata)try{let t=yield this.resolve();this.metadata=null!=t?t.getMetadata():new tN(this)}catch(t){this.metadata=new tN(this)}return this.metadata})}isDeactivated(){return E(this,void 0,void 0,function*(){if((yield this.getMetadata()).isDeactivated())return!0;let t=yield o2.getInstance().resolveDidBiography(this);if(null==t)return!1;let e=t.getStatus()==oZ.DEACTIVATED;return e&&(yield this.getMetadata()).setDeactivated(e),e})}resolve(t=!1){return E(this,void 0,void 0,function*(){let e=yield o2.getInstance().resolveDid(this,t);return null!=e&&this.setMetadata(e.getMetadata()),e})}resolveBiography(){return E(this,void 0,void 0,function*(){return yield o2.getInstance().resolveDidBiography(this)})}toString(){return null==this.repr&&(this.repr="did:"+this.method+":"+this.methodSpecificId),this.repr}hashCode(){return 3357+tB(this.toString())}equals(t){if(t==this)return!0;if(t instanceof tz){let e=this.method===t.method;return e?this.methodSpecificId===t.methodSpecificId:e}return"string"==typeof t&&this.toString()===t}compareTo(t){tU(t,"did is null");let e=(t,e)=>t<e?-1:t>e?1:0,i=e(this.method,t.method);return 0==i?e(this.methodSpecificId,t.methodSpecificId):i}}tz.SCHEMA="did",tz.METHOD="elastos",tz.METADATA="metadata";class tV{constructor(t,e){if(this.did=null,this.path=null,this.fragment=null,this.parser=new class{constructor(t){this.superThis=t}isHexChar(t){return t>="A"&&t<="F"||t>="a"&&t<="f"||t>="0"&&t<="9"}isTokenChar(t,e){return t>="A"&&t<="Z"||t>="a"&&t<="z"||t>="0"&&t<="9"||!e&&("."==t||"_"==t||"-"==t)}scanNextPart(t,e,i,r,n){let o=i,s=!0;for(let a=e;a<i;a++){let e=t.charAt(a);if(null!=r&&r.indexOf(e)>=0){o=a;break}if(null!=n&&n.indexOf(e)>=0){if(s)throw new Z("Invalid char at: "+a);s=!0}else if(this.isTokenChar(e,s))s=!1;else{if("%"!=e)throw new Z("Invalid char at: "+a);{if(a+2>=i)throw new Z("Invalid char at: "+a);let e=t.charAt(++a);if(!this.isHexChar(e)||(e=t.charAt(++a),!this.isHexChar(e)))throw new Z("Invalid hex char at: "+a);s=!1}}}return o}parse(t,e){if(null==t&&(t=null),this.superThis.did=t,null==e)throw new Z("Null DIDURL string");let i,r=0,n=e.length;for(;n>0&&" ">=e.charAt(n-1);)n--;for(;r<n&&" ">=e.charAt(r);)r++;if(r==n)throw new Z("Empty DIDURL string");let o=r;if(o<n&&"did:"==e.substring(o,o+4)){i=this.scanNextPart(e,o,n,"/?#",":");try{this.superThis.did=tz.createFrom(e.toString(),o,i)}catch(t){throw new Z("Invalid did at: "+o,t)}o=i}if(o<n&&"/"==e.charAt(o)&&(i=this.scanNextPart(e,o+1,n,"?#","/"),this.superThis.path=e.substring(o,i),o=i),o<n&&"?"==e.charAt(o)){i=this.scanNextPart(e,o+1,n,"#","&=");let t=e.substring(o+1,i);if(o=i,""!=t){let e=new Map;for(let i of t.split("&")){let t=i.split("=");if(t.length>0&&""!=t[0]){let i=t[0],r=2==t.length?t[1]:null;e.set(i,r)}}this.superThis.query=e}}else this.superThis.query=new Map;if(o<n&&"#"==e.charAt(o)||o==r){"#"==e.charAt(o)&&o++,i=this.scanNextPart(e,o,n,"",null);let t=e.substring(o,i);""!=t&&(this.superThis.fragment=t)}}}(this),tj(!!t||!!e,"Invalid context and url"),!t)return this.did=e,this.query=new Map,this;"string"==typeof t?this.parser.parse(e,t):(null!=t.did&&(this.did=t.did),this.path=t.path,this.query=t.query,this.queryString=t.queryString,this.fragment=t.fragment,this.repr=t.repr,this.metadata=t.metadata)}static fromDID(t){return new tV(null,t)}static from(t,e){let i;return t?(i=null==e?null:"string"==typeof e?tz.from(e):e,"string"==typeof t||i?new tV(t,i):t):null}clone(t){let e=tV.fromDID(this.did);return e.path=this.path,e.query=0==this.query.size&&t?new Map:new Map(this.query),e.queryString=this.queryString,e.fragment=this.fragment,e.repr=this.repr,e}getDid(){return this.did}setDid(t){this.did=t}mapToString(t,e){let i=!0,r="";return t.forEach((t,n)=>{i?i=!1:r+=e,r+=n,null!=t&&(r+="="+t)}),r}getPath(){return this.path}setPath(t){this.path=t}getQueryString(){return 0==this.query.size?null:(null==this.queryString&&(this.queryString=this.mapToString(this.query,"&")),this.queryString)}getQuery(){return this.query}setQuery(t){this.query=new Map(t)}getQueryParameter(t){tj(null!=t&&""!==t,"Invalid parameter name");let e=this.query.get(t);return null==e?null:e}hasQueryParameter(t){return tj(null!=t&&""!=t,"Invalid parameter name"),this.query.has(t)}getFragment(){return this.fragment}setFragment(t){this.fragment=t}setMetadata(t){this.metadata=t}getMetadata(){return this.metadata}isQualified(){return null!=this.did&&null!=this.fragment}toJSON(t=null){let e=null;return t&&(e=new tz(t)),this.toString(e)}toString(t=null){if(!t&&this.repr)return this.repr;let e="";return null==this.did||null!=t&&this.did.equals(t)||(e+=this.did),null!=this.path&&""!==this.path&&(e+=this.path),null!=this.query&&0!=this.query.size&&(e+="?"+this.getQueryString()),null!=this.fragment&&""!==this.fragment&&(e+="#"+this.getFragment()),t||(this.repr=e),e}equals(t){return t==this||(t instanceof tV?this.toString()===t.toString():"string"==typeof t&&this.toString()===t)}compareTo(t){var e,i;return tU(t,"id is null"),(e=this.toString())<(i=t.toString())?-1:e>i?1:0}hashCode(){return tB(this.toString())}}tV.SEPS=[":",";","/","?","#"],(eM=tV||(tV={})).Builder=class{constructor(t){this.url=t instanceof tz?eM.fromDID(t):t.clone(!1)}setDid(t){return tj(null!=t,"Invalid did"),"string"==typeof t?this.url.setDid(tz.from(t)):this.url.setDid(t),this}clearDid(){return this.url.setDid(null),this}setPath(t){return this.url.setPath(t),this}clearPath(){return this.url.setPath(""),this}setQueryParameter(t,e){return tj(null!=t&&""!==t,"Invalid parameter name"),this.url.getQuery().set(t,e),this}setQueryParameters(t){return this.url.getQuery().clear(),null!=t&&t.size>0&&t.forEach((t,e)=>this.url.getQuery().set(e,t)),this}removeQueryParameter(t){return tj(null!=t&&""!==t,"Invalid parameter name"),this.url.getQuery().delete(t),this}clearQueryParameters(){return this.url.getQuery().clear(),this}setFragment(t){return this.url.setFragment(t),this}clearFragment(){return this.url.setFragment(""),this}build(){return this.url.clone(!0)}},(ej=tD||(tD={}))[ej.ERROR=0]="ERROR",ej[ej.WARNING=1]="WARNING",ej[ej.INFO=2]="INFO",ej[ej.DEBUG=3]="DEBUG",ej[ej.TRACE=4]="TRACE";class tq{static enableJsonLdContext(t){this.enabledJsonLdContext=t}static isEnabledJsonLdContext(){return this.enabledJsonLdContext}static setLogLevel(t){b.setLevel(new S(t))}static getLogLevel(){return b.getLevel().getLevel()}}tq.enabledJsonLdContext=!1;class tW{constructor(t){this.header=t||{}}setAlgorithm(t){return delete this.header.alg,this.header.alg=t,this}getAlgorithm(){return this.header.alg}setKeyId(t){return this.header.kid=t,this}getKeyId(){return this.header.kid}setType(t){return this.header.typ=t,this}getType(){return this.header.typ}setContentType(t){return this.header.cty=t,this}getContentType(){return this.header.cty}put(t,e){return t!=tW.ALG&&t!=tW.KID&&(this.header[t]&&delete this.header[t],this.header[t]=e),this}get(t){return this.header?this.header[t]:null}getJWSHeaderParameters(){return this.header}getJWTHeaderParameters(){return null!=this.header.alg&&"none"!==this.header.alg?this.header:null}}tW.JWT_TYPE="JWT",tW.TYPE="typ",tW.CONTENT_TYPE="cty",tW.ALG="alg",tW.KID="kid";class tY{constructor(t){this.payload=t||{}}put(t,e){return this.payload[t]&&delete this.payload[t],this.payload[t]=e,this}putWithObject(t){return this.payload=Object.assign(Object.assign({},this.payload),t),this}putWithJson(t){let e=JSON.parse(t);return this.putWithObject(e),this}get(t){return this.payload[t]}getAsObject(t){let e=this.payload[t];return null!=e?e:null}getAsJson(t){let e=this.payload[t];return null==e?null:JSON.stringify(e)}setId(t){return this.payload.jti=t,this}getId(){return this.payload.jti}setAudience(t){return this.payload.aud=t,this}getAudience(){return this.payload.aud}setExpiration(t){return this.payload.exp=t,this}getExpiration(){return this.payload.exp}setIssuedAt(t){return this.payload.iat=t,this}getIssuedAt(){return this.payload.iat}setIssuer(t){return this.payload.iss=t,this}getIssuer(){return this.payload.iss}setJti(t){return this.payload.jti=t,this}getJti(){return this.payload.jti}setNotBefore(t){return this.payload.nbf=t,this}getNotBefore(){return this.payload.nbf}setSubject(t){return this.payload.sub=t,this}getSubject(){return this.payload.sub}getJWTPayload(){return this.payload}}class tH{constructor(t,e){this.header=null,this.payload=null,tj(null!=t,"Invalid issuer"),this.header=new tW,this.payload=new tY,this.payload.setIssuer(t.toString()),this.keyprovider=e,this.issuer=t}static createHeader(){return new tW}static createClaims(){return new tY}setHeader(t){return this.header=t,this}setClaims(t){return this.payload=t,t.getIssuer()||this.payload.setIssuer(this.issuer.toString()),this}setClaimsWithJson(t){return this.payload=new tY,this.payload.putWithJson(t),this.payload.getIssuer()||this.payload.setIssuer(this.issuer.toString()),this}setClaimsWithObject(t){return this.payload=new tY,this.payload.putWithObject(t),this.payload.getIssuer()||this.payload.setIssuer(this.issuer.toString()),this}addClaims(t){return this.payload.putWithObject(t),this}addClaimsWithJson(t){let e=JSON.parse(t);return this.addClaims(e),this}addHeader(t,e){return this.header.put(t,e),this}claims(t,e){return this.payload.put(t,e),this}claimsWithJson(t,e){let i=JSON.parse(e);return this.claims(t,i),this}setId(t){return this.payload.setId(t),this}setAudience(t){return this.payload.setAudience(t),this}setExpiration(t){let e=t instanceof Date?t.getUTCSeconds():t;return this.payload.setExpiration(e),this}setIssuedAt(t){let e=t instanceof Date?t.getUTCSeconds():t;return this.payload.setIssuedAt(e),this}setIssuer(t){return this.payload.setIssuer(t),this}setJti(t){return this.payload.setJti(t),this}setNotBefore(t){let e=t instanceof Date?t.getUTCSeconds():t;return this.payload.setNotBefore(e),this}setSubject(t){return this.payload.setSubject(t),this}sign(t,e=null){return E(this,void 0,void 0,function*(){tj(null!=t&&""!=t,"Invalid password"),this.header.setAlgorithm("ES256"),e&&this.header.setKeyId(e);let i=new p.N6(this.payload.getJWTPayload()).setProtectedHeader(this.header.getJWTHeaderParameters()),r=yield this.keyprovider.getPrivateKey(e,t);return yield i.sign(r)})}compact(){return this.header.setAlgorithm("none"),`${eP.fromString(JSON.stringify(this.header.getJWSHeaderParameters()))}.${eP.fromString(JSON.stringify(this.payload.getJWTPayload()))}.`}}class tJ{constructor(t,e){this.header=new tW(t),this.claims=new tY(e)}getHeader(){return this.header}getBody(){return this.claims}}class tX{constructor(t,e){this.keyprovider=t,this.options=e}isSigned(t){return"none"!=(0,p.Ut)(t).alg}getSignkey(t){return(0,p.Ut)(t).kid}getIssuer(t){let e=t.split(".");if(3!=e.length)throw new tE("Invalid jwt token.");let i=JSON.parse(eP.toString(e[1])).iss;if(null==i)throw new tE("No issuer in the token.");return i}parse(t){return E(this,void 0,void 0,function*(){if(this.isSigned(t)){var e;if(null==this.keyprovider){let e=tz.from(this.getIssuer(t));if(null==e)throw new tE("No issuer in the token");let i=yield e.resolve();if(null==i)throw new A("No issuer doc in the chain.");this.keyprovider=i.getKeyProvider()}let i=yield this.keyprovider.getPublicKey(this.getSignkey(t));try{e=yield(0,p._f)(t,i,this.options)}catch(t){throw new tE(t)}return new tJ(e.protectedHeader,e.payload)}{let e=p.W9.decode(t,this.options);return new tJ(e.header,e.payload)}})}}class tG{constructor(){return this.keyProvider=null,this.options={},this}static newWithKeyProvider(t){let e=new tG;return e.keyProvider=t,e}requireSubject(t){return this.options.subject=t,this}requireAudience(t){return this.options.audience=t,this}requireIssuer(t){return this.options.issuer=t,this}requireIssuedAt(t){return this.options.maxTokenAge=t,this}requireAlgorithms(t){return this.options.algorithms=t,this}requireHeaderType(t){return this.options.typ=t,this}setAllowedClockSkewSeconds(t){return this.options.clockTolerance=t,this}build(){return Object.assign({},this.options),new tX(this.keyProvider,this.options)}}class tZ extends tk{constructor(t=null,e=null){super(e),this.id=t}setId(t){this.id=t}setTransactionId(t){this.put(tZ.TXID,t)}getTransactionId(){return this.get(tZ.TXID)}setPublished(t){tj(null!=t,"Invalid timestamp"),this.put(tZ.PUBLISHED,t)}getPublished(){return this.getDate(tZ.PUBLISHED,null)}setRevoked(t){this.put(tZ.REVOKED,t)}isRevoked(){return this.getBoolean(tZ.REVOKED,!1)}clone(){try{return super.clone()}catch(t){return tZ.log.error(t),null}}save(){return E(this,void 0,void 0,function*(){if(this.attachedStore())try{yield this.getStore().storeCredentialMetadata(this.id,this)}catch(t){throw tZ.log.error("INTERNAL - error store metadata for credential {}",this.id),t}})}static parse(t,e=null){try{return tP.deserialize(t,tZ,e)}catch(t){throw t instanceof tb?t:new tb(t)}}}tZ.TXID="txid",tZ.PUBLISHED="published",tZ.REVOKED="revoked",tZ.log=new b("CredentialMetadata"),(eK=tT||(tT={}))[eK.EXTERNAL=0]="EXTERNAL",eK[eK.INTERNAL=1]="INTERNAL",(eU=tA||(tA={}))[eU.ELA=0]="ELA",eU[eU.IDCHAIN=1]="IDCHAIN",(eB=tx||(tx={})).ELA_STANDARD="ELA_STANDARD",eB.ELA_MULTISIG="ELA_MULTISIG",eB.ELA_CROSSCHAIN="ELA_CROSSCHAIN",eB.ELA_IDCHAIN="ELA_IDCHAIN",eB.ELA_DESTROY="ELA_DESTROY";class tQ{}tQ._DEFAULT_PUBLICKEY_TYPE="secp256r1",tQ.DEFAULT_PUBLICKEY_TYPE="ECDSAsecp256r1",tQ.DATE_FORMAT="yyyy-MM-dd'T'HH:mm:ss'Z'",tQ.DATE_FORMAT_ISO_8601="yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",tQ.MAX_VALID_YEARS=5;let t$=new b("VerifiableCredential");class t0 extends tP{constructor(){super()}static newWithVerifiableCredential(t,e){let i=new t0;return i.context=t.context,i.id=t.id,i.type=t.type,i.issuer=t.issuer,i.issuanceDate=t.issuanceDate,i.expirationDate=t.expirationDate,i.subject=t.subject,e&&(i.proof=t.proof),i}checkAttachedStore(){if(!this.getMetadata().attachedStore())throw new L("Not attach with did store")}getId(){return this.id}getType(){return this.type}getIssuer(){return this.issuer}getIssuanceDate(){return this.issuanceDate}hasExpirationDate(){return null!=this.expirationDate}getExpirationDate(){return E(this,void 0,void 0,function*(){if(null!=this.expirationDate)return this.expirationDate;try{let t=yield this.subject.getId().resolve();if(null!=t)return t.getExpires()}catch(t){}return null})}getLastModified(){return this.proof.getCreated()}getSubject(){return this.subject}getProof(){return this.proof}getSerializeContextDid(){return this.getSubject().getId()}setMetadata(t){this.metadata=t,this.getId().setMetadata(t)}getMetadata(){return null==this.metadata&&(this.metadata=new tZ(this.getId())),this.metadata}getStore(){return this.metadata.getStore()}isSelfProclaimed(){return this.issuer.equals(this.subject.getId())}isExpired(){return!(null==this.expirationDate||!f().isAfter(f(this.expirationDate)))}isGenuine(t=null){return E(this,void 0,void 0,function*(){if(!this.getId().getDid().equals(this.getSubject().getId()))return null!=t&&(t.failed(this,"VC {}: invalid id '{}', should under the scope of '{}'",this.getId(),this.getId(),this.getSubject().getId()),t.failed(this,"VC {}: is not genuine",this.getId())),!1;let e=yield this.issuer.resolve();if(null==e)return null!=t&&(t.failed(this,"VC {}: Can not resolve the document for issuer '{}'",this.getId(),this.getIssuer()),t.failed(this,"VC {}: is not genuine",this.getId())),!1;if(!e.isGenuine(t))return null!=t&&(t.failed(this,"VC {}: issuer '{}' is not genuine",this.getId(),this.getIssuer()),t.failed(this,"VC {}: is not genuine",this.getId())),!1;if(!e.isAuthenticationKey(this.proof.getVerificationMethod()))return null!=t&&(t.failed(this,"VC {}: key '{}' for proof is not an authencation key of '{}'",this.getId(),this.proof.getVerificationMethod(),this.proof.getVerificationMethod().getDid()),t.failed(this,"VC {}: is not genuine",this.getId())),!1;if(this.proof.getType()!==tQ.DEFAULT_PUBLICKEY_TYPE)return null!=t&&(t.failed(this,"VC {}: key type '{}' for proof is not supported",this.getId(),this.proof.getType()),t.failed(this,"VC {}: is not genuine",this.getId())),!1;let i=t0.newWithVerifiableCredential(this,!1).serialize(!0);if(!e.verify(this.proof.getVerificationMethod(),this.proof.getSignature(),o.Buffer.from(i)))return null!=t&&(t.failed(this,"VC {}: proof is invalid, signature mismatch",this.getId()),t.failed(this,"VC {}: is not genuine",this.getId())),!1;if(!this.isSelfProclaimed()){let e=yield this.subject.getId().resolve();if(null!=e&&!e.isGenuine(t))return null!=t&&(t.failed(this,"VC {}: holder's document is not genuine",this.getId()),t.failed(this,"VC {}: is not genuine",this.getId())),!1}return null!=t&&t.succeeded(this,"VC {}: is genuine",this.getId()),!0})}isGenuineInternal(t){if(function(t,e){if(!t)throw Error(e)}(this.isSelfProclaimed(),"The credential should be self-proclaimed"),tj(this.getSubject().getId().equals(t.getSubject()),"Invalid owner document"),!this.getId().getDid().equals(this.getSubject().getId())||!t.isAuthenticationKey(this.proof.getVerificationMethod())||this.proof.getType()!==tQ.DEFAULT_PUBLICKEY_TYPE)return!1;let e=t0.newWithVerifiableCredential(this,!1).serialize(!0);return!!t.verify(this.proof.getVerificationMethod(),this.proof.getSignature(),o.Buffer.from(e))}isRevoked(){return E(this,void 0,void 0,function*(){if(this.getMetadata().isRevoked())return!0;let t=yield o2.getInstance().resolveCredentialBiography(this.getId(),this.getIssuer());if(null==t)return!1;let e=t.getStatus().equals(oj.REVOKED);return e&&this.getMetadata().setRevoked(e),e})}isValid(t=null){return E(this,void 0,void 0,function*(){if(yield this.isRevoked())return null!=t&&(t.failed(this,"VC {}: is revoked",this.getId()),t.failed(this,"VC {}: is invalid",this.getId())),!1;if(this.isExpired())return null!=t&&(t.failed(this,"VC {}: is expired",this.getId()),t.failed(this,"VC {}: is invalid",this.getId())),!1;let e=yield this.issuer.resolve();if(null==e)return null!=t&&(t.failed(this,"VC {}: can not resolve the document for issuer '{}'",this.getId(),this.getIssuer()),t.failed(this,"VC {}: is invalid",this.getId())),!1;if(yield e.isDeactivated())return null!=t&&(t.failed(this,"VC {}: issuer '{}' is deactivated",this.getId(),this.getIssuer()),t.failed(this,"VC {}: is invalid",this.getId())),!1;if(!e.isGenuine())return null!=t&&(t.failed(this,"VC {}: issuer '{}' is not genuine",this.getId(),this.getIssuer()),t.failed(this,"VC {}: is invalid",this.getId())),!1;if(!e.isAuthenticationKey(this.proof.getVerificationMethod()))return null!=t&&(t.failed(this,"VC {}: key '{}' for proof is not an authencation key of '{}'",this.getId(),this.proof.getVerificationMethod(),this.proof.getVerificationMethod().getDid()),t.failed(this,"VC {}: is invalid",this.getSubject())),!1;if(this.proof.getType()!==tQ.DEFAULT_PUBLICKEY_TYPE)return null!=t&&(t.failed(this,"VC {}: key type '{}' for proof is not supported",this.getId(),this.proof.getType()),t.failed(this,"VC {}: is invalid",this.getId())),!1;let i=t0.newWithVerifiableCredential(this,!1).serialize(!0);return e.verify(this.proof.getVerificationMethod(),this.proof.getSignature(),o.Buffer.from(i))?(null!=t&&t.succeeded(this,"VC {}: is valid",this.getId()),!0):(null!=t&&(t.failed(this,"VC {}: proof is invalid, signature mismatch",this.getId()),t.failed(this,"VC {}: is invalid",this.getId())),!1)})}wasDeclared(){return E(this,void 0,void 0,function*(){let t=yield o2.getInstance().resolveCredentialBiography(this.getId(),this.getIssuer());if(t.getStatus()==oj.NOT_FOUND)return!1;for(let e of t.getAllTransactions())if(e.getRequest().getOperation().equals(ok.Operation.DECLARE))return!0;return!1})}declare(t,e,i=null){return E(this,void 0,void 0,function*(){if(tj(null!=e&&""!==e,"Invalid storepass"),this.checkAttachedStore(),!(yield this.isGenuine()))throw t$.error("Publish failed because the credential is not genuine."),new $(this.getId().toString()+" isn't genuine");if(yield this.isExpired())throw t$.error("Publish failed because the credential is expired."),new tt(this.getId().toString()+" is expired");if(yield this.isRevoked())throw t$.error("Publish failed because the credential is revoked."),new te(this.getId().toString()+" is revoked");if(yield this.wasDeclared())throw t$.error("Publish failed because the credential already declared."),new ti(this.getId().toString()+" is already declared");let r=yield this.getStore().loadDid(this.getSubject().getId());if(null==r){if(null==(r=yield this.getSubject().getId().resolve()))throw new G(this.getSubject().getId().toString()+" isn't found in the chain");r.getMetadata().attachStore(this.getStore())}if(null==t&&null==r.getDefaultPublicKeyId())throw new q("Unknown sign key");if(null!=t){if(!r.isAuthenticationKey(t))throw new q(t.toString()+" isn't the authentication key")}else t=r.getDefaultPublicKeyId();yield o2.getInstance().declareCredential(this,r,t,e,i)})}revoke(t,e=null,i=null,r=null){return E(this,void 0,void 0,function*(){tj(null!=i&&""!==i,"Invalid storepass"),this.checkAttachedStore(),null!=e&&e.getMetadata().attachedStore()&&this.getMetadata().attachStore(e.getStore());let n=yield this.getSubject().getId().resolve();if(null==n)throw t$.error("Publish failed because the credential owner is not published."),new G(this.getSubject().getId().toString()+" isn't found in the chain");n.getMetadata().attachStore(this.getStore());let o=yield this.getIssuer().resolve();if(null==o)throw t$.error("Publish failed because the credential issuer is not published."),new G(this.getIssuer().toString()+" isn't found in the chain");if(o.getMetadata().attachStore(this.getStore()),yield this.isRevoked())throw t$.error("Publish failed because the credential is revoked."),new te(this.getId().toString()+" is revoked");if("string"==typeof t&&(t=tV.from(t,this.getSubject().getId())),null==e){let i=null!=t&&null!=t.getDid()?t.getDid():this.getSubject().getId();if(null==(e=yield this.getStore().loadDid(i))){if(null==(e=yield this.getSubject().getId().resolve()))throw new G(this.getSubject().getId().toString()+" isn't found in the chain");e.getMetadata().attachStore(this.getStore())}}if(!(e.getSubject().equals(this.getSubject().getId())||e.getSubject().equals(this.getIssuer())||n.hasController(e.getSubject())||o.hasController(e.getSubject())))throw t$.error("Publish failed because the invalid signer or signkey."),new q("Not owner or issuer: "+e.getSubject());if(null==t&&null==e.getDefaultPublicKeyId())throw new q("Unknown sign key");if(null!=t){if(!e.isAuthenticationKey(t))throw new q(t.toString()+" isn't the authencation key")}else t=e.getDefaultPublicKeyId();yield o2.getInstance().revokeCredential(this,e,t,i,r)})}static revoke(t,e,i,r,n=null){return E(this,void 0,void 0,function*(){if(tj(null!=t,"Invalid credential id"),tj(null!=e,"Invalid issuer's document"),tj(r&&null!=r,"Invalid storepass"),!e.getMetadata().attachedStore())throw new L(e.getSubject().toString()+" not attach with did store");let o=yield o2.getInstance().resolveCredentialBiography(t,e.getSubject());if(o.getStatus().equals(oj.REVOKED))throw t$.error("Publish failed because the credential is revoked."),new te(t.toString()+" is revoked");if(o.getStatus().equals(oj.VALID)){let t=o.getTransaction(0).getRequest().getCredential();if(!e.getSubject().equals(t.getSubject().getId())&&!e.getSubject().equals(t.getIssuer()))throw t$.error("Publish failed because the invalid signer or signkey."),new q("Not owner or issuer: "+e.getSubject())}if(null==i&&null==e.getDefaultPublicKeyId())throw new q("Unknown sign key");if(null!=i){if(!e.isAuthenticationKey(i))throw new q(i.toString()+" isn't the authencation key")}else i=e.getDefaultPublicKeyId();yield o2.getInstance().revokeCredential(t,e,i,r,n)})}static resolve(t,e=null,i=!1){return E(this,void 0,void 0,function*(){if(null==t)throw new _("No credential id");"string"==typeof t&&(t=tV.from(t)),"string"==typeof e&&(e=tz.from(e));let r=yield o2.getInstance().resolveCredential(t,e,i);return null!=r&&t.setMetadata(r.getMetadata()),r})}static resolveBiography(t,e){return tj(null!=t,"Invalid credential id"),o2.getInstance().resolveCredentialBiography(t,e)}static list(t,e=0,i=0){return tj(null!=t,"Invalid did"),o2.getInstance().listCredentials(t,e,i)}toJSON(t=null){let e=t?new tz(t):null,i={};return null!=this.context&&this.context.length>0&&(i["@context"]=Array.from(this.context)),i.id=this.id.toString(e),i.type=this.type,e&&this.issuer.equals(e)||(i.issuer=this.issuer.toString()),this.issuanceDate&&(i.issuanceDate=this.dateToString(this.issuanceDate)),this.expirationDate&&(i.expirationDate=this.dateToString(this.expirationDate)),i.credentialSubject=this.subject.toJSON(t),this.proof&&(i.proof=this.proof.toJSON(t)),i}fromJSON(t,e=null){if(!t.credentialSubject)throw new z("Missing property: subject");let i=t.credentialSubject,r=this.getDid("credentialSubject.id",i.id,{mandatory:!1,nullable:!1,defaultValue:e});if(!r)throw new z("Missing property: subject.id");if(this.context=this.getContext("@context",t["@context"],{mandatory:!1,nullable:!1,defaultValue:[]}),this.id=this.getDidUrl("id",t.id,{mandatory:!0,nullable:!1,context:r}),this.type=this.getStrings("type",t.type,{mandatory:!0,nullable:!1}),this.issuer=this.getDid("issuer",t.issuer,{mandatory:!1,nullable:!1,defaultValue:r}),this.issuanceDate=this.getDate("issuanceDate",t.issuanceDate,{mandatory:!0,nullable:!1}),this.expirationDate=this.getDate("expirationDate",t.expirationDate,{mandatory:!0,nullable:!0}),this.subject=t0.Subject.deserialize(i,t0.Subject,r),!t.proof)throw new z("Missing property: proof");let n=t.proof;this.proof=t0.Proof.deserialize(n,t0.Proof,this.issuer)}static parse(t,e=null){try{return tP.deserialize(t,t0,e)}catch(t){throw t instanceof z?t:new z(t)}}}t0.W3C_CREDENTIAL_CONTEXT="https://www.w3.org/2018/credentials/v1",t0.ELASTOS_CREDENTIAL_CONTEXT="https://ns.elastos.org/credentials/v1",t0.DEFAULT_CREDENTIAL_TYPE="VerifiableCredential",(ez=t0||(t0={})).Subject=class extends tP{constructor(t=null,e={}){super(),this.id=t,this.properties=tR(JSON.parse(JSON.stringify(e)))}getId(){return this.id}getProperties(){return JSON.parse(JSON.stringify(this.properties))}getPropertyCount(){return Object.keys(this.properties).length}getProperty(t){return this.properties[t]}getPropertiesAsString(){return JSON.stringify(this.properties)}toJSON(t=null){t&&new tz(t);let e={};return e.id=this.id.toString(),e=Object.assign(Object.assign({},e),this.properties)}fromJSON(t,e=null){this.id=this.getDid("subject.id",t.id,{mandatory:!1,defaultValue:e});let i=JSON.parse(JSON.stringify(t));delete i.id,this.properties=tR(i)}},ez.Proof=class extends tP{constructor(t=null,e=null,i=new Date,r=tQ.DEFAULT_PUBLICKEY_TYPE){super(),this.type=null!=r?r:tQ.DEFAULT_PUBLICKEY_TYPE,this.created=null==i?null:new Date(i.getTime()/1e3*1e3),this.created&&this.created.setMilliseconds(0),this.verificationMethod=t,this.signature=e}getType(){return this.type}getVerificationMethod(){return this.verificationMethod}getCreated(){return this.created}getSignature(){return this.signature}toJSON(t=null){let e={};return(t?new tz(t):null)&&this.type===tQ.DEFAULT_PUBLICKEY_TYPE||(e.type=this.type),this.created&&(e.created=this.dateToString(this.created)),e.verificationMethod=this.verificationMethod.toJSON(t),e.signature=this.signature,e}fromJSON(t,e=null){this.type=this.getString("proof.type",t.type,{mandatory:!1,defaultValue:tQ.DEFAULT_PUBLICKEY_TYPE}),this.created=this.getDate("proof.created",t.created,{mandatory:!1}),this.verificationMethod=this.getDidUrl("proof.verificationMethod",t.verificationMethod,{mandatory:!0,nullable:!1,context:e}),this.signature=this.getString("proof.signature",t.signature,{mandatory:!0,nullable:!1})}},ez.Builder=class{constructor(t,e){this.issuer=t,this.target=e,this.credential=new ez,this.credential.issuer=t.getDid(),this.setDefaultType()}checkNotSealed(){if(null==this.credential)throw new Q(this.id.toString()+" is already sealed")}id(t){return this.checkNotSealed(),tj(null!=t,"Invalid id"),"string"==typeof t&&(t=tV.from(t,this.target)),tj(null==t.getDid()||t.getDid().equals(this.target),"Invalid id"),null==t.getDid()&&(t=tV.from(t,this.target)),this.credential.id=t,this}setDefaultType(){this.checkNotSealed(),tq.isEnabledJsonLdContext()&&(null==this.credential.context&&(this.credential.context=[]),this.credential.context.includes(ez.W3C_CREDENTIAL_CONTEXT)||this.credential.context.push(ez.W3C_CREDENTIAL_CONTEXT),this.credential.context.includes(ez.ELASTOS_CREDENTIAL_CONTEXT)||this.credential.context.push(ez.ELASTOS_CREDENTIAL_CONTEXT)),null==this.credential.type&&(this.credential.type=[]),this.credential.type.includes(ez.DEFAULT_CREDENTIAL_TYPE)||this.credential.type.push(ez.DEFAULT_CREDENTIAL_TYPE)}typeWithContext(t,e){return this.checkNotSealed(),tK(t,"Invalid type: "+t),tq.isEnabledJsonLdContext()?(tK(e,"Invalid context: "+e),null==this.credential.context&&(this.credential.context=[]),this.credential.context.includes(e)||this.credential.context.push(e)):t$.warn("JSON-LD context support not enabled"),null==this.credential.type&&(this.credential.type=[]),this.credential.type.includes(t)||this.credential.type.push(t),this}type(t){if(this.checkNotSealed(),tK(t,"Invalid type: "+t),0>t.indexOf("#"))return this.typeWithContext(t,null);{let e=t.split("#",2);return this.typeWithContext(e[1],e[0])}}types(...t){if(null==t||0==t.length)return this;for(let e of(this.checkNotSealed(),t))this.type(e);return this}getMaxExpires(){return(null!=this.credential.getIssuanceDate()?f(this.credential.getIssuanceDate()):f()).add(tQ.MAX_VALID_YEARS,"years").toDate()}defaultExpirationDate(){return this.checkNotSealed(),this.credential.expirationDate=this.getMaxExpires(),this.credential.expirationDate&&this.credential.expirationDate.setMilliseconds(0),this}expirationDate(t){this.checkNotSealed(),tj(null!=t,"Invalid expiration date");let e=f(t),i=this.getMaxExpires();return e.isAfter(i)&&(e=f(i)),this.credential.expirationDate=e.toDate(),this.credential.expirationDate&&this.credential.expirationDate.setMilliseconds(0),this}properties(t){this.checkNotSealed();let e="string"==typeof t?JSON.parse(t):JSON.parse(JSON.stringify(t));return delete e.id,null==t||0==Object.keys(t).length?this.subjectProperties={}:this.subjectProperties=e,this}property(t,e){return this.checkNotSealed(),tj(null!=t&&""!==t&&"id"!==t,"Invalid name"),this.subjectProperties||(this.subjectProperties={}),this.subjectProperties[t]=e,this}sanitize(){if(null!=this.credential.context&&0!=this.credential.context.length||(this.credential.context=[]),null==this.credential.id)throw new z("Missing credential id");if(null==this.credential.type||0==this.credential.type.length)throw new z("Missing credential type");t1.sort(this.credential.type),this.credential.issuanceDate=new Date,this.credential.issuanceDate&&this.credential.issuanceDate.setMilliseconds(0),this.credential.hasExpirationDate()||this.defaultExpirationDate(),this.subjectProperties=tR(this.subjectProperties),this.credential.proof=null}seal(t){return E(this,void 0,void 0,function*(){this.checkNotSealed(),tj(null!=t&&""!==t,"Invalid storepass"),this.sanitize(),this.credential.subject=new ez.Subject(this.target,this.subjectProperties);let e=this.credential.serialize(!0),i=yield this.issuer.sign(t,o.Buffer.from(e));this.credential.proof=new ez.Proof(this.issuer.getSignKey(),i);let r=this.credential;return this.credential=null,r})}};class t1{static sort(t){t.sort((t,e)=>"string"==typeof t?t<e?-1:t>e?1:0:t.compareTo(e))}}class t2 extends Map{get(t){for(let e of this.entries())if(e[0].equals(t))return e[1];return null}delete(t){for(let e of this.entries())if(e[0].equals(t))return super.delete(e[0]);return!1}has(t){for(let e of this.entries())if(e[0].equals(t))return!0;return!1}valuesAsSortedArray(){let t=Array.from(this.keys());return t1.sort(t),t.map(t=>this.get(t))}}class t5{header(){throw Error("Not implemented.")}push(t){return this.pushAny(t,!0)}pushLast(t){return this.pushAny(t,!0)}pushAny(t,e){throw Error("Not implemented.")}}class t3{static getHeaderLen(){return d.crypto_secretstream_xchacha20poly1305_HEADERBYTES}static getEncryptExtraSize(){return d.crypto_secretstream_xchacha20poly1305_ABYTES}pull(t){throw Error("Not implemented.")}isComplete(){throw Error("Not implemented.")}}class t6{static getCurve25519KeyPair(t){let e=d.crypto_sign_seed_keypair(t);if(!e)throw Error("Failed to generate ed25519 key pair.");let i=d.crypto_sign_ed25519_sk_to_curve25519(e.privateKey);if(!i)throw Error("Failed to generate curve25519 private key.");let r=d.crypto_sign_ed25519_pk_to_curve25519(e.publicKey);if(!r)throw Error("Failed to generate curve25519 public key.");return{ed25519Sk:e.privateKey,ed25519Pk:e.publicKey,privateKey:i,publicKey:r}}}class t8 extends t5{constructor(t){super();let e=d.crypto_secretstream_xchacha20poly1305_init_push(t);if(!e)throw Error("Failed to init encryption.");this.header_=e.header,this.state=e.state}header(){return this.header_}pushAny(t,e){tj(!!t,"Invalid clearText");let i=t instanceof Uint8Array?t:new Uint8Array(t),r=e?d.crypto_secretstream_xchacha20poly1305_TAG_FINAL:d.crypto_secretstream_xchacha20poly1305_TAG_MESSAGE,n=d.crypto_secretstream_xchacha20poly1305_push(this.state,i,null,r);if(!n)throw Error("Failed to encrypt clearText.");return n}}class t4 extends t3{constructor(t,e){if(super(),this.state=d.crypto_secretstream_xchacha20poly1305_init_pull(e,t),!this.state)throw Error("Failed to init decryption.");this.complete=!1}pull(t){tj(!!t,"Invalid clearText");let e=t instanceof Uint8Array?t:new Uint8Array(t),i=d.crypto_secretstream_xchacha20poly1305_pull(this.state,e);if(!i)throw Error("Failed to decrypt the cipherText.");return i.tag==d.crypto_secretstream_xchacha20poly1305_TAG_FINAL&&(this.complete=!0),i.message}isComplete(){return this.complete}}class t7{constructor(t){this.key=t}setOtherSideCurve25519PublicKey(t){throw Error("Not support yet.")}encrypt(t,e){tj(!!t,"Invalid data"),tj(!!e,"Invalid nonce");let i=d.crypto_aead_xchacha20poly1305_ietf_encrypt(new Uint8Array(t),null,null,new Uint8Array(e),this.key);if(!i)throw Error("Failed to encrypt data.");return o.Buffer.from(i)}decrypt(t,e){tj(!!t,"Invalid data"),tj(!!e,"Invalid nonce");let i=d.crypto_aead_xchacha20poly1305_ietf_decrypt(null,new Uint8Array(t),null,new Uint8Array(e),this.key);if(!i)throw Error("Failed to decrypt data.");return o.Buffer.from(i)}createEncryptionStream(){return new t8(this.key)}createDecryptionStream(t){return new t4(this.key,new Uint8Array(t))}getEd25519PublicKey(){throw Error("Not support yet.")}getCurve25519PublicKey(){throw Error("Not support yet.")}}class t9{constructor(t,e){this.keyPair=t,this.isServer=e,this.encryptKey=null,this.sharedKeys=null}checkEncryptionKeys(){if(!this.encryptKey||!this.sharedKeys)throw Error("Please set an other side public key first.")}setOtherSideCurve25519PublicKey(t){if(this.encryptKey=d.crypto_box_beforenm(new Uint8Array(t),this.keyPair.privateKey),!this.encryptKey)throw Error("Failed to generate encrypt keys.");if(this.sharedKeys=this.isServer?d.crypto_kx_server_session_keys(this.keyPair.publicKey,this.keyPair.privateKey,new Uint8Array(t)):d.crypto_kx_client_session_keys(this.keyPair.publicKey,this.keyPair.privateKey,new Uint8Array(t)),!this.sharedKeys)throw Error("Failed to generate shared keys.")}encrypt(t,e){tj(!!t,"Invalid data"),tj(!!e,"Invalid nonce"),this.checkEncryptionKeys();let i=d.crypto_box_easy_afternm(new Uint8Array(t),new Uint8Array(e),this.encryptKey);if(!i)throw Error("Failed to encrypt data.");return o.Buffer.from(i)}decrypt(t,e){tj(!!t,"Invalid data"),tj(!!e,"Invalid nonce"),this.checkEncryptionKeys();let i=d.crypto_box_open_easy_afternm(new Uint8Array(t),new Uint8Array(e),this.encryptKey);if(!i)throw Error("Failed to decrypt data.");return o.Buffer.from(i)}createEncryptionStream(){return this.checkEncryptionKeys(),new t8(this.sharedKeys.sharedTx)}createDecryptionStream(t){return this.checkEncryptionKeys(),new t4(this.sharedKeys.sharedRx,new Uint8Array(t))}getEd25519PublicKey(){return o.Buffer.from(this.keyPair.ed25519Pk)}getCurve25519PublicKey(){return o.Buffer.from(this.keyPair.publicKey)}}let et=new b("DIDDocument");class ee extends tP{constructor(t){super(),this.subject=t}static clone(t,e){let i=new ee(t.subject);return i.context=t.context,i.controllers=t.controllers,i.controllerDocs=t.controllerDocs,i.effectiveController=t.effectiveController,i.multisig=t.multisig,i.publicKeys=t.publicKeys,i.authenticationKeys=t.authenticationKeys,i.authorizationKeys=t.authorizationKeys,i.defaultPublicKey=t.defaultPublicKey,i.credentials=t.credentials,i.services=t.services,i.expires=t.expires,e&&(i.proofs=t.proofs),i.metadata=t.metadata,i}getSubject(){return this.subject}canonicalId(t){return"string"==typeof t?tV.from(t,this.getSubject()):null==t||null!=t.getDid()?t:tV.from(t,this.getSubject())}checkAttachedStore(){if(!this.getMetadata().attachedStore())throw new L("Not attach with did store")}checkIsPrimitive(){if(this.isCustomizedDid())throw new M(this.getSubject().toString()+"is a customized did")}checkIsCustomized(){if(!this.isCustomizedDid())throw new F(this.getSubject().toString()+"isn't a customized did")}checkHasEffectiveController(){if(null==this.getEffectiveController())throw new j("No effective controller of "+this.getSubject().toString())}isCustomizedDid(){return null==this.defaultPublicKey}getControllers(){return this.controllers}getControllerCount(){return this.controllers.length}getController(){return 1==this.controllers.length?this.controllers[0]:null}hasController(t=null){return t?void 0!==this.controllers.find(e=>e.equals(t)):0!=this.controllers.length}getControllerDocument(t){return this.controllerDocs.get(t)}getEffectiveController(){return this.effectiveController}getEffectiveControllerDocument(){return null==this.effectiveController?null:this.getControllerDocument(this.effectiveController)}setEffectiveController(t){if(this.checkIsCustomized(),null!=t){if(!this.hasController(t))throw new K("Not contoller for target DID");this.effectiveController=t;let e=this.getControllerDocument(this.effectiveController);e.getMetadata().attachedStore()||e.getMetadata().attachStore(this.getMetadata().getStore())}else this.effectiveController=t}isMultiSignature(){return null!=this.multisig}getMultiSignature(){return this.multisig}getPublicKeyCount(){let t=this.publicKeys.size;if(this.hasController())for(let e of this.controllerDocs.values())t+=e.getAuthenticationKeyCount();return t}getPublicKeys(){let t=Array.from(this.publicKeys.values());if(this.hasController())for(let e of this.controllerDocs.values())t.push(...e.getAuthenticationKeys());return t}selectPublicKeys(t,e){tj(null!=t||null!=e,"Invalid select args"),t=this.canonicalId(t);let i=[];for(let r of this.publicKeys.values())(null==t||r.getId().equals(t))&&(null!=e&&r.getType()!==e||i.push(r));if(this.hasController())for(let r of this.controllerDocs.values())i.push(...r.selectAuthenticationKeys(t,e));return i}getPublicKey(t){tj(null!=t,"Invalid publicKey id"),t=this.canonicalId(t);let e=this.publicKeys.get(t);if(null==e&&this.hasController()){let i=this.getControllerDocument(t.getDid());null!=i&&(e=i.getAuthenticationKey(t))}return e}hasPublicKey(t){return null!=this.getPublicKey(this.canonicalId(t))}hasPrivateKey(t){return E(this,void 0,void 0,function*(){return"string"==typeof t&&(t=this.canonicalId(t)),tj(null!=t,"Invalid publicKey id"),!(!this.hasPublicKey(t)||!this.getMetadata().attachedStore())&&(yield this.getMetadata().getStore().containsPrivateKey(t))})}getDefaultPublicKeyId(){let t=this.getDefaultPublicKey();return null!=t?t.getId():null}getDefaultPublicKey(){return null!=this.defaultPublicKey?this.defaultPublicKey:null!=this.effectiveController?this.getControllerDocument(this.effectiveController).getDefaultPublicKey():null}derive(t,e){return E(this,void 0,void 0,function*(){return tj(null!=e&&""!==e,"Invalid storepass"),this.checkAttachedStore(),this.checkIsPrimitive(),oA.deserialize((yield this.getMetadata().getStore().loadPrivateKey(this.getDefaultPublicKeyId(),e))).deriveWithIndex(t).serializeBase58()})}mapToDerivePath(t,e){let i=ex.encodeToBuffer(o.Buffer.from(t,"utf-8")),r="m/",n=eT.wrap(i);for(;n.hasRemaining();){let t=n.readInt();r=(r=t>=0?r.concat(t.toString()):r.concat((2147483647&t).toString()).concat("'")).concat("/")}return e>=0?r.concat(e.toString()):r.concat((2147483647&e).toString()).concat("'")}deriveFromIdentifier(t,e,i){return E(this,void 0,void 0,function*(){tj(t&&null!=t,"Invalid identifier"),this.checkAttachedStore(),this.checkIsPrimitive();let r=oA.deserialize((yield this.getMetadata().getStore().loadPrivateKey(this.getDefaultPublicKeyId(),i))),n=this.mapToDerivePath(t,e);return r.deriveWithPath(n).serializeBase58()})}getAuthenticationKeyCount(){let t=this.authenticationKeys.size;if(this.hasController())for(let e of this.controllerDocs.values())t+=e.getAuthenticationKeyCount();return t}getAuthenticationKeys(){let t=Array.from(this.authenticationKeys.values());if(this.hasController())for(let e of this.controllerDocs.values())t.push(...e.getAuthenticationKeys());return t}selectAuthenticationKeys(t,e){tj(null!=t||null!=e,"Invalid select args"),t=this.canonicalId(t);let i=[];for(let r of this.authenticationKeys.values())(null==t||r.getId().equals(t))&&(null!=e&&r.getType()!==e||i.push(r));if(this.hasController())for(let r of this.controllerDocs.values())i.push(...r.selectAuthenticationKeys(t,e));return i}getAuthenticationKey(t){tj(null!=t,"Invalid publicKey id"),t=this.canonicalId(t);let e=this.authenticationKeys.get(t);if(null!=e)return e;if(this.hasController()){let e=this.controllerDocs.get(t.getDid());if(null!=e)return e.getAuthenticationKey(t)}return null}isAuthenticationKey(t){return null!=this.getAuthenticationKey(this.canonicalId(t))}getAuthorizationKeyCount(){return this.authorizationKeys.size}getAuthorizationKeys(){return Array.from(this.authorizationKeys.values())}selectAuthorizationKeys(t,e){tj(null!=t||null!=e,"Invalid select args"),t=this.canonicalId(t);let i=[];for(let r of this.authorizationKeys.values())(null==t||r.getId().equals(t))&&(null!=e&&r.getType()!==e||i.push(r));return i}getAuthorizationKey(t){return tj(null!=t,"Invalid publicKey id"),this.authorizationKeys.get(this.canonicalId(t))}isAuthorizationKey(t){return null!=this.getAuthorizationKey(t)}getCredentialCount(){return this.credentials.size}getCredentials(){return Array.from(this.credentials.values())}selectCredentials(t,e){tj(null!=t||null!=e,"Invalid select args"),t=this.canonicalId(t);let i=[];for(let r of this.credentials.values())(null==t||r.getId().equals(t))&&(null!=e&&0>r.getType().indexOf(e)||i.push(r));return i}getCredential(t){return tj(null!=t,"Invalid Credential id"),this.credentials.get(this.canonicalId(t))}getServiceCount(){return this.services.size}getServices(){return Array.from(this.services.values())}selectServices(t,e){tj(null!=t||null!=e,"Invalid select args"),t=this.canonicalId(t);let i=[];for(let r of this.services.values())(null==t||r.getId().equals(t))&&(null!=e&&r.getType()!==e||i.push(r));return i}getService(t){return tj(null!=t,"Invalid service id"),this.services.get(this.canonicalId(t))}getExpires(){return this.expires}getLastModified(){return this.getProof().getCreated()}getSignature(){return this.getProof().getSignature()}getProof(){return this.getProofs()[0]}getProofs(){return this.proofs.valuesAsSortedArray()}getSerializeContextDid(){return this.getSubject()}toJSON(t=null){let e=t?new tz(t):null,i={};if(this.context.length>0&&(i["@context"]=Array.from(this.context)),i.id=this.subject.toString(),this.controllers.length>0&&(i.controller=1==this.controllers.length?this.controllers[0].toString():Array.from(this.controllers,t=>t.toString())),this.multisig&&(i.multisig=this.multisig.toString()),this.publicKeys.size>0&&(i.publicKey=Array.from(this.publicKeys.valuesAsSortedArray(),e=>e.toJSON(t))),this.authenticationKeys.size>0&&(i.authentication=Array.from(this.authenticationKeys.valuesAsSortedArray(),t=>t.getId().toString(e))),this.authorizationKeys.size>0&&(i.authorization=Array.from(this.authorizationKeys.valuesAsSortedArray(),t=>t.getId().toString(e))),this.credentials.size>0&&(i.verifiableCredential=Array.from(this.credentials.valuesAsSortedArray(),e=>e.toJSON(t))),this.services.size>0&&(i.service=Array.from(this.services.valuesAsSortedArray(),e=>e.toJSON(t))),this.expires&&(i.expires=this.dateToString(this.expires)),this.proofs&&this.proofs.size>0){let e=this.proofs.valuesAsSortedArray();1==e.length?i.proof=e[0].toJSON(t):i.proof=Array.from(e,e=>e.toJSON(t))}return i}fromJSON(t,e=null){return E(this,void 0,void 0,function*(){this.fromJSONOnly(t,e),this.controllers.length>0&&(yield this.resolveControllers())})}resolveControllers(){return E(this,void 0,void 0,function*(){if(this.controllerDocs.size===this.controllers.length)return;let t=[];for(let e of this.controllers){let i=e.resolve().then(t=>{if(null==t)throw new C("Can not resolve controller: "+e);if(this.controllerDocs.has(e))throw new C("Duplicated controller: "+e);this.controllerDocs.set(e,t)});t.push(i)}try{yield Promise.all(t)}catch(t){throw new C("Can not resolve the controller's DID: "+t,t)}})}fromJSONOnly(t,e=null){this.context=this.getContext("@context",t["@context"],{mandatory:!1,nullable:!1,defaultValue:[]}),this.subject=this.getDid("id",t.id,{mandatory:!0,nullable:!1,defaultValue:null}),e=this.subject,this.controllers=this.getDids("controller",t.controller,{mandatory:!1,nullable:!1,defaultValue:[]});let i=this.getString("multisig",t.multisig,{mandatory:!1,nullable:!1});if(i&&(this.multisig=ee.MultiSignature.fromString(i)),this.controllerDocs=new t2,this.controllers.length<=1){if(this.multisig)throw new C("Invalid multisig property")}else{if(null==this.multisig)throw new C("Missing multisig property");if(this.multisig.n()!=this.controllers.length)throw new C("Invalid multisig property")}if(this.publicKeys=new t2,t.publicKey){if(!Array.isArray(t.publicKey))throw new C("Invalid property: publicKey, type error.");for(let i of t.publicKey){let t;try{t=ee.PublicKey.deserialize(i,ee.PublicKey,e)}catch(t){throw new C("Invalid publicKey: "+i.id,t)}if(this.publicKeys.has(t.getId()))throw new C("Duplicated publicKey: "+t.getId());this.publicKeys.set(t.getId(),t)}}if(this.authenticationKeys=new t2,t.authentication){if(!Array.isArray(t.authentication))throw new C("Invalid property: authentication, type error.");for(let i of t.authentication){let t;if("string"==typeof i){let r=new tV(i,e);if(!this.publicKeys.has(r))throw new C("Not exists publicKey reference: "+r);t=this.publicKeys.get(r)}else{try{t=ee.PublicKey.deserialize(i,ee.PublicKey,e)}catch(t){throw new C("Invalid publicKey: "+i.id,t)}if(this.publicKeys.has(t.getId()))throw new C("Duplicated publicKey: "+t.getId());this.publicKeys.set(t.getId(),t)}if(!t.getController().equals(e))throw new C("Invalid authentication key: "+t.getId());this.authenticationKeys.set(t.getId(),t)}}if(this.authorizationKeys=new t2,t.authorization){if(!Array.isArray(t.authorization))throw new C("Invalid property: authorization, type error.");for(let i of t.authorization){let t;if("string"==typeof i){let r=new tV(i,e);if(!this.publicKeys.has(r))throw new C("Not exists publicKey reference: "+r);t=this.publicKeys.get(r)}else{try{t=ee.PublicKey.deserialize(i,ee.PublicKey,e)}catch(t){throw new C("Invalid publicKey: "+i.id,t)}if(this.publicKeys.has(t.getId()))throw new C("Duplicated publicKey: "+t.getId());this.publicKeys.set(t.getId(),t)}if(t.getController().equals(e))throw new C("Invalid authorization key: "+t.getId());this.authorizationKeys.set(t.getId(),t)}}if(this.controllers.length>0)1==this.controllers.length&&(this.effectiveController=this.controllers[0]);else{if(!this.publicKeys||0==this.publicKeys.size)throw new C("Missing publicKeys");for(let t of this.publicKeys.values())if(t.getController().equals(this.subject)&&oA.toAddress(t.getPublicKeyBytes())===this.subject.getMethodSpecificId()){this.defaultPublicKey=t,this.authenticationKeys.has(t.getId())||this.authenticationKeys.set(t.getId(),t);break}if(!this.defaultPublicKey)throw new C("Missing default public key")}if(this.credentials=new t2,t.verifiableCredential){if(!Array.isArray(t.verifiableCredential))throw new C("Invalid property: verifiableCredential, type error.");for(let i of t.verifiableCredential){let t;try{t=t0.deserialize(i,t0,e)}catch(t){throw new C("Invalid verifiableCredential: "+i.id,t)}if(this.credentials.has(t.getId()))throw new C("Duplicated verifiableCredential: "+t.getId());this.credentials.set(t.getId(),t)}}if(this.services=new t2,t.service){if(!Array.isArray(t.service))throw new C("Invalid property: service, type error.");for(let i of t.service){let t;try{t=ee.Service.deserialize(i,ee.Service,e)}catch(t){throw new C("Invalid service: "+i.id,t)}if(this.services.has(t.getId()))throw new C("Duplicated service: "+t.getId());this.services.set(t.getId(),t)}}if(this.expires=this.getDate("expires",t.expires,{mandatory:!0,nullable:!1}),!t.proof)throw new C("Missing property: proof");if(this.proofs=new t2,Array.isArray(t.proof))for(let i of t.proof){let t=ee.Proof.deserialize(i,ee.Proof,e);if(null==t.getCreator().getDid())throw new C("Invalid proof creater: "+t.getCreator());if(this.proofs.has(t.getCreator().getDid()))throw new C("Aleady exist proof from "+t.getCreator().getDid());this.proofs.set(t.getCreator().getDid(),t)}else{let i=t.proof;this.isCustomizedDid()||i.creator||(i.creator=this.getDefaultPublicKeyId().toString());let r=ee.Proof.deserialize(i,ee.Proof,e);if(null==r.getCreator().getDid())throw new C("Invalid proof creater: "+r.getCreator());this.proofs.set(r.getCreator().getDid(),r)}}setMetadata(t){this.metadata=t,this.subject.setMetadata(t)}getMetadata(){return null==this.metadata&&(this.metadata=new tN(this.getSubject())),this.metadata}getStore(){return this.getMetadata().getStore()}isExpired(){return f().isAfter(f(this.expires))}isGenuine(t=null){let e=null==this.multisig?1:this.multisig.m();if(this.proofs.size!=e)return null!=t&&(t.failed(this,"{}: proof size not matched with multisig, {} expected, actual is {}",this.getSubject(),this.multisig.m(),this.proofs.size),t.failed(this,"{}: is not genuine",this.getSubject())),!1;let i=ee.clone(this,!1).serialize(!0),r=eO.sha256Digest(o.Buffer.from(i,"utf-8"));if(this.isCustomizedDid()){for(let e of this.proofs.values()){if(e.getType()!==tQ.DEFAULT_PUBLICKEY_TYPE)return null!=t&&(t.failed(this,"{}: key type '{}' for proof is not supported",this.getSubject(),e.getType()),t.failed(this,"{}: is not genuine",this.getSubject())),!1;let i=this.getControllerDocument(e.getCreator().getDid());if(null==i)return null!=t&&(t.failed(this,"{}: can not resolve the document for controller '{}' to verify the proof",this.getSubject(),e.getCreator().getDid()),t.failed(this,"{}: is not genuine",this.getSubject())),!1;if(!i.isGenuine(t))return null!=t&&(t.failed(this,"{}: controller '{}' is not genuine, failed to verify the proof",this.getSubject(),e.getCreator().getDid()),t.failed(this,"{}: is not genuine",this.getSubject())),!1;if(!e.getCreator().equals(i.getDefaultPublicKeyId()))return null!=t&&(t.failed(this,"{}: key '{}' for proof is not default key of '{}'",this.getSubject(),e.getCreator(),e.getCreator().getDid()),t.failed(this,"{}: is not genuine",this.getSubject())),!1;if(!i.verifyDigest(e.getCreator(),e.getSignature(),r))return null!=t&&(t.failed(this,"{}: proof '{}' is invalid, signature mismatch",this.getSubject(),e.getCreator()),t.failed(this,"{}: is not genuine",this.getSubject())),!1}return null!=t&&t.succeeded(this,"{}: is genuine",this.getSubject()),!0}{let e=this.getProof();if(e.getType()!==tQ.DEFAULT_PUBLICKEY_TYPE)return null!=t&&(t.failed(this,"{}: key type '{}' for proof is not supported",this.getSubject(),e.getType()),t.failed(this,"{}: is not genuine",this.getSubject())),!1;if(!e.getCreator().equals(this.getDefaultPublicKeyId()))return null!=t&&(t.failed(this,"{}: key '{}' for proof is not default key",this.getSubject(),e.getCreator()),t.failed(this,"{}: is not genuine",this.getSubject())),!1;let i=this.verifyDigest(e.getCreator(),e.getSignature(),r);return null!=t&&(i?t.succeeded(this,"{}: is genuine",this.getSubject()):(t.failed(this,"{}: can not verify the signature",this.getSubject()),t.failed(this,"{}: is not genuine",this.getSubject()))),i}}isDeactivated(){return E(this,void 0,void 0,function*(){if(this.getMetadata().isDeactivated())return!0;let t=yield o2.getInstance().resolveDidBiography(this.getSubject());if(null==t)return!1;let e=t.getStatus()==oZ.DEACTIVATED;return e&&this.getMetadata().setDeactivated(e),e})}isQualified(){return null!=this.proofs&&0!=this.proofs.size&&this.proofs.size==(null==this.multisig?1:this.multisig.m())}isValid(t=null){return E(this,void 0,void 0,function*(){if(yield this.isDeactivated())return null!=t&&(t.failed(this,"{}: is deactivated",this.getSubject()),t.failed(this,"{}: is invalid",this.getSubject())),!1;if(this.isExpired())return null!=t&&(t.failed(this,"{}: is expired",this.getSubject()),t.failed(this,"{}: is invalid",this.getSubject())),!1;if(!this.isGenuine(t))return null!=t&&t.failed(this,"{}: is invalid",this.getSubject()),!1;if(this.hasController())for(let e of this.controllerDocs.values()){if(yield e.isDeactivated())return null!=t&&(t.failed(this,"{}: controller '{}' is deactivated",this.getSubject(),e.getSubject()),t.failed(this,"{}: is invalid",this.getSubject())),!1;if(!e.isGenuine(t))return null!=t&&(t.failed(this,"{}: controller '{}' is not genuine",this.getSubject(),e.getSubject()),t.failed(this,"{}: is invalid",this.getSubject())),!1}return null!=t&&t.succeeded(this,"{}: is valid",this.getSubject()),!0})}copy(){let t=new ee(this.subject);t.context=null==this.context?null:Array.from(this.context),t.controllers=Array.from(this.controllers),t.controllerDocs=new t2(this.controllerDocs),null!=this.multisig&&(t.multisig=ee.MultiSignature.newFromMultiSignature(this.multisig)),t.effectiveController=this.effectiveController,t.publicKeys=new t2(this.publicKeys),t.authenticationKeys=new t2(this.authenticationKeys),t.authorizationKeys=new t2(this.authorizationKeys),t.defaultPublicKey=this.defaultPublicKey,t.credentials=new t2(this.credentials),t.services=new t2(this.services),t.expires=this.expires,t.proofs=new t2(this.proofs);let e=this.getMetadata().clone();return t.setMetadata(e),t}clone(){let t=new ee(this.subject);return t.context=this.context,t.controllers=this.controllers,t.controllerDocs=this.controllerDocs,t.effectiveController=this.effectiveController,t.multisig=this.multisig,t.publicKeys=this.publicKeys,t.authenticationKeys=this.authenticationKeys,t.authorizationKeys=this.authorizationKeys,t.defaultPublicKey=this.defaultPublicKey,t.credentials=this.credentials,t.services=this.services,t.expires=this.expires,t.proofs=this.proofs,t.metadata=this.getMetadata().clone(),t}signWithId(t,e,...i){let r;tj(e&&null!=e,"Invalid storepass"),tj(null!=i&&i.length>0,"Invalid input data"),this.checkAttachedStore(),r="string"==typeof t?this.canonicalId(t):t;let n=ex.encodeToBuffer(...i);return this.signDigest(r,e,n)}signWithStorePass(t,...e){return this.signWithId(null,t,...e)}signWithTicket(t,e){return E(this,void 0,void 0,function*(){return tj(null!=t,"Invalid ticket"),tj(e&&null!=e,"Invalid storepass"),this.checkAttachedStore(),yield t.seal(this,e),t})}signWithDocument(t,e){return E(this,void 0,void 0,function*(){if(tj(null!=t,"Invalid document"),tj(e&&null!=e,"Invalid storepass"),this.checkAttachedStore(),!t.isCustomizedDid())throw new F(t.getSubject().toString()+"isn't a customized did");if(!t.hasController(this.getSubject()))throw new K(this.getSubject()+" isn't the controller of "+t.getSubject().toString());if(this.isCustomizedDid()){if(null==this.getEffectiveController())throw new j("no effective controller of "+this.getSubject().toString())}else if(!t.hasController(this.getSubject()))throw new K(this.getSubject().toString()+" isn't the controller of "+t.getSubject().toString());if(t.proofs.has(this.getSubject()))throw new U(this.getSubject().toString()+" already signed");let i=ee.Builder.newFromDocument(t).edit(this);try{return yield i.seal(e)}catch(t){throw new k(t)}})}signDigest(t,e,i){tj(e&&null!=e,"Invalid storepass"),tj(null!=i&&i.length>0,"Invalid digest"),this.checkAttachedStore(),"string"==typeof t&&(t=this.canonicalId(t));let r=null!=t?this.getPublicKey(t):this.getDefaultPublicKey();if(null==r)throw null!=t?new q(t.toString()+" is a invalid key"):new j("No effective controller of "+this.getSubject().toString());return this.getMetadata().getStore().sign(r.getId(),e,i)}verify(t,e,...i){tj(e&&null!=e,"Invalid signature"),tj(null!=i&&i.length>0,"Invalid digest");let r=eO.sha256Digest(...i);return this.verifyDigest(t,e,r)}verifyDigest(t,e,i){tj(e&&null!=e,"Invalid signature"),tj(null!=i&&i.length>0,"Invalid digest"),"string"==typeof t&&(t=this.canonicalId(t));let r=null!=t?this.getPublicKey(t):this.getDefaultPublicKey();if(null==r)throw new q(null!=t?t.toString()+"is a invalide key":"No explicit publicKey");let n=r.getPublicKeyBytes(),s=o.Buffer.from(eP.decode(e),"hex");return eO.verify(n,s,i)}getDerivedPrivateKeyForCipher(t,e,i){return E(this,void 0,void 0,function*(){tj(!!t,"Invalid identifier"),this.checkAttachedStore(),this.checkIsPrimitive();let r=oA.deserialize((yield this.getMetadata().getStore().loadPrivateKey(this.getDefaultPublicKeyId(),i))),n=this.mapToDerivePath(t,e);return new Uint8Array(r.deriveWithPath(n).getPrivateKeyBytes())})}createCipher(t,e,i){return E(this,void 0,void 0,function*(){let r=yield this.getDerivedPrivateKeyForCipher(t,e,i);return new t7(r)})}createCurve25519Cipher(t,e,i,r){return E(this,void 0,void 0,function*(){let n=yield this.getDerivedPrivateKeyForCipher(t,e,i),o=t6.getCurve25519KeyPair(n);return new t9(o,r)})}getKeyProvider(){let t=this;return new class{getPublicKey(e=null){return E(this,void 0,void 0,function*(){let i;if(i=null==e?t.getDefaultPublicKeyId():t.canonicalId(e),!t.hasPublicKey(i))return null;let r=t.getPublicKey(i).getPublicKeyBytes(),n=new y.Key("oct",r,{namedCurve:"P-256"}),o=Object.assign({},(yield n.export("jwk")));return yield(0,p.nO)(o,"ES256",!0)})}getPrivateKey(e=null,i){return E(this,void 0,void 0,function*(){let r;r=null==e?t.getDefaultPublicKeyId():t.canonicalId(e);let n=t.getMetadata().getStore();if(!(yield n.containsPrivateKey(r)))return null;let o=oA.deserialize((yield n.loadPrivateKey(r,i))),s=new y.Key("oct",o.getPrivateKeyBytes(),{namedCurve:"P-256"}),a=Object.assign({},(yield s.export("jwk")));return yield(0,p.nO)(a,"ES256",!0)})}}}jwtBuilder(){return new tH(this.getSubject(),this.getKeyProvider()).setIssuer(this.getSubject().toString())}jwtParserBuilder(){let t=tG.newWithKeyProvider(this.getKeyProvider());return t.requireIssuer(this.getSubject().toString()),t}newCustomized(t,e,i){return this.newCustomizedDidWithController(t,[],1,e,i)}newCustomizedDidWithController(t,e,i,r,n){return E(this,void 0,void 0,function*(){tj(t&&null!=t,"Invalid DID"),tj(r&&null!=r,"Invalid storepass"),this.checkAttachedStore();let o=tz.from(t),s=[];e&&e.length&&e.forEach(t=>{let e=tz.from(t);e.equals(this.getSubject())||s.includes(t)||s.push(e)}),tj(i>=0&&i<=s.length+1,"Invalid multisig"),ee.log.info("Creating new DID {} with controller {}...",o,this.getSubject());let a=null;if(!n&&(a=yield o.resolve(!0)))throw new P(o.toString()+" already exist");ee.log.info("Creating new DID {} with controller {}...",o,this.getSubject());let l=ee.Builder.newFromDID(o,this.getStore(),this);for(let t of s)yield l.addController(t);l.setMultiSignature(i);try{return a=yield l.seal(r),yield this.getStore().storeDid(a),a}catch(t){throw new k(t)}})}createTransferTicket(t,e,i){return E(this,void 0,void 0,function*(){tj(t&&null!=t,"Invalid to"),tj(e&&null!=e,"Invalid storepass");let r=i?yield i.resolve(!0):this;if(i){if(this.checkIsPrimitive(),this.checkAttachedStore(),!r)throw new G(i.toString()+" isn't found in the chain");if(yield r.isDeactivated())throw new O(i.toString()+" is deactived");if(!r.isCustomizedDid())throw new F(i.toString()+" isn't a customized did");if(!r.hasController(this.getSubject()))throw new K(this.getSubject().toString()+" isn't the controller of did")}else this.checkIsCustomized(),this.checkAttachedStore(),this.checkHasEffectiveController();let n=yield es.newForDIDDocument(r,t);return yield n.seal(this,e),n})}publishWithTicket(t,e,i,r=null){return E(this,void 0,void 0,function*(){tj((yield t.isValid()),"Invalid ticket"),tj(t.getSubject().equals(this.getSubject()),"Ticket mismatch with current DID"),tj(i&&null!=i,"Invalid storepass"),this.checkIsCustomized(),tj(this.proofs.has(t.getTo()),"Document not signed by: "+t.getTo()),this.checkAttachedStore();let n="string"==typeof e?this.canonicalId(e):e;if(null==n&&null==this.getDefaultPublicKeyId())throw new j("no effective controller of "+this.getSubject().toString());let o=this.getSubject(),s=yield o.resolve(!0);if(null==s)throw new G(o.toString()+" isn't found in the chain");if(yield s.isDeactivated())throw new O(o.toString()+" is deactivated");if(null==n){if(null==(n=this.getDefaultPublicKeyId()))throw new q("No sign key.")}else if(null==this.getAuthenticationKey(n))throw new q(n.toString()+" is a invalid key");yield o2.getInstance().transferDid(this,t,n,i,r)})}publish(t,e=null,i=!1,r=null){return E(this,void 0,void 0,function*(){tj(t&&null!=t,"Invalid storepass"),this.checkAttachedStore();let n="string"==typeof e?this.canonicalId(e):e;if(null==n&&null==this.getDefaultPublicKeyId())throw new j("No effective controller of "+this.getSubject().toString());if(ee.log.info("Publishing DID {}, force={}...",this.getSubject(),i),!this.isGenuine())throw ee.log.error("Publish failed because document is not genuine."),new tr(this.getSubject().toString()+" isn't genuine");if(yield this.isDeactivated())throw ee.log.error("Publish failed because DID is deactivated."),new O(this.getSubject().toString()+" is deactivated");if(this.isExpired()&&!i)throw ee.log.error("Publish failed because document is expired."),ee.log.info("You can publish the expired document using force mode."),new tn(this.getSubject().toString()+" is expired");let o=null,s=null,a=yield this.getSubject().resolve(!0);if(null!=a){if(yield a.isDeactivated())throw this.getMetadata().setDeactivated(!0),ee.log.error("Publish failed because DID is deactivated."),new O(this.getSubject().toString()+" is deactivated");if(this.isCustomizedDid()){let t=null==this.getMultiSignature()?ee.MultiSignature.ONE_OF_ONE:this.getMultiSignature(),e=null==a.getMultiSignature()?ee.MultiSignature.ONE_OF_ONE:a.getMultiSignature();if(!t.equals(e))throw new tS("Multisig is changed");let i=a.getControllers(),r=this.getControllers();if(i.length!=r.length)throw new tS("Controllrs count is changed");i.sort(),r.sort();for(let t=0;t<i.length;t++)if(!i[t].equals(r[t]))throw new tS("Controllers are changed")}if(s=a.getProof().getSignature(),!i){let t=this.getMetadata().getPreviousSignature(),e=this.getMetadata().getSignature();if(null==t&&null==e)throw ee.log.error("Trying to publish over an existing document, but signatures information is missing. DID SDK doesn't know how to handle it, use force mode to ignore checks."),new to(this.getSubject().toString()+" signatures information is missing");if(null==t||null==e){if((null!=t?t:e)!==s)throw ee.log.error("Current copy not based on the latest on-chain copy, signature mismatch."),new to(this.getSubject().toString()+" signature mismatch")}else if(e!==s&&t!==s)throw ee.log.error("Current copy not based on the latest on-chain copy, signature mismatch."),new to(this.getSubject().toString()+" signature mismatch")}o=a.getMetadata().getTransactionId()}if(null==n)n=this.getDefaultPublicKeyId();else if(null==this.getAuthenticationKey(n))throw new q(n.toString()+" is a invalid key");o&&null!=o?(ee.log.info("Try to publish[update] {}...",this.getSubject()),yield o2.getInstance().updateDid(this,o,n,t,r)):(ee.log.info("Try to publish[create] {}...",this.getSubject()),yield o2.getInstance().createDid(this,n,t,r)),null!=s&&this.getMetadata().setPreviousSignature(s),this.getMetadata().setSignature(this.getProof().getSignature())})}publishUntrusted(t,e,i=null){return E(this,void 0,void 0,function*(){if(tj(null!=e&&""!=e,"Invalid storepass"),this.checkIsPrimitive(),this.checkAttachedStore(),null==t&&null==this.getDefaultPublicKeyId())throw new j("No effective controller of "+this.getSubject().toString());if(ee.log.info("Publishing untrusted DID {}...",this.getSubject()),!this.isGenuine())throw ee.log.error("Publish failed because document is not genuine."),new tr(this.getSubject().toString()+" isn't genuine");if(yield this.isDeactivated())throw ee.log.error("Publish failed because DID is deactivated."),new O(this.getSubject().toString()+" is deactivated");if(this.isExpired())throw ee.log.error("Publish failed because document is expired."),new tn(this.getSubject().toString()+" is expired");let r=null,n=null,o=yield o2.getInstance().resolveUntrustedDid(this.getSubject(),!0);if(null!=o){if(yield o.isDeactivated())throw this.getMetadata().setDeactivated(!0),ee.log.error("Publish failed because DID is deactivated."),new O(this.getSubject().toString()+" is deactivated");n=o.getProof().getSignature(),r=o.getMetadata().getTransactionId()}if(null==t)t=this.getDefaultPublicKeyId();else if(null==this.getAuthenticationKey(t))throw new q(t.toString()+" is a invalid key");r&&null!=r?(ee.log.info("Try to publish[update] {}...",this.getSubject()),yield o2.getInstance().updateDid(this,r,t,e,i)):(ee.log.info("Try to publish[create] {}...",this.getSubject()),yield o2.getInstance().createDid(this,t,e,i)),null!=n&&this.getMetadata().setPreviousSignature(n),this.getMetadata().setSignature(this.getProof().getSignature())})}deactivate(t=null,e,i=null){return E(this,void 0,void 0,function*(){if(tj(e&&null!=e,"Invalid storepass"),this.checkAttachedStore(),null==t&&null==this.getDefaultPublicKeyId())throw new j("No effective controller of "+this.getSubject().toString());let r=yield this.getSubject().resolve(!0);if(null==r)throw new G(this.getSubject().toString()+" isn't found in the chain");if(yield r.isDeactivated())throw new O(this.getSubject().toString()+" is deactivated");if(r.getMetadata().attachStore(this.getStore()),r.effectiveController=this.effectiveController,null==t)t=r.getDefaultPublicKeyId();else if(r.isCustomizedDid()){let e=this.getControllerDocument(t.getDid());if(null==e||!t.equals(e.getDefaultPublicKeyId()))throw new q(t.toString()+" is a invalid key")}else if(!t.equals(r.getDefaultPublicKeyId())&&null==r.getAuthorizationKey(t))throw new q(t.toString()+" is a invalid key");yield o2.getInstance().deactivateDid(r,t,e,i)})}deactivateTargetDID(t,e=null,i,r=null){return E(this,void 0,void 0,function*(){if(tj(null!=t,"Invalid target DID"),tj(i&&null!=i,"Invalid storepass"),this.checkAttachedStore(),null==e&&null==this.getDefaultPublicKeyId())throw new j("No effective controller of "+this.getSubject().toString());let n=yield t.resolve(!0);if(null==n)throw new G(t.toString()+" isn't found in the chain");if(yield n.isDeactivated())throw new O(t.toString()+" is deactivated");if(n.getMetadata().attachStore(this.getStore()),n.isCustomizedDid()){if(!n.hasController(this.getSubject()))throw new K(this.getSubject().toString()+" isn't the controller of "+n.getSubject().toString());if(null==e)e=this.getDefaultPublicKeyId();else if(!e.equals(this.getDefaultPublicKeyId()))throw new q(e.toString()+" isn't the default key");yield o2.getInstance().deactivateDid(n,e,i,r)}else{if(0==n.getAuthorizationKeyCount())throw new q("No authorization key from: "+t);let o=null;if(null==e)o=this.getAuthenticationKeys();else{let t=this.getAuthenticationKey(e);if(null==t)throw new q(e.toString()+" isn't an authentication key");(o=[]).push(t)}let s=null,a=null;t:for(let t of o)for(let e of n.getAuthorizationKeys())if(e.getController().equals(this.getSubject())&&e.getPublicKeyBase58()===t.getPublicKeyBase58()){s=t.getId(),a=e.getId();break t}if(null==s||null==a)throw new q("No matched authorization key.");yield o2.getInstance().deactivateTargetDid(n,a,this,s,i,r)}})}static parseAsync(t){return E(this,void 0,void 0,function*(){try{return yield tP.deserializeAsync(t,ee)}catch(t){throw t instanceof C?t:new C(t)}})}static _parseOnly(t){tj(t&&""!==t,"Invalid JSON content");try{let e;e="string"==typeof t?JSON.parse(t):t;let i=new ee;return i.fromJSONOnly(e),i}catch(t){throw t instanceof C?t:new C(t)}}}ee.log=new b("DIDDocument"),ee.W3C_DID_CONTEXT="https://www.w3.org/ns/did/v1",ee.ELASTOS_DID_CONTEXT="https://ns.elastos.org/did/v1",ee.W3ID_SECURITY_CONTEXT="https://w3id.org/security/v1",function(t){class e extends tP{constructor(t=null,e=null,i=null,r=tQ.DEFAULT_PUBLICKEY_TYPE){super(),this.id=t,this.type=null!=r?r:tQ.DEFAULT_PUBLICKEY_TYPE,this.controller=e,this.publicKeyBase58=i}getId(){return this.id}getType(){return this.type}getController(){return this.controller}getPublicKeyBase58(){return this.publicKeyBase58}getPublicKeyBytes(){return oT.decode(this.publicKeyBase58)}equals(t){return this==t||this.getId().equals(t.getId())&&this.getType()===t.getType()&&this.getController().equals(t.getController())&&this.getPublicKeyBase58()===t.getPublicKeyBase58()}compareTo(t){let e=this.id.compareTo(t.id);return 0!=e?e:0!=(e=this.publicKeyBase58.localeCompare(t.publicKeyBase58))?e:0!=(e=this.type.localeCompare(t.type))?e:this.controller.compareTo(t.controller)}toJSON(t=null){let e=t?new tz(t):null,i={};return i.id=this.id.toString(e),e&&this.type===tQ.DEFAULT_PUBLICKEY_TYPE||(i.type=this.type),e&&this.controller.equals(e)||(i.controller=this.controller.toString()),i.publicKeyBase58=this.publicKeyBase58,i}fromJSON(t,e=null){this.id=this.getDidUrl("publicKey.id",t.id,{mandatory:!0,nullable:!1,context:e}),this.type=this.getString("publicKey.type",t.type,{mandatory:!1,defaultValue:tQ.DEFAULT_PUBLICKEY_TYPE}),this.controller=this.getDid("publicKey.controller",t.controller,{mandatory:!1,nullable:!1,defaultValue:e}),this.publicKeyBase58=this.getString("publicKey.publicKeyBase58",t.publicKeyBase58,{mandatory:!0,nullable:!1})}}t.PublicKey=e,t.Service=class extends tP{constructor(t=null,e=null,i=null,r){super(),this.id=t,this.type=e,this.serviceEndpoint=i,this.properties=r?tR(r):{},Object.keys(this.properties).length>0&&(delete this.properties.id,delete this.properties.type,delete this.properties.serviceEndpoint)}getId(){return this.id}getType(){return this.type}getServiceEndpoint(){return this.serviceEndpoint}getProperties(){return Object.keys(this.properties).length>0?this.properties:null}equals(t){return this==t||this.getId().equals(t.getId())&&this.getType()===t.getType()&&this.getServiceEndpoint()===t.getServiceEndpoint()}compareTo(t){let e=this.id.compareTo(t.id);return 0!=e?e:0!=(e=this.type.localeCompare(t.type))?e:this.serviceEndpoint.localeCompare(t.serviceEndpoint)}toJSON(t=null){let e=t?new tz(t):null,i={};return i.id=this.id.toString(e),i.type=this.type,i.serviceEndpoint=this.serviceEndpoint,Object.assign(Object.assign({},i),this.properties)}fromJSON(t,e=null){this.id=this.getDidUrl("service.id",t.id,{mandatory:!0,nullable:!1,context:e}),this.type=this.getString("service.type",t.type,{mandatory:!0,nullable:!1}),this.serviceEndpoint=this.getString("service.serviceEndpoint",t.serviceEndpoint,{mandatory:!0,nullable:!1}),Object.keys(t).length>3&&(this.properties=tR(t),delete this.properties.id,delete this.properties.type,delete this.properties.serviceEndpoint)}};class i extends tP{constructor(t=null,e=null,i=new Date,r=tQ.DEFAULT_PUBLICKEY_TYPE){super(),this.type=r||tQ.DEFAULT_PUBLICKEY_TYPE,this.created=void 0===i?new Date:null!==i?new Date(i):null,this.created&&this.created.setMilliseconds(0),this.creator=t,this.signature=e}equals(t){return 0==this.compareTo(t)}getType(){return this.type}getCreated(){return this.created}getCreator(){return this.creator}getSignature(){return this.signature}compareTo(t){let e=this.created.getTime()-t.created.getTime();return 0==e&&(e=this.creator.compareTo(t.creator)),e}toJSON(t=null){let e=t?new tz(t):null,i={};return e&&this.type===tQ.DEFAULT_PUBLICKEY_TYPE||(i.type=this.type),this.created&&(i.created=this.dateToString(this.created)),i.creator=this.creator.toString(e),i.signatureValue=this.signature,i}fromJSON(t,e=null){this.type=this.getString("proof.type",t.type,{mandatory:!1,defaultValue:tQ.DEFAULT_PUBLICKEY_TYPE}),this.created=this.getDate("proof.created",t.created,{mandatory:!1}),this.creator=this.getDidUrl("proof.creator",t.creator,{mandatory:!0,nullable:!1,context:e}),this.signature=this.getString("proof.signatureValue",t.signatureValue,{mandatory:!0,nullable:!1})}}t.Proof=i;class r{constructor(t,e){this.apply(t,e)}static fromString(t){if(!t||null==t)throw new _("Invalid multisig spec");let e=t.split(":");if(null==e||2!=e.length)throw new _("Invalid multisig spec");return new r(Number.parseInt(e[0]),Number.parseInt(e[1]))}static newFromMultiSignature(t){return new r(t.m(),t.n())}apply(t,e){tj(e>0,"Invalid multisig spec: n should > 0"),tj(t>0&&t<=e,"Invalid multisig spec: m should > 0 and <= n"),this.mv=t,this.nv=e}m(){return this.mv}n(){return this.nv}equals(t){return this==t||this.mv==t.mv&&this.nv==t.nv}toString(){return this.mv.toString()+":"+this.nv.toString()}}r.ONE_OF_ONE=new r(1,1),t.MultiSignature=r;class n{constructor(){}static newFromDID(e,i,r){let o=new n;if(o.document=new t(e),tq.isEnabledJsonLdContext()&&o.addDefaultContexts(),o.sourceDocument=o.document,void 0!==r)o.document.controllers=[],o.document.controllerDocs=new t2,o.document.controllers.push(r.getSubject()),o.document.controllerDocs.set(r.getSubject(),r),o.document.effectiveController=r.getSubject(),o.document.setMetadata(new tN(e,i)),o.controllerDoc=r;else{let t=new tN(e,i);o.document.setMetadata(t)}return o}static newFromDocument(t,e){let i=new n;return i.sourceDocument=t,i.document=t.copy(),void 0!==e&&(i.document.effectiveController=e.getSubject(),i.controllerDoc=e),i}edit(t){if(void 0!==t){if(this.document.checkIsCustomized(),!this.document.getMetadata().attachedStore()&&!t.getMetadata().attachedStore())throw new L("Not attach with did store");if(t.getMetadata().attachedStore()?this.document.getMetadata().attachStore(t.getMetadata().getStore()):t.getMetadata().attachStore(this.document.getMetadata().getStore()),!this.sourceDocument.hasController(t.getSubject()))throw new K(t.getSubject().toString()+" isn't the controller of "+this.sourceDocument.getSubject().toString());return this.document.effectiveController=t.getSubject(),this.controllerDoc=t,this}if(this.document.isCustomizedDid()){if(null==this.sourceDocument.getEffectiveController())throw new j("Unable to edit a customized DIDDocument without effective controller");return this.edit(this.sourceDocument.getEffectiveControllerDocument())}return this.document.checkAttachedStore(),this}canonicalId(t){return"string"==typeof t?tV.from(t,this.getSubject()):null==t||null!=t.getDid()?t:tV.from(t,this.getSubject())}invalidateProof(){null!=this.document.proofs&&0!=this.document.proofs.size&&this.document.proofs.clear()}checkNotSealed(){if(null==this.document)throw new Q(this.getSubject().toString()+" is already sealed")}checkIsCustomized(){if(!this.document.isCustomizedDid())throw new F(this.document.getSubject().toString()+"isn't a customized did")}addDefaultContexts(){return tq.isEnabledJsonLdContext()?(null==this.document.context&&(this.document.context=[]),this.document.context.includes(t.W3C_DID_CONTEXT)||this.document.context.push(t.W3C_DID_CONTEXT),this.document.context.includes(t.ELASTOS_DID_CONTEXT)||this.document.context.push(t.ELASTOS_DID_CONTEXT),this.document.context.includes(t.W3ID_SECURITY_CONTEXT)||this.document.context.push(t.W3ID_SECURITY_CONTEXT)):et.warn("JSON-LD context support not enabled"),this}addContext(t){return tq.isEnabledJsonLdContext()?(null==this.document.context&&(this.document.context=[]),this.document.context.includes(t)||this.document.context.push(t)):et.warn("JSON-LD context support not enabled"),this}getSubject(){return this.checkNotSealed(),this.document.getSubject()}addController(t){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid controller"),"string"==typeof t&&(t=tz.from(t)),this.checkNotSealed(),this.checkIsCustomized(),tj(!this.document.controllers.includes(t),"Controller already exists");let e=yield t.resolve(!0);if(null==e)throw new G(t.toString()+" isn't found in the chain");if(yield e.isDeactivated())throw new O(t.toString()+" is deactivated");if(e.isExpired())throw new tn(t.toString()+" is expired");if(!e.isGenuine())throw new tr(t.toString()+" isn't genuine");if(e.isCustomizedDid())throw new M(t.toString()+"is a customized did");return this.document.controllers.push(t),this.document.controllerDocs.set(t,e),this.document.multisig=null,this.invalidateProof(),this})}removeController(t){if(tj(null!=t,"Invalid controller"),"string"==typeof t&&(t=tz.from(t)),this.checkNotSealed(),this.checkIsCustomized(),t.equals(this.controllerDoc.getSubject()))throw new tu(t.toString());let e=this.document.controllers.findIndex(e=>e.equals(t));return -1!=e&&(this.document.controllers.splice(e,1),this.document.controllerDocs.delete(t),this.document.multisig=null,this.invalidateProof()),this}setMultiSignature(t){this.checkNotSealed(),this.checkIsCustomized(),tj(t>=1,"Invalid signature count");let e=this.document.controllers.length;tj(t<=e,"Signature count exceeds the upper limit");let i=null;return e>1&&(i=new r(t,e)),null==this.document.multisig&&null==i||null!=this.document.multisig&&null!=i&&this.document.multisig.equals(i)||(this.document.multisig=new r(t,e),this.invalidateProof()),this}addPublicKey(t){if(null==this.document.publicKeys)this.document.publicKeys=new t2,this.document.authenticationKeys=new t2,this.document.authorizationKeys=new t2;else for(let e of this.document.publicKeys.values()){if(e.getId().equals(t.getId()))throw new ts("PublicKey id '"+t.getId()+"' already exist.");if(e.getPublicKeyBase58()===t.getPublicKeyBase58())throw new ts("PublicKey '"+t.getPublicKeyBase58()+"' already exist.")}this.document.publicKeys.set(t.getId(),t),null==this.document.defaultPublicKey&&oA.toAddress(t.getPublicKeyBytes())===this.getSubject().getMethodSpecificId()&&(this.document.defaultPublicKey=t,this.document.authenticationKeys.set(t.getId(),t)),this.invalidateProof()}createAndAddPublicKey(t,i,r,n="ECDSAsecp256r1"){return this.checkNotSealed(),"string"==typeof t&&(t=this.canonicalId(t)),void 0===r?r=null:"string"==typeof r&&(r=tz.from(r)),tj(null!=t&&(null==t.getDid()||t.getDid().equals(this.getSubject())),"Invalid publicKey id"),tj(i&&null!=i,"Invalid publicKey"),null==r&&(r=this.getSubject()),this.addPublicKey(new e(this.canonicalId(t),r,i,n)),this}removePublicKey(t,e=!1){return E(this,void 0,void 0,function*(){if(this.checkNotSealed(),tj(null!=t,"Invalid publicKey id"),null==this.document.publicKeys||0==this.document.publicKeys.size)throw new tl(this.getSubject().toString()+" has no any publickey");t=this.canonicalId(t);let i=this.document.publicKeys.get(t);if(null==i)throw new tl("No key "+t.toString());if(null!=this.document.defaultPublicKey&&this.document.defaultPublicKey.getId().equals(t))throw new tc(t.toString()+"is default key");if(!e&&(this.document.authenticationKeys.has(i.getId())||this.document.authorizationKeys.has(i.getId())))throw new tc(t.toString());if(this.document.publicKeys.delete(t)){this.document.authenticationKeys.delete(t),this.document.authorizationKeys.delete(t);try{this.document.getMetadata().attachedStore()&&(yield this.document.getMetadata().getStore().deletePrivateKey(t))}catch(t){n.log.error("INTERNAL - Remove private key",t)}this.invalidateProof()}return this})}addExistingAuthenticationKey(t){if(tj(null!=t,"Invalid publicKey id"),null==this.document.publicKeys||0==this.document.publicKeys.size)throw new tl(this.getSubject().toString()+" has no any publickey");t=this.canonicalId(t);let e=this.document.publicKeys.get(t);if(null==e)throw new tl("No key "+t.toString());if(!e.getController().equals(this.getSubject()))throw new ta(t.toString()+" isn't the self key, so it can't to be authentaication key");return this.document.authenticationKeys.has(t)||(this.document.authenticationKeys.set(t,e),this.invalidateProof()),this}addAuthenticationKey(t,i){this.checkNotSealed(),tj(null!=t,"Invalid publicKey id"),"string"==typeof t&&(t=this.canonicalId(t)),tj(null!=t&&(null==t.getDid()||t.getDid().equals(this.getSubject())),"Invalid publicKey id"),tj(i&&null!=i,"Invalid publicKey");let r=new e(this.canonicalId(t),this.getSubject(),i);return this.addPublicKey(r),this.document.authenticationKeys.set(t,r),this}removeAuthenticationKey(t){if(this.checkNotSealed(),tj(null!=t,"Invalid publicKey id"),null==this.document.publicKeys||0==this.document.publicKeys.size)throw new tl(this.getSubject().toString()+" has no any publickey");t=this.canonicalId(t);let e=this.document.publicKeys.get(t);if(null==e||!this.document.authenticationKeys.has(e.getId()))throw new tl("No key "+t.toString());if(null!=this.document.defaultPublicKey&&this.document.defaultPublicKey.getId().equals(t))throw new tc("Cannot remove the default PublicKey from authentication.");if(!this.document.authenticationKeys.has(t))throw new tl("No key "+t.toString());return this.document.authenticationKeys.delete(t),this.invalidateProof(),this}addExistingAuthorizationKey(t){if(this.checkNotSealed(),tj(null!=t,"Invalid publicKey id"),this.document.isCustomizedDid())throw new M(this.getSubject().toString()+"is a customized did");if(null==this.document.publicKeys||0==this.document.publicKeys.size)throw new tl(this.getSubject().toString()+" has no any publickey");t=this.canonicalId(t);let e=this.document.publicKeys.get(t);if(null==e)throw new tl("No key "+t.toString());if(e.getController().equals(this.getSubject()))throw new ta("Self key can't be authorization key");return this.document.authorizationKeys.has(t)||(this.document.authorizationKeys.set(t,e),this.invalidateProof()),this}addAuthorizationKey(t,i,r){if(this.checkNotSealed(),tj(null!=t,"Invalid publicKey id"),"string"==typeof t&&(t=this.canonicalId(t)),"string"==typeof i&&(i=tz.from(i)),tj(null==t.getDid()||t.getDid().equals(this.getSubject()),"Invalid publicKey id"),tj(r&&null!=r,"Invalid publicKey"),this.document.isCustomizedDid())throw new M(this.getSubject().toString()+"is a customized did");if(i.equals(this.getSubject()))throw new ta("Key's controller is self.");let n=new e(this.canonicalId(t),i,r);return this.addPublicKey(n),this.document.authorizationKeys.set(t,n),this}authorizeDid(t,i,r){return E(this,void 0,void 0,function*(){if(this.checkNotSealed(),tj(null!=t&&(null==t.getDid()||t.getDid().equals(this.getSubject())),"Invalid publicKey id"),tj(null!=i&&!i.equals(this.getSubject()),"Invalid controller"),this.document.isCustomizedDid())throw new M(this.getSubject().toString()+"is a customized did");let n=yield i.resolve();if(null==n)throw new G(t.toString()+" isn't found in the chain");if(yield n.isDeactivated())throw new O(i.toString()+" is deactivated");if(n.isExpired())throw new tn(i.toString()+" is expired");if(!n.isGenuine())throw new tr(i.toString()+" isn't genuine");if(n.isCustomizedDid())throw new M(i.toString()+"is a customized did");null==r&&(r=n.getDefaultPublicKeyId());let o=n.getAuthenticationKey(r);if(null==o)throw new tl("No authentication key "+r.toString());let s=new e(this.canonicalId(t),i,o.getPublicKeyBase58(),o.getType());return this.addPublicKey(s),this.document.authorizationKeys.set(t,s),this})}removeAuthorizationKey(t){this.checkNotSealed(),tj(null!=t,"Invalid publicKey id");let e="string"==typeof t?this.canonicalId(t):t;if(null==this.document.publicKeys||0==this.document.publicKeys.size)throw new tl(this.getSubject().toString()+" has no any publickey");if(e=this.canonicalId(e),null==this.document.publicKeys.get(e))throw new tl("No key "+e.toString());if(!this.document.authorizationKeys.has(e))throw new tl("No authorization key "+e.toString());return this.document.authorizationKeys.delete(e),this.invalidateProof(),this}addCredential(t){return E(this,void 0,void 0,function*(){if(this.checkNotSealed(),tj(null!=t,"Invalid credential"),!t.getSubject().getId().equals(this.getSubject()))throw new ta("Credential "+t.getSubject().getId().toString()+" doesn't belong to DID"+this.getSubject().toString());if(!(t.isSelfProclaimed()?t.isGenuineInternal(this.document):yield t.isGenuine()))throw new z(t.getId().toString());return this.addCredentialUncheck(t)})}addCredentialUncheck(t){if(null==this.document.credentials)this.document.credentials=new t2;else if(this.document.credentials.has(t.getId()))throw new ts("Credential "+t.getId().toString()+"already exists in the document");return this.document.credentials.set(t.getId(),t),this.invalidateProof(),this}createAndAddCredential(t,e,i=null,r=[],n=null){return E(this,void 0,void 0,function*(){this.checkNotSealed(),tj(null!=e,"Invalid publicKey id"),"string"==typeof e&&(e=this.canonicalId(e)),tj(null!=e,"Invalid publicKey id"),tj(null==e.getDid()||e.getDid().equals(this.getSubject()),"Invalid publicKey id"),tj(t&&null!=t,"Invalid storepass");let o=(yield eD.create(this.document)).issueFor(this.document.getSubject());null==n&&(n=this.document.getExpires());try{let s=yield o.id(this.canonicalId(e)).types(...r).properties(i).expirationDate(n).seal(t);return this.addCredentialUncheck(s)}catch(t){throw new k(t)}})}removeCredential(t){if(this.checkNotSealed(),tj(null!=t,"Invalid credential id"),null==this.document.credentials||0==this.document.credentials.size)throw new tl(this.getSubject().toString()+" has no any credential");if(!this.document.credentials.delete(this.canonicalId(t)))throw new tl("No credential "+t.toString());return this.invalidateProof(),this}addService(e,i,r,n){this.checkNotSealed(),tj(null!=e,"Invalid publicKey id"),"string"==typeof e&&(e=this.canonicalId(e)),tj(null!=e&&(null==e.getDid()||e.getDid().equals(this.getSubject())),"Invalid publicKey id"),tj(i&&null!=i,"Invalid type"),tj(r&&null!=r,"Invalid endpoint");let o=new t.Service(this.canonicalId(e),i,r,n);if(null==this.document.services)this.document.services=new t2;else if(this.document.services.has(o.getId()))throw new ts("Service '"+o.getId()+"' already exist.");return this.document.services.set(o.getId(),o),this.invalidateProof(),this}removeService(t){if(this.checkNotSealed(),tj(null!=t,"Invalid credential id"),"string"==typeof t&&(t=this.canonicalId(t)),null==this.document.services||0==this.document.services.size)throw new tl(t.toString()+" has no any service");if(!this.document.services.delete(this.canonicalId(t)))throw new tl("No service "+t.toString());return this.invalidateProof(),this}getMaxExpires(){return f().add(tQ.MAX_VALID_YEARS,"years").toDate()}setDefaultExpires(){return this.checkNotSealed(),this.document.expires=this.getMaxExpires(),this.document.expires&&this.document.expires.setMilliseconds(0),this.invalidateProof(),this}setExpires(t){if(this.checkNotSealed(),tj(null!=t,"Invalid expires"),t.setMilliseconds(0),f(t).isAfter(this.getMaxExpires()))throw new _("Invalid expires, out of range.");return this.document.expires=t,this.invalidateProof(),this}removeProof(t){if(this.checkNotSealed(),tj(null!=t,"Invalid controller"),null==this.document.proofs||0==this.document.proofs.size)return this;if(null==this.document.proofs.delete(t))throw new tl("No proof signed by: "+t);return this}sanitize(){if(this.document.isCustomizedDid()){if(null==this.document.controllers||0==this.document.controllers.length)throw new C("Missing controllers");if(this.document.controllers.length>1){if(null==this.document.multisig)throw new C("Missing multisig");if(this.document.multisig.n()!=this.document.controllers.length)throw new C("Invalid multisig, not matched with controllers")}else if(null!=this.document.multisig)throw new C("Invalid multisig")}null!=this.document.context&&0!=this.document.context.length||(this.document.context=[]);let t=null==this.document.multisig?1:this.document.multisig.m();if(null!=this.document.proofs&&this.document.proofs.size==t)throw new Q(this.getSubject().toString()+" is already sealed");null==this.document.controllers||0==this.document.controllers.length?(this.document.controllers=[],this.document.controllerDocs=new t2):t1.sort(this.document.controllers),null!=this.document.publicKeys&&0!=this.document.publicKeys.size||(this.document.publicKeys=new t2,this.document.authenticationKeys=new t2,this.document.authorizationKeys=new t2),null==this.document.credentials&&(this.document.credentials=new t2),null==this.document.services&&(this.document.services=new t2),null!=this.document.proofs&&0!=this.document.proofs.size||null==this.document.getExpires()&&this.setDefaultExpires(),null==this.document.proofs&&(this.document.proofs=new t2)}seal(t){return E(this,void 0,void 0,function*(){this.checkNotSealed(),tj(t&&null!=t,"Invalid storepass"),this.sanitize();let e=this.document.isCustomizedDid()?this.controllerDoc:this.document,r=e.getDefaultPublicKeyId();if(this.document.proofs.has(e.getSubject()))throw new U(e.getSubject().toString()+" already signed");let n=this.document.proofs;this.document.proofs=null;let s=this.document.serialize(!0);this.document.proofs=n;let a=yield this.document.signWithId(r,t,o.Buffer.from(s)),l=new i(r,a);this.document.proofs.set(l.getCreator().getDid(),l);let u=this.document;return this.document=null,u})}}n.log=new b("DIDDocumentBuilder"),t.Builder=n}(ee||(ee={}));let ei=new b("RootIdentity");class er{constructor(){}static newFromMnemonic(t,e){let i=new er;return i.mnemonic=t,null==e&&(e=""),i.rootPrivateKey=oA.newWithMnemonic(t,e),i.preDerivedPublicKey=i.rootPrivateKey.deriveWithPath(oA.PRE_DERIVED_PUBLICKEY_PATH),i.index=0,i}static newFromPrivateKey(t){let e=new er;return e.rootPrivateKey=t,e.preDerivedPublicKey=t.deriveWithPath(oA.PRE_DERIVED_PUBLICKEY_PATH),e.index=0,e}static newFromPreDerivedPublicKey(t,e){let i=new er;return i.preDerivedPublicKey=t,i.index=e,i}static getIdFromMnemonic(t,e){return this.newFromMnemonic(t,e).getId()}static createFromMnemonic(t,e,i,r,n=!1){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid mnemonic"),tj(null!=i,"Invalid DID store"),tj(null!=r&&""!==r,"Invalid storepass");try{tj(oO.checkIsValid(t),"Invalid mnemonic.")}catch(t){throw new _(t)}null==e&&(e="");let o=er.newFromMnemonic(t,e);if((yield i.containsRootIdentity(o.getId()))&&!n)throw new R(o.getId()+" already exist");return o.setMetadata(new er.Metadata(o.getId(),i)),yield i.storeRootIdentity(o,r),o.wipe(),o})}static createFromPrivateKey(t,e,i,r=!1){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid extended private key"),tj(null!=e,"Invalid DID store"),tj(null!=i&&""!==i,"Invalid storepass");let n=oA.deserializeBase58(t),o=er.newFromPrivateKey(n);if((yield e.containsRootIdentity(o.getId()))&&!r)throw new R(o.getId()+" already exist");return o.setMetadata(new er.Metadata(o.getId(),e)),yield e.storeRootIdentity(o,i),o.wipe(),o})}static createFromPreDerivedPublicKey(t,e){let i=null==t?null:oA.deserializeBase58(t);return er.newFromPreDerivedPublicKey(i,e)}wipe(){this.rootPrivateKey.wipe(),this.mnemonic=null,this.rootPrivateKey=null}getStore(){return this.metadata.getStore()}setMetadata(t){this.metadata=t}static getId(t){return tj(null!=t&&t.length>0,"Invalid key bytes"),s.createHash("md5").update(t.toString("hex"),"hex").digest("hex")}getId(){return null==this.id&&(this.id=er.getId(this.preDerivedPublicKey.serializePublicKey())),this.id}getAlias(){return this.metadata.getAlias()}setAlias(t){this.metadata.setAlias(t)}setAsDefault(){return E(this,void 0,void 0,function*(){yield this.getStore().setDefaultRootIdentity(this)})}getDefaultDid(){let t=this.metadata.getDefaultDid();return null==t?this.getDid(0):t}setDefaultDid(t){t instanceof tz?this.metadata.setDefaultDid(t):this.metadata.setDefaultDid(tz.from(t))}setDefaultDidByIndex(t){tj(t>=0,"Invalid index"),this.metadata.setDefaultDid(this.getDid(t))}getMnemonic(){return this.mnemonic}getRootPrivateKey(){return this.rootPrivateKey}getPreDerivedPublicKey(){return this.preDerivedPublicKey}getIndex(){return this.index}setIndex(t){return E(this,void 0,void 0,function*(){this.index=t,yield this.getStore().storeRootIdentity(this)})}incrementIndex(){return E(this,void 0,void 0,function*(){let t=++this.index;return yield this.getStore().storeRootIdentity(this),t})}getDid(t){tj(t>=0,"Invalid index");let e=this.preDerivedPublicKey.deriveWithIndex(0).deriveWithIndex(t);return new tz(tz.METHOD,e.getAddress())}getDidFromIdentifier(t,e=0){let i=this.preDerivedPublicKey.deriveWithPath(this.mapToDerivePath(t,e,!0));return new tz(tz.METHOD,i.getAddress())}static lazyCreateDidPrivateKey(t,e,i){return E(this,void 0,void 0,function*(){let r=yield e.loadDid(t.getDid());if(null==r)throw ei.error("INTERNAL - Missing document for DID: {}",t.getDid()),new T("Missing document for DID: "+t.getDid());let n=r.getMetadata().getRootIdentityId();if(null==n)return null;let o=yield e.derive(n,oA.DERIVE_PATH_PREFIX+r.getMetadata().getIndex(),i),s=r.getPublicKey(t);if(null==s)throw ei.error("INTERNAL - Invalid public key: {}",t),new T("Invalid public key: "+t);if(o.getPublicKeyBase58()!==s.getPublicKeyBase58())throw ei.error("INTERNAL - Invalid DID metadata: {}",t.getDid()),new T("Invalid DID metadata: "+t.getDid());let a=o.serialize();return yield e.storePrivateKey(t,a,i),a})}mapToDerivePath(t,e,i=!1){let r,n=ex.encodeToBuffer(w.from(t,"utf-8")),o=eT.wrap(n);for(r=i?"m/":"";o.hasRemaining();){let t=o.readInt();r=r.concat((2147483647&t).toString()).concat("/")}return r.concat((2147483647&e).toString())}newDid(t,e,i=!1){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid storepass");let r=!1;void 0===e&&(e=this.getIndex(),r=!0),tj(e>=0,"Invalid index");let n=this.getDid(e),o=yield this.getStore().loadDid(n);if(null!=o){if(yield o.isDeactivated())throw new O(n.toString()+" is deactivated");if(!i)throw new P("DID already exists in the store.")}try{if(o=yield n.resolve(),null!=o){if(yield o.isDeactivated())throw new O(n.toString()+" is deactivated");if(!i)throw new P("DID already published.")}}catch(t){if(t instanceof A&&!i)throw t}ei.debug("Creating new DID {} at index {}...",n.toString(),e);let s=yield this.getStore().derive(this.getId(),oA.DERIVE_PATH_PREFIX+e,t);try{let i=tV.from("#primary",n);yield this.getStore().storePrivateKey(i,s.serialize(),t);let a=ee.Builder.newFromDID(n,this.getStore());return a.addAuthenticationKey(i,s.getPublicKeyBase58()),(o=yield a.seal(t)).getMetadata().setRootIdentityId(this.getId()),o.getMetadata().setIndex(e),o.getMetadata().attachStore(this.getStore()),yield this.getStore().storeDid(o),r&&(yield this.incrementIndex()),o}catch(t){throw new k(t)}finally{s.wipe()}})}newDidFromIdentifier(t,e,i=0,r=!1){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid storepass"),tj(null!=e&&""!==e,"Invalid identifier");let n=oA.PRE_DERIVED_PUBLICKEY_PATH+"/"+this.mapToDerivePath(e,i),o=yield this.getStore().derive(this.getId(),n,t),s=new tz(tz.METHOD,o.getAddress()),a=yield this.getStore().loadDid(s);if(null!=a){if(yield a.isDeactivated())throw new O(s.toString()+" is deactivated");if(!r)throw new P("DID already exists in the store.")}try{if(a=yield s.resolve(),null!=a){if(yield a.isDeactivated())throw new O(s.toString()+" is deactivated");if(!r)throw new P("DID already published.")}}catch(t){if(t instanceof A&&!r)throw t}ei.debug("Creating new DID {} with iden {}...",s.toString(),i);try{let r=tV.from("#primary",s);yield this.getStore().storePrivateKey(r,o.serialize(),t);let n=ee.Builder.newFromDID(s,this.getStore());return n.addAuthenticationKey(r,o.getPublicKeyBase58()),(a=yield n.seal(t)).getMetadata().setRootIdentityId(this.getId()),a.getMetadata().setExtra("application",e),a.getMetadata().setExtra("securityCode",i),a.getMetadata().attachStore(this.getStore()),yield this.getStore().storeDid(a),a}catch(t){throw new k(t)}finally{o.wipe()}})}hasMnemonic(){return E(this,void 0,void 0,function*(){return yield this.getStore().containsRootIdentityMnemonic(this.getId())})}exportMnemonic(t){return E(this,void 0,void 0,function*(){return tj(null!=t&&""!==t,"Invalid storepass"),yield this.getStore().exportRootIdentityMnemonic(this.getId(),t)})}synchronizeIndex(t,e=null){return E(this,void 0,void 0,function*(){tj(t>=0,"Invalid index"),null==e&&(e=oR.getInstance());let i=this.getDid(t);ei.info("Synchronize {}/{}...",i.toString(),t);let r=yield i.resolve(!0);if(null==r)return ei.info("Synchronize {}/{}...not exists",i.toString(),t),!1;ei.debug("Synchronize {}/{}..exists, got the on-chain copy.",i.toString(),t);let n=r,o=yield this.getStore().loadDid(i);if(null!=o){if(o.getMetadata().detachStore(),o.getSignature()===r.getSignature()||null!=o.getMetadata().getSignature()&&o.getProof().getSignature()===o.getMetadata().getSignature())n.getMetadata().merge(o.getMetadata());else{if(ei.debug("{} on-chain copy conflict with local copy.",i.toString()),null==(n=e.merge(r,o))||!n.getSubject().equals(i))throw ei.error("Conflict handle merge the DIDDocument error."),new T("deal with local modification error.");ei.debug("Conflict handle return the final copy.")}}let s=n.getMetadata();return s.setPublished(r.getMetadata().getPublished()),s.setSignature(r.getProof().getSignature()),r.getMetadata().isDeactivated()&&s.setDeactivated(!0),s.setRootIdentityId(this.getId()),s.setIndex(t),null!=o&&o.getMetadata().attachStore(this.getStore()),yield this.getStore().storeDid(n),yield this.getStore().storeLazyPrivateKey(n.getDefaultPublicKeyId()),!0})}synchronize(t=null){return E(this,void 0,void 0,function*(){ei.info("Synchronize root identity {}...",this.getId());let e=this.getIndex()-1,i=0,r=0;for(;r<e||i<20;)(yield this.synchronizeIndex(r,t))?(r>e&&(e=r),i=0):r>e&&i++,r++;e>=this.getIndex()&&(yield this.setIndex(e+1))})}}!function(t){class e extends tk{constructor(t=null,e=null){super(e),this.id=t}setId(t){this.id=t}setDefaultDid(t){this.put(e.DEFAULT_DID,t.toString())}getDefaultDid(){return tz.from(this.get(e.DEFAULT_DID))}save(){return E(this,void 0,void 0,function*(){if(this.attachedStore())try{yield this.getStore().storeRootIdentityMetadata(this.id,this)}catch(t){throw t instanceof T&&ei.error("INTERNAL - error store metadata for credential {}",this.id),t}})}static parse(t,i=null){try{return tP.deserialize(t,e,i)}catch(t){throw t instanceof tb?t:new tb(t)}}}e.DEFAULT_DID="defaultDid",t.Metadata=e}(er||(er={}));let en=new b("FileSystemStorage");class eo{constructor(t){this.storeRoot=new oP(t),this.currentDataDir=eo.DATA_DIR}init(){return E(this,void 0,void 0,function*(){this.storeRoot.exists()?this.checkStore():this.initializeStore()})}initializeStore(){try{en.debug("Initializing DID store at {}",this.storeRoot.getAbsolutePath()),this.storeRoot.createDirectory();let t=new tC;this.getFile(!0,this.currentDataDir,eo.METADATA).writeText(t.serialize())}catch(t){throw en.error("Initialize DID store error",t),new ty('Initialize DIDStore "'+this.storeRoot.getAbsolutePath()+'" error.',t)}}checkStore(){if(en.debug("Checking DID store at {}",this.storeRoot.getAbsolutePath()),this.storeRoot.isFile())throw en.error("Path {} not a directory",this.storeRoot.getAbsolutePath()),new ty('Invalid DIDStore "'+this.storeRoot.getAbsolutePath()+'".');this.postOperations();let t=this.getDir(this.currentDataDir);if(!t.exists()){let t=this.storeRoot.list();if(null==t||0==t.length)return void this.initializeStore();throw en.error("Path {} cannot be initialized as DID Store because it's not empty",this.storeRoot.getAbsolutePath()),new ty("Path cannot be initialized as DID Store because it's not empty \""+this.storeRoot.getAbsolutePath()+'".')}if(!t.isDirectory())throw en.error("Path {} is not a DID store, missing data directory",this.storeRoot.getAbsolutePath()),new ty('Invalid DIDStore "'+this.storeRoot.getAbsolutePath()+'".');let e=this.getFile(!1,this.currentDataDir,eo.METADATA);if(!e.exists()||!e.isFile())throw en.error("Path {} not a DID store, missing store metadata",this.storeRoot.getAbsolutePath()),new ty('Invalid DIDStore "'+this.storeRoot.getAbsolutePath()+'".');try{let t=e.readText(),i=tC.parse(t);if(i.getType()!==tC.DID_STORE_TYPE)throw new ty("Unknown DIDStore type");if(i.getVersion()!=tC.DID_STORE_VERSION)throw new ty("Unsupported DIDStore version")}catch(t){throw en.error("Check DID store error, failed load store metadata",t),new ty("Can not check the store metadata",t)}}static toPath(t){return t.toString(t.getDid()).replace(";","+").replace("/","~").replace("?","!")}static toDIDURL(t,e){return e=e.replace("+",";").replace("~","/").replace("!","?"),tV.from(e,t)}static copyFile(t,e){e.writeText(t.readText())}getFile(t,...e){let i=null,r=this.storeRoot.getAbsolutePath();for(let t of e)r+=oP.SEPARATOR+t;return i=new oP(r),t&&i.getParentDirectory().createDirectory(),i}getDir(...t){let e=this.storeRoot.getAbsolutePath()+oP.SEPARATOR+t.join(oP.SEPARATOR);return new oP(e)}getLocation(){return this.storeRoot.toString()}getStoreRoot(){return this.storeRoot}storeMetadata(t){return E(this,void 0,void 0,function*(){try{let e=this.getFile(!0,this.currentDataDir,eo.METADATA);null==t||t.isEmpty()?e.delete():e.writeText(t.serialize())}catch(t){throw new ty("Store DIDStore metadata error",t)}})}loadMetadata(){return E(this,void 0,void 0,function*(){try{let t=this.getFile(!1,this.currentDataDir,eo.METADATA),e=null;return t.exists()&&(e=tC.parse(t.readText())),e}catch(t){throw new ty("Load DIDStore metadata error",t)}})}getRootIdentityFile(t,e,i){return this.getFile(i,this.currentDataDir,eo.ROOT_IDENTITIES_DIR,t,e)}getRootIdentityDir(t){return this.getDir(this.currentDataDir,eo.ROOT_IDENTITIES_DIR,t)}storeRootIdentityMetadata(t,e){return E(this,void 0,void 0,function*(){try{let i=this.getRootIdentityFile(t,eo.METADATA,!0);null==e||e.isEmpty()?i.delete():i.writeText(e.serialize())}catch(e){throw new ty("Store root identity metadata error: "+t,e)}})}loadRootIdentityMetadata(t){return E(this,void 0,void 0,function*(){try{let e=this.getRootIdentityFile(t,eo.METADATA,!1),i=null;return e.exists()&&(i=er.Metadata.parse(e.readText())),i}catch(e){throw new ty("Load root identity metadata error: "+t,e)}})}storeRootIdentity(t,e,i,r,n){return E(this,void 0,void 0,function*(){try{null!=e&&this.getRootIdentityFile(t,eo.ROOT_IDENTITY_MNEMONIC_FILE,!0).writeText(e),null!=i&&this.getRootIdentityFile(t,eo.ROOT_IDENTITY_PRIVATEKEY_FILE,!0).writeText(i),null!=r&&this.getRootIdentityFile(t,eo.ROOT_IDENTITY_PUBLICKEY_FILE,!0).writeText(r),this.getRootIdentityFile(t,eo.ROOT_IDENTITY_INDEX_FILE,!0).writeText(n.toFixed())}catch(e){throw new ty("Store root identity error: "+t,e)}})}loadRootIdentity(t){return E(this,void 0,void 0,function*(){try{let e=this.getRootIdentityFile(t,eo.ROOT_IDENTITY_PUBLICKEY_FILE,!1);if(!e.exists())return null;let i=e.readText();e=this.getRootIdentityFile(t,eo.ROOT_IDENTITY_INDEX_FILE,!1);let r=Number.parseInt(e.readText());return er.createFromPreDerivedPublicKey(i,r)}catch(e){throw new ty("Load public key for identity error: "+t,e)}})}containsRootIdentity(t){return E(this,void 0,void 0,function*(){return this.getRootIdentityDir(t).exists()})}updateRootIdentityIndex(t,e){return E(this,void 0,void 0,function*(){try{this.getRootIdentityFile(t,eo.ROOT_IDENTITY_INDEX_FILE,!1).writeText(""+e)}catch(e){throw new ty("Update index for indentiy error: "+t,e)}})}loadRootIdentityPrivateKey(t){return E(this,void 0,void 0,function*(){try{let e=this.getRootIdentityFile(t,eo.ROOT_IDENTITY_PRIVATEKEY_FILE,!1);return e.exists()?e.readText():null}catch(e){throw new ty("Load private key for identity error: "+t,e)}})}deleteRootIdentity(t){return E(this,void 0,void 0,function*(){let e=this.getRootIdentityDir(t);return!!e.exists()&&(e.delete(),!0)})}listRootIdentities(){return E(this,void 0,void 0,function*(){let t=this.getDir(this.currentDataDir,eo.ROOT_IDENTITIES_DIR);if(!t.exists())return[];let e=t.listFiles().filter(t=>{if(!t.isDirectory())return!1;let e=new oP(t,eo.ROOT_IDENTITY_PRIVATEKEY_FILE);return e.exists()&&e.isFile()});if(null==e||0==e.length)return[];let i=[];for(let t of e){let e=yield this.loadRootIdentity(t.getName());i.push(e)}return i})}containsRootIdenities(){return E(this,void 0,void 0,function*(){let t=this.getDir(this.currentDataDir,eo.ROOT_IDENTITIES_DIR);if(!t.exists())return!1;let e=t.listFiles().filter(t=>t.isDirectory());return null!=e&&e.length>0})}loadRootIdentityMnemonic(t){return E(this,void 0,void 0,function*(){try{return this.getRootIdentityFile(t,eo.ROOT_IDENTITY_MNEMONIC_FILE,!1).readText()}catch(e){throw new ty("Load mnemonic for identity error: "+t,e)}})}getDidFile(t,e){return this.getFile(e,this.currentDataDir,eo.DID_DIR,t.getMethodSpecificId(),eo.DOCUMENT_FILE)}getDidMetadataFile(t,e){return this.getFile(e,this.currentDataDir,eo.DID_DIR,t.getMethodSpecificId(),eo.METADATA)}getDidDir(t){return this.getDir(this.currentDataDir,eo.DID_DIR,t.getMethodSpecificId())}storeDidMetadata(t,e){return E(this,void 0,void 0,function*(){try{let i=this.getDidMetadataFile(t,!0);null==e||e.isEmpty()?i.delete():i.writeText(e.serialize())}catch(e){throw new ty("Store DID metadata error: "+t,e)}})}loadDidMetadata(t){return E(this,void 0,void 0,function*(){try{let e=this.getDidMetadataFile(t,!1),i=null;return e.exists()&&(i=tN.parse(e.readText())),i}catch(e){throw new ty("Load DID metadata error: "+t,e)}})}storeDid(t){return E(this,void 0,void 0,function*(){try{this.getDidFile(t.getSubject(),!0).writeText(t.serialize(!0))}catch(e){throw new ty("Store DID document error: "+t.getSubject(),e)}})}loadDid(t){return E(this,void 0,void 0,function*(){try{let e=this.getDidFile(t,!1);return e.exists()?yield ee.parseAsync(e.readText()):null}catch(e){throw new ty("Load DID document error: "+t,e)}})}deleteDid(t){return E(this,void 0,void 0,function*(){let e=this.getDidDir(t);return!!e.exists()&&(e.delete(),!0)})}listDids(){return E(this,void 0,void 0,function*(){let t=this.getDir(this.currentDataDir,eo.DID_DIR);if(!t.exists())return[];let e=t.listFiles().filter(t=>{if(!t.isDirectory())return!1;let e=new oP(t,eo.DOCUMENT_FILE);return e.exists()&&e.isFile()});if(null==e||0==e.length)return[];let i=[];for(let t of e){let e=new tz(tz.METHOD,t.getName());i.push(e)}return i})}containsDid(t){return E(this,void 0,void 0,function*(){return this.getDidDir(t).exists()})}containsDids(){return E(this,void 0,void 0,function*(){let t=this.getDir(this.currentDataDir,eo.DID_DIR);if(!t.exists())return!1;let e=t.listFiles().filter(t=>t.isDirectory());return null!=e&&e.length>0})}getCredentialFile(t,e){return this.getFile(e,this.currentDataDir,eo.DID_DIR,t.getDid().getMethodSpecificId(),eo.CREDENTIALS_DIR,eo.toPath(t),eo.CREDENTIAL_FILE)}getCredentialMetadataFile(t,e){return this.getFile(e,this.currentDataDir,eo.DID_DIR,t.getDid().getMethodSpecificId(),eo.CREDENTIALS_DIR,eo.toPath(t),eo.METADATA)}getCredentialDir(t){return this.getDir(this.currentDataDir,eo.DID_DIR,t.getDid().getMethodSpecificId(),eo.CREDENTIALS_DIR,eo.toPath(t))}getCredentialsDir(t){return this.getDir(this.currentDataDir,eo.DID_DIR,t.getMethodSpecificId(),eo.CREDENTIALS_DIR)}storeCredentialMetadata(t,e){return E(this,void 0,void 0,function*(){try{let i=this.getCredentialMetadataFile(t,!0);null==e||e.isEmpty()?i.delete():i.writeText(e.serialize())}catch(e){throw new ty("Store credential metadata error: "+t,e)}})}loadCredentialMetadata(t){return E(this,void 0,void 0,function*(){try{let e=this.getCredentialMetadataFile(t,!1);return e.exists()?tZ.parse(e.readText()):null}catch(e){throw new ty("Load credential metadata error: "+t,e)}})}storeCredential(t,e,i){return E(this,void 0,void 0,function*(){try{let r=e;if(i){let t=w.alloc(4);t[0]=14,t[1]=12,t[2]=86,t[3]=67,r=w.concat([t,e])}this.getCredentialFile(t,!0).writeText(r)}catch(e){throw new ty("Store credential error: "+t,e)}})}loadCredential(t){return E(this,void 0,void 0,function*(){try{let e=this.getCredentialFile(t,!1).readText(!1);return e&&14==e[0]&&12==e[1]&&86==e[2]&&67==e[3]?[e.slice(4),!0]:[e,!1]}catch(e){throw new ty("Load credential error: "+t,e)}})}containsCredential(t){return E(this,void 0,void 0,function*(){return this.getCredentialDir(t).exists()})}containsCredentials(t){return E(this,void 0,void 0,function*(){let e=this.getCredentialsDir(t);if(!e.exists())return!1;let i=e.listFiles().filter(t=>t.isDirectory());return null!=i&&i.length>0})}deleteCredential(t){return E(this,void 0,void 0,function*(){let e=this.getCredentialDir(t);return!!e.exists()&&(e.delete(),0==(e=this.getCredentialsDir(t.getDid())).list().length&&e.delete(),!0)})}listCredentials(t){return E(this,void 0,void 0,function*(){let e=this.getCredentialsDir(t);if(!e.exists())return[];let i=e.listFiles().filter(t=>{if(!t.isDirectory())return!1;let e=new oP(t,eo.CREDENTIAL_FILE);return e.exists()&&e.isFile()});if(null==i||0==i.length)return[];let r=[];for(let e of i)r.push(eo.toDIDURL(t,e.getName()));return r})}getPrivateKeyFile(t,e){return this.getFile(e,this.currentDataDir,eo.DID_DIR,t.getDid().getMethodSpecificId(),eo.PRIVATEKEYS_DIR,eo.toPath(t))}getPrivateKeysDir(t){return this.getDir(this.currentDataDir,eo.DID_DIR,t.getMethodSpecificId(),eo.PRIVATEKEYS_DIR)}containsPrivateKey(t){return E(this,void 0,void 0,function*(){return this.getPrivateKeyFile(t,!1).exists()})}storePrivateKey(t,e){return E(this,void 0,void 0,function*(){try{this.getPrivateKeyFile(t,!0).writeText(e)}catch(e){throw new ty("Store private key error: "+t,e)}})}loadPrivateKey(t){return E(this,void 0,void 0,function*(){try{let e=this.getPrivateKeyFile(t,!1);return e.exists()?e.readText():null}catch(e){throw new ty("Load private key error: "+t,e)}})}containsPrivateKeys(t){return E(this,void 0,void 0,function*(){let e=this.getPrivateKeysDir(t);if(!e.exists())return!1;let i=e.listFiles().filter(t=>t.isFile());return null!=i&&i.length>0})}deletePrivateKey(t){return E(this,void 0,void 0,function*(){let e=this.getPrivateKeyFile(t,!1);if(e.exists()){e.delete();let i=this.getPrivateKeysDir(t.getDid());return 0==i.list().length&&i.delete(),!0}return!1})}listPrivateKeys(t){return E(this,void 0,void 0,function*(){let e=this.getPrivateKeysDir(t);if(!e.exists())return[];let i=e.listFiles().filter(t=>t.isFile());if(null==i||0==i.length)return[];let r=[];for(let e of i)r.push(eo.toDIDURL(t,e.getName()));return r})}needReencrypt(t){let e=["(.+)\\"+oP.SEPARATOR+eo.DATA_DIR+"\\"+oP.SEPARATOR+eo.ROOT_IDENTITIES_DIR+"\\"+oP.SEPARATOR+"(.+)\\"+oP.SEPARATOR+eo.ROOT_IDENTITY_PRIVATEKEY_FILE,"(.+)\\"+oP.SEPARATOR+eo.DATA_DIR+"\\"+oP.SEPARATOR+eo.ROOT_IDENTITIES_DIR+"\\"+oP.SEPARATOR+"(.+)\\"+oP.SEPARATOR+eo.ROOT_IDENTITY_MNEMONIC_FILE,"(.+)\\"+oP.SEPARATOR+eo.DATA_DIR+"\\"+oP.SEPARATOR+eo.DID_DIR+"\\"+oP.SEPARATOR+"(.+)\\"+oP.SEPARATOR+eo.PRIVATEKEYS_DIR+"\\"+oP.SEPARATOR+"(.+)"],i=t.getAbsolutePath();for(let t of e)if(i.match(t))return!0;return!1}isCredential(t){let e=["(.+)\\"+oP.SEPARATOR+eo.DATA_DIR+"\\"+oP.SEPARATOR+eo.DID_DIR+"\\"+oP.SEPARATOR+"(.+)\\"+oP.SEPARATOR+eo.CREDENTIALS_DIR+"\\"+oP.SEPARATOR+"(.+)\\"+oP.SEPARATOR+eo.CREDENTIAL_FILE],i=t.getAbsolutePath();for(let t of e)if(i.match(t))return!0;return!1}copy(t,e,i){if(t.isDirectory())for(let r of(e.exists()||e.createDirectory(),t.list())){let n=new oP(t,r),o=new oP(e,r);this.copy(n,o,i)}else if(this.needReencrypt(t)){let r=t.readText();e.writeText(i.reEncrypt(r))}else if(this.isCredential(t)){let r=t.readText(!1);if(14==r[0]&&12==r[1]&&86==r[2]&&67==r[3]){let t=i.reEncrypt(w.from(r.slice(4)).toString()),n=w.from(t,"utf-8"),o=w.alloc(4);o[0]=14,o[1]=12,o[2]=86,o[3]=67,n=w.concat([o,n]),e.writeText(n)}else eo.copyFile(t,e)}else eo.copyFile(t,e)}postChangePassword(){let t=this.getDir(eo.DATA_DIR),e=this.getDir(eo.DATA_DIR+eo.JOURNAL_SUFFIX),i=(new Date).getTime()/1e3,r=this.getDir(eo.DATA_DIR+"_"+i),n=this.getFile(!1,"postChangePassword");n.exists()?(e.exists()&&(t.exists()&&t.rename(r.getAbsolutePath()),e.rename(t.getAbsolutePath())),n.delete()):e.exists()&&e.delete()}changePassword(t){return E(this,void 0,void 0,function*(){try{let e=this.getDir(eo.DATA_DIR),i=this.getDir(eo.DATA_DIR+eo.JOURNAL_SUFFIX);this.copy(e,i,t),this.getFile(!0,"postChangePassword").createFile()}catch(t){if(t instanceof D)throw t;throw new ty("Change store password failed.")}finally{this.postChangePassword()}})}postOperations(){this.getFile(!1,"postChangePassword").exists()&&this.postChangePassword()}}eo.DATA_DIR="data",eo.ROOT_IDENTITIES_DIR="roots",eo.ROOT_IDENTITY_MNEMONIC_FILE="mnemonic",eo.ROOT_IDENTITY_PRIVATEKEY_FILE="private",eo.ROOT_IDENTITY_PUBLICKEY_FILE="public",eo.ROOT_IDENTITY_INDEX_FILE="index",eo.DID_DIR="ids",eo.DOCUMENT_FILE="document",eo.CREDENTIALS_DIR="credentials",eo.CREDENTIAL_FILE="credential",eo.PRIVATEKEYS_DIR="privatekeys",eo.METADATA=".metadata",eo.JOURNAL_SUFFIX=".journal";class es extends tP{constructor(t=null,e=null,i=null){super(),this.id=t,this.to=e,this.txid=i}static newForDIDDocument(t,e){return E(this,void 0,void 0,function*(){if(tj(null!=t,"Invalid target DID document"),tj(null!=e,"Invalid to DID"),!t.isCustomizedDid())throw new F(t.getSubject().toString()+"isn't a customized did");let i=yield t.getSubject().resolve();t.getMetadata().setTransactionId(i.getMetadata().getTransactionId());let r=new es(t.getSubject(),e,t.getMetadata().getTransactionId());return r.doc=t,r})}static newWithTicket(t,e){let i=new es(t.id,t.to,t.txid);return i.doc=t.doc,e&&(i.proofs=t.proofs),i}getSubject(){return this.id}getTo(){return this.to}getTransactionId(){return this.txid}getProof(){return this.getProofs()[0]}getProofs(){return this.proofs.valuesAsSortedArray()}getDocument(){return E(this,void 0,void 0,function*(){return null==this.doc&&(this.doc=yield this.id.resolve()),this.doc})}isGenuine(t=null){return E(this,void 0,void 0,function*(){let e=yield this.getDocument();if(null==e)return null!=t&&(t.failed(this,"Ticket {}: can not resolve the owner document",this.getSubject()),t.failed(this,"Ticket {}: is not genuine",this.getSubject())),!1;if(!e.isGenuine(t))return null!=t&&(t.failed(this,"Ticket {}: the owner document is not genuine",this.getSubject()),t.failed(this,"Ticket {}: is not genuine",this.getSubject())),!1;if(e.getControllerCount()>1&&this.proofs.size!=e.getMultiSignature().m()||1>=e.getControllerCount()&&1!=this.proofs.size)return null!=t&&(t.failed(this,"Ticket {}: proof size not matched with multisig, {} expected, actual is {}",this.getSubject(),e.getMultiSignature().m(),e.proofs.size),t.failed(this,"Ticket {}: is not genuine",this.getSubject())),!1;let i=es.newWithTicket(this,!1).serialize(!0),r=eO.sha256Digest(o.Buffer.from(i,"utf-8"));for(let i of this.proofs.values()){if(i.getType()!==tQ.DEFAULT_PUBLICKEY_TYPE)return null!=t&&(t.failed(this,"Ticket {}: key type '{}' for proof is not supported",this.getSubject(),i.getType()),t.failed(this,"Ticket {}: is not genuine",this.getSubject())),!1;let n=e.getControllerDocument(i.getVerificationMethod().getDid());if(null==n)return null!=t&&(t.failed(this,"Ticket {}: can not resolve the document for controller '{}' to verify the proof",this.getSubject(),i.getVerificationMethod().getDid()),t.failed(this,"Ticket {}: is not genuine",this.getSubject())),!1;if(!(yield n.isValid(t)))return null!=t&&(t.failed(this,"Ticket {}: controller '{}' is invalid, failed to verify the proof",this.getSubject(),i.getVerificationMethod().getDid()),t.failed(this,"Ticket {}: is not genuine",this.getSubject())),!1;if(!i.getVerificationMethod().equals(n.getDefaultPublicKeyId()))return null!=t&&(t.failed(this,"Ticket {}: key '{}' for proof is not default key of '{}'",this.getSubject(),i.getVerificationMethod(),i.getVerificationMethod().getDid()),t.failed(this,"Ticket {}: is not genuine",this.getSubject())),!1;if(!e.verifyDigest(i.getVerificationMethod(),i.getSignature(),r))return null!=t&&(t.failed(this,"Ticket {}: proof '{}' is invalid, signature mismatch",this.getSubject(),i.getVerificationMethod()),t.failed(this,"Ticket {}: is not genuine",this.getSubject())),!1}return null!=t&&t.succeeded(this,"Ticket {}: is genuine",this.getSubject()),!0})}isValid(t=null){return E(this,void 0,void 0,function*(){let e=yield this.getDocument();return null==e?(null!=t&&(t.failed(this,"Ticket {}: can not resolve the owners document",this.getSubject()),t.failed(this,"Ticket {}: is not valid",this.getSubject())),!1):(yield e.isValid(t))?(yield this.isGenuine(t))?this.txid!==e.getMetadata().getTransactionId()?(null!=t&&(t.failed(this,"Ticket {}: the transaction id already out date",this.getSubject()),t.failed(this,"Ticket {}: is not valid",this.getSubject())),!1):(null!=t&&t.succeeded(this,"Ticket {}: is valid",this.getSubject()),!0):(null!=t&&t.failed(this,"Ticket {}: is not valid",this.getSubject()),!1):(null!=t&&(t.failed(this,"Ticket {}: the owners document is not valid",this.getSubject()),t.failed(this,"Ticket {}: is not valid",this.getSubject())),!1)})}isQualified(){return E(this,void 0,void 0,function*(){if(null==this.proofs||0==this.proofs.size)return!1;let t=(yield this.getDocument()).getMultiSignature();return this.proofs.size==(null==t?1:t.m())})}toJSON(t=null){let e={};if(e.id=this.id.toString(),e.to=this.to.toString(),e.txid=this.txid,this.proofs){let i=this.proofs.valuesAsSortedArray();1==i.length?e.proof=i[0].toJSON(t):e.proof=Array.from(i,e=>e.toJSON(t))}return e}fromJSON(t,e=null){if(this.id=this.getDid("id",t.id,{mandatory:!0,nullable:!1}),this.to=this.getDid("to",t.to,{mandatory:!0,nullable:!1}),this.txid=this.getString("txid",t.txid,{mandatory:!0,nullable:!1}),!t.proof)throw new B("Missing property: proof");if(this.proofs=new t2,Array.isArray(t.proof))for(let e of t.proof){let t=es.Proof.deserialize(e,es.Proof,this.id);if(null==t.getVerificationMethod().getDid())throw new B("Invalid verification method: "+t.getVerificationMethod());if(this.proofs.has(t.getVerificationMethod().getDid()))throw new B("Aleady exist proof from "+t.getVerificationMethod().getDid());this.proofs.set(t.getVerificationMethod().getDid(),t)}else{let e=t.proof,i=es.Proof.deserialize(e,es.Proof,this.id);if(null==i.getVerificationMethod().getDid())throw new B("Invalid verification method: "+i.getVerificationMethod());this.proofs.set(i.getVerificationMethod().getDid(),i)}}seal(t,e){return E(this,void 0,void 0,function*(){try{if(yield this.isQualified())return;if(t.isCustomizedDid()){if(null==t.getEffectiveController())throw new j("No effective controller of "+this.getSubject().toString())}else try{if(!(yield this.getDocument()).hasController(t.getSubject()))throw new K(t.getSubject().toString()+" isn't the controller")}catch(t){throw new k(t)}}catch(t){throw new k(t)}let i=t.getDefaultPublicKeyId();if(null==this.proofs)this.proofs=new t2;else if(this.proofs.has(i.getDid()))throw new U(i.getDid().toString()+" already signed");let r=es.newWithTicket(this,!1).serialize(!0),n=yield t.signWithStorePass(e,o.Buffer.from(r)),s=new es.Proof(i,n);this.proofs.set(s.getVerificationMethod().getDid(),s)})}static parse(t){try{return tP.deserialize(t,es)}catch(t){throw t instanceof B?t:new B(t)}}}(es||(es={})).Proof=class extends tP{constructor(t=null,e=null,i=new Date,r=tQ.DEFAULT_PUBLICKEY_TYPE){super(),this.type=null!=r?r:tQ.DEFAULT_PUBLICKEY_TYPE,this.created=null==i?new Date:i,this.created&&this.created.setMilliseconds(0),this.verificationMethod=t,this.signature=e}getType(){return this.type}getVerificationMethod(){return this.verificationMethod}getCreated(){return this.created}getSignature(){return this.signature}equals(t){return 0===this.compareTo(t)}compareTo(t){let e=this.created.getTime()-t.created.getTime();return 0==e&&(e=this.verificationMethod.compareTo(t.verificationMethod)),e}toJSON(t=null){let e=t?new tz(t):null,i={};return e&&this.type===tQ.DEFAULT_PUBLICKEY_TYPE||(i.type=this.type),this.created&&(i.created=this.dateToString(this.created)),i.verificationMethod=this.verificationMethod.toString(e),i.signature=this.signature,i}fromJSON(t,e=null){this.type=this.getString("proof.type",t.type,{mandatory:!1,defaultValue:tQ.DEFAULT_PUBLICKEY_TYPE}),this.created=this.getDate("proof.created",t.created,{mandatory:!1}),this.verificationMethod=this.getDidUrl("proof.verificationMethod",t.verificationMethod,{mandatory:!0,nullable:!1,context:e}),this.signature=this.getString("proof.signature",t.signature,{mandatory:!0,nullable:!1})}};let ea=new b("VerifiableCredential");class el extends tP{constructor(t){super(),this.holder=t,this.credentials=new t2}static newFromPresentation(t,e){let i=new el;return i.context=t.context,i.id=t.id,i.type=t.type,i.holder=t.holder,i.created=t.created,i.credentials=t.credentials,e&&(i.proof=t.proof),i}getId(){return this.id?this.id:null}getType(){return this.type}getHolder(){return null!=this.holder?this.holder:this.proof.getVerificationMethod().getDid()}getCreated(){return null!=this.proof.getCreated()?this.proof.getCreated():this.created}getCredentialCount(){return this.credentials.size}getCredentials(){return this.credentials.valuesAsSortedArray()}getCredential(t){return tj(null!=t,"Invalid credential id"),("string"==typeof t||null==t.getDid())&&(t=tV.from(t,this.getHolder())),this.credentials.get(t)}getProof(){return this.proof}isGenuine(t=null){return E(this,void 0,void 0,function*(){let e=yield this.getHolder().resolve();if(null==e)return null!=t&&(t.failed(this,"VP {}: can not resolve the holder's document",this.getId()),t.failed(this,"VP {}: is not genuine",this.getId())),!1;if(!e.isGenuine(t))return null!=t&&(t.failed(this,"VP {}: holder's document is not genuine",this.getId()),t.failed(this,"VP {}: is not genuine",this.getId())),!1;if(this.proof.getType()!==tQ.DEFAULT_PUBLICKEY_TYPE)return null!=t&&(t.failed(this,"VP {}: key type '{}' for proof is not supported",this.getId(),this.proof.getType()),t.failed(this,"VP {}: is not genuine",this.getId())),!1;if(!e.isAuthenticationKey(this.proof.getVerificationMethod()))return null!=t&&(t.failed(this,"VP {}: Key '{}' for proof is not an authencation key of '{}'",this.getId(),this.proof.getVerificationMethod(),this.proof.getVerificationMethod().getDid()),t.failed(this,"VP {}: is not genuine",this.getId())),!1;for(let e of this.credentials.values()){if(!e.getSubject().getId().equals(this.getHolder()))return null!=t&&(t.failed(this,"VP {}: credential '{}' not owned by the holder '{}'",this.getId(),e.getId(),this.getHolder()),t.failed(this,"VP {}: is not genuine",this.getId())),!1;if(!(yield e.isGenuine(t)))return null!=t&&(t.failed(this,"VP {}: credential '{}' is not genuine",this.getId(),e.getId()),t.failed(this,"VP {}: is not genuine",this.getId())),!1}let i=el.newFromPresentation(this,!1).serialize(!0),r=e.verify(this.proof.getVerificationMethod(),this.proof.getSignature(),o.Buffer.from(i),o.Buffer.from(this.proof.getRealm()),o.Buffer.from(this.proof.getNonce()));return null!=t&&(r?t.succeeded(this,"VP {}: is genuine",this.getId()):(t.failed(this,"VP {}: proof is invalid, signature mismatch",this.getId()),t.failed(this,"VP {}: is not genuine",this.getId()))),r})}isValid(t=null){return E(this,void 0,void 0,function*(){let e=yield this.getHolder().resolve();if(null==e)return null!=t&&(t.failed(this,"VP {}: can not resolve the holder's document",this.getId()),t.failed(this,"VP {}: is invalid",this.getId())),!1;if(yield e.isDeactivated())return null!=t&&(t.failed(this,"VP {}: holder's document is deactivate",this.getId()),t.failed(this,"VP {}: is invalid",this.getId())),!1;if(!e.isGenuine(t))return null!=t&&(t.failed(this,"VP {}: holder's document is genuine",this.getId()),t.failed(this,"VP {}: is invalid",this.getId())),!1;if(this.proof.getType()!==tQ.DEFAULT_PUBLICKEY_TYPE)return null!=t&&(t.failed(this,"VP {}: Key type '{}' for proof is not supported",this.getId(),this.proof.getType()),t.failed(this,"VP {}: is invalid",this.getId())),!1;if(!e.isAuthenticationKey(this.proof.getVerificationMethod()))return null!=t&&(t.failed(this,"VP {}: Key '{}' for proof is not an authencation key of '{}'",this.getId(),this.proof.getVerificationMethod(),this.proof.getVerificationMethod().getDid()),t.failed(this,"VP {}: is invalid",this.getId())),!1;let i=el.newFromPresentation(this,!1).serialize(!0);if(!e.verify(this.proof.getVerificationMethod(),this.proof.getSignature(),o.Buffer.from(i),o.Buffer.from(this.proof.getRealm()),o.Buffer.from(this.proof.getNonce())))return null!=t&&(t.failed(this,"VP {}: proof is invalid, signature mismatch",this.getId()),t.failed(this,"VP {}: is invalid",this.getId())),!1;for(let e of this.credentials.values()){if(!e.getSubject().getId().equals(this.getHolder()))return null!=t&&(t.failed(this,"VP {}: credential '{}' not owned by the holder '{}'",this.getId(),e.getId(),this.getHolder()),t.failed(this,"VP {}: is not genuine",this.getId())),!1;if(!(yield e.isValid(t)))return null!=t&&(t.failed(this,"VP {}: credential '{}' is invalid",this.getId(),e.getId()),t.failed(this,"VP {}: is invalid",this.getId())),!1}return null!=t&&t.succeeded(this,"VP %s: is valid",this.getId()),!0})}toJSON(t=null){let e={};return null!=this.context&&this.context.length>0&&(e["@context"]=Array.from(this.context)),this.id&&(e.id=this.id.toString()),e.type=1==this.type.length?this.type[0]:this.type,this.holder&&(e.holder=this.holder.toString()),this.created&&(e.created=this.dateToString(this.created)),e.verifiableCredential=Array.from(this.credentials.valuesAsSortedArray(),t=>t.toJSON()),this.proof&&(e.proof=this.proof.toJSON()),e}fromJSON(t,e=null){if(this.context=this.getContext("@context",t["@context"],{mandatory:!1,nullable:!1,defaultValue:[]}),this.holder=this.getDid("holder",t.holder,{mandatory:!1,nullable:!1,defaultValue:null}),this.id=this.getDidUrl("id",t.id,{mandatory:!1,nullable:!1,context:this.holder,defaultValue:null}),this.type=this.getStrings("type",t.type,{mandatory:!0,nullable:!1,defaultValue:[el.DEFAULT_PRESENTATION_TYPE]}),this.created=this.getDate("created",t.created,{mandatory:!1,nullable:!0}),!t.proof)throw new th("Missing property: proof");let i=t.proof;if(this.proof=el.Proof.deserialize(i,el.Proof,this.holder),null==this.created&&null==this.proof.getCreated())throw new th("Missing presentation create timestamp");if(this.credentials=new t2,t.verifiableCredential){if(!Array.isArray(t.verifiableCredential))throw new th("Invalid property: verifiableCredential, type error.");for(let e of t.verifiableCredential){let t;try{t=t0.deserialize(e,t0,this.holder)}catch(t){throw new th("credential invalid: "+e.id,t)}if(this.credentials.has(t.getId()))throw new th("Duplicated credential id: "+t.getId());this.credentials.set(t.getId(),t)}}}static parse(t){try{return tP.deserialize(t,el)}catch(t){throw t instanceof th?t:new th(t)}}static createFor(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid did"),tj(null!=i,"Invalid store"),"string"==typeof t&&(t=tz.from(t)),"string"==typeof e&&(e=tV.from(e,t));let r=yield i.loadDid(t);if(null==r)throw new G(t.toString()+" isn't found in the chain");if(null==e)e=r.getDefaultPublicKeyId();else if(!r.isAuthenticationKey(e))throw new q(e.toString()+" isn't the authencation key");if(!(yield r.hasPrivateKey(e)))throw new q("No private key: "+e);return new el.Builder(r,e)})}}el.DEFAULT_PRESENTATION_TYPE="VerifiablePresentation",function(t){t.Builder=class{constructor(e,i){this.holder=e,this.signKey=i,this.presentation=new t(e.getSubject()),this.setDefaultType()}checkNotSealed(){if(null==this.presentation)throw new Q("Presentation "+this.id.toString()+" is already sealed")}id(t){return this.checkNotSealed(),tj(null!=t,"Invalid id"),"string"==typeof t&&(t=tV.from(t,this.holder.getSubject())),tj(null!=t&&(null==t.getDid()||t.getDid().equals(this.holder.getSubject())),"Invalid id"),this.presentation.id=tV.from(t,this.holder.getSubject()),this}setDefaultType(){this.checkNotSealed(),tq.isEnabledJsonLdContext()&&(null==this.presentation.context&&(this.presentation.context=[]),this.presentation.context.includes(t0.W3C_CREDENTIAL_CONTEXT)||this.presentation.context.push(t0.W3C_CREDENTIAL_CONTEXT),this.presentation.context.includes(t0.ELASTOS_CREDENTIAL_CONTEXT)||this.presentation.context.push(t0.ELASTOS_CREDENTIAL_CONTEXT)),null==this.presentation.type&&(this.presentation.type=[]),this.presentation.type.includes(t.DEFAULT_PRESENTATION_TYPE)||this.presentation.type.push(t.DEFAULT_PRESENTATION_TYPE)}typeWithContext(t,e){return this.checkNotSealed(),tK(t,"Invalid type: "+t),tq.isEnabledJsonLdContext()?(tK(e,"Invalid context: "+e),null==this.presentation.context&&(this.presentation.context=[]),this.presentation.context.includes(e)||this.presentation.context.push(e)):ea.warn("JSON-LD context support not enabled"),null==this.presentation.type&&(this.presentation.type=[]),this.presentation.type.includes(t)||this.presentation.type.push(t),this}type(t){if(this.checkNotSealed(),tK(t,"Invalid type: "+t),0>t.indexOf("#"))return this.typeWithContext(t,null);{let e=t.split("#",2);return this.typeWithContext(e[1],e[0])}}types(t){return this.checkNotSealed(),tj(null!=t&&t.length>0,"Invalid types"),this.presentation.type=Array.from(t),this}credentials(...t){for(let e of(this.checkNotSealed(),t)){if(!e.getSubject().getId().equals(this.holder.getSubject()))throw new ta("Credential "+e.getId().toString()+" doesn't belong to the holder of presentation");if(this.presentation.credentials.has(e.getId()))throw new ts(e.getId().toString()+" already exist in the presentation");this.presentation.credentials.set(e.getId(),e)}return this}realm(t){return this.checkNotSealed(),tj(t&&null!=t,"Invalid realm"),this._realm=t,this}nonce(t){return this.checkNotSealed(),tj(t&&null!=t,"Invalid nonce"),this._nonce=t,this}seal(t){return E(this,void 0,void 0,function*(){if(this.checkNotSealed(),tj(t&&null!=t,"Invalid storepass"),null==this.presentation.type||0==this.presentation.type.length)throw new th("Missing presentation type");t1.sort(this.presentation.type),this.presentation.created=new Date,this.presentation.created&&this.presentation.created.setMilliseconds(0);let i=this.presentation.serialize(!0),r=yield this.holder.signWithId(this.signKey,t,o.Buffer.from(i),o.Buffer.from(this._realm),o.Buffer.from(this._nonce)),n=new e(this.presentation.created,this.signKey,this._realm,this._nonce,r);this.presentation.proof=n;let s=this.presentation;return this.presentation=null,s})}};class e extends tP{constructor(t=null,e=null,i=null,r=null,n=null,o=tQ.DEFAULT_PUBLICKEY_TYPE){super(),this.type=null!=o?o:tQ.DEFAULT_PUBLICKEY_TYPE,null==t?(this.created=new Date,this.created&&this.created.setMilliseconds(0)):this.created=t,this.verificationMethod=e,this.realm=i,this.nonce=r,this.signature=n}getType(){return this.type}getCreated(){return this.created}getVerificationMethod(){return this.verificationMethod}getRealm(){return this.realm}getNonce(){return this.nonce}getSignature(){return this.signature}toJSON(t=null){t&&new tz(t);let e={};return e.type=this.type,this.created&&(e.created=this.dateToString(this.created)),e.verificationMethod=this.verificationMethod.toString(),e.realm=this.realm,e.nonce=this.nonce,e.signature=this.signature,e}fromJSON(t,e=null){this.type=this.getString("proof.type",t.type,{mandatory:!1,defaultValue:tQ.DEFAULT_PUBLICKEY_TYPE}),this.created=this.getDate("created",t.created,{mandatory:!1,nullable:!0}),this.verificationMethod=this.getDidUrl("proof.verificationMethod",t.verificationMethod,{mandatory:!0,nullable:!1,context:e}),this.realm=this.getString("proof.realm",t.realm,{mandatory:!0,nullable:!1}),this.nonce=this.getString("proof.nonce",t.nonce,{mandatory:!0,nullable:!1}),this.signature=this.getString("proof.signature",t.signature,{mandatory:!0,nullable:!1})}}t.Proof=e}(el||(el={}));var eu="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},ec={exports:{}};ec.exports=function(t){var e={};function i(r){if(e[r])return e[r].exports;var n=e[r]={exports:{},id:r,loaded:!1};return t[r].call(n.exports,n,n.exports,i),n.loaded=!0,n.exports}return i.m=t,i.c=e,i.p="",i(0)}([function(t,e,i){(function(t,r,n,o){Object.defineProperty(e,"__esModule",{value:!0});var s,a,l,u=i(2),c=i(9);(d=l||(l={}))[d.EPERM=1]="EPERM",d[d.ENOENT=2]="ENOENT",d[d.EIO=5]="EIO",d[d.EBADF=9]="EBADF",d[d.EACCES=13]="EACCES",d[d.EBUSY=16]="EBUSY",d[d.EEXIST=17]="EEXIST",d[d.ENOTDIR=20]="ENOTDIR",d[d.EISDIR=21]="EISDIR",d[d.EINVAL=22]="EINVAL",d[d.EFBIG=27]="EFBIG",d[d.ENOSPC=28]="ENOSPC",d[d.EROFS=30]="EROFS",d[d.ENOTEMPTY=39]="ENOTEMPTY",d[d.ENOTSUP=95]="ENOTSUP";var h={};h[l.EPERM]="Operation not permitted.",h[l.ENOENT]="No such file or directory.",h[l.EIO]="Input/output error.",h[l.EBADF]="Bad file descriptor.",h[l.EACCES]="Permission denied.",h[l.EBUSY]="Resource busy or locked.",h[l.EEXIST]="File exists.",h[l.ENOTDIR]="File is not a directory.",h[l.EISDIR]="File is a directory.",h[l.EINVAL]="Invalid argument.",h[l.EFBIG]="File is too big.",h[l.ENOSPC]="No space left on disk.",h[l.EROFS]="Cannot modify a read-only file system.",h[l.ENOTEMPTY]="Directory is not empty.",h[l.ENOTSUP]="Operation is not supported.";var d,f,p=function(e){function i(t,i,r){void 0===i&&(i=h[t]),e.call(this,i),this.syscall="",this.errno=t,this.code=l[t],this.path=r,this.stack=(new e).stack,this.message="Error: "+this.code+": "+i+(this.path?", '"+this.path+"'":"")}return e&&(i.__proto__=e),i.prototype=Object.create(e&&e.prototype),i.prototype.constructor=i,i.fromJSON=function(t){var e=new i(0);return e.errno=t.errno,e.code=t.code,e.path=t.path,e.stack=t.stack,e.message=t.message,e},i.fromBuffer=function(t,e){return void 0===e&&(e=0),i.fromJSON(JSON.parse(t.toString("utf8",e+4,e+4+t.readUInt32LE(e))))},i.FileError=function(t,e){return new i(t,h[t],e)},i.ENOENT=function(t){return this.FileError(l.ENOENT,t)},i.EEXIST=function(t){return this.FileError(l.EEXIST,t)},i.EISDIR=function(t){return this.FileError(l.EISDIR,t)},i.ENOTDIR=function(t){return this.FileError(l.ENOTDIR,t)},i.EPERM=function(t){return this.FileError(l.EPERM,t)},i.ENOTEMPTY=function(t){return this.FileError(l.ENOTEMPTY,t)},i.prototype.toString=function(){return this.message},i.prototype.toJSON=function(){return{errno:this.errno,code:this.code,path:this.path,stack:this.stack,message:this.message}},i.prototype.writeToBuffer=function(e,i){void 0===e&&(e=t.alloc(this.bufferSize())),void 0===i&&(i=0);var r=e.write(JSON.stringify(this.toJSON()),i+4);return e.writeUInt32LE(r,i),e},i.prototype.bufferSize=function(){return 4+t.byteLength(JSON.stringify(this.toJSON()))},i}(Error),y=Object.freeze({get ErrorCode(){return l},ErrorStrings:h,ApiError:p});(g=f||(f={}))[g.NOP=0]="NOP",g[g.THROW_EXCEPTION=1]="THROW_EXCEPTION",g[g.TRUNCATE_FILE=2]="TRUNCATE_FILE",g[g.CREATE_FILE=3]="CREATE_FILE";var g,v,m=function t(e){if(this.flagStr=e,0>t.validFlagStrs.indexOf(e))throw new p(l.EINVAL,"Invalid flag: "+e)};m.getFileFlag=function(t){return m.flagCache.hasOwnProperty(t)?m.flagCache[t]:m.flagCache[t]=new m(t)},m.prototype.getFlagString=function(){return this.flagStr},m.prototype.isReadable=function(){return -1!==this.flagStr.indexOf("r")||-1!==this.flagStr.indexOf("+")},m.prototype.isWriteable=function(){return -1!==this.flagStr.indexOf("w")||-1!==this.flagStr.indexOf("a")||-1!==this.flagStr.indexOf("+")},m.prototype.isTruncating=function(){return -1!==this.flagStr.indexOf("w")},m.prototype.isAppendable=function(){return -1!==this.flagStr.indexOf("a")},m.prototype.isSynchronous=function(){return -1!==this.flagStr.indexOf("s")},m.prototype.isExclusive=function(){return -1!==this.flagStr.indexOf("x")},m.prototype.pathExistsAction=function(){return this.isExclusive()?f.THROW_EXCEPTION:this.isTruncating()?f.TRUNCATE_FILE:f.NOP},m.prototype.pathNotExistsAction=function(){return(this.isWriteable()||this.isAppendable())&&"r+"!==this.flagStr?f.CREATE_FILE:f.THROW_EXCEPTION},m.flagCache={},m.validFlagStrs=["r","r+","rs","rs+","w","wx","w+","wx+","a","ax","a+","ax+"],(tW=v||(v={}))[tW.FILE=32768]="FILE",tW[tW.DIRECTORY=16384]="DIRECTORY",tW[tW.SYMLINK=40960]="SYMLINK";var w=function(t,e,i,r,n,o){if(void 0===r&&(r=new Date),void 0===n&&(n=new Date),void 0===o&&(o=new Date),this.size=e,this.atime=r,this.mtime=n,this.ctime=o,this.dev=0,this.ino=0,this.rdev=0,this.nlink=1,this.blksize=4096,this.uid=0,this.gid=0,this.birthtime=new Date(0),this.fileData=null,i)this.mode=i;else switch(t){case v.FILE:this.mode=420;break;case v.DIRECTORY:default:this.mode=511}this.blocks=Math.ceil(e/512),this.mode<4096&&(this.mode|=t)};w.fromBuffer=function(t){var e=t.readUInt32LE(0),i=t.readUInt32LE(4),r=t.readDoubleLE(8),n=t.readDoubleLE(16),o=t.readDoubleLE(24);return new w(61440&i,e,4095&i,new Date(r),new Date(n),new Date(o))},w.prototype.toBuffer=function(){var e=t.alloc(32);return e.writeUInt32LE(this.size,0),e.writeUInt32LE(this.mode,4),e.writeDoubleLE(this.atime.getTime(),8),e.writeDoubleLE(this.mtime.getTime(),16),e.writeDoubleLE(this.ctime.getTime(),24),e},w.prototype.clone=function(){return new w(61440&this.mode,this.size,4095&this.mode,this.atime,this.mtime,this.ctime)},w.prototype.isFile=function(){return(61440&this.mode)===v.FILE},w.prototype.isDirectory=function(){return(61440&this.mode)===v.DIRECTORY},w.prototype.isSymbolicLink=function(){return(61440&this.mode)===v.SYMLINK},w.prototype.chmod=function(t){this.mode=61440&this.mode|t},w.prototype.isSocket=function(){return!1},w.prototype.isBlockDevice=function(){return!1},w.prototype.isCharacterDevice=function(){return!1},w.prototype.isFIFO=function(){return!1};var S=function(t,e){return t};function b(t){if(t)return t;throw new p(l.EIO,"Initialize BrowserFS with a file system using BrowserFS.initialize(filesystem)")}function E(t,e){switch(typeof t){case"number":return t;case"string":var i=parseInt(t,8);return isNaN(i)?e:i;default:return e}}function I(t){if(t instanceof Date)return t;if("number"==typeof t)return new Date(1e3*t);throw new p(l.EINVAL,"Invalid time.")}function _(t){if(t.indexOf("\x00")>=0)throw new p(l.EINVAL,"Path must be a string without null bytes.");if(""===t)throw new p(l.EINVAL,"Path must not be empty.");return c.resolve(t)}function D(t,e,i,r){switch(typeof t){case"object":return{encoding:void 0!==t.encoding?t.encoding:e,flag:void 0!==t.flag?t.flag:i,mode:E(t.mode,r)};case"string":return{encoding:t,flag:i,mode:r};default:return{encoding:e,flag:i,mode:r}}}function T(){}var A=function(){this.F_OK=0,this.R_OK=4,this.W_OK=2,this.X_OK=1,this.root=null,this.fdMap={},this.nextFd=100};A.prototype.initialize=function(t){if(!t.constructor.isAvailable())throw new p(l.EINVAL,"Tried to instantiate BrowserFS with an unavailable file system.");return this.root=t},A.prototype._toUnixTimestamp=function(t){if("number"==typeof t)return t;if(t instanceof Date)return t.getTime()/1e3;throw Error("Cannot parse time: "+t)},A.prototype.getRootFS=function(){return this.root?this.root:null},A.prototype.rename=function(t,e,i){void 0===i&&(i=T);var r=S(i,1);try{b(this.root).rename(_(t),_(e),r)}catch(t){r(t)}},A.prototype.renameSync=function(t,e){b(this.root).renameSync(_(t),_(e))},A.prototype.exists=function(t,e){void 0===e&&(e=T);var i=S(e,1);try{return b(this.root).exists(_(t),i)}catch(t){return i(!1)}},A.prototype.existsSync=function(t){try{return b(this.root).existsSync(_(t))}catch(t){return!1}},A.prototype.stat=function(t,e){void 0===e&&(e=T);var i=S(e,2);try{return b(this.root).stat(_(t),!1,i)}catch(t){return i(t)}},A.prototype.statSync=function(t){return b(this.root).statSync(_(t),!1)},A.prototype.lstat=function(t,e){void 0===e&&(e=T);var i=S(e,2);try{return b(this.root).stat(_(t),!0,i)}catch(t){return i(t)}},A.prototype.lstatSync=function(t){return b(this.root).statSync(_(t),!0)},A.prototype.truncate=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=T);var r=0;"function"==typeof e?i=e:"number"==typeof e&&(r=e);var n=S(i,1);try{if(r<0)throw new p(l.EINVAL);return b(this.root).truncate(_(t),r,n)}catch(t){return n(t)}},A.prototype.truncateSync=function(t,e){if(void 0===e&&(e=0),e<0)throw new p(l.EINVAL);return b(this.root).truncateSync(_(t),e)},A.prototype.unlink=function(t,e){void 0===e&&(e=T);var i=S(e,1);try{return b(this.root).unlink(_(t),i)}catch(t){return i(t)}},A.prototype.unlinkSync=function(t){return b(this.root).unlinkSync(_(t))},A.prototype.open=function(t,e,i,r){var n=this;void 0===r&&(r=T);var o=E(i,420),s=S(r="function"==typeof i?i:r,2);try{b(this.root).open(_(t),m.getFileFlag(e),o,function(t,e){e?s(t,n.getFdForFile(e)):s(t)})}catch(t){s(t)}},A.prototype.openSync=function(t,e,i){return void 0===i&&(i=420),this.getFdForFile(b(this.root).openSync(_(t),m.getFileFlag(e),E(i,420)))},A.prototype.readFile=function(t,e,i){void 0===e&&(e={}),void 0===i&&(i=T);var r=D(e,null,"r",null),n=S(i="function"==typeof e?e:i,2);try{var o=m.getFileFlag(r.flag);return o.isReadable()?b(this.root).readFile(_(t),r.encoding,o,n):n(new p(l.EINVAL,"Flag passed to readFile must allow for reading."))}catch(t){return n(t)}},A.prototype.readFileSync=function(t,e){void 0===e&&(e={});var i=D(e,null,"r",null),r=m.getFileFlag(i.flag);if(!r.isReadable())throw new p(l.EINVAL,"Flag passed to readFile must allow for reading.");return b(this.root).readFileSync(_(t),i.encoding,r)},A.prototype.writeFile=function(t,e,i,r){void 0===i&&(i={}),void 0===r&&(r=T);var n=D(i,"utf8","w",420),o=S(r="function"==typeof i?i:r,1);try{var s=m.getFileFlag(n.flag);return s.isWriteable()?b(this.root).writeFile(_(t),e,n.encoding,s,n.mode,o):o(new p(l.EINVAL,"Flag passed to writeFile must allow for writing."))}catch(t){return o(t)}},A.prototype.writeFileSync=function(t,e,i){var r=D(i,"utf8","w",420),n=m.getFileFlag(r.flag);if(!n.isWriteable())throw new p(l.EINVAL,"Flag passed to writeFile must allow for writing.");return b(this.root).writeFileSync(_(t),e,r.encoding,n,r.mode)},A.prototype.appendFile=function(t,e,i,r){void 0===r&&(r=T);var n=D(i,"utf8","a",420),o=S(r="function"==typeof i?i:r,1);try{var s=m.getFileFlag(n.flag);if(!s.isAppendable())return o(new p(l.EINVAL,"Flag passed to appendFile must allow for appending."));b(this.root).appendFile(_(t),e,n.encoding,s,n.mode,o)}catch(t){o(t)}},A.prototype.appendFileSync=function(t,e,i){var r=D(i,"utf8","a",420),n=m.getFileFlag(r.flag);if(!n.isAppendable())throw new p(l.EINVAL,"Flag passed to appendFile must allow for appending.");return b(this.root).appendFileSync(_(t),e,r.encoding,n,r.mode)},A.prototype.fstat=function(t,e){void 0===e&&(e=T);var i=S(e,2);try{this.fd2file(t).stat(i)}catch(t){i(t)}},A.prototype.fstatSync=function(t){return this.fd2file(t).statSync()},A.prototype.close=function(t,e){var i=this;void 0===e&&(e=T);var r=S(e,1);try{this.fd2file(t).close(function(e){e||i.closeFd(t),r(e)})}catch(t){r(t)}},A.prototype.closeSync=function(t){this.fd2file(t).closeSync(),this.closeFd(t)},A.prototype.ftruncate=function(t,e,i){void 0===i&&(i=T);var r="number"==typeof e?e:0,n=S(i="function"==typeof e?e:i,1);try{var o=this.fd2file(t);if(r<0)throw new p(l.EINVAL);o.truncate(r,n)}catch(t){n(t)}},A.prototype.ftruncateSync=function(t,e){void 0===e&&(e=0);var i=this.fd2file(t);if(e<0)throw new p(l.EINVAL);i.truncateSync(e)},A.prototype.fsync=function(t,e){void 0===e&&(e=T);var i=S(e,1);try{this.fd2file(t).sync(i)}catch(t){i(t)}},A.prototype.fsyncSync=function(t){this.fd2file(t).syncSync()},A.prototype.fdatasync=function(t,e){void 0===e&&(e=T);var i=S(e,1);try{this.fd2file(t).datasync(i)}catch(t){i(t)}},A.prototype.fdatasyncSync=function(t){this.fd2file(t).datasyncSync()},A.prototype.write=function(e,i,r,n,o,s){void 0===s&&(s=T);var a,u,c,h=null;if("string"==typeof i){var d="utf8";switch(typeof r){case"function":s=r;break;case"number":h=r,d="string"==typeof n?n:"utf8",s="function"==typeof o?o:s;break;default:return(s="function"==typeof n?n:"function"==typeof o?o:s)(new p(l.EINVAL,"Invalid arguments."))}u=0,c=(a=t.from(i,d)).length}else a=i,u=r,c=n,h="number"==typeof o?o:null,s="function"==typeof o?o:s;var f=S(s,3);try{var y=this.fd2file(e);null==h&&(h=y.getPos()),y.write(a,u,c,h,f)}catch(t){f(t)}},A.prototype.writeSync=function(e,i,r,n,o){var s,a,l,u=0;if("string"==typeof i){l="number"==typeof r?r:null;var c="string"==typeof n?n:"utf8";u=0,a=(s=t.from(i,c)).length}else s=i,u=r,a=n,l="number"==typeof o?o:null;var h=this.fd2file(e);return null==l&&(l=h.getPos()),h.writeSync(s,u,a,l)},A.prototype.read=function(e,i,r,n,o,s){var a,l,u,c,h;(void 0===s&&(s=T),"number"==typeof i)?(u=i,a=r,s="function"==typeof o?o:s,l=0,c=t.alloc(u),h=S(function(t,e,i){if(t)return s(t);s(t,i.toString(n),e)},3)):(c=i,l=r,u=n,a=o,h=S(s,3));try{var d=this.fd2file(e);null==a&&(a=d.getPos()),d.read(c,l,u,a,h)}catch(t){h(t)}},A.prototype.readSync=function(e,i,r,n,o){var s,a,l,u,c=!1,h="utf8";"number"==typeof i?(l=i,u=r,h=n,a=0,s=t.alloc(l),c=!0):(s=i,a=r,l=n,u=o);var d=this.fd2file(e);null==u&&(u=d.getPos());var f=d.readSync(s,a,l,u);return c?[s.toString(h),f]:f},A.prototype.fchown=function(t,e,i,r){void 0===r&&(r=T);var n=S(r,1);try{this.fd2file(t).chown(e,i,n)}catch(t){n(t)}},A.prototype.fchownSync=function(t,e,i){this.fd2file(t).chownSync(e,i)},A.prototype.fchmod=function(t,e,i){var r=S(i,1);try{var n="string"==typeof e?parseInt(e,8):e;this.fd2file(t).chmod(n,r)}catch(t){r(t)}},A.prototype.fchmodSync=function(t,e){var i="string"==typeof e?parseInt(e,8):e;this.fd2file(t).chmodSync(i)},A.prototype.futimes=function(t,e,i,r){void 0===r&&(r=T);var n=S(r,1);try{var o=this.fd2file(t);"number"==typeof e&&(e=new Date(1e3*e)),"number"==typeof i&&(i=new Date(1e3*i)),o.utimes(e,i,n)}catch(t){n(t)}},A.prototype.futimesSync=function(t,e,i){this.fd2file(t).utimesSync(I(e),I(i))},A.prototype.rmdir=function(t,e){void 0===e&&(e=T);var i=S(e,1);try{t=_(t),b(this.root).rmdir(t,i)}catch(t){i(t)}},A.prototype.rmdirSync=function(t){return t=_(t),b(this.root).rmdirSync(t)},A.prototype.mkdir=function(t,e,i){void 0===i&&(i=T),"function"==typeof e&&(i=e,e=511);var r=S(i,1);try{t=_(t),b(this.root).mkdir(t,e,r)}catch(t){r(t)}},A.prototype.mkdirSync=function(t,e){b(this.root).mkdirSync(_(t),E(e,511))},A.prototype.readdir=function(t,e){void 0===e&&(e=T);var i=S(e,2);try{t=_(t),b(this.root).readdir(t,i)}catch(t){i(t)}},A.prototype.readdirSync=function(t){return t=_(t),b(this.root).readdirSync(t)},A.prototype.link=function(t,e,i){void 0===i&&(i=T);var r=S(i,1);try{t=_(t),e=_(e),b(this.root).link(t,e,r)}catch(t){r(t)}},A.prototype.linkSync=function(t,e){return t=_(t),e=_(e),b(this.root).linkSync(t,e)},A.prototype.symlink=function(t,e,i,r){void 0===r&&(r=T);var n="string"==typeof i?i:"file",o=S(r="function"==typeof i?i:r,1);try{if("file"!==n&&"dir"!==n)return o(new p(l.EINVAL,"Invalid type: "+n));t=_(t),e=_(e),b(this.root).symlink(t,e,n,o)}catch(t){o(t)}},A.prototype.symlinkSync=function(t,e,i){if(i){if("file"!==i&&"dir"!==i)throw new p(l.EINVAL,"Invalid type: "+i)}else i="file";return t=_(t),e=_(e),b(this.root).symlinkSync(t,e,i)},A.prototype.readlink=function(t,e){void 0===e&&(e=T);var i=S(e,2);try{t=_(t),b(this.root).readlink(t,i)}catch(t){i(t)}},A.prototype.readlinkSync=function(t){return t=_(t),b(this.root).readlinkSync(t)},A.prototype.chown=function(t,e,i,r){void 0===r&&(r=T);var n=S(r,1);try{t=_(t),b(this.root).chown(t,!1,e,i,n)}catch(t){n(t)}},A.prototype.chownSync=function(t,e,i){t=_(t),b(this.root).chownSync(t,!1,e,i)},A.prototype.lchown=function(t,e,i,r){void 0===r&&(r=T);var n=S(r,1);try{t=_(t),b(this.root).chown(t,!0,e,i,n)}catch(t){n(t)}},A.prototype.lchownSync=function(t,e,i){t=_(t),b(this.root).chownSync(t,!0,e,i)},A.prototype.chmod=function(t,e,i){void 0===i&&(i=T);var r=S(i,1);try{var n=E(e,-1);if(n<0)throw new p(l.EINVAL,"Invalid mode.");b(this.root).chmod(_(t),!1,n,r)}catch(t){r(t)}},A.prototype.chmodSync=function(t,e){var i=E(e,-1);if(i<0)throw new p(l.EINVAL,"Invalid mode.");t=_(t),b(this.root).chmodSync(t,!1,i)},A.prototype.lchmod=function(t,e,i){void 0===i&&(i=T);var r=S(i,1);try{var n=E(e,-1);if(n<0)throw new p(l.EINVAL,"Invalid mode.");b(this.root).chmod(_(t),!0,n,r)}catch(t){r(t)}},A.prototype.lchmodSync=function(t,e){var i=E(e,-1);if(i<1)throw new p(l.EINVAL,"Invalid mode.");b(this.root).chmodSync(_(t),!0,i)},A.prototype.utimes=function(t,e,i,r){void 0===r&&(r=T);var n=S(r,1);try{b(this.root).utimes(_(t),I(e),I(i),n)}catch(t){n(t)}},A.prototype.utimesSync=function(t,e,i){b(this.root).utimesSync(_(t),I(e),I(i))},A.prototype.realpath=function(t,e,i){void 0===i&&(i=T);var r="object"==typeof e?e:{},n=S(i="function"==typeof e?e:T,2);try{t=_(t),b(this.root).realpath(t,r,n)}catch(t){n(t)}},A.prototype.realpathSync=function(t,e){return void 0===e&&(e={}),t=_(t),b(this.root).realpathSync(t,e)},A.prototype.watchFile=function(t,e,i){throw new p(l.ENOTSUP)},A.prototype.unwatchFile=function(t,e){throw new p(l.ENOTSUP)},A.prototype.watch=function(t,e,i){throw new p(l.ENOTSUP)},A.prototype.access=function(t,e,i){throw new p(l.ENOTSUP)},A.prototype.accessSync=function(t,e){throw new p(l.ENOTSUP)},A.prototype.createReadStream=function(t,e){throw new p(l.ENOTSUP)},A.prototype.createWriteStream=function(t,e){throw new p(l.ENOTSUP)},A.prototype.wrapCallbacks=function(t){S=t},A.prototype.getFdForFile=function(t){var e=this.nextFd++;return this.fdMap[e]=t,e},A.prototype.fd2file=function(t){var e=this.fdMap[t];if(e)return e;throw new p(l.EBADF,"Invalid file descriptor.")},A.prototype.closeFd=function(t){delete this.fdMap[t]},A.Stats=w;var x=new A,O={};function P(t,e,i,r,n){return t<e||i<e?t>i?i+1:t+1:r===n?e:e+1}function R(t,e,i){t&&console.warn("["+e+"] Direct file system constructor usage is deprecated for this file system, and will be removed in the next major version. Please use the '"+e+".Create("+JSON.stringify(i)+", callback)' method instead. See https://github.com/jvilk/BrowserFS/issues/176 for more details.")}Object.keys(A.prototype).forEach(function(t){"function"==typeof x[t]?O[t]=function(){return x[t].apply(x,arguments)}:O[t]=x[t]}),O.changeFSModule=function(t){x=t},O.getFSModule=function(){return x},O.FS=A;var k="undefined"!=typeof navigator&&!(!/(msie) ([\w.]+)/.exec(navigator.userAgent.toLowerCase())&&-1===navigator.userAgent.indexOf("Trident")),N="undefined"==typeof window;function C(){throw Error("BFS has reached an impossible code path; please file a bug.")}function F(t,e,i){i.existsSync(t)||(F(c.dirname(t),e,i),i.mkdirSync(t,e))}function L(t){var e=M(t),i=e.byteOffset,r=e.byteLength;return 0===i&&r===e.buffer.byteLength?e.buffer:e.buffer.slice(i,i+r)}function M(t){return t instanceof Uint8Array?t:new Uint8Array(t)}function j(e){return e instanceof t?e:e instanceof Uint8Array?K(e):t.from(e)}function K(e){return e instanceof t?e:0===e.byteOffset&&e.byteLength===e.buffer.byteLength?U(e.buffer):t.from(e.buffer,e.byteOffset,e.byteLength)}function U(e){return t.from(e)}function B(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=t.length),e<0||i<0||i>t.length||e>i)throw TypeError("Invalid slice bounds on buffer of length "+t.length+": ["+e+", "+i+"]");if(0===t.length)return V();var r=M(t),n=t[0],o=(n+1)%255;return t[0]=o,r[0]===o?(r[0]=n,K(r.slice(e,i))):(t[0]=n,K(r.subarray(e,i)))}var z=null;function V(){return z||(z=t.alloc(0))}function q(e,i){t.isBuffer(e)?i():i(new p(l.EINVAL,"option must be a Buffer."))}function W(t,e,i){var r=t.Options,n=t.Name,o=0,s=!1,a=!1;function u(t){s||(t&&(s=!0,i(t)),0==--o&&a&&i())}var c=function(t){if(r.hasOwnProperty(t)){var a=r[t],c=e[t];if(null==c){if(!a.optional){var h=Object.keys(e).filter(function(t){return!(t in r)}).map(function(e){return{str:e,distance:function(t,e){if(t===e)return 0;if(t.length>e.length){var i=t;t=e,e=i}for(var r=t.length,n=e.length;r>0&&t.charCodeAt(r-1)===e.charCodeAt(n-1);)r--,n--;for(var o=0;o<r&&t.charCodeAt(o)===e.charCodeAt(o);)o++;if(n-=o,0==(r-=o)||1===n)return n;for(var s,a,l,u,c,h=Array(r<<1),d=0;d<r;)h[r+d]=t.charCodeAt(o+d),h[d]=++d;for(s=0;s+3<n;)for(var f=e.charCodeAt(o+(a=s)),p=e.charCodeAt(o+(l=s+1)),y=e.charCodeAt(o+(u=s+2)),g=e.charCodeAt(o+(c=s+3)),v=s+=4,m=0;m<r;){var w=h[r+m],S=h[m];a=P(S,a,l,f,w),l=P(a,l,u,p,w),u=P(l,u,c,y,w),v=P(u,c,v,g,w),h[m++]=v,c=u,u=l,l=a,a=S}for(var b=0;s<n;){var E=e.charCodeAt(o+(a=s));b=++s;for(var I=0;I<r;I++){var _=h[I];h[I]=b=_<a||b<a?_>b?b+1:_+1:E===h[r+I]?a:a+1,a=_}}return b}(t,e)}}).filter(function(t){return t.distance<5}).sort(function(t,e){return t.distance-e.distance});return s?{}:(s=!0,{v:i(new p(l.EINVAL,"["+n+"] Required option '"+t+"' not provided."+(h.length>0?" You provided unrecognized option '"+h[0].str+"'; perhaps you meant to type '"+t+"'.":"")+"\nOption description: "+a.description))})}}else{if(!(Array.isArray(a.type)?-1!==a.type.indexOf(typeof c):typeof c===a.type))return s?{}:(s=!0,{v:i(new p(l.EINVAL,"["+n+"] Value provided for option "+t+" is not the proper type. Expected "+(Array.isArray(a.type)?"one of {"+a.type.join(", ")+"}":a.type)+", but received "+typeof c+"\nOption description: "+a.description))});a.validator&&(o++,a.validator(c,u))}}};for(var h in r){var d=c(h);if(d)return d.v}a=!0,0!==o||s||i()}var Y=Object.freeze({deprecationMessage:R,isIE:k,isWebWorker:N,fail:C,mkdirpSync:F,buffer2ArrayBuffer:L,buffer2Uint8array:M,arrayish2Buffer:j,uint8Array2Buffer:K,arrayBuffer2Buffer:U,copyingSlice:B,emptyBuffer:V,bufferValidator:q,checkOptions:W}),H=function(t){this.fs=t,this.nodefs=t.getNodeFS(),this.FS=t.getFS(),this.PATH=t.getPATH(),this.ERRNO_CODES=t.getERRNO_CODES()};H.prototype.open=function(t){var e=this.fs.realPath(t.node),i=this.FS;try{i.isFile(t.node.mode)&&(t.nfd=this.nodefs.openSync(e,this.fs.flagsToPermissionString(t.flags)))}catch(t){if(!t.code)throw t;throw new i.ErrnoError(this.ERRNO_CODES[t.code])}},H.prototype.close=function(t){var e=this.FS;try{e.isFile(t.node.mode)&&t.nfd&&this.nodefs.closeSync(t.nfd)}catch(t){if(!t.code)throw t;throw new e.ErrnoError(this.ERRNO_CODES[t.code])}},H.prototype.read=function(t,e,i,r,n){try{return this.nodefs.readSync(t.nfd,K(e),i,r,n)}catch(t){throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}},H.prototype.write=function(t,e,i,r,n){try{return this.nodefs.writeSync(t.nfd,K(e),i,r,n)}catch(t){throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}},H.prototype.llseek=function(t,e,i){var r=e;if(1===i)r+=t.position;else if(2===i&&this.FS.isFile(t.node.mode))try{r+=this.nodefs.fstatSync(t.nfd).size}catch(t){throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}if(r<0)throw new this.FS.ErrnoError(this.ERRNO_CODES.EINVAL);return t.position=r,r};var J=function(t){this.fs=t,this.nodefs=t.getNodeFS(),this.FS=t.getFS(),this.PATH=t.getPATH(),this.ERRNO_CODES=t.getERRNO_CODES()};J.prototype.getattr=function(t){var e,i=this.fs.realPath(t);try{e=this.nodefs.lstatSync(i)}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}return{dev:e.dev,ino:e.ino,mode:e.mode,nlink:e.nlink,uid:e.uid,gid:e.gid,rdev:e.rdev,size:e.size,atime:e.atime,mtime:e.mtime,ctime:e.ctime,blksize:e.blksize,blocks:e.blocks}},J.prototype.setattr=function(t,e){var i=this.fs.realPath(t);try{if(void 0!==e.mode&&(this.nodefs.chmodSync(i,e.mode),t.mode=e.mode),void 0!==e.timestamp){var r=new Date(e.timestamp);this.nodefs.utimesSync(i,r,r)}}catch(t){if(!t.code)throw t;if("ENOTSUP"!==t.code)throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}if(void 0!==e.size)try{this.nodefs.truncateSync(i,e.size)}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}},J.prototype.lookup=function(t,e){var i=this.PATH.join2(this.fs.realPath(t),e),r=this.fs.getMode(i);return this.fs.createNode(t,e,r)},J.prototype.mknod=function(t,e,i,r){var n=this.fs.createNode(t,e,i,r),o=this.fs.realPath(n);try{this.FS.isDir(n.mode)?this.nodefs.mkdirSync(o,n.mode):this.nodefs.writeFileSync(o,"",{mode:n.mode})}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}return n},J.prototype.rename=function(t,e,i){var r=this.fs.realPath(t),n=this.PATH.join2(this.fs.realPath(e),i);try{this.nodefs.renameSync(r,n),t.name=i,t.parent=e}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}},J.prototype.unlink=function(t,e){var i=this.PATH.join2(this.fs.realPath(t),e);try{this.nodefs.unlinkSync(i)}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}},J.prototype.rmdir=function(t,e){var i=this.PATH.join2(this.fs.realPath(t),e);try{this.nodefs.rmdirSync(i)}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}},J.prototype.readdir=function(t){var e=this.fs.realPath(t);try{var i=this.nodefs.readdirSync(e);return i.push(".",".."),i}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}},J.prototype.symlink=function(t,e,i){var r=this.PATH.join2(this.fs.realPath(t),e);try{this.nodefs.symlinkSync(i,r)}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}},J.prototype.readlink=function(t){var e=this.fs.realPath(t);try{return this.nodefs.readlinkSync(e)}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}};var X=function(t,e,i,r){void 0===t&&(t=self.FS),void 0===e&&(e=self.PATH),void 0===i&&(i=self.ERRNO_CODES),void 0===r&&(r=O),this.flagsToPermissionStringMap={0:"r",1:"r+",2:"r+",64:"r",65:"r+",66:"r+",129:"rx+",193:"rx+",514:"w+",577:"w",578:"w+",705:"wx",706:"wx+",1024:"a",1025:"a",1026:"a+",1089:"a",1090:"a+",1153:"ax",1154:"ax+",1217:"ax",1218:"ax+",4096:"rs",4098:"rs+"},this.nodefs=r,this.FS=t,this.PATH=e,this.ERRNO_CODES=i,this.node_ops=new J(this),this.stream_ops=new H(this)};X.prototype.mount=function(t){return this.createNode(null,"/",this.getMode(t.opts.root),0)},X.prototype.createNode=function(t,e,i,r){var n=this.FS;if(!n.isDir(i)&&!n.isFile(i)&&!n.isLink(i))throw new n.ErrnoError(this.ERRNO_CODES.EINVAL);var o=n.createNode(t,e,i);return o.node_ops=this.node_ops,o.stream_ops=this.stream_ops,o},X.prototype.getMode=function(t){var e;try{e=this.nodefs.lstatSync(t)}catch(t){if(!t.code)throw t;throw new this.FS.ErrnoError(this.ERRNO_CODES[t.code])}return e.mode},X.prototype.realPath=function(t){for(var e=[];t.parent!==t;)e.push(t.name),t=t.parent;return e.push(t.mount.opts.root),e.reverse(),this.PATH.join.apply(null,e)},X.prototype.flagsToPermissionString=function(t){var e="string"==typeof t?parseInt(t,10):t;return(e&=8191)in this.flagsToPermissionStringMap?this.flagsToPermissionStringMap[e]:t},X.prototype.getNodeFS=function(){return this.nodefs},X.prototype.getFS=function(){return this.FS},X.prototype.getPATH=function(){return this.PATH},X.prototype.getERRNO_CODES=function(){return this.ERRNO_CODES};var G=function(){};G.prototype.supportsLinks=function(){return!1},G.prototype.diskSpace=function(t,e){e(0,0)},G.prototype.openFile=function(t,e,i){throw new p(l.ENOTSUP)},G.prototype.createFile=function(t,e,i,r){throw new p(l.ENOTSUP)},G.prototype.open=function(t,e,i,r){var n=this;this.stat(t,!1,function(o,s){if(o)switch(e.pathNotExistsAction()){case f.CREATE_FILE:return n.stat(c.dirname(t),!1,function(o,s){o?r(o):s&&!s.isDirectory()?r(p.ENOTDIR(c.dirname(t))):n.createFile(t,e,i,r)});case f.THROW_EXCEPTION:return r(p.ENOENT(t));default:return r(new p(l.EINVAL,"Invalid FileFlag object."))}else{if(s&&s.isDirectory())return r(p.EISDIR(t));switch(e.pathExistsAction()){case f.THROW_EXCEPTION:return r(p.EEXIST(t));case f.TRUNCATE_FILE:return n.openFile(t,e,function(t,e){t?r(t):e?e.truncate(0,function(){e.sync(function(){r(null,e)})}):C()});case f.NOP:return n.openFile(t,e,r);default:return r(new p(l.EINVAL,"Invalid FileFlag object."))}}})},G.prototype.rename=function(t,e,i){i(new p(l.ENOTSUP))},G.prototype.renameSync=function(t,e){throw new p(l.ENOTSUP)},G.prototype.stat=function(t,e,i){i(new p(l.ENOTSUP))},G.prototype.statSync=function(t,e){throw new p(l.ENOTSUP)},G.prototype.openFileSync=function(t,e,i){throw new p(l.ENOTSUP)},G.prototype.createFileSync=function(t,e,i){throw new p(l.ENOTSUP)},G.prototype.openSync=function(t,e,i){var r;try{r=this.statSync(t,!1)}catch(r){switch(e.pathNotExistsAction()){case f.CREATE_FILE:if(!this.statSync(c.dirname(t),!1).isDirectory())throw p.ENOTDIR(c.dirname(t));return this.createFileSync(t,e,i);case f.THROW_EXCEPTION:throw p.ENOENT(t);default:throw new p(l.EINVAL,"Invalid FileFlag object.")}}if(r.isDirectory())throw p.EISDIR(t);switch(e.pathExistsAction()){case f.THROW_EXCEPTION:throw p.EEXIST(t);case f.TRUNCATE_FILE:return this.unlinkSync(t),this.createFileSync(t,e,r.mode);case f.NOP:return this.openFileSync(t,e,i);default:throw new p(l.EINVAL,"Invalid FileFlag object.")}},G.prototype.unlink=function(t,e){e(new p(l.ENOTSUP))},G.prototype.unlinkSync=function(t){throw new p(l.ENOTSUP)},G.prototype.rmdir=function(t,e){e(new p(l.ENOTSUP))},G.prototype.rmdirSync=function(t){throw new p(l.ENOTSUP)},G.prototype.mkdir=function(t,e,i){i(new p(l.ENOTSUP))},G.prototype.mkdirSync=function(t,e){throw new p(l.ENOTSUP)},G.prototype.readdir=function(t,e){e(new p(l.ENOTSUP))},G.prototype.readdirSync=function(t){throw new p(l.ENOTSUP)},G.prototype.exists=function(t,e){this.stat(t,null,function(t){e(!t)})},G.prototype.existsSync=function(t){try{return this.statSync(t,!0),!0}catch(t){return!1}},G.prototype.realpath=function(t,e,i){if(this.supportsLinks())for(var r=t.split(c.sep),n=0;n<r.length;n++){var o=r.slice(0,n+1);r[n]=c.join.apply(null,o)}else this.exists(t,function(e){e?i(null,t):i(p.ENOENT(t))})},G.prototype.realpathSync=function(t,e){if(this.supportsLinks()){for(var i=t.split(c.sep),r=0;r<i.length;r++){var n=i.slice(0,r+1);i[r]=c.join.apply(c,n)}return i.join(c.sep)}if(this.existsSync(t))return t;throw p.ENOENT(t)},G.prototype.truncate=function(t,e,i){this.open(t,m.getFileFlag("r+"),420,function(t,r){if(t)return i(t);r.truncate(e,function(t){r.close(function(e){i(t||e)})})})},G.prototype.truncateSync=function(t,e){var i=this.openSync(t,m.getFileFlag("r+"),420);try{i.truncateSync(e)}catch(t){throw t}finally{i.closeSync()}},G.prototype.readFile=function(e,i,r,n){var o=n;this.open(e,r,420,function(e,r){if(e)return n(e);n=function(t,e){r.close(function(i){return t||(t=i),o(t,e)})},r.stat(function(e,o){if(e)return n(e);var s=t.alloc(o.size);r.read(s,0,o.size,0,function(t){if(t)return n(t);if(null===i)return n(t,s);try{n(null,s.toString(i))}catch(t){n(t)}})})})},G.prototype.readFileSync=function(e,i,r){var n=this.openSync(e,r,420);try{var o=n.statSync(),s=t.alloc(o.size);return n.readSync(s,0,o.size,0),n.closeSync(),null===i?s:s.toString(i)}finally{n.closeSync()}},G.prototype.writeFile=function(e,i,r,n,o,s){var a=s;this.open(e,n,420,function(e,n){if(e)return s(e);s=function(t){n.close(function(e){a(t||e)})};try{"string"==typeof i&&(i=t.from(i,r))}catch(t){return s(t)}n.write(i,0,i.length,0,s)})},G.prototype.writeFileSync=function(e,i,r,n,o){var s=this.openSync(e,n,o);try{"string"==typeof i&&(i=t.from(i,r)),s.writeSync(i,0,i.length,0)}finally{s.closeSync()}},G.prototype.appendFile=function(e,i,r,n,o,s){var a=s;this.open(e,n,o,function(e,n){if(e)return s(e);s=function(t){n.close(function(e){a(t||e)})},"string"==typeof i&&(i=t.from(i,r)),n.write(i,0,i.length,null,s)})},G.prototype.appendFileSync=function(e,i,r,n,o){var s=this.openSync(e,n,o);try{"string"==typeof i&&(i=t.from(i,r)),s.writeSync(i,0,i.length,null)}finally{s.closeSync()}},G.prototype.chmod=function(t,e,i,r){r(new p(l.ENOTSUP))},G.prototype.chmodSync=function(t,e,i){throw new p(l.ENOTSUP)},G.prototype.chown=function(t,e,i,r,n){n(new p(l.ENOTSUP))},G.prototype.chownSync=function(t,e,i,r){throw new p(l.ENOTSUP)},G.prototype.utimes=function(t,e,i,r){r(new p(l.ENOTSUP))},G.prototype.utimesSync=function(t,e,i){throw new p(l.ENOTSUP)},G.prototype.link=function(t,e,i){i(new p(l.ENOTSUP))},G.prototype.linkSync=function(t,e){throw new p(l.ENOTSUP)},G.prototype.symlink=function(t,e,i,r){r(new p(l.ENOTSUP))},G.prototype.symlinkSync=function(t,e,i){throw new p(l.ENOTSUP)},G.prototype.readlink=function(t,e){e(new p(l.ENOTSUP))},G.prototype.readlinkSync=function(t){throw new p(l.ENOTSUP)};var Z=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.supportsSynch=function(){return!0},e.prototype.rename=function(t,e,i){try{this.renameSync(t,e),i()}catch(t){i(t)}},e.prototype.stat=function(t,e,i){try{i(null,this.statSync(t,e))}catch(t){i(t)}},e.prototype.open=function(t,e,i,r){try{r(null,this.openSync(t,e,i))}catch(t){r(t)}},e.prototype.unlink=function(t,e){try{this.unlinkSync(t),e()}catch(t){e(t)}},e.prototype.rmdir=function(t,e){try{this.rmdirSync(t),e()}catch(t){e(t)}},e.prototype.mkdir=function(t,e,i){try{this.mkdirSync(t,e),i()}catch(t){i(t)}},e.prototype.readdir=function(t,e){try{e(null,this.readdirSync(t))}catch(t){e(t)}},e.prototype.chmod=function(t,e,i,r){try{this.chmodSync(t,e,i),r()}catch(t){r(t)}},e.prototype.chown=function(t,e,i,r,n){try{this.chownSync(t,e,i,r),n()}catch(t){n(t)}},e.prototype.utimes=function(t,e,i,r){try{this.utimesSync(t,e,i),r()}catch(t){r(t)}},e.prototype.link=function(t,e,i){try{this.linkSync(t,e),i()}catch(t){i(t)}},e.prototype.symlink=function(t,e,i,r){try{this.symlinkSync(t,e,i),r()}catch(t){r(t)}},e.prototype.readlink=function(t,e){try{e(null,this.readlinkSync(t))}catch(t){e(t)}},e}(G),Q=function(){};Q.prototype.sync=function(t){t(new p(l.ENOTSUP))},Q.prototype.syncSync=function(){throw new p(l.ENOTSUP)},Q.prototype.datasync=function(t){this.sync(t)},Q.prototype.datasyncSync=function(){return this.syncSync()},Q.prototype.chown=function(t,e,i){i(new p(l.ENOTSUP))},Q.prototype.chownSync=function(t,e){throw new p(l.ENOTSUP)},Q.prototype.chmod=function(t,e){e(new p(l.ENOTSUP))},Q.prototype.chmodSync=function(t){throw new p(l.ENOTSUP)},Q.prototype.utimes=function(t,e,i){i(new p(l.ENOTSUP))},Q.prototype.utimesSync=function(t,e){throw new p(l.ENOTSUP)};var $=function(e){function i(t,i,r,n,o){if(e.call(this),this._pos=0,this._dirty=!1,this._fs=t,this._path=i,this._flag=r,this._stat=n,this._buffer=o||V(),this._stat.size!==this._buffer.length&&this._flag.isReadable())throw Error("Invalid buffer: Buffer is "+this._buffer.length+" long, yet Stats object specifies that file is "+this._stat.size+" long.")}return e&&(i.__proto__=e),i.prototype=Object.create(e&&e.prototype),i.prototype.constructor=i,i.prototype.getBuffer=function(){return this._buffer},i.prototype.getStats=function(){return this._stat},i.prototype.getFlag=function(){return this._flag},i.prototype.getPath=function(){return this._path},i.prototype.getPos=function(){return this._flag.isAppendable()?this._stat.size:this._pos},i.prototype.advancePos=function(t){return this._pos+=t},i.prototype.setPos=function(t){return this._pos=t},i.prototype.sync=function(t){try{this.syncSync(),t()}catch(e){t(e)}},i.prototype.syncSync=function(){throw new p(l.ENOTSUP)},i.prototype.close=function(t){try{this.closeSync(),t()}catch(e){t(e)}},i.prototype.closeSync=function(){throw new p(l.ENOTSUP)},i.prototype.stat=function(t){try{t(null,this._stat.clone())}catch(e){t(e)}},i.prototype.statSync=function(){return this._stat.clone()},i.prototype.truncate=function(t,e){try{this.truncateSync(t),this._flag.isSynchronous()&&!O.getRootFS().supportsSynch()&&this.sync(e),e()}catch(t){return e(t)}},i.prototype.truncateSync=function(e){if(this._dirty=!0,!this._flag.isWriteable())throw new p(l.EPERM,"File not opened with a writeable mode.");if(this._stat.mtime=new Date,e>this._buffer.length){var i=t.alloc(e-this._buffer.length,0);return this.writeSync(i,0,i.length,this._buffer.length),void(this._flag.isSynchronous()&&O.getRootFS().supportsSynch()&&this.syncSync())}this._stat.size=e;var r=t.alloc(e);this._buffer.copy(r,0,0,e),this._buffer=r,this._flag.isSynchronous()&&O.getRootFS().supportsSynch()&&this.syncSync()},i.prototype.write=function(t,e,i,r,n){try{n(null,this.writeSync(t,e,i,r),t)}catch(t){n(t)}},i.prototype.writeSync=function(e,i,r,n){if(this._dirty=!0,null==n&&(n=this.getPos()),!this._flag.isWriteable())throw new p(l.EPERM,"File not opened with a writeable mode.");var o=n+r;if(o>this._stat.size&&(this._stat.size=o,o>this._buffer.length)){var s=t.alloc(o);this._buffer.copy(s),this._buffer=s}var a=e.copy(this._buffer,n,i,i+r);return this._stat.mtime=new Date,this._flag.isSynchronous()?this.syncSync():this.setPos(n+a),a},i.prototype.read=function(t,e,i,r,n){try{n(null,this.readSync(t,e,i,r),t)}catch(t){n(t)}},i.prototype.readSync=function(t,e,i,r){if(!this._flag.isReadable())throw new p(l.EPERM,"File not opened with a readable mode.");null==r&&(r=this.getPos()),r+i>this._stat.size&&(i=this._stat.size-r);var n=this._buffer.copy(t,e,r,r+i);return this._stat.atime=new Date,this._pos=r+i,n},i.prototype.chmod=function(t,e){try{this.chmodSync(t),e()}catch(t){e(t)}},i.prototype.chmodSync=function(t){if(!this._fs.supportsProps())throw new p(l.ENOTSUP);this._dirty=!0,this._stat.chmod(t),this.syncSync()},i.prototype.isDirty=function(){return this._dirty},i.prototype.resetDirty=function(){this._dirty=!1},i}(Q),tt=function(t){function e(e,i,r,n,o){t.call(this,e,i,r,n,o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.sync=function(t){t()},e.prototype.syncSync=function(){},e.prototype.close=function(t){t()},e.prototype.closeSync=function(){},e}($),te=function(t){function e(e,i,r,n,o){t.call(this,e,i,r,n,o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.syncSync=function(){this.isDirty()&&(this._fs._syncSync(this),this.resetDirty())},e.prototype.closeSync=function(){this.syncSync()},e}($),ti=function(t){function e(i,r,n){if(void 0===n&&(n=!0),t.call(this),this._queue=[],this._queueRunning=!1,this._isInitialized=!1,this._initializeCallbacks=[],this._sync=i,this._async=r,!i.supportsSynch())throw Error("The first argument to AsyncMirror needs to be a synchronous file system.");R(n,e.Name,{sync:"sync file system instance",async:"async file system instance"})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){try{var r=new e(t.sync,t.async,!1);r.initialize(function(t){t?i(t):i(null,r)},!1)}catch(t){i(t)}},e.isAvailable=function(){return!0},e.prototype.getName=function(){return e.Name},e.prototype._syncSync=function(t){this._sync.writeFileSync(t.getPath(),t.getBuffer(),null,m.getFileFlag("w"),t.getStats().mode),this.enqueueOp({apiMethod:"writeFile",arguments:[t.getPath(),t.getBuffer(),null,t.getFlag(),t.getStats().mode]})},e.prototype.initialize=function(t,e){var i=this;void 0===e&&(e=!0),e&&console.warn("[AsyncMirror] AsyncMirror.initialize() is deprecated and will be removed in the next major version. Please use 'AsyncMirror.Create({ sync: (sync file system instance), async: (async file system instance)}, cb)' to create and initialize AsyncMirror instances.");var r=this._initializeCallbacks;if(this._isInitialized)t();else if(1===r.push(t)){var n=function(t,e,r){"/"!==t&&i._sync.mkdirSync(t,e),i._async.readdir(t,function(e,i){var n=0;e?r(e):function e(s){s?r(s):n<i.length?(o(c.join(t,i[n]),e),n++):r()}()})},o=function(t,e){i._async.stat(t,!1,function(r,o){var s;r?e(r):o.isDirectory()?n(t,o.mode,e):(s=o.mode,i._async.readFile(t,null,m.getFileFlag("r"),function(r,n){if(r)e(r);else try{i._sync.writeFileSync(t,n,null,m.getFileFlag("w"),s)}catch(t){r=t}finally{e(r)}}))})};n("/",0,function(t){i._isInitialized=!t,i._initializeCallbacks=[],r.forEach(function(e){return e(t)})})}},e.prototype.isReadOnly=function(){return!1},e.prototype.supportsSynch=function(){return!0},e.prototype.supportsLinks=function(){return!1},e.prototype.supportsProps=function(){return this._sync.supportsProps()&&this._async.supportsProps()},e.prototype.renameSync=function(t,e){this.checkInitialized(),this._sync.renameSync(t,e),this.enqueueOp({apiMethod:"rename",arguments:[t,e]})},e.prototype.statSync=function(t,e){return this.checkInitialized(),this._sync.statSync(t,e)},e.prototype.openSync=function(t,e,i){return this.checkInitialized(),this._sync.openSync(t,e,i).closeSync(),new te(this,t,e,this._sync.statSync(t,!1),this._sync.readFileSync(t,null,m.getFileFlag("r")))},e.prototype.unlinkSync=function(t){this.checkInitialized(),this._sync.unlinkSync(t),this.enqueueOp({apiMethod:"unlink",arguments:[t]})},e.prototype.rmdirSync=function(t){this.checkInitialized(),this._sync.rmdirSync(t),this.enqueueOp({apiMethod:"rmdir",arguments:[t]})},e.prototype.mkdirSync=function(t,e){this.checkInitialized(),this._sync.mkdirSync(t,e),this.enqueueOp({apiMethod:"mkdir",arguments:[t,e]})},e.prototype.readdirSync=function(t){return this.checkInitialized(),this._sync.readdirSync(t)},e.prototype.existsSync=function(t){return this.checkInitialized(),this._sync.existsSync(t)},e.prototype.chmodSync=function(t,e,i){this.checkInitialized(),this._sync.chmodSync(t,e,i),this.enqueueOp({apiMethod:"chmod",arguments:[t,e,i]})},e.prototype.chownSync=function(t,e,i,r){this.checkInitialized(),this._sync.chownSync(t,e,i,r),this.enqueueOp({apiMethod:"chown",arguments:[t,e,i,r]})},e.prototype.utimesSync=function(t,e,i){this.checkInitialized(),this._sync.utimesSync(t,e,i),this.enqueueOp({apiMethod:"utimes",arguments:[t,e,i]})},e.prototype.checkInitialized=function(){if(!this._isInitialized)throw new p(l.EPERM,"AsyncMirrorFS is not initialized. Please initialize AsyncMirrorFS using its initialize() method before using it.")},e.prototype.enqueueOp=function(t){var e=this;if(this._queue.push(t),!this._queueRunning){this._queueRunning=!0;var i=function(t){if(t&&console.error("WARNING: File system has desynchronized. Received following error: "+t+"\n$"),e._queue.length>0){var r=e._queue.shift(),n=r.arguments;n.push(i),e._async[r.apiMethod].apply(e._async,n)}else e._queueRunning=!1};i()}},e}(Z);ti.Name="AsyncMirror",ti.Options={sync:{type:"object",description:"The synchronous file system to mirror the asynchronous file system to."},async:{type:"object",description:"The asynchronous file system to mirror."}};var tr="object"==typeof r&&r&&r.Object===Object&&r,tn="object"==typeof self&&self&&self.Object===Object&&self,to=tr||tn||Function("return this")(),ts=to.Symbol,ta=Object.prototype,tl=ta.hasOwnProperty,tu=ta.toString,tc=ts?ts.toStringTag:void 0,th=Object.prototype.toString,td=ts?ts.toStringTag:void 0;function tf(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":td&&td in Object(t)?function(t){var e=tl.call(t,tc),i=t[tc];try{t[tc]=void 0;var r=!0}catch(t){}var n=tu.call(t);return r&&(e?t[tc]=i:delete t[tc]),n}(t):th.call(t)}function tp(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991}function ty(t){return null!=t&&tp(t.length)&&!function(t){if(e=typeof t,null==t||"object"!=e&&"function"!=e)return!1;var e,i=tf(t);return"[object Function]"==i||"[object GeneratorFunction]"==i||"[object AsyncFunction]"==i||"[object Proxy]"==i}(t)}var tg={};function tv(){}function tm(t){return function(){if(null!==t){var e=t;t=null,e.apply(this,arguments)}}}var tw="function"==typeof Symbol&&Symbol.iterator;function tS(t){return null!=t&&"object"==typeof t}function tb(t){return tS(t)&&"[object Arguments]"==tf(t)}var tE=Object.prototype,tI=tE.hasOwnProperty,t_=tE.propertyIsEnumerable,tD=tb(function(){return arguments}())?tb:function(t){return tS(t)&&tI.call(t,"callee")&&!t_.call(t,"callee")},tT=Array.isArray,tA="object"==typeof e&&e&&!e.nodeType&&e,tx=tA&&"object"==typeof n&&n&&!n.nodeType&&n,tO=tx&&tx.exports===tA?to.Buffer:void 0,tP=(tO?tO.isBuffer:void 0)||function(){return!1},tR=/^(?:0|[1-9]\d*)$/,tk={};tk["[object Float32Array]"]=tk["[object Float64Array]"]=tk["[object Int8Array]"]=tk["[object Int16Array]"]=tk["[object Int32Array]"]=tk["[object Uint8Array]"]=tk["[object Uint8ClampedArray]"]=tk["[object Uint16Array]"]=tk["[object Uint32Array]"]=!0,tk["[object Arguments]"]=tk["[object Array]"]=tk["[object ArrayBuffer]"]=tk["[object Boolean]"]=tk["[object DataView]"]=tk["[object Date]"]=tk["[object Error]"]=tk["[object Function]"]=tk["[object Map]"]=tk["[object Number]"]=tk["[object Object]"]=tk["[object RegExp]"]=tk["[object Set]"]=tk["[object String]"]=tk["[object WeakMap]"]=!1;var tN="object"==typeof e&&e&&!e.nodeType&&e,tC=tN&&"object"==typeof n&&n&&!n.nodeType&&n,tF=tC&&tC.exports===tN&&tr.process,tL=function(){try{return tF&&tF.binding&&tF.binding("util")}catch(t){}}(),tM=tL&&tL.isTypedArray,tj=tM?function(t){return tM(t)}:function(t){return tS(t)&&tp(t.length)&&!!tk[tf(t)]},tK=Object.prototype.hasOwnProperty,tU=Object.prototype,tB=(tY=Object.keys,tH=Object,function(t){return tY(tH(t))}),tz=Object.prototype.hasOwnProperty;function tV(t){return function(){if(null===t)throw Error("Callback was already called.");var e=t;t=null,e.apply(this,arguments)}}function tq(t,e,i){i=tm(i||tv);var r=0,n=0,o=t.length;function s(t,e){t?i(t):++n!==o&&e!==tg||i(null)}for(0===o&&i(null);r<o;r++)e(t[r],r,tV(s))}var tW,tY,tH,tJ,tX,tG,tZ=(tJ=function(t,e,i,r){(function(t,i,r){if(r=tm(r||tv),e<=0||!t)return r(null);var n=function(t){if(ty(t))return e=-1,i=t.length,function(){return++e<i?{value:t[e],key:e}:null};var e,i,r,n,o,s,a=tw&&t[tw]&&t[tw]();return a?(r=-1,function(){var t=a.next();return t.done?null:(r++,{value:t.value,key:r})}):(n=ty(t)?function(t,e){var i,r=tT(t),n=!r&&tD(t),o=!r&&!n&&tP(t),s=!r&&!n&&!o&&tj(t),a=r||n||o||s,l=a?function(t,e){for(var i=-1,r=Array(t);++i<t;)r[i]=e(i);return r}(t.length,String):[],u=l.length;for(var c in t)!tK.call(t,c)||a&&("length"==c||o&&("offset"==c||"parent"==c)||s&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||(i=null==(i=u)?9007199254740991:i)&&("number"==typeof c||tR.test(c))&&c>-1&&c%1==0&&c<i)||l.push(c);return l}(t):function(t){if(e=t&&t.constructor,t!==("function"==typeof e&&e.prototype||tU))return tB(t);var e,i=[];for(var r in Object(t))tz.call(t,r)&&"constructor"!=r&&i.push(r);return i}(t),o=-1,s=n.length,function(){var e=n[++o];return o<s?{value:t[e],key:e}:null})}(t),o=!1,s=0;function a(t,e){if(s-=1,t)o=!0,r(t);else{if(e===tg||o&&s<=0)return o=!0,r(null);l()}}function l(){for(;s<e&&!o;){var t=n();if(null===t)return o=!0,void(s<=0&&r(null));s+=1,i(t.value,t.key,tV(a))}}l()})(t,i,r)},tX=1/0,function(t,e,i){return tJ(t,tX,e,i)}),tQ="function"==typeof setImmediate&&setImmediate,t$="object"==typeof o&&"function"==typeof o.nextTick;function t0(t,e,i){!function(t,e,i){(ty(t)?tq:tZ)(t,e,i)}(t,function(t,i,r){return e(t,r)},i)}tQ&&setImmediate,t$||tQ&&setImmediate;var t1=function(t){this._cache={},this._client=t};t1.prototype.readdir=function(t,e){var i=this,r=this.getCachedDirInfo(t);this._wrap(function(e){null!==r&&r.contents?i._client.readdir(t,{contentHash:r.stat.contentHash},e):i._client.readdir(t,e)},function(n,o,s,a){n?n.status===Dropbox.ApiError.NO_CONTENT&&null!==r?e(null,r.contents.slice(0)):e(n):(i.updateCachedDirInfo(t,s,o.slice(0)),a.forEach(function(e){i.updateCachedInfo(c.join(t,e.name),e)}),e(null,o))})},t1.prototype.remove=function(t,e){var i=this;this._wrap(function(e){i._client.remove(t,e)},function(r,n){r||i.updateCachedInfo(t,n),e(r)})},t1.prototype.move=function(t,e,i){var r=this;this._wrap(function(i){r._client.move(t,e,i)},function(n,o){n||(r.deleteCachedInfo(t),r.updateCachedInfo(e,o)),i(n)})},t1.prototype.stat=function(t,e){var i=this;this._wrap(function(e){i._client.stat(t,e)},function(r,n){r||i.updateCachedInfo(t,n),e(r,n)})},t1.prototype.readFile=function(t,e){var i=this,r=this.getCachedFileInfo(t);null!==r&&null!==r.contents?this.stat(t,function(n,o){n?e(n):o.contentHash===r.stat.contentHash?e(n,r.contents.slice(0),r.stat):i.readFile(t,e)}):this._wrap(function(e){i._client.readFile(t,{arrayBuffer:!0},e)},function(r,n,o){r||i.updateCachedInfo(t,o,n.slice(0)),e(r,n,o)})},t1.prototype.writeFile=function(t,e,i){var r=this;this._wrap(function(i){r._client.writeFile(t,e,i)},function(n,o){n||r.updateCachedInfo(t,o,e.slice(0)),i(n,o)})},t1.prototype.mkdir=function(t,e){var i=this;this._wrap(function(e){i._client.mkdir(t,e)},function(r,n){r||i.updateCachedInfo(t,n,[]),e(r)})},t1.prototype._wrap=function(t,e){var i=0,r=function(n){if(n&&3>++i)switch(n.status){case Dropbox.ApiError.SERVER_ERROR:case Dropbox.ApiError.NETWORK_ERROR:case Dropbox.ApiError.RATE_LIMITED:setTimeout(function(){t(r)},2e3);break;default:e.apply(null,arguments)}else e.apply(null,arguments)};t(r)},t1.prototype.getCachedInfo=function(t){return this._cache[t.toLowerCase()]},t1.prototype.putCachedInfo=function(t,e){this._cache[t.toLowerCase()]=e},t1.prototype.deleteCachedInfo=function(t){delete this._cache[t.toLowerCase()]},t1.prototype.getCachedDirInfo=function(t){var e=this.getCachedInfo(t);return e&&e.stat.isFolder?e:null},t1.prototype.getCachedFileInfo=function(t){var e=this.getCachedInfo(t);return e&&e.stat.isFile?e:null},t1.prototype.updateCachedDirInfo=function(t,e,i){void 0===i&&(i=null);var r=this.getCachedInfo(t);null===e.contentHash||void 0!==r&&r.stat.contentHash===e.contentHash||this.putCachedInfo(t,{stat:e,contents:i})},t1.prototype.updateCachedFileInfo=function(t,e,i){void 0===i&&(i=null);var r=this.getCachedInfo(t);null===e.versionTag||void 0!==r&&r.stat.versionTag===e.versionTag||this.putCachedInfo(t,{stat:e,contents:i})},t1.prototype.updateCachedInfo=function(t,e,i){var r;void 0===i&&(i=null),e.isFile&&(null==(r=i)||"object"==typeof r&&"number"==typeof r.byteLength)?this.updateCachedFileInfo(t,e,i):e.isFolder&&Array.isArray(i)&&this.updateCachedDirInfo(t,e,i)};var t2=function(t){function e(e,i,r,n,o){t.call(this,e,i,r,n,o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.sync=function(t){var e=this;if(this.isDirty()){var i=L(this.getBuffer());this._fs._writeFileStrict(this.getPath(),i,function(i){i||e.resetDirty(),t(i)})}else t()},e.prototype.close=function(t){this.sync(t)},e}($),t5=function(t){function e(i,r){void 0===r&&(r=!0),t.call(this),this._client=new t1(i),R(r,e.Name,{client:"authenticated dropbox client instance"}),tG||((tG={})[Dropbox.ApiError.NETWORK_ERROR]=l.EIO,tG[Dropbox.ApiError.INVALID_PARAM]=l.EINVAL,tG[Dropbox.ApiError.INVALID_TOKEN]=l.EPERM,tG[Dropbox.ApiError.OAUTH_ERROR]=l.EPERM,tG[Dropbox.ApiError.NOT_FOUND]=l.ENOENT,tG[Dropbox.ApiError.INVALID_METHOD]=l.EINVAL,tG[Dropbox.ApiError.NOT_ACCEPTABLE]=l.EINVAL,tG[Dropbox.ApiError.CONFLICT]=l.EINVAL,tG[Dropbox.ApiError.RATE_LIMITED]=l.EBUSY,tG[Dropbox.ApiError.SERVER_ERROR]=l.EBUSY,tG[Dropbox.ApiError.OVER_QUOTA]=l.ENOSPC)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){i(null,new e(t.client,!1))},e.isAvailable=function(){return"undefined"!=typeof Dropbox},e.prototype.getName=function(){return e.Name},e.prototype.isReadOnly=function(){return!1},e.prototype.supportsSymlinks=function(){return!1},e.prototype.supportsProps=function(){return!1},e.prototype.supportsSynch=function(){return!1},e.prototype.empty=function(t){var e=this;this._client.readdir("/",function(i,r){i?t(e.convert(i,"/")):t0(r,function(t,i){var r=c.join("/",t);e._client.remove(r,function(t){i(t?e.convert(t,r):null)})},function(e){e?t(e):t()})})},e.prototype.rename=function(t,e,i){var r=this;this._client.move(t,e,function(n){n?r._client.stat(e,function(o,s){if(o||s.isFolder){var a=n.response.error.indexOf(t)>-1?t:e;i(r.convert(n,a))}else r._client.remove(e,function(n){n?i(r.convert(n,e)):r.rename(t,e,i)})}):i()})},e.prototype.stat=function(t,e,i){var r=this;this._client.stat(t,function(e,n){if(e)i(r.convert(e,t));else{if(!n||!n.isRemoved)return i(null,new w(r._statType(n),n.size));i(p.FileError(l.ENOENT,t))}})},e.prototype.open=function(t,e,i,r){var n=this;this._client.readFile(t,function(i,o,s){if(!i){var a;return a=null===o?V():U(o),r(null,n._makeFile(t,e,s,a))}if(!e.isReadable()){if(i.status===Dropbox.ApiError.NOT_FOUND){var l=new ArrayBuffer(0);return n._writeFileStrict(t,l,function(i,o){i?r(i):r(null,n._makeFile(t,e,o,U(l)))})}return r(n.convert(i,t))}r(n.convert(i,t))})},e.prototype._writeFileStrict=function(t,e,i){var r=this,n=c.dirname(t);this.stat(n,!1,function(o,s){o?i(p.FileError(l.ENOENT,n)):r._client.writeFile(t,e,function(e,n){e?i(r.convert(e,t)):i(null,n)})})},e.prototype._statType=function(t){return t.isFile?v.FILE:v.DIRECTORY},e.prototype._makeFile=function(t,e,i,r){var n=this._statType(i),o=new w(n,i.size);return new t2(this,t,e,o,r)},e.prototype._remove=function(t,e,i){var r=this;this._client.stat(t,function(n,o){n?e(r.convert(n,t)):o.isFile&&!i?e(p.FileError(l.ENOTDIR,t)):!o.isFile&&i?e(p.FileError(l.EISDIR,t)):r._client.remove(t,function(i){e(i?r.convert(i,t):null)})})},e.prototype.unlink=function(t,e){this._remove(t,e,!0)},e.prototype.rmdir=function(t,e){this._remove(t,e,!1)},e.prototype.mkdir=function(t,e,i){var r=this,n=c.dirname(t);this._client.stat(n,function(e,o){e?i(r.convert(e,n)):r._client.mkdir(t,function(e){i(e?p.FileError(l.EEXIST,t):null)})})},e.prototype.readdir=function(t,e){var i=this;this._client.readdir(t,function(t,r){return t?e(i.convert(t)):e(null,r)})},e.prototype.convert=function(t,e){void 0===e&&(e=null);var i=tG[t.status];return void 0===i&&(i=l.EIO),e?p.FileError(i,e):new p(i)},e}(G);function t3(t,e){void 0===e&&(e="");for(var i=t.errno,r=t.node,n=[];r&&(n.unshift(r.name),r!==r.parent);)r=r.parent;return new p(i,h[i],n.length>0?"/"+n.join("/"):e)}t5.Name="Dropbox",t5.Options={client:{type:"object",description:"An *authenticated* Dropbox client. Must be from the 0.10 JS SDK.",validator:function(t,e){t.isAuthenticated&&t.isAuthenticated()?e():e(new p(l.EINVAL,"'client' option must be an authenticated Dropbox client from the v0.10 JS SDK."))}}};var t6=function(t){function e(e,i,r,n){t.call(this),this._fs=e,this._FS=i,this._path=r,this._stream=n}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getPos=function(){},e.prototype.close=function(t){var e=null;try{this.closeSync()}catch(t){e=t}finally{t(e)}},e.prototype.closeSync=function(){try{this._FS.close(this._stream)}catch(t){throw t3(t,this._path)}},e.prototype.stat=function(t){try{t(null,this.statSync())}catch(e){t(e)}},e.prototype.statSync=function(){try{return this._fs.statSync(this._path,!1)}catch(t){throw t3(t,this._path)}},e.prototype.truncate=function(t,e){var i=null;try{this.truncateSync(t)}catch(t){i=t}finally{e(i)}},e.prototype.truncateSync=function(t){try{this._FS.ftruncate(this._stream.fd,t)}catch(t){throw t3(t,this._path)}},e.prototype.write=function(t,e,i,r,n){try{n(null,this.writeSync(t,e,i,r),t)}catch(t){n(t)}},e.prototype.writeSync=function(t,e,i,r){try{var n=M(t),o=null===r?void 0:r;return this._FS.write(this._stream,n,e,i,o)}catch(t){throw t3(t,this._path)}},e.prototype.read=function(t,e,i,r,n){try{n(null,this.readSync(t,e,i,r),t)}catch(t){n(t)}},e.prototype.readSync=function(t,e,i,r){try{var n=M(t),o=null===r?void 0:r;return this._FS.read(this._stream,n,e,i,o)}catch(t){throw t3(t,this._path)}},e.prototype.sync=function(t){t()},e.prototype.syncSync=function(){},e.prototype.chown=function(t,e,i){var r=null;try{this.chownSync(t,e)}catch(t){r=t}finally{i(r)}},e.prototype.chownSync=function(t,e){try{this._FS.fchown(this._stream.fd,t,e)}catch(t){throw t3(t,this._path)}},e.prototype.chmod=function(t,e){var i=null;try{this.chmodSync(t)}catch(t){i=t}finally{e(i)}},e.prototype.chmodSync=function(t){try{this._FS.fchmod(this._stream.fd,t)}catch(t){throw t3(t,this._path)}},e.prototype.utimes=function(t,e,i){var r=null;try{this.utimesSync(t,e)}catch(t){r=t}finally{i(r)}},e.prototype.utimesSync=function(t,e){this._fs.utimesSync(this._path,t,e)},e}(Q),t8=function(e){function i(t){e.call(this),this._FS=t}return e&&(i.__proto__=e),i.prototype=Object.create(e&&e.prototype),i.prototype.constructor=i,i.Create=function(t,e){e(null,new i(t.FS))},i.isAvailable=function(){return!0},i.prototype.getName=function(){return this._FS.DB_NAME()},i.prototype.isReadOnly=function(){return!1},i.prototype.supportsLinks=function(){return!0},i.prototype.supportsProps=function(){return!0},i.prototype.supportsSynch=function(){return!0},i.prototype.renameSync=function(t,e){try{this._FS.rename(t,e)}catch(i){throw i.errno===l.ENOENT?t3(i,this.existsSync(t)?e:t):t3(i)}},i.prototype.statSync=function(t,e){try{var i=e?this._FS.lstat(t):this._FS.stat(t),r=this.modeToFileType(i.mode);return new w(r,i.size,i.mode,i.atime,i.mtime,i.ctime)}catch(e){throw t3(e,t)}},i.prototype.openSync=function(t,e,i){try{var r=this._FS.open(t,e.getFlagString(),i);if(this._FS.isDir(r.node.mode))throw this._FS.close(r),p.EISDIR(t);return new t6(this,this._FS,t,r)}catch(e){throw t3(e,t)}},i.prototype.unlinkSync=function(t){try{this._FS.unlink(t)}catch(e){throw t3(e,t)}},i.prototype.rmdirSync=function(t){try{this._FS.rmdir(t)}catch(e){throw t3(e,t)}},i.prototype.mkdirSync=function(t,e){try{this._FS.mkdir(t,e)}catch(e){throw t3(e,t)}},i.prototype.readdirSync=function(t){try{return this._FS.readdir(t).filter(function(t){return"."!==t&&".."!==t})}catch(e){throw t3(e,t)}},i.prototype.truncateSync=function(t,e){try{this._FS.truncate(t,e)}catch(e){throw t3(e,t)}},i.prototype.readFileSync=function(t,e,i){try{var r=K(this._FS.readFile(t,{flags:i.getFlagString()}));return e?r.toString(e):r}catch(e){throw t3(e,t)}},i.prototype.writeFileSync=function(e,i,r,n,o){try{r&&(i=t.from(i,r));var s=M(i);this._FS.writeFile(e,s,{flags:n.getFlagString(),encoding:"binary"}),this._FS.chmod(e,o)}catch(t){throw t3(t,e)}},i.prototype.chmodSync=function(t,e,i){try{e?this._FS.lchmod(t,i):this._FS.chmod(t,i)}catch(e){throw t3(e,t)}},i.prototype.chownSync=function(t,e,i,r){try{e?this._FS.lchown(t,i,r):this._FS.chown(t,i,r)}catch(e){throw t3(e,t)}},i.prototype.symlinkSync=function(t,e,i){try{this._FS.symlink(t,e)}catch(t){throw t3(t)}},i.prototype.readlinkSync=function(t){try{return this._FS.readlink(t)}catch(e){throw t3(e,t)}},i.prototype.utimesSync=function(t,e,i){try{this._FS.utime(t,e.getTime(),i.getTime())}catch(e){throw t3(e,t)}},i.prototype.modeToFileType=function(t){if(this._FS.isDir(t))return v.DIRECTORY;if(this._FS.isFile(t))return v.FILE;if(this._FS.isLink(t))return v.SYMLINK;throw p.EPERM("Invalid mode: "+t)},i}(Z);t8.Name="EmscriptenFileSystem",t8.Options={FS:{type:"object",description:"The Emscripten file system to use (the `FS` variable)"}};var t4=function(t){function e(e,i){t.call(this),this._folder=e,this._wrapped=i}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){i(null,new e(t.folder,t.wrapped))},e.isAvailable=function(){return!0},e.prototype.initialize=function(t){var e=this;this._wrapped.exists(this._folder,function(i){i?t():e._wrapped.isReadOnly()?t(p.ENOENT(e._folder)):e._wrapped.mkdir(e._folder,511,t)})},e.prototype.getName=function(){return this._wrapped.getName()},e.prototype.isReadOnly=function(){return this._wrapped.isReadOnly()},e.prototype.supportsProps=function(){return this._wrapped.supportsProps()},e.prototype.supportsSynch=function(){return this._wrapped.supportsSynch()},e.prototype.supportsLinks=function(){return!1},e}(G);function t7(t,e){if(null!==e&&"object"==typeof e){var i=e.path;i&&(i="/"+c.relative(t,i),e.message=e.message.replace(e.path,i),e.path=i)}return e}function t9(t,e,i){return"Sync"!==t.slice(t.length-4)?function(){var r,n;return arguments.length>0&&(e&&(arguments[0]=c.join(this._folder,arguments[0])),i&&(arguments[1]=c.join(this._folder,arguments[1])),arguments[arguments.length-1]=(r=this._folder,"function"==typeof(n=arguments[arguments.length-1])?function(t){arguments.length>0&&(arguments[0]=t7(r,t)),n.apply(null,arguments)}:n)),this._wrapped[t].apply(this._wrapped,arguments)}:function(){try{return e&&(arguments[0]=c.join(this._folder,arguments[0])),i&&(arguments[1]=c.join(this._folder,arguments[1])),this._wrapped[t].apply(this._wrapped,arguments)}catch(t){throw t7(this._folder,t)}}}t4.Name="FolderAdapter",t4.Options={folder:{type:"string",description:"The folder to use as the root directory"},wrapped:{type:"object",description:"The file system to wrap"}},["diskSpace","stat","statSync","open","openSync","unlink","unlinkSync","rmdir","rmdirSync","mkdir","mkdirSync","readdir","readdirSync","exists","existsSync","realpath","realpathSync","truncate","truncateSync","readFile","readFileSync","writeFile","writeFileSync","appendFile","appendFileSync","chmod","chmodSync","chown","chownSync","utimes","utimesSync","readlink","readlinkSync"].forEach(function(t){t4.prototype[t]=t9(t,!0,!1)}),["rename","renameSync","link","linkSync","symlink","symlinkSync"].forEach(function(t){t4.prototype[t]=t9(t,!0,!0)});var et="undefined"!=typeof window?window:"undefined"!=typeof self?self:r,ee=et.webkitRequestFileSystem||et.requestFileSystem||null;function ei(t,e,i){switch(t.name){case"PathExistsError":return p.EEXIST(e);case"QuotaExceededError":return p.FileError(l.ENOSPC,e);case"NotFoundError":return p.ENOENT(e);case"SecurityError":return p.FileError(l.EACCES,e);case"InvalidModificationError":return p.FileError(l.EPERM,e);case"TypeMismatchError":return p.FileError(i?l.ENOTDIR:l.EISDIR,e);default:return p.FileError(l.EINVAL,e)}}var er=function(t){function e(e,i,r,n,o,s){t.call(this,e,r,n,o,s),this._entry=i}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.sync=function(t){var e=this;if(!this.isDirty())return t();this._entry.createWriter(function(i){var r=e.getBuffer(),n=new Blob([L(r)]),o=n.size;i.onwriteend=function(r){i.onwriteend=null,i.onerror=null,i.truncate(o),e.resetDirty(),t()},i.onerror=function(i){t(ei(i,e.getPath(),!1))},i.write(n)})},e.prototype.close=function(t){this.sync(t)},e}($),en=function(t){function e(i,r,n){void 0===i&&(i=5),void 0===r&&(r=et.PERSISTENT),void 0===n&&(n=!0),t.call(this),this.size=1048576*i,this.type=r,R(n,e.Name,{size:i,type:r})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){var r=new e(t.size,t.type,!1);r.allocate(function(t){return t?i(t):i(null,r)},!1)},e.isAvailable=function(){return!!ee},e.prototype.getName=function(){return e.Name},e.prototype.isReadOnly=function(){return!1},e.prototype.supportsSymlinks=function(){return!1},e.prototype.supportsProps=function(){return!1},e.prototype.supportsSynch=function(){return!1},e.prototype.allocate=function(t,e){var i=this;void 0===t&&(t=function(){}),void 0===e&&(e=!0),e&&console.warn("[HTML5FS] HTML5FS.allocate() is deprecated and will be removed in the next major release. Please use 'HTML5FS.Create({type: "+this.type+", size: "+this.size+"}, cb)' to create and allocate HTML5FS instances.");var r=function(e){i.fs=e,t()},n=function(e){t(ei(e,"/",!0))};this.type===et.PERSISTENT?function(t,e,i,r){if(void 0!==navigator.webkitPersistentStorage)switch(t){case et.PERSISTENT:navigator.webkitPersistentStorage.requestQuota(e,i,r);break;case et.TEMPORARY:navigator.webkitTemporaryStorage.requestQuota(e,i,r);break;default:r(TypeError("Invalid storage type: "+t))}else et.webkitStorageInfo.requestQuota(t,e,i,r)}(this.type,this.size,function(t){ee(i.type,t,r,n)},n):ee(this.type,this.size,r,n)},e.prototype.empty=function(t){this._readdir("/",function(e,i){e?(console.error("Failed to empty FS"),t(e)):t0(i,function(t,e){var i=function(){e()},r=function(i){e(ei(i,t.fullPath,!t.isDirectory))};t.isDirectory?t.removeRecursively(i,r):t.remove(i,r)},function(i){e?(console.error("Failed to empty FS"),t(e)):t()})})},e.prototype.rename=function(t,e,i){var r=this,n=2,o=0,s=this.fs.root,a=t,u=function(t){--n<=0&&i(ei(t,a,!1))},h=function(n){return 2==++o?i(new p(l.EINVAL,"Something was identified as both a file and a directory. This should never happen.")):t===e?i():(a=c.dirname(e),void s.getDirectory(a,{},function(o){a=c.basename(e),n.moveTo(o,a,function(t){i()},function(o){n.isDirectory?(a=e,r.unlink(e,function(n){n?u(o):r.rename(t,e,i)})):u(o)})},u))};s.getFile(t,{},h,u),s.getDirectory(t,{},h,u)},e.prototype.stat=function(t,e,i){var r=this,n={create:!1},o=function(t){i(null,new w(v.DIRECTORY,4096))},s=function(e){i(ei(e,t,!1))};this.fs.root.getFile(t,n,function(t){t.file(function(t){i(null,new w(v.FILE,t.size))},s)},function(){r.fs.root.getDirectory(t,n,o,s)})},e.prototype.open=function(t,e,i,r){var n=this,o=function(i){"InvalidModificationError"===i.name&&e.isExclusive()?r(p.EEXIST(t)):r(ei(i,t,!1))};this.fs.root.getFile(t,{create:e.pathNotExistsAction()===f.CREATE_FILE,exclusive:e.isExclusive()},function(i){i.file(function(s){var a=new FileReader;a.onloadend=function(o){r(null,n._makeFile(t,i,e,s,a.result))},a.onerror=function(t){o(a.error)},a.readAsArrayBuffer(s)},o)},o)},e.prototype.unlink=function(t,e){this._remove(t,e,!0)},e.prototype.rmdir=function(t,e){var i=this;this.readdir(t,function(r,n){r?e(r):n.length>0?e(p.ENOTEMPTY(t)):i._remove(t,e,!1)})},e.prototype.mkdir=function(t,e,i){this.fs.root.getDirectory(t,{create:!0,exclusive:!0},function(t){i()},function(e){i(ei(e,t,!0))})},e.prototype.readdir=function(t,e){this._readdir(t,function(t,i){if(!i)return e(t);for(var r=[],n=0;n<i.length;n+=1){var o=i[n];r.push(o.name)}e(null,r)})},e.prototype._makeFile=function(t,e,i,r,n){void 0===n&&(n=new ArrayBuffer(0));var o=new w(v.FILE,r.size),s=U(n);return new er(this,e,t,i,o,s)},e.prototype._readdir=function(t,e){var i=function(i){e(ei(i,t,!0))};this.fs.root.getDirectory(t,{create:!1},function(t){var r=t.createReader(),n=[],o=function(){r.readEntries(function(t){t.length?(n=n.concat(Array.prototype.slice.call(t||[],0)),o()):e(null,n)},i)};o()},i)},e.prototype._remove=function(t,e,i){var r=function(r){r.remove(function(){e()},function(r){e(ei(r,t,!i))})},n=function(r){e(ei(r,t,!i))},o={create:!1};i?this.fs.root.getFile(t,o,r,n):this.fs.root.getDirectory(t,o,r,n)},e}(G);en.Name="HTML5FS",en.Options={size:{type:"number",optional:!0,description:"Storage quota to request, in megabytes. Allocated value may be less. Defaults to 5."},type:{type:"number",optional:!0,description:"window.PERSISTENT or window.TEMPORARY. Defaults to PERSISTENT."}};var eo=function(t,e,i,r,n,o){this.id=t,this.size=e,this.mode=i,this.atime=r,this.mtime=n,this.ctime=o};eo.fromBuffer=function(t){if(void 0===t)throw Error("NO");return new eo(t.toString("ascii",30),t.readUInt32LE(0),t.readUInt16LE(4),t.readDoubleLE(6),t.readDoubleLE(14),t.readDoubleLE(22))},eo.prototype.toStats=function(){return new w((61440&this.mode)===v.DIRECTORY?v.DIRECTORY:v.FILE,this.size,this.mode,new Date(this.atime),new Date(this.mtime),new Date(this.ctime))},eo.prototype.getSize=function(){return 30+this.id.length},eo.prototype.toBuffer=function(e){return void 0===e&&(e=t.alloc(this.getSize())),e.writeUInt32LE(this.size,0),e.writeUInt16LE(this.mode,4),e.writeDoubleLE(this.atime,6),e.writeDoubleLE(this.mtime,14),e.writeDoubleLE(this.ctime,22),e.write(this.id,30,this.id.length,"ascii"),e},eo.prototype.update=function(t){var e=!1;this.size!==t.size&&(this.size=t.size,e=!0),this.mode!==t.mode&&(this.mode=t.mode,e=!0);var i=t.atime.getTime();this.atime!==i&&(this.atime=i,e=!0);var r=t.mtime.getTime();this.mtime!==r&&(this.mtime=r,e=!0);var n=t.ctime.getTime();return this.ctime!==n&&(this.ctime=n,e=!0),e},eo.prototype.isFile=function(){return(61440&this.mode)===v.FILE},eo.prototype.isDirectory=function(){return(61440&this.mode)===v.DIRECTORY};var es=null;function ea(){return es||(es=t.from("{}"))}function el(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function eu(t,e){return!t||(e(t),!1)}function ec(t,e,i){return!t||(e.abort(function(){i(t)}),!1)}var eh=function(t){this.store=t,this.originalData={},this.modifiedKeys=[]};eh.prototype.get=function(t){var e=this.store.get(t);return this.stashOldValue(t,e),e},eh.prototype.put=function(t,e,i){return this.markModified(t),this.store.put(t,e,i)},eh.prototype.del=function(t){this.markModified(t),this.store.del(t)},eh.prototype.commit=function(){},eh.prototype.abort=function(){for(var t=0,e=this.modifiedKeys;t<e.length;t+=1){var i=e[t],r=this.originalData[i];r?this.store.put(i,r,!0):this.store.del(i)}},eh.prototype.stashOldValue=function(t,e){this.originalData.hasOwnProperty(t)||(this.originalData[t]=e)},eh.prototype.markModified=function(t){-1===this.modifiedKeys.indexOf(t)&&(this.modifiedKeys.push(t),this.originalData.hasOwnProperty(t)||(this.originalData[t]=this.store.get(t)))};var ed=function(t){function e(e,i,r,n,o){t.call(this,e,i,r,n,o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.syncSync=function(){this.isDirty()&&(this._fs._syncSync(this.getPath(),this.getBuffer(),this.getStats()),this.resetDirty())},e.prototype.closeSync=function(){this.syncSync()},e}($),ef=function(e){function i(t){e.call(this),this.store=t.store,this.makeRootDirectory()}return e&&(i.__proto__=e),i.prototype=Object.create(e&&e.prototype),i.prototype.constructor=i,i.isAvailable=function(){return!0},i.prototype.getName=function(){return this.store.name()},i.prototype.isReadOnly=function(){return!1},i.prototype.supportsSymlinks=function(){return!1},i.prototype.supportsProps=function(){return!1},i.prototype.supportsSynch=function(){return!0},i.prototype.empty=function(){this.store.clear(),this.makeRootDirectory()},i.prototype.renameSync=function(e,i){var r=this.store.beginTransaction("readwrite"),n=c.dirname(e),o=c.basename(e),s=c.dirname(i),a=c.basename(i),u=this.findINode(r,n),h=this.getDirListing(r,n,u);if(!h[o])throw p.ENOENT(e);var d,f,y=h[o];if(delete h[o],0===(s+"/").indexOf(e+"/"))throw new p(l.EBUSY,n);if(s===n?(d=u,f=h):(d=this.findINode(r,s),f=this.getDirListing(r,s,d)),f[a]){var g=this.getINode(r,i,f[a]);if(!g.isFile())throw p.EPERM(i);try{r.del(g.id),r.del(f[a])}catch(t){throw r.abort(),t}}f[a]=y;try{r.put(u.id,t.from(JSON.stringify(h)),!0),r.put(d.id,t.from(JSON.stringify(f)),!0)}catch(t){throw r.abort(),t}r.commit()},i.prototype.statSync=function(t,e){return this.findINode(this.store.beginTransaction("readonly"),t).toStats()},i.prototype.createFileSync=function(t,e,i){var r=this.store.beginTransaction("readwrite"),n=V(),o=this.commitNewFile(r,t,v.FILE,i,n);return new ed(this,t,e,o.toStats(),n)},i.prototype.openFileSync=function(t,e){var i=this.store.beginTransaction("readonly"),r=this.findINode(i,t),n=i.get(r.id);if(void 0===n)throw p.ENOENT(t);return new ed(this,t,e,r.toStats(),n)},i.prototype.unlinkSync=function(t){this.removeEntry(t,!1)},i.prototype.rmdirSync=function(t){if(this.readdirSync(t).length>0)throw p.ENOTEMPTY(t);this.removeEntry(t,!0)},i.prototype.mkdirSync=function(e,i){var r=this.store.beginTransaction("readwrite"),n=t.from("{}");this.commitNewFile(r,e,v.DIRECTORY,i,n)},i.prototype.readdirSync=function(t){var e=this.store.beginTransaction("readonly");return Object.keys(this.getDirListing(e,t,this.findINode(e,t)))},i.prototype._syncSync=function(t,e,i){var r=this.store.beginTransaction("readwrite"),n=this._findINode(r,c.dirname(t),c.basename(t)),o=this.getINode(r,t,n),s=o.update(i);try{r.put(o.id,e,!0),s&&r.put(n,o.toBuffer(),!0)}catch(t){throw r.abort(),t}r.commit()},i.prototype.makeRootDirectory=function(){var t=this.store.beginTransaction("readwrite");if(void 0===t.get("/")){var e=(new Date).getTime(),i=new eo(el(),4096,511|v.DIRECTORY,e,e,e);t.put(i.id,ea(),!1),t.put("/",i.toBuffer(),!1),t.commit()}},i.prototype._findINode=function(t,e,i){var r=this,n=function(n){var o=r.getDirListing(t,e,n);if(o[i])return o[i];throw p.ENOENT(c.resolve(e,i))};return"/"===e?""===i?"/":n(this.getINode(t,e,"/")):n(this.getINode(t,e+c.sep+i,this._findINode(t,c.dirname(e),c.basename(e))))},i.prototype.findINode=function(t,e){return this.getINode(t,e,this._findINode(t,c.dirname(e),c.basename(e)))},i.prototype.getINode=function(t,e,i){var r=t.get(i);if(void 0===r)throw p.ENOENT(e);return eo.fromBuffer(r)},i.prototype.getDirListing=function(t,e,i){if(!i.isDirectory())throw p.ENOTDIR(e);var r=t.get(i.id);if(void 0===r)throw p.ENOENT(e);return JSON.parse(r.toString())},i.prototype.addNewNode=function(t,e){for(var i;;)try{return i=el(),t.put(i,e,!1),i}catch(t){}throw new p(l.EIO,"Unable to commit data to key-value store.")},i.prototype.commitNewFile=function(e,i,r,n,o){var s,a=c.dirname(i),l=c.basename(i),u=this.findINode(e,a),h=this.getDirListing(e,a,u),d=(new Date).getTime();if("/"===i||h[l])throw p.EEXIST(i);try{var f=this.addNewNode(e,o);s=new eo(f,o.length,n|r,d,d,d);var y=this.addNewNode(e,s.toBuffer());h[l]=y,e.put(u.id,t.from(JSON.stringify(h)),!0)}catch(t){throw e.abort(),t}return e.commit(),s},i.prototype.removeEntry=function(e,i){var r=this.store.beginTransaction("readwrite"),n=c.dirname(e),o=this.findINode(r,n),s=this.getDirListing(r,n,o),a=c.basename(e);if(!s[a])throw p.ENOENT(e);var l=s[a];delete s[a];var u=this.getINode(r,e,l);if(!i&&u.isDirectory())throw p.EISDIR(e);if(i&&!u.isDirectory())throw p.ENOTDIR(e);try{r.del(u.id),r.del(l),r.put(o.id,t.from(JSON.stringify(s)),!0)}catch(t){throw r.abort(),t}r.commit()},i}(Z),ep=function(t){function e(e,i,r,n,o){t.call(this,e,i,r,n,o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.sync=function(t){var e=this;this.isDirty()?this._fs._sync(this.getPath(),this.getBuffer(),this.getStats(),function(i){i||e.resetDirty(),t(i)}):t()},e.prototype.close=function(t){this.sync(t)},e}($),ey=function(e){function i(){e.apply(this,arguments)}return e&&(i.__proto__=e),i.prototype=Object.create(e&&e.prototype),i.prototype.constructor=i,i.isAvailable=function(){return!0},i.prototype.init=function(t,e){this.store=t,this.makeRootDirectory(e)},i.prototype.getName=function(){return this.store.name()},i.prototype.isReadOnly=function(){return!1},i.prototype.supportsSymlinks=function(){return!1},i.prototype.supportsProps=function(){return!1},i.prototype.supportsSynch=function(){return!1},i.prototype.empty=function(t){var e=this;this.store.clear(function(i){eu(i,t)&&e.makeRootDirectory(t)})},i.prototype.rename=function(e,i,r){var n=this,o=this.store.beginTransaction("readwrite"),s=c.dirname(e),a=c.basename(e),u=c.dirname(i),h=c.basename(i),d={},f={},y=!1;if(0===(u+"/").indexOf(e+"/"))return r(new p(l.EBUSY,s));var g=function(l){n.findINodeAndDirListing(o,l,function(c,g,v){c?y||(y=!0,o.abort(function(){r(c)})):(d[l]=g,f[l]=v,function(){if(!y&&f.hasOwnProperty(s)&&f.hasOwnProperty(u)){var l=f[s],c=d[s],g=f[u],v=d[u];if(l[a]){var m=l[a];delete l[a];var w=function(){g[h]=m,o.put(c.id,t.from(JSON.stringify(l)),!0,function(e){ec(e,o,r)&&(s===u?o.commit(r):o.put(v.id,t.from(JSON.stringify(g)),!0,function(t){ec(t,o,r)&&o.commit(r)}))})};g[h]?n.getINode(o,i,g[h],function(t,e){ec(t,o,r)&&(e.isFile()?o.del(e.id,function(t){ec(t,o,r)&&o.del(g[h],function(t){ec(t,o,r)&&w()})}):o.abort(function(t){r(p.EPERM(i))}))}):w()}else r(p.ENOENT(e))}}())})};g(s),s!==u&&g(u)},i.prototype.stat=function(t,e,i){var r=this.store.beginTransaction("readonly");this.findINode(r,t,function(t,e){eu(t,i)&&i(null,e.toStats())})},i.prototype.createFile=function(t,e,i,r){var n=this,o=this.store.beginTransaction("readwrite"),s=V();this.commitNewFile(o,t,v.FILE,i,s,function(i,o){eu(i,r)&&r(null,new ep(n,t,e,o.toStats(),s))})},i.prototype.openFile=function(t,e,i){var r=this,n=this.store.beginTransaction("readonly");this.findINode(n,t,function(o,s){eu(o,i)&&n.get(s.id,function(n,o){eu(n,i)&&(void 0===o?i(p.ENOENT(t)):i(null,new ep(r,t,e,s.toStats(),o)))})})},i.prototype.unlink=function(t,e){this.removeEntry(t,!1,e)},i.prototype.rmdir=function(t,e){var i=this;this.readdir(t,function(r,n){r?e(r):n.length>0?e(p.ENOTEMPTY(t)):i.removeEntry(t,!0,e)})},i.prototype.mkdir=function(e,i,r){var n=this.store.beginTransaction("readwrite"),o=t.from("{}");this.commitNewFile(n,e,v.DIRECTORY,i,o,r)},i.prototype.readdir=function(t,e){var i=this,r=this.store.beginTransaction("readonly");this.findINode(r,t,function(n,o){eu(n,e)&&i.getDirListing(r,t,o,function(t,i){eu(t,e)&&e(null,Object.keys(i))})})},i.prototype._sync=function(t,e,i,r){var n=this,o=this.store.beginTransaction("readwrite");this._findINode(o,c.dirname(t),c.basename(t),function(s,a){ec(s,o,r)&&n.getINode(o,t,a,function(t,n){if(ec(t,o,r)){var s=n.update(i);o.put(n.id,e,!0,function(t){ec(t,o,r)&&(s?o.put(a,n.toBuffer(),!0,function(t){ec(t,o,r)&&o.commit(r)}):o.commit(r))})}})})},i.prototype.makeRootDirectory=function(t){var e=this.store.beginTransaction("readwrite");e.get("/",function(i,r){if(i||void 0===r){var n=(new Date).getTime(),o=new eo(el(),4096,511|v.DIRECTORY,n,n,n);e.put(o.id,ea(),!1,function(i){ec(i,e,t)&&e.put("/",o.toBuffer(),!1,function(i){i?e.abort(function(){t(i)}):e.commit(t)})})}else e.commit(t)})},i.prototype._findINode=function(t,e,i,r){var n=this,o=function(t,n,o){t?r(t):o[i]?r(null,o[i]):r(p.ENOENT(c.resolve(e,i)))};"/"===e?""===i?r(null,"/"):this.getINode(t,e,"/",function(i,s){eu(i,r)&&n.getDirListing(t,e,s,function(t,e){o(t,0,e)})}):this.findINodeAndDirListing(t,e,o)},i.prototype.findINode=function(t,e,i){var r=this;this._findINode(t,c.dirname(e),c.basename(e),function(n,o){eu(n,i)&&r.getINode(t,e,o,i)})},i.prototype.getINode=function(t,e,i,r){t.get(i,function(t,i){eu(t,r)&&(void 0===i?r(p.ENOENT(e)):r(null,eo.fromBuffer(i)))})},i.prototype.getDirListing=function(t,e,i,r){i.isDirectory()?t.get(i.id,function(t,i){if(eu(t,r))try{r(null,JSON.parse(i.toString()))}catch(t){r(p.ENOENT(e))}}):r(p.ENOTDIR(e))},i.prototype.findINodeAndDirListing=function(t,e,i){var r=this;this.findINode(t,e,function(n,o){eu(n,i)&&r.getDirListing(t,e,o,function(t,e){eu(t,i)&&i(null,o,e)})})},i.prototype.addNewNode=function(t,e,i){var r,n=0,o=function(){5==++n?i(new p(l.EIO,"Unable to commit data to key-value store.")):(r=el(),t.put(r,e,!1,function(t,e){t||!e?o():i(null,r)}))};o()},i.prototype.commitNewFile=function(e,i,r,n,o,s){var a=this,l=c.dirname(i),u=c.basename(i),h=(new Date).getTime();if("/"===i)return s(p.EEXIST(i));this.findINodeAndDirListing(e,l,function(l,c,d){ec(l,e,s)&&(d[u]?e.abort(function(){s(p.EEXIST(i))}):a.addNewNode(e,o,function(i,l){if(ec(i,e,s)){var f=new eo(l,o.length,n|r,h,h,h);a.addNewNode(e,f.toBuffer(),function(i,r){ec(i,e,s)&&(d[u]=r,e.put(c.id,t.from(JSON.stringify(d)),!0,function(t){ec(t,e,s)&&e.commit(function(t){ec(t,e,s)&&s(null,f)})}))})}}))})},i.prototype.removeEntry=function(e,i,r){var n=this,o=this.store.beginTransaction("readwrite"),s=c.dirname(e),a=c.basename(e);this.findINodeAndDirListing(o,s,function(s,l,u){if(ec(s,o,r)){if(u[a]){var c=u[a];delete u[a],n.getINode(o,e,c,function(n,s){ec(n,o,r)&&(!i&&s.isDirectory()?o.abort(function(){r(p.EISDIR(e))}):i&&!s.isDirectory()?o.abort(function(){r(p.ENOTDIR(e))}):o.del(s.id,function(e){ec(e,o,r)&&o.del(c,function(e){ec(e,o,r)&&o.put(l.id,t.from(JSON.stringify(u)),!0,function(t){ec(t,o,r)&&o.commit(r)})})}))})}else o.abort(function(){r(p.ENOENT(e))})}})},i}(G),eg=function(){this.store={}};eg.prototype.name=function(){return ev.Name},eg.prototype.clear=function(){this.store={}},eg.prototype.beginTransaction=function(t){return new eh(this)},eg.prototype.get=function(t){return this.store[t]},eg.prototype.put=function(t,e,i){return!(!i&&this.store.hasOwnProperty(t)||(this.store[t]=e,0))},eg.prototype.del=function(t){delete this.store[t]};var ev=function(t){function e(){t.call(this,{store:new eg})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){i(null,new e)},e}(ef);ev.Name="InMemory",ev.Options={};var em=et.indexedDB||et.mozIndexedDB||et.webkitIndexedDB||et.msIndexedDB;function ew(t,e){switch(void 0===e&&(e=t.toString()),t.name){case"NotFoundError":return new p(l.ENOENT,e);case"QuotaExceededError":return new p(l.ENOSPC,e);default:return new p(l.EIO,e)}}function eS(t,e,i){return void 0===e&&(e=l.EIO),void 0===i&&(i=null),function(r){r.preventDefault(),t(new p(e,null!==i?i:void 0))}}var eb=function(t,e){this.tx=t,this.store=e};eb.prototype.get=function(t,e){try{var i=this.store.get(t);i.onerror=eS(e),i.onsuccess=function(t){var i=t.target.result;e(null,void 0===i?i:U(i))}}catch(t){e(ew(t))}};var eE=function(t){function e(e,i){t.call(this,e,i)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.put=function(t,e,i,r){try{var n,o=L(e);(n=i?this.store.put(o,t):this.store.add(o,t)).onerror=eS(r),n.onsuccess=function(t){r(null,!0)}}catch(t){r(ew(t))}},e.prototype.del=function(t,e){try{var i=this.store.delete(t);i.onerror=eS(e),i.onsuccess=function(t){e()}}catch(t){e(ew(t))}},e.prototype.commit=function(t){setTimeout(t,0)},e.prototype.abort=function(t){var e=null;try{this.tx.abort()}catch(t){e=ew(t)}finally{t(e)}},e}(eb),eI=function(t,e){var i=this;void 0===e&&(e="browserfs"),this.storeName=e;var r=em.open(this.storeName,1);r.onupgradeneeded=function(t){var e=t.target.result;e.objectStoreNames.contains(i.storeName)&&e.deleteObjectStore(i.storeName),e.createObjectStore(i.storeName)},r.onsuccess=function(e){i.db=e.target.result,t(null,i)},r.onerror=eS(t,l.EACCES)};eI.prototype.name=function(){return e_.Name+" - "+this.storeName},eI.prototype.clear=function(t){try{var e=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).clear();e.onsuccess=function(e){setTimeout(t,0)},e.onerror=eS(t)}catch(e){t(ew(e))}},eI.prototype.beginTransaction=function(t){void 0===t&&(t="readonly");var e=this.db.transaction(this.storeName,t),i=e.objectStore(this.storeName);if("readwrite"===t)return new eE(e,i);if("readonly"===t)return new eb(e,i);throw new p(l.EINVAL,"Invalid transaction type.")};var e_=function(t){function e(i,r,n){var o=this;void 0===n&&(n=!0),t.call(this),this.store=new eI(function(t){t?i(t):o.init(o.store,function(t){i(t,o)})},r),R(n,e.Name,{storeName:r})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){new e(i,t.storeName,!1)},e.isAvailable=function(){try{return void 0!==em&&null!==em.open("__browserfs_test__")}catch(t){return!1}},e}(ey);e_.Name="IndexedDB",e_.Options={storeName:{type:"string",optional:!0,description:"The name of this file system. You can have multiple IndexedDB file systems operating at once, but each must have a different name."}};var eD,eT=!1;try{et.localStorage.setItem("__test__",String.fromCharCode(55296)),eT=et.localStorage.getItem("__test__")===String.fromCharCode(55296)}catch(t){eT=!1}eD=eT?"binary_string":"binary_string_ie",t.isEncoding(eD)||(eD="base64");var eA=function(){};eA.prototype.name=function(){return ex.Name},eA.prototype.clear=function(){et.localStorage.clear()},eA.prototype.beginTransaction=function(t){return new eh(this)},eA.prototype.get=function(e){try{var i=et.localStorage.getItem(e);if(null!==i)return t.from(i,eD)}catch(t){}},eA.prototype.put=function(t,e,i){try{return!(!i&&null!==et.localStorage.getItem(t)||(et.localStorage.setItem(t,e.toString(eD)),0))}catch(t){throw new p(l.ENOSPC,"LocalStorage is full.")}},eA.prototype.del=function(t){try{et.localStorage.removeItem(t)}catch(e){throw new p(l.EIO,"Unable to delete key "+t+": "+e)}};var ex=function(t){function e(){t.call(this,{store:new eA})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){i(null,new e)},e.isAvailable=function(){return void 0!==et.localStorage},e}(ef);ex.Name="LocalStorage",ex.Options={};var eO=function(t){function e(){t.call(this),this.mountList=[],this.mntMap={},this.rootFs=new ev}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){var r=new e;Object.keys(t).forEach(function(e){r.mount(e,t[e])}),i(null,r)},e.isAvailable=function(){return!0},e.prototype.mount=function(t,e){if("/"!==t[0]&&(t="/"+t),t=c.resolve(t),this.mntMap[t])throw new p(l.EINVAL,"Mount point "+t+" is already taken.");F(t,511,this.rootFs),this.mntMap[t]=e,this.mountList.push(t),this.mountList=this.mountList.sort(function(t,e){return e.length-t.length})},e.prototype.umount=function(t){if("/"!==t[0]&&(t="/"+t),t=c.resolve(t),!this.mntMap[t])throw new p(l.EINVAL,"Mount point "+t+" is already unmounted.");for(delete this.mntMap[t],this.mountList.splice(this.mountList.indexOf(t),1);"/"!==t&&0===this.rootFs.readdirSync(t).length;)this.rootFs.rmdirSync(t),t=c.dirname(t)},e.prototype._getFs=function(t){for(var e=this.mountList,i=e.length,r=0;r<i;r++){var n=e[r];if(n.length<=t.length&&0===t.indexOf(n))return""===(t=t.substr(n.length>1?n.length:0))&&(t="/"),{fs:this.mntMap[n],path:t}}return{fs:this.rootFs,path:t}},e.prototype.getName=function(){return e.Name},e.prototype.diskSpace=function(t,e){e(0,0)},e.prototype.isReadOnly=function(){return!1},e.prototype.supportsLinks=function(){return!1},e.prototype.supportsProps=function(){return!1},e.prototype.supportsSynch=function(){return!0},e.prototype.standardizeError=function(t,e,i){var r=t.message.indexOf(e);return -1!==r&&(t.message=t.message.substr(0,r)+i+t.message.substr(r+e.length),t.path=i),t},e.prototype.rename=function(t,e,i){var r=this,n=this._getFs(t),o=this._getFs(e);return n.fs===o.fs?n.fs.rename(n.path,o.path,function(s){s&&r.standardizeError(r.standardizeError(s,n.path,t),o.path,e),i(s)}):O.readFile(t,function(r,n){if(r)return i(r);O.writeFile(e,n,function(e){if(e)return i(e);O.unlink(t,i)})})},e.prototype.renameSync=function(t,e){var i=this._getFs(t),r=this._getFs(e);if(i.fs===r.fs)try{return i.fs.renameSync(i.path,r.path)}catch(n){throw this.standardizeError(this.standardizeError(n,i.path,t),r.path,e),n}var n=O.readFileSync(t);return O.writeFileSync(e,n),O.unlinkSync(t)},e.prototype.readdirSync=function(t){var e=this._getFs(t),i=null;if(e.fs!==this.rootFs)try{i=this.rootFs.readdirSync(t)}catch(t){}try{var r=e.fs.readdirSync(e.path);return null===i?r:r.concat(i.filter(function(t){return -1===r.indexOf(t)}))}catch(r){if(null===i)throw this.standardizeError(r,e.path,t);return i}},e.prototype.readdir=function(t,e){var i=this,r=this._getFs(t);r.fs.readdir(r.path,function(n,o){if(r.fs!==i.rootFs)try{var s=i.rootFs.readdirSync(t);o=o?o.concat(s.filter(function(t){return -1===o.indexOf(t)})):s}catch(o){if(n)return e(i.standardizeError(n,r.path,t))}else if(n)return e(i.standardizeError(n,r.path,t));e(null,o)})},e.prototype.rmdirSync=function(t){var e=this._getFs(t);if(this._containsMountPt(t))throw p.ENOTEMPTY(t);try{e.fs.rmdirSync(e.path)}catch(i){throw this.standardizeError(i,e.path,t)}},e.prototype.rmdir=function(t,e){var i=this,r=this._getFs(t);this._containsMountPt(t)?e(p.ENOTEMPTY(t)):r.fs.rmdir(r.path,function(n){e(n?i.standardizeError(n,r.path,t):null)})},e.prototype._containsMountPt=function(t){for(var e=this.mountList,i=e.length,r=0;r<i;r++){var n=e[r];if(n.length>=t.length&&n.slice(0,t.length)===t)return!0}return!1},e}(G);function eP(t,e,i){return e?function(){for(var e=[],i=arguments.length;i--;)e[i]=arguments[i];var r=e[0],n=this._getFs(r);e[0]=n.path;try{return n.fs[t].apply(n.fs,e)}catch(t){throw this.standardizeError(t,n.path,r),t}}:function(){for(var e=this,i=[],r=arguments.length;r--;)i[r]=arguments[r];var n=i[0],o=this._getFs(n);if(i[0]=o.path,"function"==typeof i[i.length-1]){var s=i[i.length-1];i[i.length-1]=function(){for(var t=[],i=arguments.length;i--;)t[i]=arguments[i];t.length>0&&t[0]instanceof p&&e.standardizeError(t[0],o.path,n),s.apply(null,t)}}return o.fs[t].apply(o.fs,i)}}eO.Name="MountableFileSystem",eO.Options={};for(var eR,ek=[["exists","unlink","readlink"],["stat","mkdir","realpath","truncate"],["open","readFile","chmod","utimes"],["chown"],["writeFile","appendFile"]],eN=0;eN<ek.length;eN++)for(var eC=0,eF=ek[eN];eC<eF.length;eC+=1){var eL=eF[eC];eO.prototype[eL]=eP(eL,!1),eO.prototype[eL+"Sync"]=eP(eL+"Sync",!0)}if("undefined"!=typeof setImmediate)eR=setImmediate;else{var eM=[],ej="zero-timeout-message";if(function(){if(void 0!==et.importScripts||!et.postMessage)return!1;var t=!0,e=et.onmessage;return et.onmessage=function(){t=!1},et.postMessage("","*"),et.onmessage=e,t}()){eR=function(t){eM.push(t),et.postMessage(ej,"*")};var eK=function(t){if(t.source===self&&t.data===ej&&(t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,eM.length>0))return eM.shift()()};et.addEventListener?et.addEventListener("message",eK,!0):et.attachEvent("onmessage",eK)}else if(et.MessageChannel){var eU=new et.MessageChannel;eU.port1.onmessage=function(t){if(eM.length>0)return eM.shift()()},eR=function(t){eM.push(t),eU.port2.postMessage("")}}else eR=function(t){return setTimeout(t,0)}}var eB=eR,ez=function(){this._locked=!1,this._waiters=[]};ez.prototype.lock=function(t){this._locked?this._waiters.push(t):(this._locked=!0,t())},ez.prototype.unlock=function(){if(!this._locked)throw Error("unlock of a non-locked mutex");var t=this._waiters.shift();t?eB(t):this._locked=!1},ez.prototype.tryLock=function(){return!this._locked&&(this._locked=!0,!0)},ez.prototype.isLocked=function(){return this._locked};var eV=function(t){this._fs=t,this._mu=new ez};eV.prototype.getName=function(){return"LockedFS<"+this._fs.getName()+">"},eV.prototype.getFSUnlocked=function(){return this._fs},eV.prototype.initialize=function(t){this._fs.initialize(t)},eV.prototype.diskSpace=function(t,e){this._fs.diskSpace(t,e)},eV.prototype.isReadOnly=function(){return this._fs.isReadOnly()},eV.prototype.supportsLinks=function(){return this._fs.supportsLinks()},eV.prototype.supportsProps=function(){return this._fs.supportsProps()},eV.prototype.supportsSynch=function(){return this._fs.supportsSynch()},eV.prototype.rename=function(t,e,i){var r=this;this._mu.lock(function(){r._fs.rename(t,e,function(t){r._mu.unlock(),i(t)})})},eV.prototype.renameSync=function(t,e){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.renameSync(t,e)},eV.prototype.stat=function(t,e,i){var r=this;this._mu.lock(function(){r._fs.stat(t,e,function(t,e){r._mu.unlock(),i(t,e)})})},eV.prototype.statSync=function(t,e){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.statSync(t,e)},eV.prototype.open=function(t,e,i,r){var n=this;this._mu.lock(function(){n._fs.open(t,e,i,function(t,e){n._mu.unlock(),r(t,e)})})},eV.prototype.openSync=function(t,e,i){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.openSync(t,e,i)},eV.prototype.unlink=function(t,e){var i=this;this._mu.lock(function(){i._fs.unlink(t,function(t){i._mu.unlock(),e(t)})})},eV.prototype.unlinkSync=function(t){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.unlinkSync(t)},eV.prototype.rmdir=function(t,e){var i=this;this._mu.lock(function(){i._fs.rmdir(t,function(t){i._mu.unlock(),e(t)})})},eV.prototype.rmdirSync=function(t){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.rmdirSync(t)},eV.prototype.mkdir=function(t,e,i){var r=this;this._mu.lock(function(){r._fs.mkdir(t,e,function(t){r._mu.unlock(),i(t)})})},eV.prototype.mkdirSync=function(t,e){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.mkdirSync(t,e)},eV.prototype.readdir=function(t,e){var i=this;this._mu.lock(function(){i._fs.readdir(t,function(t,r){i._mu.unlock(),e(t,r)})})},eV.prototype.readdirSync=function(t){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.readdirSync(t)},eV.prototype.exists=function(t,e){var i=this;this._mu.lock(function(){i._fs.exists(t,function(t){i._mu.unlock(),e(t)})})},eV.prototype.existsSync=function(t){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.existsSync(t)},eV.prototype.realpath=function(t,e,i){var r=this;this._mu.lock(function(){r._fs.realpath(t,e,function(t,e){r._mu.unlock(),i(t,e)})})},eV.prototype.realpathSync=function(t,e){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.realpathSync(t,e)},eV.prototype.truncate=function(t,e,i){var r=this;this._mu.lock(function(){r._fs.truncate(t,e,function(t){r._mu.unlock(),i(t)})})},eV.prototype.truncateSync=function(t,e){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.truncateSync(t,e)},eV.prototype.readFile=function(t,e,i,r){var n=this;this._mu.lock(function(){n._fs.readFile(t,e,i,function(t,e){n._mu.unlock(),r(t,e)})})},eV.prototype.readFileSync=function(t,e,i){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.readFileSync(t,e,i)},eV.prototype.writeFile=function(t,e,i,r,n,o){var s=this;this._mu.lock(function(){s._fs.writeFile(t,e,i,r,n,function(t){s._mu.unlock(),o(t)})})},eV.prototype.writeFileSync=function(t,e,i,r,n){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.writeFileSync(t,e,i,r,n)},eV.prototype.appendFile=function(t,e,i,r,n,o){var s=this;this._mu.lock(function(){s._fs.appendFile(t,e,i,r,n,function(t){s._mu.unlock(),o(t)})})},eV.prototype.appendFileSync=function(t,e,i,r,n){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.appendFileSync(t,e,i,r,n)},eV.prototype.chmod=function(t,e,i,r){var n=this;this._mu.lock(function(){n._fs.chmod(t,e,i,function(t){n._mu.unlock(),r(t)})})},eV.prototype.chmodSync=function(t,e,i){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.chmodSync(t,e,i)},eV.prototype.chown=function(t,e,i,r,n){var o=this;this._mu.lock(function(){o._fs.chown(t,e,i,r,function(t){o._mu.unlock(),n(t)})})},eV.prototype.chownSync=function(t,e,i,r){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.chownSync(t,e,i,r)},eV.prototype.utimes=function(t,e,i,r){var n=this;this._mu.lock(function(){n._fs.utimes(t,e,i,function(t){n._mu.unlock(),r(t)})})},eV.prototype.utimesSync=function(t,e,i){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.utimesSync(t,e,i)},eV.prototype.link=function(t,e,i){var r=this;this._mu.lock(function(){r._fs.link(t,e,function(t){r._mu.unlock(),i(t)})})},eV.prototype.linkSync=function(t,e){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.linkSync(t,e)},eV.prototype.symlink=function(t,e,i,r){var n=this;this._mu.lock(function(){n._fs.symlink(t,e,i,function(t){n._mu.unlock(),r(t)})})},eV.prototype.symlinkSync=function(t,e,i){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.symlinkSync(t,e,i)},eV.prototype.readlink=function(t,e){var i=this;this._mu.lock(function(){i._fs.readlink(t,function(t,r){i._mu.unlock(),e(t,r)})})},eV.prototype.readlinkSync=function(t){if(this._mu.isLocked())throw Error("invalid sync call");return this._fs.readlinkSync(t)};var eq="/.deletedFiles.log";function eW(t){return m.getFileFlag(t)}var eY,eH=function(t){function e(e,i,r,n,o){t.call(this,e,i,r,n,o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.sync=function(t){var e=this;this.isDirty()?this._fs._syncAsync(this,function(i){e.resetDirty(),t(i)}):t(null)},e.prototype.syncSync=function(){this.isDirty()&&(this._fs._syncSync(this),this.resetDirty())},e.prototype.close=function(t){this.sync(t)},e.prototype.closeSync=function(){this.syncSync()},e}($),eJ=function(t){function e(e,i){if(t.call(this),this._isInitialized=!1,this._initializeCallbacks=[],this._deletedFiles={},this._deleteLog="",this._deleteLogUpdatePending=!1,this._deleteLogUpdateNeeded=!1,this._deleteLogError=null,this._writable=e,this._readable=i,this._writable.isReadOnly())throw new p(l.EINVAL,"Writable file system must be writable.")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.isAvailable=function(){return!0},e.prototype.getOverlayedFileSystems=function(){return{readable:this._readable,writable:this._writable}},e.prototype._syncAsync=function(t,e){var i=this;this.createParentDirectoriesAsync(t.getPath(),function(r){if(r)return e(r);i._writable.writeFile(t.getPath(),t.getBuffer(),null,eW("w"),t.getStats().mode,e)})},e.prototype._syncSync=function(t){this.createParentDirectories(t.getPath()),this._writable.writeFileSync(t.getPath(),t.getBuffer(),null,eW("w"),t.getStats().mode)},e.prototype.getName=function(){return eX.Name},e.prototype.initialize=function(t){var e=this,i=this._initializeCallbacks,r=function(t){e._isInitialized=!t,e._initializeCallbacks=[],i.forEach(function(e){return e(t)})};if(this._isInitialized)return t();i.push(t),1===i.length&&this._writable.readFile(eq,"utf8",eW("r"),function(t,i){if(t){if(t.errno!==l.ENOENT)return r(t)}else e._deleteLog=i;e._reparseDeletionLog(),r()})},e.prototype.isReadOnly=function(){return!1},e.prototype.supportsSynch=function(){return this._readable.supportsSynch()&&this._writable.supportsSynch()},e.prototype.supportsLinks=function(){return!1},e.prototype.supportsProps=function(){return this._readable.supportsProps()&&this._writable.supportsProps()},e.prototype.getDeletionLog=function(){return this._deleteLog},e.prototype.restoreDeletionLog=function(t){this._deleteLog=t,this._reparseDeletionLog(),this.updateLog("")},e.prototype.rename=function(t,e,i){var r=this;if(this.checkInitAsync(i)&&!this.checkPathAsync(t,i)&&!this.checkPathAsync(e,i))return t===eq||e===eq?i(p.EPERM("Cannot rename deletion log.")):t===e?i():void this.stat(t,!1,function(n,o){return n?i(n):r.stat(e,!1,function(n,s){function a(n){var o=n.shift();if(!o)return i();var s=c.resolve(t,o),l=c.resolve(e,o);r.rename(s,l,function(t){if(t)return i(t);a(n)})}var u=511;if(o.isDirectory()){if(n)return n.errno!==l.ENOENT?i(n):r._writable.exists(t,function(n){if(n)return r._writable.rename(t,e,i);r._writable.mkdir(e,u,function(e){if(e)return i(e);r._readable.readdir(t,function(t,e){if(t)return i();a(e)})})});if(u=s.mode,!s.isDirectory())return i(p.ENOTDIR(e));r.readdir(e,function(n,o){if(o&&o.length)return i(p.ENOTEMPTY(e));r._readable.readdir(t,function(t,e){if(t)return i();a(e)})})}if(s&&s.isDirectory())return i(p.EISDIR(e));r.readFile(t,null,eW("r"),function(n,s){return n?i(n):r.writeFile(e,s,null,eW("w"),o.mode,function(e){return e?i(e):r.unlink(t,i)})})})})},e.prototype.renameSync=function(t,e){var i=this;if(this.checkInitialized(),this.checkPath(t),this.checkPath(e),t===eq||e===eq)throw p.EPERM("Cannot rename deletion log.");var r=this.statSync(t,!1);if(r.isDirectory()){if(t===e)return;var n=511;if(this.existsSync(e)){var o=this.statSync(e,!1);if(n=o.mode,!o.isDirectory())throw p.ENOTDIR(e);if(this.readdirSync(e).length>0)throw p.ENOTEMPTY(e)}this._writable.existsSync(t)?this._writable.renameSync(t,e):this._writable.existsSync(e)||this._writable.mkdirSync(e,n),this._readable.existsSync(t)&&this._readable.readdirSync(t).forEach(function(r){i.renameSync(c.resolve(t,r),c.resolve(e,r))})}else{if(this.existsSync(e)&&this.statSync(e,!1).isDirectory())throw p.EISDIR(e);this.writeFileSync(e,this.readFileSync(t,null,eW("r")),null,eW("w"),r.mode)}t!==e&&this.existsSync(t)&&this.unlinkSync(t)},e.prototype.stat=function(t,e,i){var r=this;this.checkInitAsync(i)&&this._writable.stat(t,e,function(n,o){n&&n.errno===l.ENOENT?(r._deletedFiles[t]&&i(p.ENOENT(t)),r._readable.stat(t,e,function(t,e){e&&((e=e.clone()).mode=146|e.mode),i(t,e)})):i(n,o)})},e.prototype.statSync=function(t,e){this.checkInitialized();try{return this._writable.statSync(t,e)}catch(r){if(this._deletedFiles[t])throw p.ENOENT(t);var i=this._readable.statSync(t,e).clone();return i.mode=146|i.mode,i}},e.prototype.open=function(t,e,i,r){var n=this;this.checkInitAsync(r)&&!this.checkPathAsync(t,r)&&this.stat(t,!1,function(o,s){if(!s)return e.pathNotExistsAction()===f.CREATE_FILE?n.createParentDirectoriesAsync(t,function(o){return o?r(o):n._writable.open(t,e,i,r)}):r(p.ENOENT(t));switch(e.pathExistsAction()){case f.TRUNCATE_FILE:return n.createParentDirectoriesAsync(t,function(o){if(o)return r(o);n._writable.open(t,e,i,r)});case f.NOP:return n._writable.exists(t,function(o){o?n._writable.open(t,e,i,r):((s=s.clone()).mode=i,n._readable.readFile(t,null,eW("r"),function(i,o){if(i)return r(i);-1===s.size&&(s.size=o.length),r(null,new eH(n,t,e,s,o))}))});default:return r(p.EEXIST(t))}})},e.prototype.openSync=function(t,e,i){if(this.checkInitialized(),this.checkPath(t),t===eq)throw p.EPERM("Cannot open deletion log.");if(!this.existsSync(t)){if(e.pathNotExistsAction()===f.CREATE_FILE)return this.createParentDirectories(t),this._writable.openSync(t,e,i);throw p.ENOENT(t)}switch(e.pathExistsAction()){case f.TRUNCATE_FILE:return this.createParentDirectories(t),this._writable.openSync(t,e,i);case f.NOP:if(this._writable.existsSync(t))return this._writable.openSync(t,e,i);var r=this._readable.readFileSync(t,null,eW("r")),n=this._readable.statSync(t,!1).clone();return n.mode=i,new eH(this,t,e,n,r);default:throw p.EEXIST(t)}},e.prototype.unlink=function(t,e){var i=this;this.checkInitAsync(e)&&!this.checkPathAsync(t,e)&&this.exists(t,function(r){if(!r)return e(p.ENOENT(t));i._writable.exists(t,function(r){if(r)return i._writable.unlink(t,function(r){if(r)return e(r);i.exists(t,function(r){r&&i.deletePath(t),e(null)})});i.deletePath(t),e(null)})})},e.prototype.unlinkSync=function(t){if(this.checkInitialized(),this.checkPath(t),!this.existsSync(t))throw p.ENOENT(t);this._writable.existsSync(t)&&this._writable.unlinkSync(t),this.existsSync(t)&&this.deletePath(t)},e.prototype.rmdir=function(t,e){var i=this;if(this.checkInitAsync(e)){var r=function(){i.readdir(t,function(r,n){return r?e(r):n.length?e(p.ENOTEMPTY(t)):(i.deletePath(t),void e(null))})};this.exists(t,function(n){if(!n)return e(p.ENOENT(t));i._writable.exists(t,function(n){n?i._writable.rmdir(t,function(n){if(n)return e(n);i._readable.exists(t,function(t){t?r():e()})}):r()})})}},e.prototype.rmdirSync=function(t){if(this.checkInitialized(),!this.existsSync(t))throw p.ENOENT(t);if(this._writable.existsSync(t)&&this._writable.rmdirSync(t),this.existsSync(t)){if(this.readdirSync(t).length>0)throw p.ENOTEMPTY(t);this.deletePath(t)}},e.prototype.mkdir=function(t,e,i){var r=this;this.checkInitAsync(i)&&this.exists(t,function(n){if(n)return i(p.EEXIST(t));r.createParentDirectoriesAsync(t,function(n){if(n)return i(n);r._writable.mkdir(t,e,i)})})},e.prototype.mkdirSync=function(t,e){if(this.checkInitialized(),this.existsSync(t))throw p.EEXIST(t);this.createParentDirectories(t),this._writable.mkdirSync(t,e)},e.prototype.readdir=function(t,e){var i=this;this.checkInitAsync(e)&&this.stat(t,!1,function(r,n){return r?e(r):n.isDirectory()?void i._writable.readdir(t,function(r,n){if(r&&"ENOENT"!==r.code)return e(r);!r&&n||(n=[]),i._readable.readdir(t,function(r,o){!r&&o||(o=[]);var s={};e(null,n.concat(o.filter(function(e){return!i._deletedFiles[t+"/"+e]})).filter(function(t){var e=!s[t];return s[t]=!0,e}))})}):e(p.ENOTDIR(t))})},e.prototype.readdirSync=function(t){var e=this;if(this.checkInitialized(),!this.statSync(t,!1).isDirectory())throw p.ENOTDIR(t);var i=[];try{i=i.concat(this._writable.readdirSync(t))}catch(t){}try{i=i.concat(this._readable.readdirSync(t).filter(function(i){return!e._deletedFiles[t+"/"+i]}))}catch(t){}var r={};return i.filter(function(t){var e=!r[t];return r[t]=!0,e})},e.prototype.exists=function(t,e){var i=this;this.checkInitialized(),this._writable.exists(t,function(r){if(r)return e(!0);i._readable.exists(t,function(r){e(r&&!0!==i._deletedFiles[t])})})},e.prototype.existsSync=function(t){return this.checkInitialized(),this._writable.existsSync(t)||this._readable.existsSync(t)&&!0!==this._deletedFiles[t]},e.prototype.chmod=function(t,e,i,r){var n=this;this.checkInitAsync(r)&&this.operateOnWritableAsync(t,function(o){if(o)return r(o);n._writable.chmod(t,e,i,r)})},e.prototype.chmodSync=function(t,e,i){var r=this;this.checkInitialized(),this.operateOnWritable(t,function(){r._writable.chmodSync(t,e,i)})},e.prototype.chown=function(t,e,i,r,n){var o=this;this.checkInitAsync(n)&&this.operateOnWritableAsync(t,function(s){if(s)return n(s);o._writable.chown(t,e,i,r,n)})},e.prototype.chownSync=function(t,e,i,r){var n=this;this.checkInitialized(),this.operateOnWritable(t,function(){n._writable.chownSync(t,e,i,r)})},e.prototype.utimes=function(t,e,i,r){var n=this;this.checkInitAsync(r)&&this.operateOnWritableAsync(t,function(o){if(o)return r(o);n._writable.utimes(t,e,i,r)})},e.prototype.utimesSync=function(t,e,i){var r=this;this.checkInitialized(),this.operateOnWritable(t,function(){r._writable.utimesSync(t,e,i)})},e.prototype.deletePath=function(t){this._deletedFiles[t]=!0,this.updateLog("d"+t+"\n")},e.prototype.updateLog=function(t){var e=this;this._deleteLog+=t,this._deleteLogUpdatePending?this._deleteLogUpdateNeeded=!0:(this._deleteLogUpdatePending=!0,this._writable.writeFile(eq,this._deleteLog,"utf8",m.getFileFlag("w"),420,function(t){e._deleteLogUpdatePending=!1,t?e._deleteLogError=t:e._deleteLogUpdateNeeded&&(e._deleteLogUpdateNeeded=!1,e.updateLog(""))}))},e.prototype._reparseDeletionLog=function(){var t=this;this._deletedFiles={},this._deleteLog.split("\n").forEach(function(e){t._deletedFiles[e.slice(1)]="d"===e.slice(0,1)})},e.prototype.checkInitialized=function(){if(!this._isInitialized)throw new p(l.EPERM,"OverlayFS is not initialized. Please initialize OverlayFS using its initialize() method before using it.");if(null!==this._deleteLogError){var t=this._deleteLogError;throw this._deleteLogError=null,t}},e.prototype.checkInitAsync=function(t){if(!this._isInitialized)return t(new p(l.EPERM,"OverlayFS is not initialized. Please initialize OverlayFS using its initialize() method before using it.")),!1;if(null!==this._deleteLogError){var e=this._deleteLogError;return this._deleteLogError=null,t(e),!1}return!0},e.prototype.checkPath=function(t){if(t===eq)throw p.EPERM(t)},e.prototype.checkPathAsync=function(t,e){return t===eq&&(e(p.EPERM(t)),!0)},e.prototype.createParentDirectoriesAsync=function(t,e){var i=c.dirname(t),r=[],n=this;this._writable.stat(i,!1,function t(o,s){o?(r.push(i),i=c.dirname(i),n._writable.stat(i,!1,t)):function t(){if(!r.length)return e();var i=r.pop();n._readable.stat(i,!1,function(r,o){if(!o)return e();n._writable.mkdir(i,o.mode,function(i){if(i)return e(i);t()})})}()})},e.prototype.createParentDirectories=function(t){for(var e=this,i=c.dirname(t),r=[];!this._writable.existsSync(i);)r.push(i),i=c.dirname(i);(r=r.reverse()).forEach(function(t){e._writable.mkdirSync(t,e.statSync(t,!1).mode)})},e.prototype.operateOnWritable=function(t,e){if(!this.existsSync(t))throw p.ENOENT(t);this._writable.existsSync(t)||this.copyToWritable(t),e()},e.prototype.operateOnWritableAsync=function(t,e){var i=this;this.exists(t,function(r){if(!r)return e(p.ENOENT(t));i._writable.exists(t,function(r){if(!r)return i.copyToWritableAsync(t,e);e()})})},e.prototype.copyToWritable=function(t){var e=this.statSync(t,!1);e.isDirectory()?this._writable.mkdirSync(t,e.mode):this.writeFileSync(t,this._readable.readFileSync(t,null,eW("r")),null,eW("w"),this.statSync(t,!1).mode)},e.prototype.copyToWritableAsync=function(t,e){var i=this;this.stat(t,!1,function(r,n){return r?e(r):n.isDirectory()?i._writable.mkdir(t,n.mode,e):void i._readable.readFile(t,null,eW("r"),function(r,o){if(r)return e(r);i.writeFile(t,o,null,eW("w"),n.mode,e)})})},e}(G),eX=function(t){function e(i,r,n){void 0===n&&(n=!0),t.call(this,new eJ(i,r)),R(n,e.Name,{readable:"readable file system",writable:"writable file system"})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){try{var r=new e(t.writable,t.readable,!1);r.initialize(function(t){i(t,r)},!1)}catch(t){i(t)}},e.isAvailable=function(){return eJ.isAvailable()},e.prototype.initialize=function(e,i){void 0===i&&(i=!0),i&&console.warn("[OverlayFS] OverlayFS.initialize() is deprecated and will be removed in the next major release. Please use 'OverlayFS.Create({readable: readable file system instance, writable: writable file system instance}, cb)' to create and initialize OverlayFS instances."),t.prototype.initialize.call(this,e)},e.prototype.getOverlayedFileSystems=function(){return t.prototype.getFSUnlocked.call(this).getOverlayedFileSystems()},e.prototype.unwrap=function(){return t.prototype.getFSUnlocked.call(this)},e}(eV);eX.Name="OverlayFS",eX.Options={writable:{type:"object",description:"The file system to write modified files to."},readable:{type:"object",description:"The file system that initially populates this file system."}},(ic=eY||(eY={}))[ic.CB=0]="CB",ic[ic.FD=1]="FD",ic[ic.API_ERROR=2]="API_ERROR",ic[ic.STATS=3]="STATS",ic[ic.PROBE=4]="PROBE",ic[ic.FILEFLAG=5]="FILEFLAG",ic[ic.BUFFER=6]="BUFFER",ic[ic.ERROR=7]="ERROR";var eG=function(){this._callbacks={},this._nextId=0};eG.prototype.toRemoteArg=function(t){var e=this._nextId++;return this._callbacks[e]=t,{type:eY.CB,id:e}},eG.prototype.toLocalArg=function(t){var e=this._callbacks[t];return delete this._callbacks[t],e};var eZ=function(){this._fileDescriptors={},this._nextId=0};function eQ(t){var e;return{type:eY.API_ERROR,errorData:L(t.writeToBuffer())}}function e$(t){var e;return p.fromBuffer(U(t.errorData))}function e0(t){return{type:eY.ERROR,name:t.name,message:t.message,stack:t.stack}}function e1(t){var e=et[t.name];"function"!=typeof e&&(e=Error);var i=new e(t.message);return i.stack=t.stack,i}function e2(t){var e;return{type:eY.STATS,statsData:L(t.toBuffer())}}function e5(t){var e;return w.fromBuffer(U(t.statsData))}function e3(t){return{type:eY.FILEFLAG,flagStr:t.getFlagString()}}function e6(t){return m.getFileFlag(t.flagStr)}function e8(t){return{type:eY.BUFFER,data:L(t)}}eZ.prototype.toRemoteArg=function(e,i,r,n){var o,s,a=this._nextId++;this._fileDescriptors[a]=e,e.stat(function(l,u){l?n(l):(s=L(u.toBuffer()),r.isReadable()?e.read(t.alloc(u.size),0,u.size,0,function(t,e,l){t?n(t):(o=L(l),n(null,{type:eY.FD,id:a,data:o,stat:s,path:i,flag:r.getFlagString()}))}):n(null,{type:eY.FD,id:a,data:new ArrayBuffer(0),stat:s,path:i,flag:r.getFlagString()}))})},eZ.prototype.applyFdAPIRequest=function(t,e){var i=this,r=t.args[0];this._applyFdChanges(r,function(n,o){n?e(n):o[t.method](function(n){"close"===t.method&&delete i._fileDescriptors[r.id],e(n)})})},eZ.prototype._applyFdChanges=function(t,e){var i=this._fileDescriptors[t.id],r=U(t.data),n=w.fromBuffer(U(t.stat)),o=m.getFileFlag(t.flag);o.isWriteable()?i.write(r,0,r.length,o.isAppendable()?i.getPos():0,function(t){function s(){i.stat(function(t,r){t?e(t):r.mode!==n.mode?i.chmod(n.mode,function(t){e(t,i)}):e(t,i)})}t?e(t):o.isAppendable()?s():i.truncate(r.length,function(){s()})}):e(null,i)};var e4=function(t){function e(e,i,r,n,o,s){t.call(this,e,i,r,n,s),this._remoteFdId=o}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getRemoteFdId=function(){return this._remoteFdId},e.prototype.toRemoteArg=function(){return{type:eY.FD,id:this._remoteFdId,data:L(this.getBuffer()),stat:L(this.getStats().toBuffer()),path:this.getPath(),flag:this.getFlag().getFlagString()}},e.prototype.sync=function(t){this._syncClose("sync",t)},e.prototype.close=function(t){this._syncClose("close",t)},e.prototype._syncClose=function(t,e){var i=this;this.isDirty()?this._fs.syncClose(t,this,function(t){t||i.resetDirty(),e(t)}):e()},e}($),e7=function(e){function i(t,r){var n=this;void 0===r&&(r=!0),e.call(this),this._callbackConverter=new eG,this._isInitialized=!1,this._isReadOnly=!1,this._supportLinks=!1,this._supportProps=!1,this._worker=t,R(r,i.Name,{worker:"Web Worker instance"}),this._worker.addEventListener("message",function(t){var e=t.data;if(e&&"object"==typeof e&&e.hasOwnProperty("browserfsMessage")&&e.browserfsMessage){var i,r=e.args,o=Array(r.length);for(i=0;i<o.length;i++)o[i]=n._argRemote2Local(r[i]);n._callbackConverter.toLocalArg(e.cbId).apply(null,o)}})}return e&&(i.__proto__=e),i.prototype=Object.create(e&&e.prototype),i.prototype.constructor=i,i.Create=function(t,e){var r=new i(t.worker,!1);r.initialize(function(){e(null,r)})},i.isAvailable=function(){return"undefined"!=typeof importScripts||"undefined"!=typeof Worker},i.attachRemoteListener=function(e){var i=new eZ;e.addEventListener("message",function(r){var n,o=r.data;if(o&&"object"==typeof o&&o.hasOwnProperty("browserfsMessage")&&o.browserfsMessage){var s,a,l,u,c=o.args,h=Array(c.length);switch(o.method){case"close":case"sync":n=c[1],i.applyFdAPIRequest(o,function(t){var i={browserfsMessage:!0,cbId:n.id,args:t?[eQ(t)]:[]};e.postMessage(i)});break;case"probe":s=O.getRootFS(),a=c[1],l={type:eY.PROBE,isReadOnly:s.isReadOnly(),supportsLinks:s.supportsLinks(),supportsProps:s.supportsProps()},u={browserfsMessage:!0,cbId:a.id,args:[l]},e.postMessage(u);break;default:for(var d=0;d<c.length;d++)h[d]=function(r,n){if(!r)return r;if("object"==typeof r){if("number"!=typeof r.type)return r;switch(r.type){case eY.CB:var o=r.id;return function(){var r,s,a=arguments,l=Array(arguments.length),u=arguments.length;for(r=0;r<arguments.length;r++)!function(r,a){var c;(c=function(t,i){l[r]=i,t?u>0&&(u=-1,s={browserfsMessage:!0,cbId:o,args:[eQ(t)]},e.postMessage(s)):0==--u&&(s={browserfsMessage:!0,cbId:o,args:l},e.postMessage(s))})(null,"object"==typeof a?a instanceof w?e2(a):a instanceof p?eQ(a):a instanceof Q?i.toRemoteArg(a,n[0],n[1],c):a instanceof m?e3(a):a instanceof t?e8(a):a instanceof Error?e0(a):a:a)}(r,a[r]);0==arguments.length&&(s={browserfsMessage:!0,cbId:o,args:l},e.postMessage(s))};case eY.API_ERROR:return e$(r);case eY.STATS:return e5(r);case eY.FILEFLAG:return e6(r);case eY.BUFFER:return U(r.data);case eY.ERROR:return e1(r)}}return r}(c[d],h);var f=O.getRootFS();f[o.method].apply(f,h)}}})},i.prototype.getName=function(){return i.Name},i.prototype.initialize=function(t){var e=this;if(this._isInitialized)t();else{var i={browserfsMessage:!0,method:"probe",args:[this._argLocal2Remote(V()),this._callbackConverter.toRemoteArg(function(i){e._isInitialized=!0,e._isReadOnly=i.isReadOnly,e._supportLinks=i.supportsLinks,e._supportProps=i.supportsProps,t()})]};this._worker.postMessage(i)}},i.prototype.isReadOnly=function(){return this._isReadOnly},i.prototype.supportsSynch=function(){return!1},i.prototype.supportsLinks=function(){return this._supportLinks},i.prototype.supportsProps=function(){return this._supportProps},i.prototype.rename=function(t,e,i){this._rpc("rename",arguments)},i.prototype.stat=function(t,e,i){this._rpc("stat",arguments)},i.prototype.open=function(t,e,i,r){this._rpc("open",arguments)},i.prototype.unlink=function(t,e){this._rpc("unlink",arguments)},i.prototype.rmdir=function(t,e){this._rpc("rmdir",arguments)},i.prototype.mkdir=function(t,e,i){this._rpc("mkdir",arguments)},i.prototype.readdir=function(t,e){this._rpc("readdir",arguments)},i.prototype.exists=function(t,e){this._rpc("exists",arguments)},i.prototype.realpath=function(t,e,i){this._rpc("realpath",arguments)},i.prototype.truncate=function(t,e,i){this._rpc("truncate",arguments)},i.prototype.readFile=function(t,e,i,r){this._rpc("readFile",arguments)},i.prototype.writeFile=function(t,e,i,r,n,o){this._rpc("writeFile",arguments)},i.prototype.appendFile=function(t,e,i,r,n,o){this._rpc("appendFile",arguments)},i.prototype.chmod=function(t,e,i,r){this._rpc("chmod",arguments)},i.prototype.chown=function(t,e,i,r,n){this._rpc("chown",arguments)},i.prototype.utimes=function(t,e,i,r){this._rpc("utimes",arguments)},i.prototype.link=function(t,e,i){this._rpc("link",arguments)},i.prototype.symlink=function(t,e,i,r){this._rpc("symlink",arguments)},i.prototype.readlink=function(t,e){this._rpc("readlink",arguments)},i.prototype.syncClose=function(t,e,i){this._worker.postMessage({browserfsMessage:!0,method:t,args:[e.toRemoteArg(),this._callbackConverter.toRemoteArg(i)]})},i.prototype._argRemote2Local=function(t){if(!t)return t;if("object"==typeof t){if("number"!=typeof t.type)return t;switch(t.type){case eY.API_ERROR:return e$(t);case eY.FD:return new e4(this,t.path,m.getFileFlag(t.flag),w.fromBuffer(U(t.stat)),t.id,U(t.data));case eY.STATS:return e5(t);case eY.FILEFLAG:return e6(t);case eY.BUFFER:return U(t.data);case eY.ERROR:return e1(t)}}return t},i.prototype._rpc=function(t,e){for(var i=Array(e.length),r=0;r<e.length;r++)i[r]=this._argLocal2Remote(e[r]);this._worker.postMessage({browserfsMessage:!0,method:t,args:i})},i.prototype._argLocal2Remote=function(e){if(!e)return e;switch(typeof e){case"object":return e instanceof w?e2(e):e instanceof p?eQ(e):e instanceof e4?e.toRemoteArg():e instanceof m?e3(e):e instanceof t?e8(e):e instanceof Error?e0(e):"Unknown argument";case"function":return this._callbackConverter.toRemoteArg(e);default:return e}},i}(G);function e9(t,e,i){var r=new XMLHttpRequest;r.open("HEAD",e,t),r.onreadystatechange=function(t){if(4===r.readyState){if(200!==r.status)return i(new p(r.status,"XHR HEAD error."));try{return i(null,parseInt(r.getResponseHeader("Content-Length")||"-1",10))}catch(t){return i(new p(l.EIO,"XHR HEAD error: Could not read content-length."))}}},r.send()}e7.Name="WorkerFS",e7.Options={worker:{type:"object",description:"The target worker that you want to connect to, or the current worker if in a worker context.",validator:function(t,e){t.postMessage?e():e(new p(l.EINVAL,"option must be a Web Worker instance."))}}};var it=function(e,i,r){var n=new XMLHttpRequest;n.open("GET",e,!0);var o=!0;switch(i){case"buffer":n.responseType="arraybuffer";break;case"json":try{n.responseType="json",o="json"===n.responseType}catch(t){o=!1}break;default:return r(new p(l.EINVAL,"Invalid download type: "+i))}n.onreadystatechange=function(e){if(4===n.readyState){if(200!==n.status)return r(new p(n.status,"XHR error."));switch(i){case"buffer":return r(null,n.response?t.from(n.response):V());case"json":return r(null,o?n.response:JSON.parse(n.responseText))}}},n.send()},ie=k&&"undefined"!=typeof Blob?function(e,i){var r,n,o=new XMLHttpRequest;switch(o.open("GET",e,!1),i){case"buffer":o.responseType="arraybuffer";break;case"json":break;default:throw new p(l.EINVAL,"Invalid download type: "+i)}if(o.onreadystatechange=function(e){if(4===o.readyState){if(200===o.status)switch(i){case"buffer":r=t.from(o.response);break;case"json":r=JSON.parse(o.response)}else n=new p(o.status,"XHR error.")}},o.send(),n)throw n;return r}:function(e,i){var r=new XMLHttpRequest;r.open("GET",e,!1);var n=null,o=null;if(r.overrideMimeType("text/plain; charset=x-user-defined"),r.onreadystatechange=function(e){if(4===r.readyState){if(200!==r.status)return void(o=new p(r.status,"XHR error."));switch(i){case"buffer":var s=r.responseText;n=t.alloc(s.length);for(var a=0;a<s.length;a++)n[a]=s.charCodeAt(a);return;case"json":return void(n=JSON.parse(r.responseText))}}},r.send(),o)throw o;return n},ii=function(){this._index={},this.addPath("/",new io)};ii.fromListing=function(t){var e=new ii,i=new io;e._index["/"]=i;for(var r=[["",t,i]];r.length>0;){var n=void 0,o=r.pop(),s=o[0],a=o[1],l=o[2];for(var u in a)if(a.hasOwnProperty(u)){var c=a[u],h=s+"/"+u;c?(e._index[h]=n=new io,r.push([h,c,n])):n=new ir(new w(v.FILE,-1,365)),l&&(l._ls[u]=n)}}return e},ii.prototype.fileIterator=function(t){for(var e in this._index)if(this._index.hasOwnProperty(e))for(var i=this._index[e],r=0,n=i.getListing();r<n.length;r+=1){var o=n[r],s=i.getItem(o);is(s)&&t(s.getData())}},ii.prototype.addPath=function(t,e){if(!e)throw Error("Inode must be specified");if("/"!==t[0])throw Error("Path must be absolute, got: "+t);if(this._index.hasOwnProperty(t))return this._index[t]===e;var i=this._split_path(t),r=i[0],n=i[1],o=this._index[r];return!(void 0===o&&"/"!==t&&(o=new io,!this.addPath(r,o))||"/"!==t&&!o.addItem(n,e)||(ia(e)&&(this._index[t]=e),0))},ii.prototype.addPathFast=function(t,e){var i=t.lastIndexOf("/"),r=0===i?"/":t.substring(0,i),n=t.substring(i+1),o=this._index[r];return void 0===o&&(o=new io,this.addPathFast(r,o)),!!o.addItem(n,e)&&(e.isDir()&&(this._index[t]=e),!0)},ii.prototype.removePath=function(t){var e=this._split_path(t),i=e[0],r=e[1],n=this._index[i];if(void 0===n)return null;var o=n.remItem(r);if(null===o)return null;if(ia(o)){for(var s=0,a=o.getListing();s<a.length;s+=1){var l=a[s];this.removePath(t+"/"+l)}"/"!==t&&delete this._index[t]}return o},ii.prototype.ls=function(t){var e=this._index[t];return void 0===e?null:e.getListing()},ii.prototype.getInode=function(t){var e=this._split_path(t),i=e[0],r=e[1],n=this._index[i];return void 0===n?null:i===t?n:n.getItem(r)},ii.prototype._split_path=function(t){var e=c.dirname(t);return[e,t.substr(e.length+("/"===e?0:1))]};var ir=function(t){this.data=t};ir.prototype.isFile=function(){return!0},ir.prototype.isDir=function(){return!1},ir.prototype.getData=function(){return this.data},ir.prototype.setData=function(t){this.data=t};var io=function(t){void 0===t&&(t=null),this.data=t,this._ls={}};function is(t){return!!t&&t.isFile()}function ia(t){return!!t&&t.isDir()}io.prototype.isFile=function(){return!1},io.prototype.isDir=function(){return!0},io.prototype.getData=function(){return this.data},io.prototype.getStats=function(){return new w(v.DIRECTORY,4096,365)},io.prototype.getListing=function(){return Object.keys(this._ls)},io.prototype.getItem=function(t){return this._ls[t]||null},io.prototype.addItem=function(t,e){return!(t in this._ls)&&(this._ls[t]=e,!0)},io.prototype.remItem=function(t){var e=this._ls[t];return void 0===e?null:(delete this._ls[t],e)};var il=function(t){function e(i,r,n){void 0===r&&(r=""),void 0===n&&(n=!0),t.call(this),i||(i="index.json"),r.length>0&&"/"!==r.charAt(r.length-1)&&(r+="/"),this.prefixUrl=r;var o=null;if("string"==typeof i){if(!(o=this._requestFileSync(i,"json")))throw Error("Unable to find listing at URL: ${listingUrlOrObj}")}else o=i;R(n,e.Name,{index:"string"==typeof i?i:"file index as an object",baseUrl:r}),this._index=ii.fromListing(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){void 0===t.index&&(t.index="index.json"),"string"==typeof t.index?e.FromURL(t.index,i,t.baseUrl,!1):i(null,new e(t.index,t.baseUrl,!1))},e.isAvailable=function(){return"undefined"!=typeof XMLHttpRequest&&null!==XMLHttpRequest},e.FromURL=function(t,i,r,n){void 0===r&&(r=t.slice(0,t.lastIndexOf("/")+1)),void 0===n&&(n=!0),n&&console.warn("[XmlHttpRequest] XmlHttpRequest.FromURL() is deprecated and will be removed in the next major release. Please use 'XmlHttpRequest.Create({ index: \""+t+'", baseUrl: "'+r+"\" }, cb)' instead."),it(t,"json",function(t,n){t?i(t):i(null,new e(n,r,!1))})},e.prototype.empty=function(){this._index.fileIterator(function(t){t.fileData=null})},e.prototype.getName=function(){return e.Name},e.prototype.diskSpace=function(t,e){e(0,0)},e.prototype.isReadOnly=function(){return!0},e.prototype.supportsLinks=function(){return!1},e.prototype.supportsProps=function(){return!1},e.prototype.supportsSynch=function(){return!0},e.prototype.preloadFile=function(t,e){var i=this._index.getInode(t);if(!is(i))throw p.EISDIR(t);if(null===i)throw p.ENOENT(t);var r=i.getData();r.size=e.length,r.fileData=e},e.prototype.stat=function(t,e,i){var r,n=this._index.getInode(t);if(null===n)return i(p.ENOENT(t));is(n)?(r=n.getData()).size<0?this._requestFileSizeAsync(t,function(t,e){if(t)return i(t);r.size=e,i(null,r.clone())}):i(null,r.clone()):ia(n)?i(null,r=n.getStats()):i(p.FileError(l.EINVAL,t))},e.prototype.statSync=function(t,e){var i,r=this._index.getInode(t);if(null===r)throw p.ENOENT(t);if(is(r))(i=r.getData()).size<0&&(i.size=this._requestFileSizeSync(t));else{if(!ia(r))throw p.FileError(l.EINVAL,t);i=r.getStats()}return i},e.prototype.open=function(t,e,i,r){if(e.isWriteable())return r(new p(l.EPERM,t));var n=this,o=this._index.getInode(t);if(null===o)return r(p.ENOENT(t));if(!is(o))return r(p.EISDIR(t));var s=o.getData();switch(e.pathExistsAction()){case f.THROW_EXCEPTION:case f.TRUNCATE_FILE:return r(p.EEXIST(t));case f.NOP:if(s.fileData)return r(null,new tt(n,t,e,s.clone(),s.fileData));this._requestFileAsync(t,"buffer",function(i,o){return i?r(i):(s.size=o.length,s.fileData=o,r(null,new tt(n,t,e,s.clone(),o)))});break;default:return r(new p(l.EINVAL,"Invalid FileMode object."))}},e.prototype.openSync=function(t,e,i){if(e.isWriteable())throw new p(l.EPERM,t);var r=this._index.getInode(t);if(null===r)throw p.ENOENT(t);if(!is(r))throw p.EISDIR(t);var n=r.getData();switch(e.pathExistsAction()){case f.THROW_EXCEPTION:case f.TRUNCATE_FILE:throw p.EEXIST(t);case f.NOP:if(n.fileData)return new tt(this,t,e,n.clone(),n.fileData);var o=this._requestFileSync(t,"buffer");return n.size=o.length,n.fileData=o,new tt(this,t,e,n.clone(),o);default:throw new p(l.EINVAL,"Invalid FileMode object.")}},e.prototype.readdir=function(t,e){try{e(null,this.readdirSync(t))}catch(t){e(t)}},e.prototype.readdirSync=function(t){var e=this._index.getInode(t);if(null===e)throw p.ENOENT(t);if(ia(e))return e.getListing();throw p.ENOTDIR(t)},e.prototype.readFile=function(t,e,i,r){var n=r;this.open(t,i,420,function(t,i){if(t)return r(t);r=function(t,e){i.close(function(i){return t||(t=i),n(t,e)})};var o=i.getBuffer();null===e?r(t,B(o)):function(t,e,i){try{i(null,t.toString(e))}catch(t){i(t)}}(o,e,r)})},e.prototype.readFileSync=function(t,e,i){var r=this.openSync(t,i,420);try{var n=r.getBuffer();return null===e?B(n):n.toString(e)}finally{r.closeSync()}},e.prototype.getXhrPath=function(t){return"/"===t.charAt(0)&&(t=t.slice(1)),this.prefixUrl+t},e.prototype._requestFileAsync=function(t,e,i){it(this.getXhrPath(t),e,i)},e.prototype._requestFileSync=function(t,e){return ie(this.getXhrPath(t),e)},e.prototype._requestFileSizeAsync=function(t,e){e9(!0,this.getXhrPath(t),e)},e.prototype._requestFileSizeSync=function(t){var e,i;return e=this.getXhrPath(t),i=-1,e9(!1,e,function(t,e){if(t)throw t;i=e}),i},e}(G);il.Name="XmlHttpRequest",il.Options={index:{type:["string","object"],optional:!0,description:"URL to a file index as a JSON file or the file index object itself, generated with the make_xhrfs_index script. Defaults to `index.json`."},baseUrl:{type:"string",optional:!0,description:"Used as the URL prefix for fetched files. Default: Fetch files relative to the index."}};var iu=function(){};iu.str2byte=function(t,e){for(var i=t.length>e.length?e.length:t.length,r=0;r<i;r++){var n=t.charCodeAt(r);if(n>127){var o=iu.extendedChars.indexOf(t.charAt(r));o>-1&&(n=o+128)}e[n]=r}return i},iu.byte2str=function(t){for(var e=Array(t.length),i=0;i<t.length;i++){var r=t[i];e[i]=r>127?iu.extendedChars[r-128]:String.fromCharCode(r)}return e.join("")},iu.byteLength=function(t){return t.length},iu.extendedChars=["\xc7","\xfc","\xe9","\xe2","\xe4","\xe0","\xe5","\xe7","\xea","\xeb","\xe8","\xef","\xee","\xec","\xc4","\xc5","\xc9","\xe6","\xc6","\xf4","\xf6","\xf2","\xfb","\xf9","\xff","\xd6","\xdc","\xf8","\xa3","\xd8","\xd7","","\xe1","\xed","\xf3","\xfa","\xf1","\xd1","\xaa","\xba","\xbf","\xae","\xac","\xbd","\xbc","\xa1","\xab","\xbb","_","_","_","\xa6","\xa6","\xc1","\xc2","\xc0","\xa9","\xa6","\xa6","+","+","\xa2","\xa5","+","+","-","-","+","-","+","\xe3","\xc3","+","+","-","-","\xa6","-","+","\xa4","\xf0","\xd0","\xca","\xcb","\xc8","i","\xcd","\xce","\xcf","+","+","_","_","\xa6","\xcc","_","\xd3","\xdf","\xd4","\xd2","\xf5","\xd5","\xb5","\xfe","\xde","\xda","\xdb","\xd9","\xfd","\xdd","\xaf","\xb4","\xad","\xb1","_","\xbe","\xb6","\xa7","\xf7","\xb8","\xb0","\xa8","\xb7","\xb9","\xb3","\xb2","_"," "];var ic,ih,id,ip=i(31).inflateRaw,iy={};function ig(t,e){return new Date(1980+(e>>9),(e>>5&15)-1,31&e,t>>11,t>>5&63,31&t)}function iv(t,e,i,r){return 0===r?"":e?t.toString("utf8",i,i+r):iu.byte2str(t.slice(i,i+r))}(s=ih||(ih={}))[s.MSDOS=0]="MSDOS",s[s.AMIGA=1]="AMIGA",s[s.OPENVMS=2]="OPENVMS",s[s.UNIX=3]="UNIX",s[s.VM_CMS=4]="VM_CMS",s[s.ATARI_ST=5]="ATARI_ST",s[s.OS2_HPFS=6]="OS2_HPFS",s[s.MAC=7]="MAC",s[s.Z_SYSTEM=8]="Z_SYSTEM",s[s.CP_M=9]="CP_M",s[s.NTFS=10]="NTFS",s[s.MVS=11]="MVS",s[s.VSE=12]="VSE",s[s.ACORN_RISC=13]="ACORN_RISC",s[s.VFAT=14]="VFAT",s[s.ALT_MVS=15]="ALT_MVS",s[s.BEOS=16]="BEOS",s[s.TANDEM=17]="TANDEM",s[s.OS_400=18]="OS_400",s[s.OSX=19]="OSX",(a=id||(id={}))[a.STORED=0]="STORED",a[a.SHRUNK=1]="SHRUNK",a[a.REDUCED_1=2]="REDUCED_1",a[a.REDUCED_2=3]="REDUCED_2",a[a.REDUCED_3=4]="REDUCED_3",a[a.REDUCED_4=5]="REDUCED_4",a[a.IMPLODE=6]="IMPLODE",a[a.DEFLATE=8]="DEFLATE",a[a.DEFLATE64=9]="DEFLATE64",a[a.TERSE_OLD=10]="TERSE_OLD",a[a.BZIP2=12]="BZIP2",a[a.LZMA=14]="LZMA",a[a.TERSE_NEW=18]="TERSE_NEW",a[a.LZ77=19]="LZ77",a[a.WAVPACK=97]="WAVPACK",a[a.PPMD=98]="PPMD";var im=function(t){if(this.data=t,67324752!==t.readUInt32LE(0))throw new p(l.EINVAL,"Invalid Zip file: Local file header has invalid signature: "+this.data.readUInt32LE(0))};im.prototype.versionNeeded=function(){return this.data.readUInt16LE(4)},im.prototype.flags=function(){return this.data.readUInt16LE(6)},im.prototype.compressionMethod=function(){return this.data.readUInt16LE(8)},im.prototype.lastModFileTime=function(){return ig(this.data.readUInt16LE(10),this.data.readUInt16LE(12))},im.prototype.rawLastModFileTime=function(){return this.data.readUInt32LE(10)},im.prototype.crc32=function(){return this.data.readUInt32LE(14)},im.prototype.fileNameLength=function(){return this.data.readUInt16LE(26)},im.prototype.extraFieldLength=function(){return this.data.readUInt16LE(28)},im.prototype.fileName=function(){return iv(this.data,this.useUTF8(),30,this.fileNameLength())},im.prototype.extraField=function(){var t=30+this.fileNameLength();return this.data.slice(t,t+this.extraFieldLength())},im.prototype.totalSize=function(){return 30+this.fileNameLength()+this.extraFieldLength()},im.prototype.useUTF8=function(){return 2048==(2048&this.flags())};var iw=function(t,e,i){this.header=t,this.record=e,this.data=i};iw.prototype.decompress=function(){var t=this.header.compressionMethod(),e=iy[t];if(e)return e(this.data,this.record.compressedSize(),this.record.uncompressedSize(),this.record.flag());var i=id[t];throw i||(i="Unknown: "+t),new p(l.EINVAL,"Invalid compression method on file '"+this.header.fileName()+"': "+i)},iw.prototype.getHeader=function(){return this.header},iw.prototype.getRecord=function(){return this.record},iw.prototype.getRawData=function(){return this.data};var iS=function(t,e){if(this.zipData=t,this.data=e,33639248!==this.data.readUInt32LE(0))throw new p(l.EINVAL,"Invalid Zip file: Central directory record has invalid signature: "+this.data.readUInt32LE(0));this._filename=this.produceFilename()};iS.prototype.versionMadeBy=function(){return this.data.readUInt16LE(4)},iS.prototype.versionNeeded=function(){return this.data.readUInt16LE(6)},iS.prototype.flag=function(){return this.data.readUInt16LE(8)},iS.prototype.compressionMethod=function(){return this.data.readUInt16LE(10)},iS.prototype.lastModFileTime=function(){return ig(this.data.readUInt16LE(12),this.data.readUInt16LE(14))},iS.prototype.rawLastModFileTime=function(){return this.data.readUInt32LE(12)},iS.prototype.crc32=function(){return this.data.readUInt32LE(16)},iS.prototype.compressedSize=function(){return this.data.readUInt32LE(20)},iS.prototype.uncompressedSize=function(){return this.data.readUInt32LE(24)},iS.prototype.fileNameLength=function(){return this.data.readUInt16LE(28)},iS.prototype.extraFieldLength=function(){return this.data.readUInt16LE(30)},iS.prototype.fileCommentLength=function(){return this.data.readUInt16LE(32)},iS.prototype.diskNumberStart=function(){return this.data.readUInt16LE(34)},iS.prototype.internalAttributes=function(){return this.data.readUInt16LE(36)},iS.prototype.externalAttributes=function(){return this.data.readUInt32LE(38)},iS.prototype.headerRelativeOffset=function(){return this.data.readUInt32LE(42)},iS.prototype.produceFilename=function(){return iv(this.data,this.useUTF8(),46,this.fileNameLength()).replace(/\\/g,"/")},iS.prototype.fileName=function(){return this._filename},iS.prototype.rawFileName=function(){return this.data.slice(46,46+this.fileNameLength())},iS.prototype.extraField=function(){var t=44+this.fileNameLength();return this.data.slice(t,t+this.extraFieldLength())},iS.prototype.fileComment=function(){var t=46+this.fileNameLength()+this.extraFieldLength();return iv(this.data,this.useUTF8(),t,this.fileCommentLength())},iS.prototype.rawFileComment=function(){var t=46+this.fileNameLength()+this.extraFieldLength();return this.data.slice(t,t+this.fileCommentLength())},iS.prototype.totalSize=function(){return 46+this.fileNameLength()+this.extraFieldLength()+this.fileCommentLength()},iS.prototype.isDirectory=function(){var t=this.fileName();return!!(16&this.externalAttributes())||"/"===t.charAt(t.length-1)},iS.prototype.isFile=function(){return!this.isDirectory()},iS.prototype.useUTF8=function(){return 2048==(2048&this.flag())},iS.prototype.isEncrypted=function(){return 1==(1&this.flag())},iS.prototype.getFileData=function(){var t=this.headerRelativeOffset(),e=new im(this.zipData.slice(t));return new iw(e,this,this.zipData.slice(t+e.totalSize()))},iS.prototype.getData=function(){return this.getFileData().decompress()},iS.prototype.getRawData=function(){return this.getFileData().getRawData()},iS.prototype.getStats=function(){return new w(v.FILE,this.uncompressedSize(),365,new Date,this.lastModFileTime())};var ib=function(t){if(this.data=t,101010256!==this.data.readUInt32LE(0))throw new p(l.EINVAL,"Invalid Zip file: End of central directory record has invalid signature: "+this.data.readUInt32LE(0))};ib.prototype.diskNumber=function(){return this.data.readUInt16LE(4)},ib.prototype.cdDiskNumber=function(){return this.data.readUInt16LE(6)},ib.prototype.cdDiskEntryCount=function(){return this.data.readUInt16LE(8)},ib.prototype.cdTotalEntryCount=function(){return this.data.readUInt16LE(10)},ib.prototype.cdSize=function(){return this.data.readUInt32LE(12)},ib.prototype.cdOffset=function(){return this.data.readUInt32LE(16)},ib.prototype.cdZipCommentLength=function(){return this.data.readUInt16LE(20)},ib.prototype.cdZipComment=function(){return iv(this.data,!0,22,this.cdZipCommentLength())},ib.prototype.rawCdZipComment=function(){return this.data.slice(22,22+this.cdZipCommentLength())};var iE=function(t,e,i,r){this.index=t,this.directoryEntries=e,this.eocd=i,this.data=r},iI=function(t){function e(i,r,n){void 0===r&&(r=""),void 0===n&&(n=!0),t.call(this),this.name=r,this._index=new ii,this._directoryEntries=[],this._eocd=null,R(n,e.Name,{zipData:"zip data as a Buffer",name:r}),i instanceof iE?(this._index=i.index,this._directoryEntries=i.directoryEntries,this._eocd=i.eocd,this.data=i.data):(this.data=i,this.populateIndex())}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){try{e.computeIndex(t.zipData,function(r){var n=new e(r,t.name,!1);i(null,n)},!1)}catch(t){i(t)}},e.isAvailable=function(){return!0},e.RegisterDecompressionMethod=function(t,e){iy[t]=e},e.computeIndex=function(t,i,r){void 0===r&&(r=!0),r&&console.warn("[ZipFS] ZipFS.computeIndex is now deprecated, and will be removed in the next major release. Please update your code to use 'ZipFS.Create({ zipData: zip file as a Buffer}, cb)' instead.");var n=new ii,o=e.getEOCD(t);if(o.diskNumber()!==o.cdDiskNumber())throw new p(l.EINVAL,"ZipFS does not support spanned zip files.");var s=o.cdOffset();if(4294967295===s)throw new p(l.EINVAL,"ZipFS does not support Zip64.");var a=s+o.cdSize();e.computeIndexResponsive(t,n,s,a,i,[],o)},e.getEOCD=function(t){for(var e=Math.min(65557,t.length-1),i=22;i<e;i++)if(101010256===t.readUInt32LE(t.length-i))return new ib(t.slice(t.length-i));throw new p(l.EINVAL,"Invalid ZIP file: Could not locate End of Central Directory signature.")},e.addToIndex=function(t,e){var i=t.fileName();if("/"===i.charAt(0))throw Error("WHY IS THIS ABSOLUTE");"/"===i.charAt(i.length-1)&&(i=i.substr(0,i.length-1)),t.isDirectory()?e.addPathFast("/"+i,new io(t)):e.addPathFast("/"+i,new ir(t))},e.computeIndexResponsive=function(t,i,r,n,o,s,a){if(r<n){for(var l=0;l++<200&&r<n;){var u=new iS(t,t.slice(r));e.addToIndex(u,i),r+=u.totalSize(),s.push(u)}eB(function(){e.computeIndexResponsive(t,i,r,n,o,s,a)})}else o(new iE(i,s,a,t))},e.prototype.getName=function(){return e.Name+(""!==this.name?" "+this.name:"")},e.prototype.getCentralDirectoryEntry=function(t){var e=this._index.getInode(t);if(null===e)throw p.ENOENT(t);if(is(e)||ia(e))return e.getData();throw p.EPERM("Invalid inode: "+e)},e.prototype.getCentralDirectoryEntryAt=function(t){var e=this._directoryEntries[t];if(!e)throw RangeError("Invalid directory index: "+t+".");return e},e.prototype.getNumberOfCentralDirectoryEntries=function(){return this._directoryEntries.length},e.prototype.getEndOfCentralDirectory=function(){return this._eocd},e.prototype.diskSpace=function(t,e){e(this.data.length,0)},e.prototype.isReadOnly=function(){return!0},e.prototype.supportsLinks=function(){return!1},e.prototype.supportsProps=function(){return!1},e.prototype.supportsSynch=function(){return!0},e.prototype.statSync=function(t,e){var i,r=this._index.getInode(t);if(null===r)throw p.ENOENT(t);if(is(r))i=r.getData().getStats();else{if(!ia(r))throw new p(l.EINVAL,"Invalid inode.");i=r.getStats()}return i},e.prototype.openSync=function(t,e,i){if(e.isWriteable())throw new p(l.EPERM,t);var r=this._index.getInode(t);if(!r)throw p.ENOENT(t);if(!is(r))throw p.EISDIR(t);var n=r.getData(),o=n.getStats();switch(e.pathExistsAction()){case f.THROW_EXCEPTION:case f.TRUNCATE_FILE:throw p.EEXIST(t);case f.NOP:return new tt(this,t,e,o,n.getData());default:throw new p(l.EINVAL,"Invalid FileMode object.")}},e.prototype.readdirSync=function(t){var e=this._index.getInode(t);if(e){if(ia(e))return e.getListing();throw p.ENOTDIR(t)}throw p.ENOENT(t)},e.prototype.readFileSync=function(t,e,i){var r=this.openSync(t,i,420);try{var n=r.getBuffer();return null===e?B(n):n.toString(e)}finally{r.closeSync()}},e.prototype.populateIndex=function(){var t=this._eocd=e.getEOCD(this.data);if(t.diskNumber()!==t.cdDiskNumber())throw new p(l.EINVAL,"ZipFS does not support spanned zip files.");var i=t.cdOffset();if(4294967295===i)throw new p(l.EINVAL,"ZipFS does not support Zip64.");for(var r=i+t.cdSize();i<r;){var n=new iS(this.data,this.data.slice(i));i+=n.totalSize(),e.addToIndex(n,this._index),this._directoryEntries.push(n)}},e}(Z);function i_(t,e,i){return t.toString("ascii",e,e+i).trim()}function iD(t,e,i){if(1===i)return String.fromCharCode(t[e]);for(var r=Math.floor(i/2),n=Array(r),o=0;o<r;o++){var s=e+(o<<1);n[o]=String.fromCharCode(t[s+1]|t[s]<<8)}return n.join("")}function iT(t,e){var i=parseInt(i_(t,e,4),10),r=parseInt(i_(t,e+4,2),10),n=parseInt(i_(t,e+6,2),10),o=parseInt(i_(t,e+8,2),10),s=parseInt(i_(t,e+10,2),10),a=parseInt(i_(t,e+12,2),10),l=parseInt(i_(t,e+14,2),10);return new Date(i,r,n,o,s,a,100*l)}function iA(t,e){var i=t[e],r=t[e+1],n=t[e+2],o=t[e+3],s=t[e+4],a=t[e+5];return new Date(i,r-1,n,o,s,a)}function ix(t,e,i,r){i-=4;for(var n=[];e<i;){var o=function(t,e){var i=t.slice(e),r=new iL(i);switch(r.signatureWord()){case 17221:return new iM(i);case 20548:return new ij(i);case 21328:return new iK(i);case 21332:return new iU(i);case 17746:return new iB(i);case 17747:return new iz(i);case 20568:return new iq(i);case 20558:return new iW(i);case 21324:return new iY(i);case 20045:return new iJ(i);case 17228:return new iX(i);case 20556:return new iG(i);case 21061:return new iZ(i);case 21574:return new iQ(i);case 21318:return new i$(i);case 21074:return new iV(i);default:return r}}(t,e),s=o.length();if(0===s||(e+=s,o instanceof iU))break;o instanceof iM?n=n.concat(o.getEntries(r)):n.push(o)}return n}iI.Name="ZipFS",iI.Options={zipData:{type:"object",description:"The zip file as a Buffer object.",validator:q},name:{type:"string",optional:!0,description:"The name of the zip file (optional)."}},iI.CompressionMethod=id,iI.RegisterDecompressionMethod(id.DEFLATE,function(t,e,i){return j(ip(t.slice(0,e),{chunkSize:i}))}),iI.RegisterDecompressionMethod(id.STORED,function(t,e,i){return B(t,0,i)});var iO=function(t){this._data=t};iO.prototype.type=function(){return this._data[0]},iO.prototype.standardIdentifier=function(){return i_(this._data,1,5)},iO.prototype.version=function(){return this._data[6]},iO.prototype.data=function(){return this._data.slice(7,2048)};var iP=function(t){function e(e){t.call(this,e),this._root=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.systemIdentifier=function(){return this._getString32(8)},e.prototype.volumeIdentifier=function(){return this._getString32(40)},e.prototype.volumeSpaceSize=function(){return this._data.readUInt32LE(80)},e.prototype.volumeSetSize=function(){return this._data.readUInt16LE(120)},e.prototype.volumeSequenceNumber=function(){return this._data.readUInt16LE(124)},e.prototype.logicalBlockSize=function(){return this._data.readUInt16LE(128)},e.prototype.pathTableSize=function(){return this._data.readUInt32LE(132)},e.prototype.locationOfTypeLPathTable=function(){return this._data.readUInt32LE(140)},e.prototype.locationOfOptionalTypeLPathTable=function(){return this._data.readUInt32LE(144)},e.prototype.locationOfTypeMPathTable=function(){return this._data.readUInt32BE(148)},e.prototype.locationOfOptionalTypeMPathTable=function(){return this._data.readUInt32BE(152)},e.prototype.rootDirectoryEntry=function(t){return null===this._root&&(this._root=this._constructRootDirectoryRecord(this._data.slice(156)),this._root.rootCheckForRockRidge(t)),this._root},e.prototype.volumeSetIdentifier=function(){return this._getString(190,128)},e.prototype.publisherIdentifier=function(){return this._getString(318,128)},e.prototype.dataPreparerIdentifier=function(){return this._getString(446,128)},e.prototype.applicationIdentifier=function(){return this._getString(574,128)},e.prototype.copyrightFileIdentifier=function(){return this._getString(702,38)},e.prototype.abstractFileIdentifier=function(){return this._getString(740,36)},e.prototype.bibliographicFileIdentifier=function(){return this._getString(776,37)},e.prototype.volumeCreationDate=function(){return iT(this._data,813)},e.prototype.volumeModificationDate=function(){return iT(this._data,830)},e.prototype.volumeExpirationDate=function(){return iT(this._data,847)},e.prototype.volumeEffectiveDate=function(){return iT(this._data,864)},e.prototype.fileStructureVersion=function(){return this._data[881]},e.prototype.applicationUsed=function(){return this._data.slice(883,1395)},e.prototype.reserved=function(){return this._data.slice(1395,2048)},e.prototype._getString32=function(t){return this._getString(t,32)},e}(iO),iR=function(t){function e(e){if(t.call(this,e),1!==this.type())throw new p(l.EIO,"Invalid primary volume descriptor.")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.name=function(){return"ISO9660"},e.prototype._constructRootDirectoryRecord=function(t){return new iC(t,-1)},e.prototype._getString=function(t,e){return this._getString(t,e)},e}(iP),ik=function(t){function e(e){if(t.call(this,e),2!==this.type())throw new p(l.EIO,"Invalid supplementary volume descriptor.");var i=this.escapeSequence(),r=i[2];if(37!==i[0]||47!==i[1]||64!==r&&67!==r&&69!==r)throw new p(l.EIO,"Unrecognized escape sequence for SupplementaryVolumeDescriptor: "+i.toString())}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.name=function(){return"Joliet"},e.prototype.escapeSequence=function(){return this._data.slice(88,120)},e.prototype._constructRootDirectoryRecord=function(t){return new iF(t,-1)},e.prototype._getString=function(t,e){return iD(this._data,t,e)},e}(iP),iN=function(t,e){this._suEntries=null,this._fileOrDir=null,this._data=t,this._rockRidgeOffset=e};iN.prototype.hasRockRidge=function(){return this._rockRidgeOffset>-1},iN.prototype.getRockRidgeOffset=function(){return this._rockRidgeOffset},iN.prototype.rootCheckForRockRidge=function(t){var e=this.getDirectory(t);this._rockRidgeOffset=e.getDotEntry(t)._getRockRidgeOffset(t),this._rockRidgeOffset>-1&&(this._fileOrDir=null)},iN.prototype.length=function(){return this._data[0]},iN.prototype.extendedAttributeRecordLength=function(){return this._data[1]},iN.prototype.lba=function(){return 2048*this._data.readUInt32LE(2)},iN.prototype.dataLength=function(){return this._data.readUInt32LE(10)},iN.prototype.recordingDate=function(){return iA(this._data,18)},iN.prototype.fileFlags=function(){return this._data[25]},iN.prototype.fileUnitSize=function(){return this._data[26]},iN.prototype.interleaveGapSize=function(){return this._data[27]},iN.prototype.volumeSequenceNumber=function(){return this._data.readUInt16LE(28)},iN.prototype.identifier=function(){return this._getString(33,this._data[32])},iN.prototype.fileName=function(t){if(this.hasRockRidge()){var e=this._rockRidgeFilename(t);if(null!==e)return e}var i=this.identifier();if(this.isDirectory(t))return i;var r=i.indexOf(";");return -1===r?i:"."===i[r-1]?i.slice(0,r-1):i.slice(0,r)},iN.prototype.isDirectory=function(t){var e=!!(2&this.fileFlags());return!e&&this.hasRockRidge()&&(e=this.getSUEntries(t).filter(function(t){return t instanceof iX}).length>0),e},iN.prototype.isSymlink=function(t){return this.hasRockRidge()&&this.getSUEntries(t).filter(function(t){return t instanceof iY}).length>0},iN.prototype.getSymlinkPath=function(t){for(var e="",i=this.getSUEntries(t),r=this._getGetString(),n=0;n<i.length;n+=1){var o=i[n];if(o instanceof iY){for(var s=0,a=o.componentRecords();s<a.length;s+=1){var l=a[s],u=l.flags();2&u?e+="./":4&u?e+="../":8&u?e+="/":(e+=l.content(r),1&u||(e+="/"))}if(!o.continueFlag())break}}return e.length>1&&"/"===e[e.length-1]?e.slice(0,e.length-1):e},iN.prototype.getFile=function(t){if(this.isDirectory(t))throw Error("Tried to get a File from a directory.");return null===this._fileOrDir&&(this._fileOrDir=t.slice(this.lba(),this.lba()+this.dataLength())),this._fileOrDir},iN.prototype.getDirectory=function(t){if(!this.isDirectory(t))throw Error("Tried to get a Directory from a file.");return null===this._fileOrDir&&(this._fileOrDir=this._constructDirectory(t)),this._fileOrDir},iN.prototype.getSUEntries=function(t){return this._suEntries||this._constructSUEntries(t),this._suEntries},iN.prototype._rockRidgeFilename=function(t){var e=this.getSUEntries(t).filter(function(t){return t instanceof iJ});if(0===e.length||6&e[0].flags())return null;for(var i="",r=this._getGetString(),n=0;n<e.length;n+=1){var o=e[n];if(i+=o.name(r),!(1&o.flags()))break}return i},iN.prototype._constructSUEntries=function(t){var e=33+this._data[32];e%2==1&&e++,e+=this._rockRidgeOffset,this._suEntries=ix(this._data,e,this.length(),t)},iN.prototype._getRockRidgeOffset=function(t){this._rockRidgeOffset=0;var e=this.getSUEntries(t);if(e.length>0){var i=e[0];if(i instanceof iK&&i.checkBytesPass())for(var r=1;r<e.length;r++){var n=e[r];if(n instanceof iV||n instanceof iB&&"IEEE_P1282"===n.extensionIdentifier())return i.bytesSkipped()}}return this._rockRidgeOffset=-1,-1};var iC=function(t){function e(e,i){t.call(this,e,i)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype._getString=function(t,e){return i_(this._data,t,e)},e.prototype._constructDirectory=function(t){return new i1(this,t)},e.prototype._getGetString=function(){return i_},e}(iN),iF=function(t){function e(e,i){t.call(this,e,i)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype._getString=function(t,e){return iD(this._data,t,e)},e.prototype._constructDirectory=function(t){return new i2(this,t)},e.prototype._getGetString=function(){return iD},e}(iN),iL=function(t){this._data=t};iL.prototype.signatureWord=function(){return this._data.readUInt16BE(0)},iL.prototype.signatureWordString=function(){return i_(this._data,0,2)},iL.prototype.length=function(){return this._data[2]},iL.prototype.suVersion=function(){return this._data[3]};var iM=function(t){function e(e){t.call(this,e),this._entries=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.continuationLba=function(){return this._data.readUInt32LE(4)},e.prototype.continuationLbaOffset=function(){return this._data.readUInt32LE(12)},e.prototype.continuationLength=function(){return this._data.readUInt32LE(20)},e.prototype.getEntries=function(t){if(!this._entries){var e=2048*this.continuationLba()+this.continuationLbaOffset();this._entries=ix(t,e,this.continuationLength(),t)}return this._entries},e}(iL),ij=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(iL),iK=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.checkBytesPass=function(){return 190===this._data[4]&&239===this._data[5]},e.prototype.bytesSkipped=function(){return this._data[6]},e}(iL),iU=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(iL),iB=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.identifierLength=function(){return this._data[4]},e.prototype.descriptorLength=function(){return this._data[5]},e.prototype.sourceLength=function(){return this._data[6]},e.prototype.extensionVersion=function(){return this._data[7]},e.prototype.extensionIdentifier=function(){return i_(this._data,8,this.identifierLength())},e.prototype.extensionDescriptor=function(){return i_(this._data,8+this.identifierLength(),this.descriptorLength())},e.prototype.extensionSource=function(){return i_(this._data,8+this.identifierLength()+this.descriptorLength(),this.sourceLength())},e}(iL),iz=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.extensionSequence=function(){return this._data[4]},e}(iL),iV=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(iL),iq=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.mode=function(){return this._data.readUInt32LE(4)},e.prototype.fileLinks=function(){return this._data.readUInt32LE(12)},e.prototype.uid=function(){return this._data.readUInt32LE(20)},e.prototype.gid=function(){return this._data.readUInt32LE(28)},e.prototype.inode=function(){return this._data.readUInt32LE(36)},e}(iL),iW=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.devTHigh=function(){return this._data.readUInt32LE(4)},e.prototype.devTLow=function(){return this._data.readUInt32LE(12)},e}(iL),iY=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.flags=function(){return this._data[4]},e.prototype.continueFlag=function(){return 1&this.flags()},e.prototype.componentRecords=function(){for(var t=[],e=5;e<this.length();){var i=new iH(this._data.slice(e));t.push(i),e+=i.length()}return t},e}(iL),iH=function(t){this._data=t};iH.prototype.flags=function(){return this._data[0]},iH.prototype.length=function(){return 2+this.componentLength()},iH.prototype.componentLength=function(){return this._data[1]},iH.prototype.content=function(t){return t(this._data,2,this.componentLength())};var iJ=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.flags=function(){return this._data[4]},e.prototype.name=function(t){return t(this._data,5,this.length()-5)},e}(iL),iX=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.childDirectoryLba=function(){return this._data.readUInt32LE(4)},e}(iL),iG=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.parentDirectoryLba=function(){return this._data.readUInt32LE(4)},e}(iL),iZ=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(iL),iQ=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.flags=function(){return this._data[4]},e.prototype.creation=function(){return 1&this.flags()?this._longFormDates()?iT(this._data,5):iA(this._data,5):null},e.prototype.modify=function(){if(2&this.flags()){var t=1&this.flags()?1:0;return this._longFormDates?iT(this._data,5+17*t):iA(this._data,5+7*t)}return null},e.prototype.access=function(){if(4&this.flags()){var t=1&this.flags()?1:0;return t+=2&this.flags()?1:0,this._longFormDates?iT(this._data,5+17*t):iA(this._data,5+7*t)}return null},e.prototype.backup=function(){if(16&this.flags()){var t=1&this.flags()?1:0;return t+=(2&this.flags()?1:0)+(4&this.flags()?1:0),this._longFormDates?iT(this._data,5+17*t):iA(this._data,5+7*t)}return null},e.prototype.expiration=function(){if(32&this.flags()){var t=1&this.flags()?1:0;return t+=(2&this.flags()?1:0)+(4&this.flags()?1:0)+(16&this.flags()?1:0),this._longFormDates?iT(this._data,5+17*t):iA(this._data,5+7*t)}return null},e.prototype.effective=function(){if(64&this.flags()){var t=1&this.flags()?1:0;return t+=(2&this.flags()?1:0)+(4&this.flags()?1:0)+(16&this.flags()?1:0)+(32&this.flags()?1:0),this._longFormDates?iT(this._data,5+17*t):iA(this._data,5+7*t)}return null},e.prototype._longFormDates=function(){return!!this.flags()},e}(iL),i$=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.virtualSizeHigh=function(){return this._data.readUInt32LE(4)},e.prototype.virtualSizeLow=function(){return this._data.readUInt32LE(12)},e.prototype.tableDepth=function(){return this._data[20]},e}(iL),i0=function(t,e){this._fileList=[],this._fileMap={},this._record=t;var i=t.lba(),r=i+t.dataLength();for(2&t.fileFlags()||(i=2048*t.getSUEntries(e).filter(function(t){return t instanceof iX})[0].childDirectoryLba(),r=1/0);i<r;)if(0!==e[i]){var n=this._constructDirectoryRecord(e.slice(i)),o=n.fileName(e);"\x00"!==o&&"\x01"!==o?n.hasRockRidge()&&0!==n.getSUEntries(e).filter(function(t){return t instanceof iZ}).length||(this._fileMap[o]=n,this._fileList.push(o)):r===1/0&&(r=i+n.dataLength()),i+=n.length()}else i++};i0.prototype.getRecord=function(t){return this._fileMap[t]},i0.prototype.getFileList=function(){return this._fileList},i0.prototype.getDotEntry=function(t){return this._constructDirectoryRecord(t.slice(this._record.lba()))};var i1=function(t){function e(e,i){t.call(this,e,i)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype._constructDirectoryRecord=function(t){return new iC(t,this._record.getRockRidgeOffset())},e}(i0),i2=function(t){function e(e,i){t.call(this,e,i)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype._constructDirectoryRecord=function(t){return new iF(t,this._record.getRockRidgeOffset())},e}(i0),i5=function(t){function e(i,r,n){var o=this;void 0===r&&(r=""),void 0===n&&(n=!0),t.call(this),this._data=i,R(n,e.Name,{data:"ISO data as a Buffer",name:r});for(var s=!1,a=32768,u=[];!s;){var c=i.slice(a);switch(new iO(c).type()){case 1:u.push(new iR(c));break;case 2:u.push(new ik(c));break;case 255:s=!0}a+=2048}if(0===u.length)throw new p(l.EIO,"Unable to find a suitable volume descriptor.");u.forEach(function(t){o._pvd&&2===o._pvd.type()||(o._pvd=t)}),this._root=this._pvd.rootDirectoryEntry(i),this._name=r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.Create=function(t,i){var r;try{r=new e(t.data,t.name,!1)}catch(t){}finally{i(void 0,r)}},e.isAvailable=function(){return!0},e.prototype.getName=function(){var t="IsoFS"+this._name+(this._pvd?"-"+this._pvd.name():"");return this._root&&this._root.hasRockRidge()&&(t+="-RockRidge"),t},e.prototype.diskSpace=function(t,e){e(this._data.length,0)},e.prototype.isReadOnly=function(){return!0},e.prototype.supportsLinks=function(){return!1},e.prototype.supportsProps=function(){return!1},e.prototype.supportsSynch=function(){return!0},e.prototype.statSync=function(t,e){var i=this._getDirectoryRecord(t);if(null===i)throw p.ENOENT(t);return this._getStats(t,i)},e.prototype.openSync=function(t,e,i){if(e.isWriteable())throw new p(l.EPERM,t);var r=this._getDirectoryRecord(t);if(!r)throw p.ENOENT(t);if(r.isSymlink(this._data))return this.openSync(c.resolve(t,r.getSymlinkPath(this._data)),e,i);if(r.isDirectory(this._data))throw p.EISDIR(t);var n=r.getFile(this._data),o=this._getStats(t,r);switch(e.pathExistsAction()){case f.THROW_EXCEPTION:case f.TRUNCATE_FILE:throw p.EEXIST(t);case f.NOP:return new tt(this,t,e,o,n);default:throw new p(l.EINVAL,"Invalid FileMode object.")}},e.prototype.readdirSync=function(t){var e=this._getDirectoryRecord(t);if(e){if(e.isDirectory(this._data))return e.getDirectory(this._data).getFileList().slice(0);throw p.ENOTDIR(t)}throw p.ENOENT(t)},e.prototype.readFileSync=function(t,e,i){var r=this.openSync(t,i,420);try{var n=r.getBuffer();return null===e?B(n):n.toString(e)}finally{r.closeSync()}},e.prototype._getDirectoryRecord=function(t){if("/"===t)return this._root;for(var e=t.split("/").slice(1),i=this._root,r=0;r<e.length;r+=1){var n=e[r];if(!i.isDirectory(this._data)||!(i=i.getDirectory(this._data).getRecord(n)))return null}return i},e.prototype._getStats=function(t,e){if(e.isSymlink(this._data)){var i=c.resolve(t,e.getSymlinkPath(this._data)),r=this._getDirectoryRecord(i);return r?this._getStats(i,r):null}var n=e.dataLength(),o=365,s=e.recordingDate(),a=s,l=s,u=s;if(e.hasRockRidge())for(var h=0,d=e.getSUEntries(this._data);h<d.length;h+=1){var f=d[h];if(f instanceof iq)o=f.mode();else if(f instanceof iQ){var p=f.flags();4&p&&(a=f.access()),2&p&&(l=f.modify()),1&p&&(u=f.creation())}}return o&=365,new w(e.isDirectory(this._data)?v.DIRECTORY:v.FILE,n,o,a,l,u)},e}(Z);i5.Name="IsoFS",i5.Options={data:{type:"object",description:"The ISO file in a buffer",validator:q}},[ti,t5,t8,t4,en,ev,e_,i5,ex,eO,eX,e7,il,iI].forEach(function(t){var e=t.Create;t.Create=function(i,r){var n="function"==typeof i,o=n?i:r,s=n?{}:i;W(t,s,function(i){i?o(i):e.call(t,s,o)})}});var i3={AsyncMirror:ti,Dropbox:t5,Emscripten:t8,FolderAdapter:t4,HTML5FS:en,InMemory:ev,IndexedDB:e_,IsoFS:i5,LocalStorage:ex,MountableFileSystem:eO,OverlayFS:eX,WorkerFS:e7,XmlHttpRequest:il,ZipFS:iI};function i6(t){switch(t){case"fs":return O;case"path":return c;case"buffer":return u;case"process":return o;case"bfs_utils":return Y;default:return i3[t]}}function i8(t){return O.initialize(t)}function i4(t,e){var i=t.fs;if(!i)return e(new p(l.EPERM,'Missing "fs" property on configuration object.'));var r=t.options,n=0,o=!1;function s(){if(!o){o=!0;var t=i3[i];t?t.Create(r,e):e(new p(l.EPERM,"File system "+i+" is not available in BrowserFS."))}}if(null!==r&&"object"==typeof r){var a=!1;Object.keys(r).filter(function(t){return"fs"!==t}).forEach(function(t){var i=r[t];null!==i&&"object"==typeof i&&i.fs&&(n++,i4(i,function(i,l){(n--,i)?o||(o=!0,e(i)):(r[t]=l,0===n&&a&&s())}))}),a=!0}0===n&&s()}o.initializeTTYs&&o.initializeTTYs(),"undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array&&(Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=this.length),t<0&&(t=this.length+t)<0&&(t=0),e<0&&(e=this.length+e)<0&&(e=0),e<t&&(e=t),new Uint8Array(this.buffer,this.byteOffset+t,e-t)})),e.install=function(e){e.Buffer=t,e.process=o;var i=e.require?e.require:null;e.require=function(t){return i6(t)||i.apply(null,Array.prototype.slice.call(arguments,0))}},e.registerFileSystem=function(t,e){i3[t]=e},e.BFSRequire=i6,e.initialize=i8,e.configure=function(t,e){i4(t,function(t,i){i?(i8(i),e()):e(t)})},e.getFileSystem=i4,e.EmscriptenFS=X,e.FileSystem=i3,e.Errors=y,e.setImmediate=eB}).call(e,i(1),function(){return this}(),i(5)(t),i(6))},function(t,e,i){t.exports=i(2).Buffer},function(t,e,i){(function(t){/*!
	 * The buffer module from node.js, for the browser.
	 *
	 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
	 * @license  MIT
	 */var r=i(3),n=i(4);function o(e){if(e>2147483647)throw RangeError("Invalid typed array length");var i=new Uint8Array(e);return i.__proto__=t.prototype,i}function t(t,e,i){if("number"==typeof t){if("string"==typeof e)throw Error("If encoding is specified then the first argument must be a string");return l(t)}return s(t,e,i)}function s(e,i,r){if("number"==typeof e)throw TypeError('"value" argument must not be a number');return A(e)?function(e,i,r){var n;if(i<0||e.byteLength<i)throw RangeError("'offset' is out of bounds");if(e.byteLength<i+(r||0))throw RangeError("'length' is out of bounds");return(n=void 0===i&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,i):new Uint8Array(e,i,r)).__proto__=t.prototype,n}(e,i,r):"string"==typeof e?function(e,i){if("string"==typeof i&&""!==i||(i="utf8"),!t.isEncoding(i))throw TypeError('"encoding" must be a valid string encoding');var r=0|h(e,i),n=o(r),s=n.write(e,i);return s!==r&&(n=n.slice(0,s)),n}(e,i):function(e){if(t.isBuffer(e)){var i,r=0|c(e.length),n=o(r);return 0===n.length||e.copy(n,0,0,r),n}if(e){if(x(e)||"length"in e)return"number"!=typeof e.length||(i=e.length)!=i?o(0):u(e);if("Buffer"===e.type&&Array.isArray(e.data))return u(e.data)}throw TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e)}function a(t){if("number"!=typeof t)throw TypeError('"size" argument must be a number');if(t<0)throw RangeError('"size" argument must not be negative')}function l(t){return a(t),o(t<0?0:0|c(t))}function u(t){for(var e=t.length<0?0:0|c(t.length),i=o(e),r=0;r<e;r+=1)i[r]=255&t[r];return i}function c(t){if(t>=2147483647)throw RangeError("Attempt to allocate Buffer larger than maximum size: 0x7fffffff bytes");return 0|t}function h(e,i){if(t.isBuffer(e))return e.length;if(x(e)||A(e))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var n=!1;;)switch(i){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return _(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return D(e).length;default:if(n)return _(e).length;i=(""+i).toLowerCase(),n=!0}}function d(t,e,i){var n,o,s=!1;if((void 0===e||e<0)&&(e=0),e>this.length||((void 0===i||i>this.length)&&(i=this.length),i<=0)||(i>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return function(t,e,i){var r,n=t.length;(!e||e<0)&&(e=0),(!i||i<0||i>n)&&(i=n);for(var o="",s=e;s<i;++s)o+=(r=t[s])<16?"0"+r.toString(16):r.toString(16);return o}(this,e,i);case"utf8":case"utf-8":return g(this,e,i);case"ascii":return function(t,e,i){var r="";i=Math.min(t.length,i);for(var n=e;n<i;++n)r+=String.fromCharCode(127&t[n]);return r}(this,e,i);case"latin1":case"binary":return function(t,e,i){var r="";i=Math.min(t.length,i);for(var n=e;n<i;++n)r+=String.fromCharCode(t[n]);return r}(this,e,i);case"base64":return n=e,o=i,0===n&&o===this.length?r.fromByteArray(this):r.fromByteArray(this.slice(n,o));case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return function(t,e,i){for(var r=t.slice(e,i),n="",o=0;o<r.length;o+=2)n+=String.fromCharCode(r[o]+256*r[o+1]);return n}(this,e,i);default:if(s)throw TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),s=!0}}function f(t,e,i){var r=t[e];t[e]=t[i],t[i]=r}function p(e,i,r,n,o){var s;if(0===e.length)return -1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),(s=r=+r)!=s&&(r=o?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(o)return -1;r=e.length-1}else if(r<0){if(!o)return -1;r=0}if("string"==typeof i&&(i=t.from(i,n)),t.isBuffer(i))return 0===i.length?-1:y(e,i,r,n,o);if("number"==typeof i)return i&=255,"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(e,i,r):Uint8Array.prototype.lastIndexOf.call(e,i,r):y(e,[i],r,n,o);throw TypeError("val must be string, number or Buffer")}function y(t,e,i,r,n){var o,s=1,a=t.length,l=e.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(t.length<2||e.length<2)return -1;s=2,a/=2,l/=2,i/=2}function u(t,e){return 1===s?t[e]:t.readUInt16BE(e*s)}if(n){var c=-1;for(o=i;o<a;o++)if(u(t,o)===u(e,-1===c?0:o-c)){if(-1===c&&(c=o),o-c+1===l)return c*s}else -1!==c&&(o-=o-c),c=-1}else for(i+l>a&&(i=a-l),o=i;o>=0;o--){for(var h=!0,d=0;d<l;d++)if(u(t,o+d)!==u(e,d)){h=!1;break}if(h)return o}return -1}function g(t,e,i){i=Math.min(t.length,i);for(var r=[],n=e;n<i;){var o,s,a,l,u=t[n],c=null,h=u>239?4:u>223?3:u>191?2:1;if(n+h<=i)switch(h){case 1:u<128&&(c=u);break;case 2:128==(192&(o=t[n+1]))&&(l=(31&u)<<6|63&o)>127&&(c=l);break;case 3:o=t[n+1],s=t[n+2],128==(192&o)&&128==(192&s)&&(l=(15&u)<<12|(63&o)<<6|63&s)>2047&&(l<55296||l>57343)&&(c=l);break;case 4:o=t[n+1],s=t[n+2],a=t[n+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(l=(15&u)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&l<1114112&&(c=l)}null===c?(c=65533,h=1):c>65535&&(c-=65536,r.push(c>>>10&1023|55296),c=56320|1023&c),r.push(c),n+=h}return function(t){var e=t.length;if(e<=v)return String.fromCharCode.apply(String,t);for(var i="",r=0;r<e;)i+=String.fromCharCode.apply(String,t.slice(r,r+=v));return i}(r)}e.Buffer=t,e.SlowBuffer=function(e){return+e!=e&&(e=0),t.alloc(+e)},e.INSPECT_MAX_BYTES=50,e.kMaxLength=2147483647,t.TYPED_ARRAY_SUPPORT=function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()}catch(t){return!1}}(),t.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),"undefined"!=typeof Symbol&&Symbol.species&&t[Symbol.species]===t&&Object.defineProperty(t,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),t.poolSize=8192,t.from=function(t,e,i){return s(t,e,i)},t.prototype.__proto__=Uint8Array.prototype,t.__proto__=Uint8Array,t.alloc=function(t,e,i){return a(t),t<=0?o(t):void 0!==e?"string"==typeof i?o(t).fill(e,i):o(t).fill(e):o(t)},t.allocUnsafe=function(t){return l(t)},t.allocUnsafeSlow=function(t){return l(t)},t.isBuffer=function(t){return null!=t&&!0===t._isBuffer},t.compare=function(e,i){if(!t.isBuffer(e)||!t.isBuffer(i))throw TypeError("Arguments must be Buffers");if(e===i)return 0;for(var r=e.length,n=i.length,o=0,s=Math.min(r,n);o<s;++o)if(e[o]!==i[o]){r=e[o],n=i[o];break}return r<n?-1:n<r?1:0},t.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},t.concat=function(e,i){if(!Array.isArray(e))throw TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return t.alloc(0);if(void 0===i)for(i=0,r=0;r<e.length;++r)i+=e[r].length;var r,n=t.allocUnsafe(i),o=0;for(r=0;r<e.length;++r){var s=e[r];if(!t.isBuffer(s))throw TypeError('"list" argument must be an Array of Buffers');s.copy(n,o),o+=s.length}return n},t.byteLength=h,t.prototype._isBuffer=!0,t.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)f(this,e,e+1);return this},t.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)f(this,e,e+3),f(this,e+1,e+2);return this},t.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)f(this,e,e+7),f(this,e+1,e+6),f(this,e+2,e+5),f(this,e+3,e+4);return this},t.prototype.toString=function(){var t=this.length;return 0===t?"":0==arguments.length?g(this,0,t):d.apply(this,arguments)},t.prototype.equals=function(e){if(!t.isBuffer(e))throw TypeError("Argument must be a Buffer");return this===e||0===t.compare(this,e)},t.prototype.inspect=function(){var t="",i=e.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(t+=" ... ")),"<Buffer "+t+">"},t.prototype.compare=function(e,i,r,n,o){if(!t.isBuffer(e))throw TypeError("Argument must be a Buffer");if(void 0===i&&(i=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===o&&(o=this.length),i<0||r>e.length||n<0||o>this.length)throw RangeError("out of range index");if(n>=o&&i>=r)return 0;if(n>=o)return -1;if(i>=r)return 1;if(this===e)return 0;for(var s=(o>>>=0)-(n>>>=0),a=(r>>>=0)-(i>>>=0),l=Math.min(s,a),u=this.slice(n,o),c=e.slice(i,r),h=0;h<l;++h)if(u[h]!==c[h]){s=u[h],a=c[h];break}return s<a?-1:a<s?1:0},t.prototype.includes=function(t,e,i){return -1!==this.indexOf(t,e,i)},t.prototype.indexOf=function(t,e,i){return p(this,t,e,i,!0)},t.prototype.lastIndexOf=function(t,e,i){return p(this,t,e,i,!1)},t.prototype.write=function(t,e,i,r){if(void 0===e)r="utf8",i=this.length,e=0;else if(void 0===i&&"string"==typeof e)r=e,i=this.length,e=0;else{if(!isFinite(e))throw Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e>>>=0,isFinite(i)?(i>>>=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}var n,o,s,a,l,u,c,h,d,f,p=this.length-e;if((void 0===i||i>p)&&(i=p),t.length>0&&(i<0||e<0)||e>this.length)throw RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var y=!1;;)switch(r){case"hex":return function(t,e,i,r){i=Number(i)||0;var n=t.length-i;r?(r=Number(r))>n&&(r=n):r=n;var o=e.length;if(o%2!=0)throw TypeError("Invalid hex string");r>o/2&&(r=o/2);for(var s=0;s<r;++s){var a=parseInt(e.substr(2*s,2),16);if(a!=a)break;t[i+s]=a}return s}(this,t,e,i);case"utf8":case"utf-8":return l=e,u=i,T(_(t,this.length-l),this,l,u);case"ascii":case"latin1":case"binary":return n=this,o=t,s=e,a=i,T(function(t){for(var e=[],i=0;i<t.length;++i)e.push(255&t.charCodeAt(i));return e}(o),n,s,a);case"base64":return c=e,h=i,T(D(t),this,c,h);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return d=e,f=i,T(function(t,e){for(var i,r,n=[],o=0;o<t.length&&!((e-=2)<0);++o)r=(i=t.charCodeAt(o))>>8,n.push(i%256),n.push(r);return n}(t,this.length-d),this,d,f);default:if(y)throw TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),y=!0}},t.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var v=4096;function m(t,e,i){if(t%1!=0||t<0)throw RangeError("offset is not uint");if(t+e>i)throw RangeError("Trying to access beyond buffer length")}function w(e,i,r,n,o,s){if(!t.isBuffer(e))throw TypeError('"buffer" argument must be a Buffer instance');if(i>o||i<s)throw RangeError('"value" argument is out of bounds');if(r+n>e.length)throw RangeError("Index out of range")}function S(t,e,i,r,n,o){if(i+r>t.length||i<0)throw RangeError("Index out of range")}function b(t,e,i,r,o){return e=+e,i>>>=0,o||S(t,0,i,4),n.write(t,e,i,r,23,4),i+4}function E(t,e,i,r,o){return e=+e,i>>>=0,o||S(t,0,i,8),n.write(t,e,i,r,52,8),i+8}t.prototype.slice=function(e,i){var r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(i=void 0===i?r:~~i)<0?(i+=r)<0&&(i=0):i>r&&(i=r),i<e&&(i=e);var n=this.subarray(e,i);return n.__proto__=t.prototype,n},t.prototype.readUIntLE=function(t,e,i){t>>>=0,e>>>=0,i||m(t,e,this.length);for(var r=this[t],n=1,o=0;++o<e&&(n*=256);)r+=this[t+o]*n;return r},t.prototype.readUIntBE=function(t,e,i){t>>>=0,e>>>=0,i||m(t,e,this.length);for(var r=this[t+--e],n=1;e>0&&(n*=256);)r+=this[t+--e]*n;return r},t.prototype.readUInt8=function(t,e){return t>>>=0,e||m(t,1,this.length),this[t]},t.prototype.readUInt16LE=function(t,e){return t>>>=0,e||m(t,2,this.length),this[t]|this[t+1]<<8},t.prototype.readUInt16BE=function(t,e){return t>>>=0,e||m(t,2,this.length),this[t]<<8|this[t+1]},t.prototype.readUInt32LE=function(t,e){return t>>>=0,e||m(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},t.prototype.readUInt32BE=function(t,e){return t>>>=0,e||m(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},t.prototype.readIntLE=function(t,e,i){t>>>=0,e>>>=0,i||m(t,e,this.length);for(var r=this[t],n=1,o=0;++o<e&&(n*=256);)r+=this[t+o]*n;return r>=(n*=128)&&(r-=Math.pow(2,8*e)),r},t.prototype.readIntBE=function(t,e,i){t>>>=0,e>>>=0,i||m(t,e,this.length);for(var r=e,n=1,o=this[t+--r];r>0&&(n*=256);)o+=this[t+--r]*n;return o>=(n*=128)&&(o-=Math.pow(2,8*e)),o},t.prototype.readInt8=function(t,e){return t>>>=0,e||m(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},t.prototype.readInt16LE=function(t,e){t>>>=0,e||m(t,2,this.length);var i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},t.prototype.readInt16BE=function(t,e){t>>>=0,e||m(t,2,this.length);var i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},t.prototype.readInt32LE=function(t,e){return t>>>=0,e||m(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},t.prototype.readInt32BE=function(t,e){return t>>>=0,e||m(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},t.prototype.readFloatLE=function(t,e){return t>>>=0,e||m(t,4,this.length),n.read(this,t,!0,23,4)},t.prototype.readFloatBE=function(t,e){return t>>>=0,e||m(t,4,this.length),n.read(this,t,!1,23,4)},t.prototype.readDoubleLE=function(t,e){return t>>>=0,e||m(t,8,this.length),n.read(this,t,!0,52,8)},t.prototype.readDoubleBE=function(t,e){return t>>>=0,e||m(t,8,this.length),n.read(this,t,!1,52,8)},t.prototype.writeUIntLE=function(t,e,i,r){t=+t,e>>>=0,i>>>=0,r||w(this,t,e,i,Math.pow(2,8*i)-1,0);var n=1,o=0;for(this[e]=255&t;++o<i&&(n*=256);)this[e+o]=t/n&255;return e+i},t.prototype.writeUIntBE=function(t,e,i,r){t=+t,e>>>=0,i>>>=0,r||w(this,t,e,i,Math.pow(2,8*i)-1,0);var n=i-1,o=1;for(this[e+n]=255&t;--n>=0&&(o*=256);)this[e+n]=t/o&255;return e+i},t.prototype.writeUInt8=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,1,255,0),this[e]=255&t,e+1},t.prototype.writeUInt16LE=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},t.prototype.writeUInt16BE=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},t.prototype.writeUInt32LE=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},t.prototype.writeUInt32BE=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},t.prototype.writeIntLE=function(t,e,i,r){if(t=+t,e>>>=0,!r){var n=Math.pow(2,8*i-1);w(this,t,e,i,n-1,-n)}var o=0,s=1,a=0;for(this[e]=255&t;++o<i&&(s*=256);)t<0&&0===a&&0!==this[e+o-1]&&(a=1),this[e+o]=(t/s>>0)-a&255;return e+i},t.prototype.writeIntBE=function(t,e,i,r){if(t=+t,e>>>=0,!r){var n=Math.pow(2,8*i-1);w(this,t,e,i,n-1,-n)}var o=i-1,s=1,a=0;for(this[e+o]=255&t;--o>=0&&(s*=256);)t<0&&0===a&&0!==this[e+o+1]&&(a=1),this[e+o]=(t/s>>0)-a&255;return e+i},t.prototype.writeInt8=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},t.prototype.writeInt16LE=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},t.prototype.writeInt16BE=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},t.prototype.writeInt32LE=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,4,2147483647,-2147483648),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},t.prototype.writeInt32BE=function(t,e,i){return t=+t,e>>>=0,i||w(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},t.prototype.writeFloatLE=function(t,e,i){return b(this,t,e,!0,i)},t.prototype.writeFloatBE=function(t,e,i){return b(this,t,e,!1,i)},t.prototype.writeDoubleLE=function(t,e,i){return E(this,t,e,!0,i)},t.prototype.writeDoubleBE=function(t,e,i){return E(this,t,e,!1,i)},t.prototype.copy=function(t,e,i,r){if(i||(i=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<i&&(r=i),r===i||0===t.length||0===this.length)return 0;if(e<0)throw RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw RangeError("sourceStart out of bounds");if(r<0)throw RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-i&&(r=t.length-e+i);var n,o=r-i;if(this===t&&i<e&&e<r)for(n=o-1;n>=0;--n)t[n+e]=this[n+i];else if(o<1e3)for(n=0;n<o;++n)t[n+e]=this[n+i];else Uint8Array.prototype.set.call(t,this.subarray(i,i+o),e);return o},t.prototype.fill=function(e,i,r,n){if("string"==typeof e){if("string"==typeof i?(n=i,i=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),1===e.length){var o,s=e.charCodeAt(0);s<256&&(e=s)}if(void 0!==n&&"string"!=typeof n)throw TypeError("encoding must be a string");if("string"==typeof n&&!t.isEncoding(n))throw TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(i<0||this.length<i||this.length<r)throw RangeError("Out of range index");if(r<=i)return this;if(i>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(o=i;o<r;++o)this[o]=e;else{var a=t.isBuffer(e)?e:new t(e,n),l=a.length;for(o=0;o<r-i;++o)this[o+i]=a[o%l]}return this};var I=/[^+/0-9A-Za-z-_]/g;function _(t,e){var i;e=e||1/0;for(var r=t.length,n=null,o=[],s=0;s<r;++s){if((i=t.charCodeAt(s))>55295&&i<57344){if(!n){if(i>56319||s+1===r){(e-=3)>-1&&o.push(239,191,189);continue}n=i;continue}if(i<56320){(e-=3)>-1&&o.push(239,191,189),n=i;continue}i=65536+(n-55296<<10|i-56320)}else n&&(e-=3)>-1&&o.push(239,191,189);if(n=null,i<128){if((e-=1)<0)break;o.push(i)}else if(i<2048){if((e-=2)<0)break;o.push(i>>6|192,63&i|128)}else if(i<65536){if((e-=3)<0)break;o.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw Error("Invalid code point");if((e-=4)<0)break;o.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return o}function D(t){return r.toByteArray(function(t){if((t=t.trim().replace(I,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function T(t,e,i,r){for(var n=0;n<r&&!(n+i>=e.length||n>=t.length);++n)e[n+i]=t[n];return n}function A(t){return t instanceof ArrayBuffer||null!=t&&null!=t.constructor&&"ArrayBuffer"===t.constructor.name&&"number"==typeof t.byteLength}function x(t){return"function"==typeof ArrayBuffer.isView&&ArrayBuffer.isView(t)}}).call(e,i(1))},function(t,e){e.byteLength=function(t){return 3*t.length/4-a(t)},e.toByteArray=function(t){var e,i,o,s,l,u,c=t.length;l=a(t),u=new n(3*c/4-l),o=l>0?c-4:c;var h=0;for(e=0,i=0;e<o;e+=4,i+=3)s=r[t.charCodeAt(e)]<<18|r[t.charCodeAt(e+1)]<<12|r[t.charCodeAt(e+2)]<<6|r[t.charCodeAt(e+3)],u[h++]=s>>16&255,u[h++]=s>>8&255,u[h++]=255&s;return 2===l?(s=r[t.charCodeAt(e)]<<2|r[t.charCodeAt(e+1)]>>4,u[h++]=255&s):1===l&&(s=r[t.charCodeAt(e)]<<10|r[t.charCodeAt(e+1)]<<4|r[t.charCodeAt(e+2)]>>2,u[h++]=s>>8&255,u[h++]=255&s),u},e.fromByteArray=function(t){for(var e,r=t.length,n=r%3,o="",s=[],a=0,l=r-n;a<l;a+=16383)s.push(function(t,e,r){for(var n,o=[],s=e;s<r;s+=3)o.push(i[(n=(t[s]<<16)+(t[s+1]<<8)+t[s+2])>>18&63]+i[n>>12&63]+i[n>>6&63]+i[63&n]);return o.join("")}(t,a,a+16383>l?l:a+16383));return 1===n?o+=i[(e=t[r-1])>>2]+i[e<<4&63]+"==":2===n&&(o+=i[(e=(t[r-2]<<8)+t[r-1])>>10]+i[e>>4&63]+i[e<<2&63]+"="),s.push(o),s.join("")};for(var i=[],r=[],n="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)i[s]=o[s],r[o.charCodeAt(s)]=s;function a(t){var e=t.length;if(e%4>0)throw Error("Invalid string. Length must be a multiple of 4");return"="===t[e-2]?2:"="===t[e-1]?1:0}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},function(t,e){e.read=function(t,e,i,r,n){var o,s,a=8*n-r-1,l=(1<<a)-1,u=l>>1,c=-7,h=i?n-1:0,d=i?-1:1,f=t[e+h];for(h+=d,o=f&(1<<-c)-1,f>>=-c,c+=a;c>0;o=256*o+t[e+h],h+=d,c-=8);for(s=o&(1<<-c)-1,o>>=-c,c+=r;c>0;s=256*s+t[e+h],h+=d,c-=8);if(0===o)o=1-u;else{if(o===l)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,r),o-=u}return(f?-1:1)*s*Math.pow(2,o-r)},e.write=function(t,e,i,r,n,o){var s,a,l,u=8*o-n-1,c=(1<<u)-1,h=c>>1,d=23===n?5960464477539062e-23:0,f=r?0:o-1,p=r?1:-1,y=e<0||0===e&&1/e<0?1:0;for(isNaN(e=Math.abs(e))||e===1/0?(a=isNaN(e)?1:0,s=c):(s=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-s))<1&&(s--,l*=2),(e+=s+h>=1?d/l:d*Math.pow(2,1-h))*l>=2&&(s++,l/=2),s+h>=c?(a=0,s=c):s+h>=1?(a=(e*l-1)*Math.pow(2,n),s+=h):(a=e*Math.pow(2,h-1)*Math.pow(2,n),s=0));n>=8;t[i+f]=255&a,f+=p,a/=256,n-=8);for(s=s<<n|a,u+=n;u>0;t[i+f]=255&s,f+=p,s/=256,u-=8);t[i+f-p]|=128*y}},function(t,e){t.exports=function(t){return t.webpackPolyfill||(t.deprecate=function(){},t.paths=[],t.children=[],t.webpackPolyfill=1),t}},function(t,e,i){var r=new(i(7)),n={};for(var o in r)!function(t){n[t]||("function"==typeof r[t]?n[t]=function(){return r[t].apply(r,arguments)}:n[t]=r[t])}(o);n.initializeTTYs=function(){null===r.stdin&&(r.initializeTTYs(),n.stdin=r.stdin,n.stdout=r.stdout,n.stderr=r.stderr)},r.nextTick(function(){n.initializeTTYs()}),t.exports=n},function(t,e,i){(function(e){var r=this&&this.__extends||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);function r(){this.constructor=t}t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},n=i(8),o=null,s=function(){function t(t,e){this.fun=t,this.array=e}return t.prototype.run=function(){this.fun.apply(null,this.array)},t}(),a=function(){function t(){this._queue=[],this._draining=!1,this._currentQueue=null,this._queueIndex=-1}return t.prototype.push=function(t){var e=this;1!==this._queue.push(t)||this._draining||setTimeout(function(){return e._drainQueue()},0)},t.prototype._cleanUpNextTick=function(){this._draining=!1,this._currentQueue&&this._currentQueue.length?this._queue=this._currentQueue.concat(this._queue):this._queueIndex=-1,this._queue.length&&this._drainQueue()},t.prototype._drainQueue=function(){var t=this;if(!this._draining){var e=setTimeout(function(){return t._cleanUpNextTick()});this._draining=!0;for(var i=this._queue.length;i;){for(this._currentQueue=this._queue,this._queue=[];++this._queueIndex<i;)this._currentQueue&&this._currentQueue[this._queueIndex].run();this._queueIndex=-1,i=this._queue.length}this._currentQueue=null,this._draining=!1,clearTimeout(e)}},t}(),l=function(t){function n(){t.apply(this,arguments),this.startTime=Date.now(),this._cwd="/",this.platform="browser",this.argv=[],this.execArgv=[],this.stdout=null,this.stderr=null,this.stdin=null,this.domain=null,this._queue=new a,this.execPath=e,this.env={},this.exitCode=0,this._gid=1,this._uid=1,this.version="v5.0",this.versions={http_parser:"0.0",node:"5.0",v8:"0.0",uv:"0.0",zlib:"0.0",ares:"0.0",icu:"0.0",modules:"0",openssl:"0.0"},this.config={target_defaults:{cflags:[],default_configuration:"Release",defines:[],include_dirs:[],libraries:[]},variables:{clang:0,host_arch:"x32",node_install_npm:!1,node_install_waf:!1,node_prefix:"",node_shared_cares:!1,node_shared_http_parser:!1,node_shared_libuv:!1,node_shared_zlib:!1,node_shared_v8:!1,node_use_dtrace:!1,node_use_etw:!1,node_use_openssl:!1,node_shared_openssl:!1,strict_aliasing:!1,target_arch:"x32",v8_use_snapshot:!1,v8_no_strict_aliasing:0,visibility:""}},this.pid=1e3*Math.random()|0,this.title="node",this.arch="x32",this._mask=18,this.connected=void 0}return r(n,t),n.prototype.chdir=function(t){null===o&&(o=i(9)),this._cwd=o.resolve(t)},n.prototype.cwd=function(){return this._cwd},n.prototype.uptime=function(){return(Date.now()-this.startTime)/1e3|0},n.prototype.nextTick=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this._queue.push(new s(t,e))},n.prototype.abort=function(){this.emit("abort")},n.prototype.exit=function(t){this.exitCode=t,this.emit("exit",[t])},n.prototype.getgid=function(){return this._gid},n.prototype.setgid=function(t){this._gid="number"==typeof t?t:1},n.prototype.getuid=function(){return this._uid},n.prototype.setuid=function(t){this._uid="number"==typeof t?t:1},n.prototype.kill=function(t,e){this.emit("kill",[t,e])},n.prototype.memoryUsage=function(){return{rss:0,heapTotal:0,heapUsed:0}},n.prototype.umask=function(t){void 0===t&&(t=this._mask);var e=this._mask;return this._mask=t,this.emit("umask",[t]),e},n.prototype.hrtime=function(){var t,e=(t="undefined"!=typeof performance?performance.now():Date.now?Date.now():(new Date).getTime())/1e3|0;return[e,t=1e6*(t-=1e3*e)|0]},n.prototype.initializeTTYs=function(){if(null===this.stdout){var t=i(10);this.stdout=new t,this.stderr=new t,this.stdin=new t}},n.prototype.disconnect=function(){},n}(n.EventEmitter);t.exports=l}).call(e,"/")},function(t,e){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(t){return"function"==typeof t}function n(t){return"object"==typeof t&&null!==t}t.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},i.prototype.emit=function(t){var e,i,o,s,a,l;if(this._events||(this._events={}),"error"===t&&(!this._events.error||n(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var u=Error('Uncaught, unspecified "error" event. ('+e+")");throw u.context=e,u}if(void 0===(i=this._events[t]))return!1;if(r(i))switch(arguments.length){case 1:i.call(this);break;case 2:i.call(this,arguments[1]);break;case 3:i.call(this,arguments[1],arguments[2]);break;default:s=Array.prototype.slice.call(arguments,1),i.apply(this,s)}else if(n(i))for(s=Array.prototype.slice.call(arguments,1),o=(l=i.slice()).length,a=0;a<o;a++)l[a].apply(this,s);return!0},i.prototype.addListener=function(t,e){var o;if(!r(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,r(e.listener)?e.listener:e),this._events[t]?n(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,n(this._events[t])&&!this._events[t].warned&&(o=void 0===this._maxListeners?i.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[t].length>o&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace()),this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(t,e){if(!r(e))throw TypeError("listener must be a function");var i=!1;function n(){this.removeListener(t,n),i||(i=!0,e.apply(this,arguments))}return n.listener=e,this.on(t,n),this},i.prototype.removeListener=function(t,e){var i,o,s,a;if(!r(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(s=(i=this._events[t]).length,o=-1,i===e||r(i.listener)&&i.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(n(i)){for(a=s;a-- >0;)if(i[a]===e||i[a].listener&&i[a].listener===e){o=a;break}if(o<0)return this;1===i.length?(i.length=0,delete this._events[t]):i.splice(o,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},i.prototype.removeAllListeners=function(t){var e,i;if(!this._events)return this;if(!this._events.removeListener)return 0==arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0==arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(r(i=this._events[t]))this.removeListener(t,i);else if(i)for(;i.length;)this.removeListener(t,i[i.length-1]);return delete this._events[t],this},i.prototype.listeners=function(t){return this._events&&this._events[t]?r(this._events[t])?[this._events[t]]:this._events[t].slice():[]},i.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(r(e))return 1;if(e)return e.length}return 0},i.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e,i){(function(e){var i=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,r=function(){function t(){}return t.normalize=function(e){""===e&&(e=".");for(var i=e.charAt(0)===t.sep,r=(e=t._removeDuplicateSeps(e)).split(t.sep),n=[],o=0;o<r.length;o++){var s=r[o];"."!==s&&(".."===s&&(i||!i&&n.length>0&&".."!==n[0])?n.pop():n.push(s))}return!i&&n.length<2&&(1===n.length?""===n[0]&&n.unshift("."):n.push(".")),e=n.join(t.sep),i&&e.charAt(0)!==t.sep&&(e=t.sep+e),e},t.join=function(){for(var e=[],i=0;i<arguments.length;i++)e[i-0]=arguments[i];for(var r=[],n=0;n<e.length;n++){var o=e[n];if("string"!=typeof o)throw TypeError("Invalid argument type to path.join: "+typeof o);""!==o&&r.push(o)}return t.normalize(r.join(t.sep))},t.resolve=function(){for(var i=[],r=0;r<arguments.length;r++)i[r-0]=arguments[r];for(var n=[],o=0;o<i.length;o++){var s=i[o];if("string"!=typeof s)throw TypeError("Invalid argument type to path.join: "+typeof s);""!==s&&(s.charAt(0)===t.sep&&(n=[]),n.push(s))}var a=t.normalize(n.join(t.sep));if(a.length>1&&a.charAt(a.length-1)===t.sep)return a.substr(0,a.length-1);if(a.charAt(0)!==t.sep){"."!==a.charAt(0)||1!==a.length&&a.charAt(1)!==t.sep||(a=1===a.length?"":a.substr(2));var l=e.cwd();a=""!==a?this.normalize(l+("/"!==l?t.sep:"")+a):l}return a},t.relative=function(e,i){e=t.resolve(e),i=t.resolve(i);var r,n=e.split(t.sep),o=i.split(t.sep);o.shift(),n.shift();var s=0,a=[];for(r=0;r<n.length;r++)if(n[r]!==o[r]){s=n.length-r;break}a=o.slice(r),1===n.length&&""===n[0]&&(s=0),s>n.length&&(s=n.length);var l="";for(r=0;r<s;r++)l+="../";return(l+=a.join(t.sep)).length>1&&l.charAt(l.length-1)===t.sep&&(l=l.substr(0,l.length-1)),l},t.dirname=function(e){var i=(e=t._removeDuplicateSeps(e)).charAt(0)===t.sep,r=e.split(t.sep);return""===r.pop()&&r.length>0&&r.pop(),r.length>1||1===r.length&&!i?r.join(t.sep):i?t.sep:"."},t.basename=function(e,i){if(void 0===i&&(i=""),""===e)return e;var r=(e=t.normalize(e)).split(t.sep),n=r[r.length-1];return""===n&&r.length>1?r[r.length-2]:i.length>0&&n.substr(n.length-i.length)===i?n.substr(0,n.length-i.length):n},t.extname=function(e){var i=(e=t.normalize(e)).split(t.sep);if(""===(e=i.pop())&&i.length>0&&(e=i.pop()),".."===e)return"";var r=e.lastIndexOf(".");return -1===r||0===r?"":e.substr(r)},t.isAbsolute=function(e){return e.length>0&&e.charAt(0)===t.sep},t._makeLong=function(t){return t},t.parse=function(t){var e,r=((e=i.exec(t)).shift(),e);return{root:r[0],dir:r[0]+r[1].slice(0,-1),base:r[2],ext:r[3],name:r[2].slice(0,r[2].length-r[3].length)}},t.format=function(e){if(null===e||"object"!=typeof e)throw TypeError("Parameter 'pathObject' must be an object, not "+typeof e);if("string"!=typeof(e.root||""))throw TypeError("'pathObject.root' must be a string or undefined, not "+typeof e.root);return(e.dir?e.dir+t.sep:"")+(e.base||"")},t._removeDuplicateSeps=function(t){return t=t.replace(this._replaceRegex,this.sep)},t.sep="/",t._replaceRegex=RegExp("//+","g"),t.delimiter=":",t.posix=t,t.win32=t,t}();t.exports=r}).call(e,i(6))},function(t,e,i){(function(e){var r=this&&this.__extends||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);function r(){this.constructor=t}t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},n=function(t){function i(){t.call(this),this.isRaw=!1,this.columns=80,this.rows=120,this.isTTY=!0,this._bufferedWrites=[],this._waitingForWrites=!1}return r(i,t),i.prototype.setRawMode=function(t){this.isRaw!==t&&(this.isRaw=t,this.emit("modeChange"))},i.prototype.changeColumns=function(t){t!==this.columns&&(this.columns=t,this.emit("resize"))},i.prototype.changeRows=function(t){t!==this.rows&&(this.rows=t,this.emit("resize"))},i.isatty=function(t){return t&&t instanceof i},i.prototype._write=function(t,i,r){var n,o;try{o="string"==typeof t?new e(t,i):t,this._bufferedWrites.push(o),this._waitingForWrites&&this._read(1024)}catch(t){n=t}finally{r(n)}},i.prototype._read=function(t){if(0===this._bufferedWrites.length)this._waitingForWrites=!0;else for(;this._bufferedWrites.length>0&&(this._waitingForWrites=this.push(this._bufferedWrites.shift()),this._waitingForWrites););},i}(i(11).Duplex);t.exports=n}).call(e,i(1))},function(t,e,i){t.exports=n;var r=i(8).EventEmitter;function n(){r.call(this)}i(12)(n,r),n.Readable=i(13),n.Writable=i(27),n.Duplex=i(28),n.Transform=i(29),n.PassThrough=i(30),n.Stream=n,n.prototype.pipe=function(t,e){var i=this;function n(e){t.writable&&!1===t.write(e)&&i.pause&&i.pause()}function o(){i.readable&&i.resume&&i.resume()}i.on("data",n),t.on("drain",o),t._isStdio||e&&!1===e.end||(i.on("end",a),i.on("close",l));var s=!1;function a(){s||(s=!0,t.end())}function l(){s||(s=!0,"function"==typeof t.destroy&&t.destroy())}function u(t){if(c(),0===r.listenerCount(this,"error"))throw t}function c(){i.removeListener("data",n),t.removeListener("drain",o),i.removeListener("end",a),i.removeListener("close",l),i.removeListener("error",u),t.removeListener("error",u),i.removeListener("end",c),i.removeListener("close",c),t.removeListener("close",c)}return i.on("error",u),t.on("error",u),i.on("end",c),i.on("close",c),t.on("close",c),t.emit("pipe",i),t}},function(t,e){"function"==typeof Object.create?t.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(t,e){t.super_=e;var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t}},function(t,e,i){(function(r){var n=function(){try{return i(11)}catch(t){}}();(e=t.exports=i(14)).Stream=n||e,e.Readable=e,e.Writable=i(22),e.Duplex=i(21),e.Transform=i(25),e.PassThrough=i(26),!r.browser&&"disable"===r.env.READABLE_STREAM&&n&&(t.exports=n)}).call(e,i(6))},function(t,e,i){(function(e){t.exports=g;var r,n=i(15),o=i(16);g.ReadableState=y,i(8).EventEmitter;var s,a=function(t,e){return t.listeners(e).length};!function(){try{s=i(11)}catch(t){}finally{s||(s=i(8).EventEmitter)}}();var l=i(2).Buffer,u=i(17),c=i(18);c.inherits=i(12);var h=i(19),d=void 0;d=h&&h.debuglog?h.debuglog("stream"):function(){};var f,p=i(20);function y(t,e){r=r||i(21),t=t||{},this.objectMode=!!t.objectMode,e instanceof r&&(this.objectMode=this.objectMode||!!t.readableObjectMode);var n=t.highWaterMark,o=this.objectMode?16:16384;this.highWaterMark=n||0===n?n:o,this.highWaterMark=~~this.highWaterMark,this.buffer=new p,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(f||(f=i(24).StringDecoder),this.decoder=new f(t.encoding),this.encoding=t.encoding)}function g(t){if(r=r||i(21),!(this instanceof g))return new g(t);this._readableState=new y(t,this),this.readable=!0,t&&"function"==typeof t.read&&(this._read=t.read),s.call(this)}function v(t,e,i,r,o){var s,a,u,c=(s=i,a=null,l.isBuffer(s)||"string"==typeof s||null==s||e.objectMode||(a=TypeError("Invalid non-string/buffer chunk")),a);if(c)t.emit("error",c);else if(null===i)e.reading=!1,function(t,e){if(!e.ended){if(e.decoder){var i=e.decoder.end();i&&i.length&&(e.buffer.push(i),e.length+=e.objectMode?1:i.length)}e.ended=!0,w(t)}}(t,e);else if(e.objectMode||i&&i.length>0){if(e.ended&&!o){var h=Error("stream.push() after EOF");t.emit("error",h)}else if(e.endEmitted&&o){var d=Error("stream.unshift() after end event");t.emit("error",d)}else!e.decoder||o||r||(i=e.decoder.write(i),u=!e.objectMode&&0===i.length),o||(e.reading=!1),u||(e.flowing&&0===e.length&&!e.sync?(t.emit("data",i),t.read(0)):(e.length+=e.objectMode?1:i.length,o?e.buffer.unshift(i):e.buffer.push(i),e.needReadable&&w(t))),e.readingMore||(e.readingMore=!0,n(b,t,e))}else o||(e.reading=!1);return!e.ended&&(e.needReadable||e.length<e.highWaterMark||0===e.length)}function m(t,e){var i;return t<=0||0===e.length&&e.ended?0:e.objectMode?1:t!=t?e.flowing&&e.length?e.buffer.head.data.length:e.length:(t>e.highWaterMark&&(e.highWaterMark=((i=t)>=8388608?i=8388608:(i--,i|=i>>>1,i|=i>>>2,i|=i>>>4,i|=i>>>8,i|=i>>>16,i++),i)),t<=e.length?t:e.ended?e.length:(e.needReadable=!0,0))}function w(t){var e=t._readableState;e.needReadable=!1,e.emittedReadable||(d("emitReadable",e.flowing),e.emittedReadable=!0,e.sync?n(S,t):S(t))}function S(t){d("emit readable"),t.emit("readable"),_(t)}function b(t,e){for(var i=e.length;!e.reading&&!e.flowing&&!e.ended&&e.length<e.highWaterMark&&(d("maybeReadMore read 0"),t.read(0),i!==e.length);)i=e.length;e.readingMore=!1}function E(t){d("readable nexttick read 0"),t.read(0)}function I(t,e){e.reading||(d("resume read 0"),t.read(0)),e.resumeScheduled=!1,e.awaitDrain=0,t.emit("resume"),_(t),e.flowing&&!e.reading&&t.read(0)}function _(t){var e=t._readableState;for(d("flow",e.flowing);e.flowing&&null!==t.read(););}function D(t,e){var i,r,n,o;return 0===e.length?null:(e.objectMode?i=e.buffer.shift():!t||t>=e.length?(i=e.decoder?e.buffer.join(""):1===e.buffer.length?e.buffer.head.data:e.buffer.concat(e.length),e.buffer.clear()):(r=e.buffer,n=e.decoder,t<r.head.data.length?(o=r.head.data.slice(0,t),r.head.data=r.head.data.slice(t)):o=t===r.head.data.length?r.shift():n?function(t,e){var i=e.head,r=1,n=i.data;for(t-=n.length;i=i.next;){var o=i.data,s=t>o.length?o.length:t;if(s===o.length?n+=o:n+=o.slice(0,t),0==(t-=s)){s===o.length?(++r,i.next?e.head=i.next:e.head=e.tail=null):(e.head=i,i.data=o.slice(s));break}++r}return e.length-=r,n}(t,r):function(t,e){var i=u.allocUnsafe(t),r=e.head,n=1;for(r.data.copy(i),t-=r.data.length;r=r.next;){var o=r.data,s=t>o.length?o.length:t;if(o.copy(i,i.length-t,0,s),0==(t-=s)){s===o.length?(++n,r.next?e.head=r.next:e.head=e.tail=null):(e.head=r,r.data=o.slice(s));break}++n}return e.length-=n,i}(t,r),i=o),i)}function T(t){var e=t._readableState;if(e.length>0)throw Error('"endReadable()" called on non-empty stream');e.endEmitted||(e.ended=!0,n(A,e,t))}function A(t,e){t.endEmitted||0!==t.length||(t.endEmitted=!0,e.readable=!1,e.emit("end"))}function x(t,e){for(var i=0,r=t.length;i<r;i++)if(t[i]===e)return i;return -1}c.inherits(g,s),g.prototype.push=function(t,e){var i=this._readableState;return i.objectMode||"string"!=typeof t||(e=e||i.defaultEncoding)!==i.encoding&&(t=u.from(t,e),e=""),v(this,i,t,e,!1)},g.prototype.unshift=function(t){return v(this,this._readableState,t,"",!0)},g.prototype.isPaused=function(){return!1===this._readableState.flowing},g.prototype.setEncoding=function(t){return f||(f=i(24).StringDecoder),this._readableState.decoder=new f(t),this._readableState.encoding=t,this},g.prototype.read=function(t){d("read",t),t=parseInt(t,10);var e=this._readableState,i=t;if(0!==t&&(e.emittedReadable=!1),0===t&&e.needReadable&&(e.length>=e.highWaterMark||e.ended))return d("read: emitReadable",e.length,e.ended),0===e.length&&e.ended?T(this):w(this),null;if(0===(t=m(t,e))&&e.ended)return 0===e.length&&T(this),null;var r,n=e.needReadable;return d("need readable",n),(0===e.length||e.length-t<e.highWaterMark)&&d("length less than watermark",n=!0),e.ended||e.reading?d("reading or ended",n=!1):n&&(d("do read"),e.reading=!0,e.sync=!0,0===e.length&&(e.needReadable=!0),this._read(e.highWaterMark),e.sync=!1,e.reading||(t=m(i,e))),null===(r=t>0?D(t,e):null)?(e.needReadable=!0,t=0):e.length-=t,0===e.length&&(e.ended||(e.needReadable=!0),i!==t&&e.ended&&T(this)),null!==r&&this.emit("data",r),r},g.prototype._read=function(t){this.emit("error",Error("_read() is not implemented"))},g.prototype.pipe=function(t,i){var r=this,s=this._readableState;switch(s.pipesCount){case 0:s.pipes=t;break;case 1:s.pipes=[s.pipes,t];break;default:s.pipes.push(t)}s.pipesCount+=1,d("pipe count=%d opts=%j",s.pipesCount,i);var l=i&&!1===i.end||t===e.stdout||t===e.stderr?p:c;function u(t){d("onunpipe"),t===r&&p()}function c(){d("onend"),t.end()}s.endEmitted?n(l):r.once("end",l),t.on("unpipe",u);var h=function(){var t=r._readableState;d("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&a(r,"data")&&(t.flowing=!0,_(r))};t.on("drain",h);var f=!1;function p(){d("cleanup"),t.removeListener("close",m),t.removeListener("finish",w),t.removeListener("drain",h),t.removeListener("error",v),t.removeListener("unpipe",u),r.removeListener("end",c),r.removeListener("end",p),r.removeListener("data",g),f=!0,s.awaitDrain&&(!t._writableState||t._writableState.needDrain)&&h()}var y=!1;function g(e){d("ondata"),y=!1,!1!==t.write(e)||y||((1===s.pipesCount&&s.pipes===t||s.pipesCount>1&&-1!==x(s.pipes,t))&&!f&&(d("false write response, pause",r._readableState.awaitDrain),r._readableState.awaitDrain++,y=!0),r.pause())}function v(e){d("onerror",e),S(),t.removeListener("error",v),0===a(t,"error")&&t.emit("error",e)}function m(){t.removeListener("finish",w),S()}function w(){d("onfinish"),t.removeListener("close",m),S()}function S(){d("unpipe"),r.unpipe(t)}return r.on("data",g),function(t,e,i){if("function"==typeof t.prependListener)return t.prependListener(e,i);t._events&&t._events[e]?o(t._events[e])?t._events[e].unshift(i):t._events[e]=[i,t._events[e]]:t.on(e,i)}(t,"error",v),t.once("close",m),t.once("finish",w),t.emit("pipe",r),s.flowing||(d("pipe resume"),r.resume()),t},g.prototype.unpipe=function(t){var e=this._readableState;if(0===e.pipesCount)return this;if(1===e.pipesCount)return t&&t!==e.pipes||(t||(t=e.pipes),e.pipes=null,e.pipesCount=0,e.flowing=!1,t&&t.emit("unpipe",this)),this;if(!t){var i=e.pipes,r=e.pipesCount;e.pipes=null,e.pipesCount=0,e.flowing=!1;for(var n=0;n<r;n++)i[n].emit("unpipe",this);return this}var o=x(e.pipes,t);return -1===o||(e.pipes.splice(o,1),e.pipesCount-=1,1===e.pipesCount&&(e.pipes=e.pipes[0]),t.emit("unpipe",this)),this},g.prototype.on=function(t,e){var i=s.prototype.on.call(this,t,e);if("data"===t)!1!==this._readableState.flowing&&this.resume();else if("readable"===t){var r=this._readableState;r.endEmitted||r.readableListening||(r.readableListening=r.needReadable=!0,r.emittedReadable=!1,r.reading?r.length&&w(this):n(E,this))}return i},g.prototype.addListener=g.prototype.on,g.prototype.resume=function(){var t=this._readableState;return t.flowing||(d("resume"),t.flowing=!0,t.resumeScheduled||(t.resumeScheduled=!0,n(I,this,t))),this},g.prototype.pause=function(){return d("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(d("pause"),this._readableState.flowing=!1,this.emit("pause")),this},g.prototype.wrap=function(t){var e=this._readableState,i=!1,r=this;for(var n in t.on("end",function(){if(d("wrapped end"),e.decoder&&!e.ended){var t=e.decoder.end();t&&t.length&&r.push(t)}r.push(null)}),t.on("data",function(n){d("wrapped data"),e.decoder&&(n=e.decoder.write(n)),e.objectMode&&null==n||(e.objectMode||n&&n.length)&&(r.push(n)||(i=!0,t.pause()))}),t)void 0===this[n]&&"function"==typeof t[n]&&(this[n]=function(e){return function(){return t[e].apply(t,arguments)}}(n));return function(t,e){for(var i=0,r=t.length;i<r;i++)e(t[i],i)}(["error","close","destroy","pause","resume"],function(e){t.on(e,r.emit.bind(r,e))}),r._read=function(e){d("wrapped _read",e),i&&(i=!1,t.resume())},r},g._fromList=D}).call(e,i(6))},function(t,e,i){(function(e){e.version&&0!==e.version.indexOf("v0.")&&(0!==e.version.indexOf("v1.")||0===e.version.indexOf("v1.8."))?t.exports=e.nextTick:t.exports=function(t,i,r,n){if("function"!=typeof t)throw TypeError('"callback" argument must be a function');var o,s,a=arguments.length;switch(a){case 0:case 1:return e.nextTick(t);case 2:return e.nextTick(function(){t.call(null,i)});case 3:return e.nextTick(function(){t.call(null,i,r)});case 4:return e.nextTick(function(){t.call(null,i,r,n)});default:for(o=Array(a-1),s=0;s<o.length;)o[s++]=arguments[s];return e.nextTick(function(){t.apply(null,o)})}}}).call(e,i(6))},function(t,e){var i={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==i.call(t)}},function(t,e,i){(function(t){var r=i(2),n=r.Buffer,o=r.SlowBuffer,s=r.kMaxLength||2147483647;e.alloc=function(t,e,i){if("function"==typeof n.alloc)return n.alloc(t,e,i);if("number"==typeof i)throw TypeError("encoding must not be number");if("number"!=typeof t)throw TypeError("size must be a number");if(t>s)throw RangeError("size is too large");var r=i,o=e;void 0===o&&(r=void 0,o=0);var a=new n(t);if("string"==typeof o)for(var l=new n(o,r),u=l.length,c=-1;++c<t;)a[c]=l[c%u];else a.fill(o);return a},e.allocUnsafe=function(t){if("function"==typeof n.allocUnsafe)return n.allocUnsafe(t);if("number"!=typeof t)throw TypeError("size must be a number");if(t>s)throw RangeError("size is too large");return new n(t)},e.from=function(e,i,r){if("function"==typeof n.from&&(!t.Uint8Array||Uint8Array.from!==n.from))return n.from(e,i,r);if("number"==typeof e)throw TypeError('"value" argument must not be a number');if("string"==typeof e)return new n(e,i);if("undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer){var o=i;if(1==arguments.length)return new n(e);void 0===o&&(o=0);var s=r;if(void 0===s&&(s=e.byteLength-o),o>=e.byteLength)throw RangeError("'offset' is out of bounds");if(s>e.byteLength-o)throw RangeError("'length' is out of bounds");return new n(e.slice(o,o+s))}if(n.isBuffer(e)){var a=new n(e.length);return e.copy(a,0,0,e.length),a}if(e){if(Array.isArray(e)||"undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return new n(e);if("Buffer"===e.type&&Array.isArray(e.data))return new n(e.data)}throw TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")},e.allocUnsafeSlow=function(t){if("function"==typeof n.allocUnsafeSlow)return n.allocUnsafeSlow(t);if("number"!=typeof t)throw TypeError("size must be a number");if(t>=s)throw RangeError("size is too large");return new o(t)}}).call(e,function(){return this}())},function(t,e,i){(function(t){function i(t){return Object.prototype.toString.call(t)}e.isArray=function(t){return Array.isArray?Array.isArray(t):"[object Array]"===i(t)},e.isBoolean=function(t){return"boolean"==typeof t},e.isNull=function(t){return null===t},e.isNullOrUndefined=function(t){return null==t},e.isNumber=function(t){return"number"==typeof t},e.isString=function(t){return"string"==typeof t},e.isSymbol=function(t){return"symbol"==typeof t},e.isUndefined=function(t){return void 0===t},e.isRegExp=function(t){return"[object RegExp]"===i(t)},e.isObject=function(t){return"object"==typeof t&&null!==t},e.isDate=function(t){return"[object Date]"===i(t)},e.isError=function(t){return"[object Error]"===i(t)||t instanceof Error},e.isFunction=function(t){return"function"==typeof t},e.isPrimitive=function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},e.isBuffer=t.isBuffer}).call(e,i(1))},function(t,e){},function(t,e,i){i(2).Buffer;var r=i(17);function n(){this.head=null,this.tail=null,this.length=0}t.exports=n,n.prototype.push=function(t){var e={data:t,next:null};this.length>0?this.tail.next=e:this.head=e,this.tail=e,++this.length},n.prototype.unshift=function(t){var e={data:t,next:this.head};0===this.length&&(this.tail=e),this.head=e,++this.length},n.prototype.shift=function(){if(0!==this.length){var t=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,t}},n.prototype.clear=function(){this.head=this.tail=null,this.length=0},n.prototype.join=function(t){if(0===this.length)return"";for(var e=this.head,i=""+e.data;e=e.next;)i+=t+e.data;return i},n.prototype.concat=function(t){if(0===this.length)return r.alloc(0);if(1===this.length)return this.head.data;for(var e=r.allocUnsafe(t>>>0),i=this.head,n=0;i;)i.data.copy(e,n),n+=i.data.length,i=i.next;return e}},function(t,e,i){var r=Object.keys||function(t){var e=[];for(var i in t)e.push(i);return e};t.exports=h;var n=i(15),o=i(18);o.inherits=i(12);var s=i(14),a=i(22);o.inherits(h,s);for(var l=r(a.prototype),u=0;u<l.length;u++){var c=l[u];h.prototype[c]||(h.prototype[c]=a.prototype[c])}function h(t){if(!(this instanceof h))return new h(t);s.call(this,t),a.call(this,t),t&&!1===t.readable&&(this.readable=!1),t&&!1===t.writable&&(this.writable=!1),this.allowHalfOpen=!0,t&&!1===t.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",d)}function d(){this.allowHalfOpen||this._writableState.ended||n(f,this)}function f(t){t.end()}},function(t,e,i){(function(e){t.exports=y;var r,n=i(15),o=!e.browser&&["v0.10","v0.9."].indexOf(e.version.slice(0,5))>-1?setImmediate:n;y.WritableState=p;var s=i(18);s.inherits=i(12);var a,l={deprecate:i(23)};!function(){try{a=i(11)}catch(t){}finally{a||(a=i(8).EventEmitter)}}();var u,c=i(2).Buffer,h=i(17);function d(){}function f(t,e,i){this.chunk=t,this.encoding=e,this.callback=i,this.next=null}function p(t,e){r=r||i(21),t=t||{},this.objectMode=!!t.objectMode,e instanceof r&&(this.objectMode=this.objectMode||!!t.writableObjectMode);var s=t.highWaterMark,a=this.objectMode?16:16384;this.highWaterMark=s||0===s?s:a,this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var l=!1===t.decodeStrings;this.decodeStrings=!l,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(t){!function(t,e){var i=t._writableState,r=i.sync,s=i.writecb;if(i.writing=!1,i.writecb=null,i.length-=i.writelen,i.writelen=0,e)--i.pendingcb,r?n(s,e):s(e),t._writableState.errorEmitted=!0,t.emit("error",e);else{var a=w(i);a||i.corked||i.bufferProcessing||!i.bufferedRequest||m(t,i),r?o(v,t,i,a,s):v(t,i,a,s)}}(e,t)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new E(this)}function y(t){if(r=r||i(21),!(u.call(y,this)||this instanceof r))return new y(t);this._writableState=new p(t,this),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev)),a.call(this)}function g(t,e,i,r,n,o,s){e.writelen=r,e.writecb=s,e.writing=!0,e.sync=!0,i?t._writev(n,e.onwrite):t._write(n,o,e.onwrite),e.sync=!1}function v(t,e,i,r){i||0===e.length&&e.needDrain&&(e.needDrain=!1,t.emit("drain")),e.pendingcb--,r(),b(t,e)}function m(t,e){e.bufferProcessing=!0;var i=e.bufferedRequest;if(t._writev&&i&&i.next){var r=Array(e.bufferedRequestCount),n=e.corkedRequestsFree;n.entry=i;for(var o=0;i;)r[o]=i,i=i.next,o+=1;g(t,e,!0,e.length,r,"",n.finish),e.pendingcb++,e.lastBufferedRequest=null,n.next?(e.corkedRequestsFree=n.next,n.next=null):e.corkedRequestsFree=new E(e)}else{for(;i;){var s=i.chunk,a=i.encoding,l=i.callback;if(g(t,e,!1,e.objectMode?1:s.length,s,a,l),i=i.next,e.writing)break}null===i&&(e.lastBufferedRequest=null)}e.bufferedRequestCount=0,e.bufferedRequest=i,e.bufferProcessing=!1}function w(t){return t.ending&&0===t.length&&null===t.bufferedRequest&&!t.finished&&!t.writing}function S(t,e){e.prefinished||(e.prefinished=!0,t.emit("prefinish"))}function b(t,e){var i=w(e);return i&&(0===e.pendingcb?(S(t,e),e.finished=!0,t.emit("finish")):S(t,e)),i}function E(t){var e=this;this.next=null,this.entry=null,this.finish=function(i){var r=e.entry;for(e.entry=null;r;){var n=r.callback;t.pendingcb--,n(i),r=r.next}t.corkedRequestsFree?t.corkedRequestsFree.next=e:t.corkedRequestsFree=e}}s.inherits(y,a),p.prototype.getBuffer=function(){for(var t=this.bufferedRequest,e=[];t;)e.push(t),t=t.next;return e},function(){try{Object.defineProperty(p.prototype,"buffer",{get:l.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.")})}catch(t){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(u=Function.prototype[Symbol.hasInstance],Object.defineProperty(y,Symbol.hasInstance,{value:function(t){return!!u.call(this,t)||t&&t._writableState instanceof p}})):u=function(t){return t instanceof this},y.prototype.pipe=function(){this.emit("error",Error("Cannot pipe, not readable"))},y.prototype.write=function(t,e,i){var r,o,s,a,l,u=this._writableState,p=!1,y=c.isBuffer(t);return"function"==typeof e&&(i=e,e=null),y?e="buffer":e||(e=u.defaultEncoding),"function"!=typeof i&&(i=d),u.ended?(r=i,o=Error("write after end"),this.emit("error",o),n(r,o)):(y||(s=i,a=!0,l=!1,null===t?l=TypeError("May not write null values to stream"):"string"==typeof t||void 0===t||u.objectMode||(l=TypeError("Invalid non-string/buffer chunk")),l&&(this.emit("error",l),n(s,l),a=!1),a))&&(u.pendingcb++,p=function(t,e,i,r,n,o){i||(s=r,a=n,e.objectMode||!1===e.decodeStrings||"string"!=typeof s||(s=h.from(s,a)),r=s,c.isBuffer(r)&&(n="buffer"));var s,a,l=e.objectMode?1:r.length;e.length+=l;var u=e.length<e.highWaterMark;if(u||(e.needDrain=!0),e.writing||e.corked){var d=e.lastBufferedRequest;e.lastBufferedRequest=new f(r,n,o),d?d.next=e.lastBufferedRequest:e.bufferedRequest=e.lastBufferedRequest,e.bufferedRequestCount+=1}else g(t,e,!1,l,r,n,o);return u}(this,u,y,t,e,i)),p},y.prototype.cork=function(){this._writableState.corked++},y.prototype.uncork=function(){var t=this._writableState;t.corked&&(t.corked--,t.writing||t.corked||t.finished||t.bufferProcessing||!t.bufferedRequest||m(this,t))},y.prototype.setDefaultEncoding=function(t){if("string"==typeof t&&(t=t.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((t+"").toLowerCase())>-1))throw TypeError("Unknown encoding: "+t);return this._writableState.defaultEncoding=t,this},y.prototype._write=function(t,e,i){i(Error("_write() is not implemented"))},y.prototype._writev=null,y.prototype.end=function(t,e,i){var r,o=this._writableState;"function"==typeof t?(i=t,t=null,e=null):"function"==typeof e&&(i=e,e=null),null!=t&&this.write(t,e),o.corked&&(o.corked=1,this.uncork()),o.ending||o.finished||(r=i,o.ending=!0,b(this,o),r&&(o.finished?n(r):this.once("finish",r)),o.ended=!0,this.writable=!1)}}).call(e,i(6))},function(t,e){(function(e){function i(t){try{if(!e.localStorage)return!1}catch(t){return!1}var i=e.localStorage[t];return null!=i&&"true"===String(i).toLowerCase()}t.exports=function(t,e){if(i("noDeprecation"))return t;var r=!1;return function(){if(!r){if(i("throwDeprecation"))throw Error(e);i("traceDeprecation")?console.trace(e):console.warn(e),r=!0}return t.apply(this,arguments)}}}).call(e,function(){return this}())},function(t,e,i){var r=i(2).Buffer,n=r.isEncoding||function(t){switch(t&&t.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}},o=e.StringDecoder=function(t){switch(this.encoding=(t||"utf8").toLowerCase().replace(/[-_]/,""),function(t){if(t&&!n(t))throw Error("Unknown encoding: "+t)}(t),this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2,this.detectIncompleteChar=a;break;case"base64":this.surrogateSize=3,this.detectIncompleteChar=l;break;default:return void(this.write=s)}this.charBuffer=new r(6),this.charReceived=0,this.charLength=0};function s(t){return t.toString(this.encoding)}function a(t){this.charReceived=t.length%2,this.charLength=this.charReceived?2:0}function l(t){this.charReceived=t.length%3,this.charLength=this.charReceived?3:0}o.prototype.write=function(t){for(var e="";this.charLength;){var i=t.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:t.length;if(t.copy(this.charBuffer,this.charReceived,0,i),this.charReceived+=i,this.charReceived<this.charLength)return"";if(t=t.slice(i,t.length),!((r=(e=this.charBuffer.slice(0,this.charLength).toString(this.encoding)).charCodeAt(e.length-1))>=55296&&r<=56319)){if(this.charReceived=this.charLength=0,0===t.length)return e;break}this.charLength+=this.surrogateSize,e=""}this.detectIncompleteChar(t);var r,n=t.length;if(this.charLength&&(t.copy(this.charBuffer,0,t.length-this.charReceived,n),n-=this.charReceived),n=(e+=t.toString(this.encoding,0,n)).length-1,(r=e.charCodeAt(n))>=55296&&r<=56319){var o=this.surrogateSize;return this.charLength+=o,this.charReceived+=o,this.charBuffer.copy(this.charBuffer,o,0,o),t.copy(this.charBuffer,0,0,o),e.substring(0,n)}return e},o.prototype.detectIncompleteChar=function(t){for(var e=t.length>=3?3:t.length;e>0;e--){var i=t[t.length-e];if(1==e&&i>>5==6){this.charLength=2;break}if(e<=2&&i>>4==14){this.charLength=3;break}if(e<=3&&i>>3==30){this.charLength=4;break}}this.charReceived=e},o.prototype.end=function(t){var e="";if(t&&t.length&&(e=this.write(t)),this.charReceived){var i=this.charReceived,r=this.charBuffer,n=this.encoding;e+=r.slice(0,i).toString(n)}return e}},function(t,e,i){t.exports=s;var r=i(21),n=i(18);function o(t){this.afterTransform=function(e,i){return function(t,e,i){var r=t._transformState;r.transforming=!1;var n=r.writecb;if(!n)return t.emit("error",Error("no writecb in Transform class"));r.writechunk=null,r.writecb=null,null!=i&&t.push(i),n(e);var o=t._readableState;o.reading=!1,(o.needReadable||o.length<o.highWaterMark)&&t._read(o.highWaterMark)}(t,e,i)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null,this.writeencoding=null}function s(t){if(!(this instanceof s))return new s(t);r.call(this,t),this._transformState=new o(this);var e=this;this._readableState.needReadable=!0,this._readableState.sync=!1,t&&("function"==typeof t.transform&&(this._transform=t.transform),"function"==typeof t.flush&&(this._flush=t.flush)),this.once("prefinish",function(){"function"==typeof this._flush?this._flush(function(t,i){a(e,t,i)}):a(e)})}function a(t,e,i){if(e)return t.emit("error",e);null!=i&&t.push(i);var r=t._writableState,n=t._transformState;if(r.length)throw Error("Calling transform done when ws.length != 0");if(n.transforming)throw Error("Calling transform done when still transforming");return t.push(null)}n.inherits=i(12),n.inherits(s,r),s.prototype.push=function(t,e){return this._transformState.needTransform=!1,r.prototype.push.call(this,t,e)},s.prototype._transform=function(t,e,i){throw Error("_transform() is not implemented")},s.prototype._write=function(t,e,i){var r=this._transformState;if(r.writecb=i,r.writechunk=t,r.writeencoding=e,!r.transforming){var n=this._readableState;(r.needTransform||n.needReadable||n.length<n.highWaterMark)&&this._read(n.highWaterMark)}},s.prototype._read=function(t){var e=this._transformState;null!==e.writechunk&&e.writecb&&!e.transforming?(e.transforming=!0,this._transform(e.writechunk,e.writeencoding,e.afterTransform)):e.needTransform=!0}},function(t,e,i){t.exports=o;var r=i(25),n=i(18);function o(t){if(!(this instanceof o))return new o(t);r.call(this,t)}n.inherits=i(12),n.inherits(o,r),o.prototype._transform=function(t,e,i){i(null,t)}},function(t,e,i){t.exports=i(22)},function(t,e,i){t.exports=i(21)},function(t,e,i){t.exports=i(25)},function(t,e,i){t.exports=i(26)},function(t,e,i){var r=i(32),n=i(33),o=i(38),s=i(39),a=i(40),l=i(41),u=i(42),c=Object.prototype.toString;function h(t){if(!(this instanceof h))return new h(t);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=r.inflateInit2(this.strm,e.windowBits);if(i!==s.Z_OK)throw Error(a[i]);this.header=new u,r.inflateGetHeader(this.strm,this.header)}function d(t,e){var i=new h(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}h.prototype.push=function(t,e){var i,a,l,u,h,d,f=this.strm,p=this.options.chunkSize,y=this.options.dictionary,g=!1;if(this.ended)return!1;a=e===~~e?e:!0===e?s.Z_FINISH:s.Z_NO_FLUSH,"string"==typeof t?f.input=o.binstring2buf(t):"[object ArrayBuffer]"===c.call(t)?f.input=new Uint8Array(t):f.input=t,f.next_in=0,f.avail_in=f.input.length;do{if(0===f.avail_out&&(f.output=new n.Buf8(p),f.next_out=0,f.avail_out=p),(i=r.inflate(f,s.Z_NO_FLUSH))===s.Z_NEED_DICT&&y&&(d="string"==typeof y?o.string2buf(y):"[object ArrayBuffer]"===c.call(y)?new Uint8Array(y):y,i=r.inflateSetDictionary(this.strm,d)),i===s.Z_BUF_ERROR&&!0===g&&(i=s.Z_OK,g=!1),i!==s.Z_STREAM_END&&i!==s.Z_OK)return this.onEnd(i),this.ended=!0,!1;f.next_out&&(0!==f.avail_out&&i!==s.Z_STREAM_END&&(0!==f.avail_in||a!==s.Z_FINISH&&a!==s.Z_SYNC_FLUSH)||("string"===this.options.to?(l=o.utf8border(f.output,f.next_out),u=f.next_out-l,h=o.buf2string(f.output,l),f.next_out=u,f.avail_out=p-u,u&&n.arraySet(f.output,f.output,l,u,0),this.onData(h)):this.onData(n.shrinkBuf(f.output,f.next_out)))),0===f.avail_in&&0===f.avail_out&&(g=!0)}while((f.avail_in>0||0===f.avail_out)&&i!==s.Z_STREAM_END);return i===s.Z_STREAM_END&&(a=s.Z_FINISH),a===s.Z_FINISH?(i=r.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===s.Z_OK):a!==s.Z_SYNC_FLUSH||(this.onEnd(s.Z_OK),f.avail_out=0,!0)},h.prototype.onData=function(t){this.chunks.push(t)},h.prototype.onEnd=function(t){t===s.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},e.Inflate=h,e.inflate=d,e.inflateRaw=function(t,e){return(e=e||{}).raw=!0,d(t,e)},e.ungzip=d},function(t,e,i){var r=i(33),n=i(34),o=i(35),s=i(36),a=i(37);function l(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function u(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function c(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=1,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new r.Buf32(852),e.distcode=e.distdyn=new r.Buf32(592),e.sane=1,e.back=-1,0):-2}function h(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,c(t)):-2}function d(t,e){var i,r;return t&&t.state?(r=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?-2:(null!==r.window&&r.wbits!==e&&(r.window=null),r.wrap=i,r.wbits=e,h(t))):-2}function f(t,e){var i,r;return t?(r=new u,t.state=r,r.window=null,0!==(i=d(t,e))&&(t.state=null),i):-2}var p,y,g=!0;function v(t,e,i,n){var o,s=t.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new r.Buf8(s.wsize)),n>=s.wsize?(r.arraySet(s.window,e,i-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((o=s.wsize-s.wnext)>n&&(o=n),r.arraySet(s.window,e,i-n,o,s.wnext),(n-=o)?(r.arraySet(s.window,e,i-n,n,0),s.wnext=n,s.whave=s.wsize):(s.wnext+=o,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=o))),0}e.inflateReset=h,e.inflateReset2=d,e.inflateResetKeep=c,e.inflateInit=function(t){return f(t,15)},e.inflateInit2=f,e.inflate=function(t,e){var i,u,c,h,d,f,m,w,S,b,E,I,_,D,T,A,x,O,P,R,k,N,C,F,L=0,M=new r.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return -2;12===(i=t.state).mode&&(i.mode=13),d=t.next_out,c=t.output,m=t.avail_out,h=t.next_in,u=t.input,f=t.avail_in,w=i.hold,S=i.bits,b=f,E=m,N=0;t:for(;;)switch(i.mode){case 1:if(0===i.wrap){i.mode=13;break}for(;S<16;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(2&i.wrap&&35615===w){i.check=0,M[0]=255&w,M[1]=w>>>8&255,i.check=o(i.check,M,2,0),w=0,S=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&w)<<8)+(w>>8))%31){t.msg="incorrect header check",i.mode=30;break}if(8!=(15&w)){t.msg="unknown compression method",i.mode=30;break}if(S-=4,k=8+(15&(w>>>=4)),0===i.wbits)i.wbits=k;else if(k>i.wbits){t.msg="invalid window size",i.mode=30;break}i.dmax=1<<k,t.adler=i.check=1,i.mode=512&w?10:12,w=0,S=0;break;case 2:for(;S<16;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(i.flags=w,8!=(255&i.flags)){t.msg="unknown compression method",i.mode=30;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=30;break}i.head&&(i.head.text=w>>8&1),512&i.flags&&(M[0]=255&w,M[1]=w>>>8&255,i.check=o(i.check,M,2,0)),w=0,S=0,i.mode=3;case 3:for(;S<32;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}i.head&&(i.head.time=w),512&i.flags&&(M[0]=255&w,M[1]=w>>>8&255,M[2]=w>>>16&255,M[3]=w>>>24&255,i.check=o(i.check,M,4,0)),w=0,S=0,i.mode=4;case 4:for(;S<16;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}i.head&&(i.head.xflags=255&w,i.head.os=w>>8),512&i.flags&&(M[0]=255&w,M[1]=w>>>8&255,i.check=o(i.check,M,2,0)),w=0,S=0,i.mode=5;case 5:if(1024&i.flags){for(;S<16;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}i.length=w,i.head&&(i.head.extra_len=w),512&i.flags&&(M[0]=255&w,M[1]=w>>>8&255,i.check=o(i.check,M,2,0)),w=0,S=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&((I=i.length)>f&&(I=f),I&&(i.head&&(k=i.head.extra_len-i.length,i.head.extra||(i.head.extra=Array(i.head.extra_len)),r.arraySet(i.head.extra,u,h,I,k)),512&i.flags&&(i.check=o(i.check,u,I,h)),f-=I,h+=I,i.length-=I),i.length))break t;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===f)break t;I=0;do k=u[h+I++],i.head&&k&&i.length<65536&&(i.head.name+=String.fromCharCode(k));while(k&&I<f);if(512&i.flags&&(i.check=o(i.check,u,I,h)),f-=I,h+=I,k)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===f)break t;I=0;do k=u[h+I++],i.head&&k&&i.length<65536&&(i.head.comment+=String.fromCharCode(k));while(k&&I<f);if(512&i.flags&&(i.check=o(i.check,u,I,h)),f-=I,h+=I,k)break t}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;S<16;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(w!==(65535&i.check)){t.msg="header crc mismatch",i.mode=30;break}w=0,S=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=12;break;case 10:for(;S<32;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}t.adler=i.check=l(w),w=0,S=0,i.mode=11;case 11:if(0===i.havedict)return t.next_out=d,t.avail_out=m,t.next_in=h,t.avail_in=f,i.hold=w,i.bits=S,2;t.adler=i.check=1,i.mode=12;case 12:if(5===e||6===e)break t;case 13:if(i.last){w>>>=7&S,S-=7&S,i.mode=27;break}for(;S<3;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}switch(i.last=1&w,S-=1,3&(w>>>=1)){case 0:i.mode=14;break;case 1:if(function(t){if(g){var e;for(p=new r.Buf32(512),y=new r.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(a(1,t.lens,0,288,p,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;a(2,t.lens,0,32,y,0,t.work,{bits:5}),g=!1}t.lencode=p,t.lenbits=9,t.distcode=y,t.distbits=5}(i),i.mode=20,6===e){w>>>=2,S-=2;break t}break;case 2:i.mode=17;break;case 3:t.msg="invalid block type",i.mode=30}w>>>=2,S-=2;break;case 14:for(w>>>=7&S,S-=7&S;S<32;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if((65535&w)!=(w>>>16^65535)){t.msg="invalid stored block lengths",i.mode=30;break}if(i.length=65535&w,w=0,S=0,i.mode=15,6===e)break t;case 15:i.mode=16;case 16:if(I=i.length){if(I>f&&(I=f),I>m&&(I=m),0===I)break t;r.arraySet(c,u,h,I,d),f-=I,h+=I,m-=I,d+=I,i.length-=I;break}i.mode=12;break;case 17:for(;S<14;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(i.nlen=257+(31&w),w>>>=5,S-=5,i.ndist=1+(31&w),w>>>=5,S-=5,i.ncode=4+(15&w),w>>>=4,S-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=30;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;S<3;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}i.lens[j[i.have++]]=7&w,w>>>=3,S-=3}for(;i.have<19;)i.lens[j[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,C={bits:i.lenbits},N=a(0,i.lens,0,19,i.lencode,0,i.work,C),i.lenbits=C.bits,N){t.msg="invalid code lengths set",i.mode=30;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;A=(L=i.lencode[w&(1<<i.lenbits)-1])>>>16&255,x=65535&L,!((T=L>>>24)<=S);){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(x<16)w>>>=T,S-=T,i.lens[i.have++]=x;else{if(16===x){for(F=T+2;S<F;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(w>>>=T,S-=T,0===i.have){t.msg="invalid bit length repeat",i.mode=30;break}k=i.lens[i.have-1],I=3+(3&w),w>>>=2,S-=2}else if(17===x){for(F=T+3;S<F;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}S-=T,k=0,I=3+(7&(w>>>=T)),w>>>=3,S-=3}else{for(F=T+7;S<F;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}S-=T,k=0,I=11+(127&(w>>>=T)),w>>>=7,S-=7}if(i.have+I>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=30;break}for(;I--;)i.lens[i.have++]=k}}if(30===i.mode)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=30;break}if(i.lenbits=9,C={bits:i.lenbits},N=a(1,i.lens,0,i.nlen,i.lencode,0,i.work,C),i.lenbits=C.bits,N){t.msg="invalid literal/lengths set",i.mode=30;break}if(i.distbits=6,i.distcode=i.distdyn,C={bits:i.distbits},N=a(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,C),i.distbits=C.bits,N){t.msg="invalid distances set",i.mode=30;break}if(i.mode=20,6===e)break t;case 20:i.mode=21;case 21:if(f>=6&&m>=258){t.next_out=d,t.avail_out=m,t.next_in=h,t.avail_in=f,i.hold=w,i.bits=S,s(t,E),d=t.next_out,c=t.output,m=t.avail_out,h=t.next_in,u=t.input,f=t.avail_in,w=i.hold,S=i.bits,12===i.mode&&(i.back=-1);break}for(i.back=0;A=(L=i.lencode[w&(1<<i.lenbits)-1])>>>16&255,x=65535&L,!((T=L>>>24)<=S);){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(A&&0==(240&A)){for(O=T,P=A,R=x;A=(L=i.lencode[R+((w&(1<<O+P)-1)>>O)])>>>16&255,x=65535&L,!(O+(T=L>>>24)<=S);){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}w>>>=O,S-=O,i.back+=O}if(w>>>=T,S-=T,i.back+=T,i.length=x,0===A){i.mode=26;break}if(32&A){i.back=-1,i.mode=12;break}if(64&A){t.msg="invalid literal/length code",i.mode=30;break}i.extra=15&A,i.mode=22;case 22:if(i.extra){for(F=i.extra;S<F;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}i.length+=w&(1<<i.extra)-1,w>>>=i.extra,S-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;A=(L=i.distcode[w&(1<<i.distbits)-1])>>>16&255,x=65535&L,!((T=L>>>24)<=S);){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(0==(240&A)){for(O=T,P=A,R=x;A=(L=i.distcode[R+((w&(1<<O+P)-1)>>O)])>>>16&255,x=65535&L,!(O+(T=L>>>24)<=S);){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}w>>>=O,S-=O,i.back+=O}if(w>>>=T,S-=T,i.back+=T,64&A){t.msg="invalid distance code",i.mode=30;break}i.offset=x,i.extra=15&A,i.mode=24;case 24:if(i.extra){for(F=i.extra;S<F;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}i.offset+=w&(1<<i.extra)-1,w>>>=i.extra,S-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=30;break}i.mode=25;case 25:if(0===m)break t;if(I=E-m,i.offset>I){if((I=i.offset-I)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=30;break}I>i.wnext?(I-=i.wnext,_=i.wsize-I):_=i.wnext-I,I>i.length&&(I=i.length),D=i.window}else D=c,_=d-i.offset,I=i.length;I>m&&(I=m),m-=I,i.length-=I;do c[d++]=D[_++];while(--I);0===i.length&&(i.mode=21);break;case 26:if(0===m)break t;c[d++]=i.length,m--,i.mode=21;break;case 27:if(i.wrap){for(;S<32;){if(0===f)break t;f--,w|=u[h++]<<S,S+=8}if(E-=m,t.total_out+=E,i.total+=E,E&&(t.adler=i.check=i.flags?o(i.check,c,E,d-E):n(i.check,c,E,d-E)),E=m,(i.flags?w:l(w))!==i.check){t.msg="incorrect data check",i.mode=30;break}w=0,S=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;S<32;){if(0===f)break t;f--,w+=u[h++]<<S,S+=8}if(w!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=30;break}w=0,S=0}i.mode=29;case 29:N=1;break t;case 30:N=-3;break t;case 31:return -4;default:return -2}return t.next_out=d,t.avail_out=m,t.next_in=h,t.avail_in=f,i.hold=w,i.bits=S,(i.wsize||E!==t.avail_out&&i.mode<30&&(i.mode<27||4!==e))&&v(t,t.output,t.next_out,E-t.avail_out),b-=t.avail_in,E-=t.avail_out,t.total_in+=b,t.total_out+=E,i.total+=E,i.wrap&&E&&(t.adler=i.check=i.flags?o(i.check,c,E,t.next_out-E):n(i.check,c,E,t.next_out-E)),t.data_type=i.bits+(i.last?64:0)+(12===i.mode?128:0)+(20===i.mode||15===i.mode?256:0),(0===b&&0===E||4===e)&&0===N&&(N=-5),N},e.inflateEnd=function(t){if(!t||!t.state)return -2;var e=t.state;return e.window&&(e.window=null),t.state=null,0},e.inflateGetHeader=function(t,e){var i;return t&&t.state?0==(2&(i=t.state).wrap)?-2:(i.head=e,e.done=!1,0):-2},e.inflateSetDictionary=function(t,e){var i,r=e.length;return t&&t.state?0!==(i=t.state).wrap&&11!==i.mode?-2:11===i.mode&&n(1,e,r,0)!==i.check?-3:v(t,e,r,r)?(i.mode=31,-4):(i.havedict=1,0):-2},e.inflateInfo="pako inflate (from Nodeca project)"},function(t,e){var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;e.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw TypeError(i+"must be non-object");for(var r in i)i.hasOwnProperty(r)&&(t[r]=i[r])}}return t},e.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var r={arraySet:function(t,e,i,r,n){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+r),n);else for(var o=0;o<r;o++)t[n+o]=e[i+o]},flattenChunks:function(t){var e,i,r,n,o,s;for(r=0,e=0,i=t.length;e<i;e++)r+=t[e].length;for(s=new Uint8Array(r),n=0,e=0,i=t.length;e<i;e++)o=t[e],s.set(o,n),n+=o.length;return s}},n={arraySet:function(t,e,i,r,n){for(var o=0;o<r;o++)t[n+o]=e[i+o]},flattenChunks:function(t){return[].concat.apply([],t)}};e.setTyped=function(t){t?(e.Buf8=Uint8Array,e.Buf16=Uint16Array,e.Buf32=Int32Array,e.assign(e,r)):(e.Buf8=Array,e.Buf16=Array,e.Buf32=Array,e.assign(e,n))},e.setTyped(i)},function(t,e){t.exports=function(t,e,i,r){for(var n=65535&t|0,o=t>>>16&65535|0,s=0;0!==i;){i-=s=i>2e3?2e3:i;do o=o+(n=n+e[r++]|0)|0;while(--s);n%=65521,o%=65521}return n|o<<16|0}},function(t,e){var i=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var r=0;r<8;r++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();t.exports=function(t,e,r,n){var o=n+r;t^=-1;for(var s=n;s<o;s++)t=t>>>8^i[255&(t^e[s])];return -1^t}},function(t,e){t.exports=function(t,e){var i,r,n,o,s,a,l,u,c,h,d,f,p,y,g,v,m,w,S,b,E,I,_,D,T;i=t.state,r=t.next_in,D=t.input,n=r+(t.avail_in-5),o=t.next_out,T=t.output,s=o-(e-t.avail_out),a=o+(t.avail_out-257),l=i.dmax,u=i.wsize,c=i.whave,h=i.wnext,d=i.window,f=i.hold,p=i.bits,y=i.lencode,g=i.distcode,v=(1<<i.lenbits)-1,m=(1<<i.distbits)-1;t:do for(p<15&&(f+=D[r++]<<p,p+=8,f+=D[r++]<<p,p+=8),w=y[f&v];;){if(f>>>=S=w>>>24,p-=S,0==(S=w>>>16&255))T[o++]=65535&w;else{if(!(16&S)){if(0==(64&S)){w=y[(65535&w)+(f&(1<<S)-1)];continue}if(32&S){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}for(b=65535&w,(S&=15)&&(p<S&&(f+=D[r++]<<p,p+=8),b+=f&(1<<S)-1,f>>>=S,p-=S),p<15&&(f+=D[r++]<<p,p+=8,f+=D[r++]<<p,p+=8),w=g[f&m];;){if(f>>>=S=w>>>24,p-=S,!(16&(S=w>>>16&255))){if(0==(64&S)){w=g[(65535&w)+(f&(1<<S)-1)];continue}t.msg="invalid distance code",i.mode=30;break t}if(E=65535&w,p<(S&=15)&&(f+=D[r++]<<p,(p+=8)<S&&(f+=D[r++]<<p,p+=8)),(E+=f&(1<<S)-1)>l){t.msg="invalid distance too far back",i.mode=30;break t}if(f>>>=S,p-=S,E>(S=o-s)){if((S=E-S)>c&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(I=0,_=d,0===h){if(I+=u-S,S<b){b-=S;do T[o++]=d[I++];while(--S);I=o-E,_=T}}else if(h<S){if(I+=u+h-S,(S-=h)<b){b-=S;do T[o++]=d[I++];while(--S);if(I=0,h<b){b-=S=h;do T[o++]=d[I++];while(--S);I=o-E,_=T}}}else if(I+=h-S,S<b){b-=S;do T[o++]=d[I++];while(--S);I=o-E,_=T}for(;b>2;)T[o++]=_[I++],T[o++]=_[I++],T[o++]=_[I++],b-=3;b&&(T[o++]=_[I++],b>1&&(T[o++]=_[I++]))}else{I=o-E;do T[o++]=T[I++],T[o++]=T[I++],T[o++]=T[I++],b-=3;while(b>2);b&&(T[o++]=T[I++],b>1&&(T[o++]=T[I++]))}break}}break}while(r<n&&o<a);r-=b=p>>3,f&=(1<<(p-=b<<3))-1,t.next_in=r,t.next_out=o,t.avail_in=r<n?n-r+5:5-(r-n),t.avail_out=o<a?a-o+257:257-(o-a),i.hold=f,i.bits=p}},function(t,e,i){var r=i(33),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],s=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(t,e,i,l,u,c,h,d){var f,p,y,g,v,m,w,S,b,E=d.bits,I=0,_=0,D=0,T=0,A=0,x=0,O=0,P=0,R=0,k=0,N=null,C=0,F=new r.Buf16(16),L=new r.Buf16(16),M=null,j=0;for(I=0;I<=15;I++)F[I]=0;for(_=0;_<l;_++)F[e[i+_]]++;for(A=E,T=15;T>=1&&0===F[T];T--);if(A>T&&(A=T),0===T)return u[c++]=20971520,u[c++]=20971520,d.bits=1,0;for(D=1;D<T&&0===F[D];D++);for(A<D&&(A=D),P=1,I=1;I<=15;I++)if(P<<=1,(P-=F[I])<0)return -1;if(P>0&&(0===t||1!==T))return -1;for(L[1]=0,I=1;I<15;I++)L[I+1]=L[I]+F[I];for(_=0;_<l;_++)0!==e[i+_]&&(h[L[e[i+_]]++]=_);if(0===t?(N=M=h,m=19):1===t?(N=n,C-=257,M=o,j-=257,m=256):(N=s,M=a,m=-1),k=0,_=0,I=D,v=c,x=A,O=0,y=-1,g=(R=1<<A)-1,1===t&&R>852||2===t&&R>592)return 1;for(;;){w=I-O,h[_]<m?(S=0,b=h[_]):h[_]>m?(S=M[j+h[_]],b=N[C+h[_]]):(S=96,b=0),f=1<<I-O,D=p=1<<x;do u[v+(k>>O)+(p-=f)]=w<<24|S<<16|b|0;while(0!==p);for(f=1<<I-1;k&f;)f>>=1;if(0!==f?(k&=f-1,k+=f):k=0,_++,0==--F[I]){if(I===T)break;I=e[i+h[_]]}if(I>A&&(k&g)!==y){for(0===O&&(O=A),v+=D,P=1<<(x=I-O);x+O<T&&!((P-=F[x+O])<=0);)x++,P<<=1;if(R+=1<<x,1===t&&R>852||2===t&&R>592)return 1;u[y=k&g]=A<<24|x<<16|v-c|0}}return 0!==k&&(u[v+k]=I-O<<24|4194304),d.bits=A,0}},function(t,e,i){var r=i(33),n=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch(t){n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){o=!1}for(var s=new r.Buf8(256),a=0;a<256;a++)s[a]=a>=252?6:a>=248?5:a>=240?4:a>=224?3:a>=192?2:1;function l(t,e){if(e<65537&&(t.subarray&&o||!t.subarray&&n))return String.fromCharCode.apply(null,r.shrinkBuf(t,e));for(var i="",s=0;s<e;s++)i+=String.fromCharCode(t[s]);return i}s[254]=s[254]=1,e.string2buf=function(t){var e,i,n,o,s,a=t.length,l=0;for(o=0;o<a;o++)55296==(64512&(i=t.charCodeAt(o)))&&o+1<a&&56320==(64512&(n=t.charCodeAt(o+1)))&&(i=65536+(i-55296<<10)+(n-56320),o++),l+=i<128?1:i<2048?2:i<65536?3:4;for(e=new r.Buf8(l),s=0,o=0;s<l;o++)55296==(64512&(i=t.charCodeAt(o)))&&o+1<a&&56320==(64512&(n=t.charCodeAt(o+1)))&&(i=65536+(i-55296<<10)+(n-56320),o++),i<128?e[s++]=i:(i<2048?e[s++]=192|i>>>6:(i<65536?e[s++]=224|i>>>12:(e[s++]=240|i>>>18,e[s++]=128|i>>>12&63),e[s++]=128|i>>>6&63),e[s++]=128|63&i);return e},e.buf2binstring=function(t){return l(t,t.length)},e.binstring2buf=function(t){for(var e=new r.Buf8(t.length),i=0,n=e.length;i<n;i++)e[i]=t.charCodeAt(i);return e},e.buf2string=function(t,e){var i,r,n,o,a=e||t.length,u=Array(2*a);for(r=0,i=0;i<a;)if((n=t[i++])<128)u[r++]=n;else if((o=s[n])>4)u[r++]=65533,i+=o-1;else{for(n&=2===o?31:3===o?15:7;o>1&&i<a;)n=n<<6|63&t[i++],o--;o>1?u[r++]=65533:n<65536?u[r++]=n:(n-=65536,u[r++]=55296|n>>10&1023,u[r++]=56320|1023&n)}return l(u,r)},e.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;i>=0&&128==(192&t[i]);)i--;return i<0||0===i?e:i+s[t[i]]>e?i:e}},function(t,e){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},function(t,e){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},function(t,e){t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},function(t,e){t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}}]);var eh=(eV=ec.exports)&&eV.__esModule&&Object.prototype.hasOwnProperty.call(eV,"default")?eV.default:eV;let ed=ec.exports.BFSRequire("fs"),{existsSync:ef,mkdirSync:ep,readdirSync:ey,readFileSync:eg,renameSync:ev,rmdirSync:em,statSync:ew,lstatSync:eS,writeFileSync:eb,unlinkSync:eE}=ed;eh.configure({fs:"LocalStorage",options:{}},function(t){if(t)throw t});let eI=new b("DIDStore");class e_{constructor(t,e,i){t<0&&(t=0),e<0&&(e=0),this.cache=new o8({maxItems:e}),this.storage=i,eI.info("DID store opened: {}, cache(init:{}, max:{})",i.getLocation(),t,e)}static open(t,e=e_.DEFAULT_STORAGE,i=e_.CACHE_INITIAL_CAPACITY,r=e_.CACHE_MAX_CAPACITY){return E(this,void 0,void 0,function*(){let n;if(tj(null!=t&&""!=t,"Invalid store context"),tj(null!=e&&""!=e,"Invalid storage name"),tj(r>=i,"Invalid cache capacity spec"),e==e_.DEFAULT_STORAGE||null==e)n=new eo(t);else try{n=new(this.storages.get(e))(t)}catch(t){throw new T("Unsupport "+e+" storage")}yield n.init();let o=new e_(i,r,n);return o.metadata=yield n.loadMetadata(),o.metadata.attachStore(o),o})}close(){this.cache.invalidateAll(),this.cache=null,this.metadata=null,this.storage=null}static calcFingerprint(t){let e=eA(o.Buffer.from(t)).toString();try{return eA(ox.encrypt(o.Buffer.from(e,"hex"),t)).toString()}catch(t){throw new N("Calculate fingerprint error.",t)}}static register(t,e){if(t==e_.DEFAULT_STORAGE)throw new _("'fs' is remained for default storage, please change one");this.storages.set(t,e)}static encryptToBase64(t,e){try{return ox.encryptToBase64(t,e)}catch(t){throw new N("Encrypt data error.",t)}}static decryptFromBase64(t,e){try{return ox.decryptFromBase64(t,e)}catch(t){throw new D("Decrypt private key error.",t)}}static reEncrypt(t,e,i){let r=this.decryptFromBase64(t,e);return this.encryptToBase64(r,i)}encrypt(t,e){let i=this.metadata.getFingerprint(),r=e_.calcFingerprint(e);if(null!=i&&r!==i)throw new D("Password mismatched with previous password.");let n=e_.encryptToBase64(t,e);return null!=i&&""!==i||this.metadata.setFingerprint(r),n}decrypt(t,e){let i=this.metadata.getFingerprint(),r=e_.calcFingerprint(e),n=e_.decryptFromBase64(t,e);return null!=i&&""!==i||this.metadata.setFingerprint(r),n}storeRootIdentity(t,e){return E(this,void 0,void 0,function*(){if(tj(null!=t,"Invalid identity"),void 0!==e){tj(null!=e&&""!==e,"Invalid storepass");let i=null;null!=t.getMnemonic()&&(i=this.encrypt(o.Buffer.from(t.getMnemonic(),"utf8"),e));let r=this.encrypt(t.getRootPrivateKey().serialize(),e),n=t.getPreDerivedPublicKey().serializePublicKeyBase58();yield this.storage.storeRootIdentity(t.getId(),i,r,n,t.getIndex()),null==this.metadata.getDefaultRootIdentity()&&this.metadata.setDefaultRootIdentity(t.getId()),this.cache.invalidate(e_.Key.forRootIdentity(t.getId())),this.cache.invalidate(e_.Key.forRootIdentityPrivateKey(t.getId()))}else yield this.storage.updateRootIdentityIndex(t.getId(),t.getIndex())})}setDefaultRootIdentity(t){return E(this,void 0,void 0,function*(){if(tj(null!=t,"Invalid identity"),!(yield this.containsRootIdentity(t.getId())))throw new _("Invalid identity, not exists in the store");this.metadata.setDefaultRootIdentity(t.getId())})}loadRootIdentity(t){return E(this,void 0,void 0,function*(){if(void 0===t&&(null==(t=this.metadata.getDefaultRootIdentity())||""===t)){let t=yield this.storage.listRootIdentities();if(1!=t.length)return null;{let e=t[0],i=yield this.loadRootIdentityMetadata(e.getId());return e.setMetadata(i),this.metadata.setDefaultRootIdentity(e.getId()),e}}tj(null!=t&&""!==t,"Invalid id");try{let e=yield this.cache.getAsync(e_.Key.forRootIdentity(t),()=>E(this,void 0,void 0,function*(){let e=yield this.storage.loadRootIdentity(t);return null!=e?(e.setMetadata((yield this.loadRootIdentityMetadata(t))),{value:e}):{value:e_.NULL}}));return e===e_.NULL?null:e}catch(e){throw new T("Load root identity failed: "+t,e)}})}containsRootIdentity(t){return E(this,void 0,void 0,function*(){return tj(null!=t&&""!==t,"Invalid id"),yield this.storage.containsRootIdentity(t)})}exportRootIdentityMnemonic(t,e){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid id"),tj(null!=e&&""!==e,"Invalid storepass");let i=yield this.storage.loadRootIdentityMnemonic(t);return null!=i?new String(this.decrypt(i,e)).valueOf():null})}containsRootIdentityMnemonic(t){return E(this,void 0,void 0,function*(){return tj(null!=t&&""!==t,"Invalid id"),null!=(yield this.storage.loadRootIdentityMnemonic(t))})}loadRootIdentityPrivateKey(t,e){return E(this,void 0,void 0,function*(){try{let i=yield this.cache.getAsync(e_.Key.forRootIdentityPrivateKey(t),()=>E(this,void 0,void 0,function*(){let e=yield this.storage.loadRootIdentityPrivateKey(t);return{value:null!=e?e:e_.NULL}}));if(i!==e_.NULL){let t=this.decrypt(i,e);return oA.deserialize(t)}return null}catch(e){throw e instanceof D?e:new T("Load root identity private key failed: "+t,e)}})}derive(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid identity"),tj(null!=e&&""!==e,"Invalid path"),tj(null!=i&&""!==i,"Invalid storepass");let r=yield this.loadRootIdentityPrivateKey(t,i);if(!r)throw new N("Unable to load root private key for id "+t+". Null private key returned.");return r.deriveWithPath(e)})}deleteRootIdentity(t){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid id");let e=yield this.storage.deleteRootIdentity(t);return e&&(null!=this.metadata.getDefaultRootIdentity()&&this.metadata.getDefaultRootIdentity()===t&&this.metadata.setDefaultRootIdentity(null),this.cache.invalidate(e_.Key.forRootIdentity(t)),this.cache.invalidate(e_.Key.forRootIdentityPrivateKey(t))),e})}listRootIdentities(){return E(this,void 0,void 0,function*(){let t=yield this.storage.listRootIdentities();for(let e of t){let t=yield this.loadRootIdentityMetadata(e.getId());e.setMetadata(t)}return t})}containsRootIdentities(){return E(this,void 0,void 0,function*(){return yield this.storage.containsRootIdenities()})}storeRootIdentityMetadata(t,e){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid id"),tj(null!=e,"Invalid metadata"),yield this.storage.storeRootIdentityMetadata(t,e)})}loadRootIdentityMetadata(t){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid id");let e=yield this.storage.loadRootIdentityMetadata(t);return null!=e?(e.setId(t),e.attachStore(this)):e=new er.Metadata(t,this),e})}storeDid(t){return E(this,void 0,void 0,function*(){if(tj(null!=t,"Invalid doc"),yield this.storage.storeDid(t),t.getStore()!=this){let e=yield this.loadDidMetadata(t.getSubject());t.getMetadata().merge(e),t.getMetadata().attachStore(this)}for(let e of(yield this.storeDidMetadata(t.getSubject(),t.getMetadata()),t.getCredentials()))yield this.storeCredential(e);this.cache.put(e_.Key.forDidDocument(t.getSubject()),t)})}loadDid(t){return E(this,void 0,void 0,function*(){let e;tj(null!=t,"Invalid did"),e=t instanceof tz?t:tz.from(t);try{let t=yield this.cache.getAsync(e_.Key.forDidDocument(e),()=>E(this,void 0,void 0,function*(){let t=yield this.storage.loadDid(e);return null!=t?(t.setMetadata((yield this.loadDidMetadata(e))),{value:t}):{value:e_.NULL}}));return t===e_.NULL?null:t}catch(t){throw new T("Load did document failed: "+e,t)}})}containsDid(t){return E(this,void 0,void 0,function*(){let e;return tj(null!=t,"Invalid did"),e=t instanceof tz?t:tz.from(t),yield this.storage.containsDid(e)})}containsDids(){return E(this,void 0,void 0,function*(){return yield this.storage.containsDids()})}storeDidMetadata(t,e){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid did"),tj(null!=e,"Invalid metadata"),yield this.storage.storeDidMetadata(t,e),e.attachStore(this),this.cache.put(e_.Key.forDidMetadata(t),e)})}loadDidMetadata(t){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid did");try{let e=yield this.cache.getAsync(e_.Key.forDidMetadata(t),()=>E(this,void 0,void 0,function*(){let e=yield this.storage.loadDidMetadata(t);return null!=e?(e.setDid(t),e.attachStore(this)):e=new tN(t,this),{value:e}}));return e===e_.NULL?null:e}catch(e){throw new T("Load did metadata failed: "+t,e)}})}deleteDid(t){return E(this,void 0,void 0,function*(){let e;tj(null!=t,"Invalid did"),e=t instanceof tz?t:tz.from(t);let i=yield this.storage.deleteDid(e);return i&&(this.cache.invalidate(e_.Key.forDidDocument(e)),this.cache.invalidate(e_.Key.forDidMetadata(e)),this.cache.invalidateAll(t=>t.id instanceof tV&&t.id.getDid()===e)),i})}listDids(){return E(this,void 0,void 0,function*(){let t=yield this.storage.listDids();for(let e of t){let t=yield this.loadDidMetadata(e);null==t?t=new tN(e,this):(t.setDid(e),t.attachStore(this)),e.setMetadata(t)}return t})}selectDids(t){return E(this,void 0,void 0,function*(){let e=yield this.listDids();if(null!=t){let i=[];for(let r of e)t.select(r)&&i.push(r);e=i}return e})}storeCredential(t,e){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid credential");let i=t.serialize(!0),r=o.Buffer.from(i,"utf-8"),n=!1;if(e&&(r=o.Buffer.from(this.encrypt(r,e),"utf-8"),n=!0),yield this.storage.storeCredential(t.getId(),r,n),t.getMetadata().getStore()!=this){let e=yield this.loadCredentialMetadata(t.getId());t.getMetadata().merge(e),t.getMetadata().attachStore(this)}yield this.storeCredentialMetadata(t.getId(),t.getMetadata()),this.cache.put(e_.Key.forCredential(t.getId()),t)})}loadCredential(t,e){return E(this,void 0,void 0,function*(){if(tj(null!=t,"Invalid credential id"),"string"==typeof t&&(t=tV.from(t)),e){let t=this.metadata.getFingerprint(),i=e_.calcFingerprint(e);if(null!=t&&i!==t)throw new D("Password mismatched with previous password.")}tj(t.isQualified(),"Unqualified credential id");try{let i=yield this.cache.getAsync(e_.Key.forCredential(t),()=>E(this,void 0,void 0,function*(){let i,[r,n]=yield this.storage.loadCredential(t);if(!r)return{value:e_.NULL};if(n&&!e)throw new T("Credential is encrypted, please provide password to get it.");return(i=n?t0.parse(this.decrypt(r.toString(),e).toString()):t0.parse(r.toString())).setMetadata((yield this.loadCredentialMetadata(t))),{value:i}}));return i===e_.NULL?null:i}catch(e){throw new T("Load credential failed: "+t,e)}})}containsCredential(t){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid credential id");let e=tV.from(t);return tj(e.isQualified(),"Unqualified credential id"),yield this.storage.containsCredential(e)})}containsCredentials(t){return E(this,void 0,void 0,function*(){return tj(null!=t,"Invalid did"),yield this.storage.containsCredentials(t)})}storeCredentialMetadata(t,e){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid credential id"),tj(t.isQualified(),"Unqualified credential id"),tj(null!=e,"Invalid credential metadata"),yield this.storage.storeCredentialMetadata(t,e),e.attachStore(this),this.cache.put(e_.Key.forCredentialMetadata(t),e)})}loadCredentialMetadata(t){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid credential id"),tj(t.isQualified(),"Unqualified credential id");try{let e=yield this.cache.getAsync(e_.Key.forCredentialMetadata(t),()=>E(this,void 0,void 0,function*(){let e=yield this.storage.loadCredentialMetadata(t);return null!=e?(e.setId(t),e.attachStore(this)):e=new tZ(t,this),{value:e}}));return e===e_.NULL?null:e}catch(e){throw new T("Load Credential metadata failed: "+t,e)}})}deleteCredential(t){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid credential id");let e=tV.from(t);tj(e.isQualified(),"Unqualified credential id");let i=yield this.storage.deleteCredential(e);return i&&(this.cache.invalidate(e_.Key.forCredential(e)),this.cache.invalidate(e_.Key.forCredentialMetadata(e))),i})}listCredentials(t){return E(this,void 0,void 0,function*(){let e;tj(null!=t,"Invalid did"),e=t instanceof tz?t:tz.from(t);let i=yield this.storage.listCredentials(e);for(let t of i){let e=yield this.loadCredentialMetadata(t);null==e?e=new tZ(t,this):(e.setId(t),e.attachStore(this)),t.setMetadata(e)}return i})}selectCredentials(t,e){return E(this,void 0,void 0,function*(){let i;tj(null!=t,"Invalid did"),i=t instanceof tz?t:tz.from(t);let r=yield this.listCredentials(i);if(null!=e){let t=[];for(let i of r)e.select(i)&&t.push(i);r=t}return r})}storePrivateKey(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid private key id");let r=tV.from(t);tj(r.isQualified(),"Unqualified private key id"),tj(null!=e&&0!=e.length,"Invalid private key"),tj(null!=i&&""!==i,"Invalid storepass");let n=this.encrypt(e,i);yield this.storage.storePrivateKey(r,n),this.cache.put(e_.Key.forDidPrivateKey(r),n)})}storeLazyPrivateKey(t){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid private key id"),tj(t.isQualified(),"Unqualified private key id"),yield this.storage.storePrivateKey(t,e_.DID_LAZY_PRIVATEKEY),this.cache.put(e_.Key.forDidPrivateKey(t),e_.DID_LAZY_PRIVATEKEY)})}loadPrivateKey(t,e){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid private key id"),tj(t.isQualified(),"Unqualified private key id"),tj(e&&null!=e,"Invalid storepass");try{let i=yield this.cache.getAsync(e_.Key.forDidPrivateKey(t),()=>E(this,void 0,void 0,function*(){let e=yield this.storage.loadPrivateKey(t);return{value:null!=e?e:e_.NULL}}));return i!==e_.NULL&&i?i===e_.DID_LAZY_PRIVATEKEY?yield er.lazyCreateDidPrivateKey(t,this,e):this.decrypt(i,e):null}catch(t){throw new T("Load did private key failed.")}})}containsPrivateKey(t){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid private key id");let e=tV.from(t);return tj(e.isQualified(),"Unqualified private key id"),yield this.storage.containsPrivateKey(e)})}containsPrivateKeys(t){return E(this,void 0,void 0,function*(){let e;return tj(null!=t,"Invalid did"),e=t instanceof tz?t:tz.from(t),yield this.storage.containsPrivateKeys(e)})}deletePrivateKey(t){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid private key id");let e=tV.from(t),i=yield this.storage.deletePrivateKey(e);return i&&this.cache.invalidate(e_.Key.forDidPrivateKey(e)),i})}sign(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid private key id"),tj(t.isQualified(),"Unqualified private key id"),tj(null!=e&&""!==e,"Invalid storepass"),tj(null!=i&&i.length>0,"Invalid digest");let r=yield this.loadPrivateKey(t,e);if(null==r)throw new T("Private key not exists: "+t.toString());let n=oA.deserialize(r),o=eO.sign(n.getPrivateKeyBytes(),i);return r.fill(0),n.wipe(),eP.fromHex(o.toString("hex"))})}changePassword(t,e){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid old password"),tj(null!=e&&""!==e,"Invalid new password"),yield this.storage.changePassword({reEncrypt:i=>e_.reEncrypt(i,t,e)}),this.metadata.setFingerprint(e_.calcFingerprint(e)),this.cache.invalidateAll()})}synchronize(t=null,e){return E(this,void 0,void 0,function*(){for(let e of(null==t&&(t=oR.getInstance()),yield this.listRootIdentities()))yield e.synchronize(t);for(let i of yield this.storage.listDids()){let r=yield this.storage.loadDid(i);if(r.isCustomizedDid()){let e=yield i.resolve();if(null==e)continue;let n=e;if(r.getMetadata().detachStore(),r.getSignature()===e.getSignature()||null!=r.getMetadata().getSignature()&&r.getProof().getSignature()===r.getMetadata().getSignature())n.getMetadata().merge(r.getMetadata());else{if(eI.debug("{} on-chain copy conflict with local copy.",i.toString()),null==(n=t.merge(e,r))||!n.getSubject().equals(i))throw eI.error("Conflict handle merge the DIDDocument error."),new T("deal with local modification error.");eI.debug("Conflict handle return the final copy.")}r.getMetadata().attachStore(this);let o=n.getMetadata();o.setPublished(e.getMetadata().getPublished()),o.setSignature(e.getProof().getSignature()),e.getMetadata().isDeactivated()&&o.setDeactivated(!0),o.attachStore(this),yield this.storage.storeDid(n)}for(let t of yield this.storage.listCredentials(i)){let i=yield this.loadCredential(t,e),r=yield t0.resolve(t,i.getIssuer());null!=r&&(r.getMetadata().merge(i.getMetadata()),yield this.storeCredential(r))}}})}exportDid(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid id"),tj(null!=e&&""!==e,"Invalid password"),tj(null!=i&&""!==i,"Invalid storepass"),"string"==typeof t&&(t=tz.from(t));let r=yield this.storage.loadDid(t);if(null==r)throw new T("Export DID "+t+" failed, not exist.");r.setMetadata((yield this.storage.loadDidMetadata(t))),eI.debug("Exporting {}...",t.toString());let n=new e_.DIDExport(t);if(n.setDocument(r),yield this.storage.containsCredentials(t)){let e=Array.from((yield this.listCredentials(t)));for(let t of(e.sort(),e)){eI.debug("Exporting credential {}...",t.toString());let e=yield this.loadCredential(t);e.setMetadata((yield this.storage.loadCredentialMetadata(t))),n.addCredential(e)}}if(yield this.storage.containsPrivateKeys(t))for(let o of r.getPublicKeys()){if(!o.getController().equals(t))continue;let r=o.getId(),s=yield this.storage.loadPrivateKey(r);null!=s&&(eI.debug("Exporting private key {}...",r.toString()),n.addPrivatekey(r,s,i,e))}return n.seal(e),n.serialize(!0)})}importDid(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid import data"),tj(null!=e&&""!==e,"Invalid password"),tj(null!=i&&""!==i,"Invalid storepass");let r=e_.DIDExport.parse(t);r.verify(e);let n=r.getDocument();for(let t of(yield this.storage.storeDid(n),yield this.storage.storeDidMetadata(n.getSubject(),n.getMetadata()),r.getCredentials()))yield this.storeCredential(t),yield this.storage.storeCredentialMetadata(t.getId(),t.getMetadata());for(let t of r.getPrivateKeys())yield this.storage.storePrivateKey(t.getId(),t.getKey(e,i));return null})}exportRootIdentity(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid id"),tj(null!=e&&""!==e,"Invalid password"),tj(null!=i&&""!==i,"Invalid storepass");let r=new e_.RootIdentityExport,n=yield this.storage.loadRootIdentityMnemonic(t);null!==n&&r.setMnemonic(n,i,e),r.setPirvateKey((yield this.storage.loadRootIdentityPrivateKey(t)),i,e);let o=yield this.storage.loadRootIdentity(t);return r.setPublicKey(o.getPreDerivedPublicKey().serializePublicKeyBase58()),r.setIndex(o.getIndex()),o.getId()==this.metadata.getDefaultRootIdentity()&&r.setDefault(),r.seal(e),r.serialize(!0)})}importRootIdentity(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t&&""!==t,"Invalid import data"),tj(null!=e&&""!==e,"Invalid password"),tj(null!=i&&""!==i,"Invalid storepass");let r=e_.RootIdentityExport.parse(t);r.verify(e);let n=r.getMnemonic(e,i),o=r.getPrivateKey(e,i),s=r.getPublicKey(),a=oA.deserializeBase58(s),l=er.getId(a.serializePublicKey());return yield this.storage.storeRootIdentity(l,n,o,s,r.getIndex()),r.isDefault()&&null==this.metadata.getDefaultRootIdentity()&&this.metadata.setDefaultRootIdentity(l),null})}exportStore(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid zip file"),tj(null!=e&&""!==e,"Invalid password"),tj(null!=i&&""!==i,"Invalid storepass");let r=new g;for(let t of yield this.listDids()){let n=yield this.exportDid(t,e,i);r.file("did-"+t.getMethodSpecificId(),n)}for(let t of yield this.listRootIdentities()){let n=yield this.exportRootIdentity(t.getId(),e,i);r.file("rootIdentity-"+t.getId(),n)}new oP(t).createFile();try{let e=yield r.generateAsync({type:"nodebuffer",platform:"UNIX"});eb(t,e,{mode:420,flag:"w+"})}catch(t){throw new tw(t)}})}importStore(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid zip file"),tj(null!=e&&""!==e,"Invalid password"),tj(null!=i&&""!==i,"Invalid storepass");let r=this.metadata.getFingerprint(),n=e_.calcFingerprint(i);if(null!=r&&n!==r)throw new D("Password mismatched with previous password.");try{let r=[],n=yield eg(t),o=yield g.loadAsync(n);o.forEach((t,n)=>{let s=o.file(t).async("string").then(r=>E(this,void 0,void 0,function*(){t.startsWith("rootIdentity-")?yield this.importRootIdentity(r,e,i):t.startsWith("did-")?yield this.importDid(r,e,i):console.log("Skip unknow export entry: "+t)}));r.push(s)}),yield Promise.all(r)}catch(t){throw new tw(t)}null!=r&&""!=r||this.metadata.setFingerprint(n)})}}e_.CACHE_INITIAL_CAPACITY=16,e_.CACHE_MAX_CAPACITY=128,e_.NULL=null,e_.DID_LAZY_PRIVATEKEY="lazy-private-key",e_.storages=new Map,e_.DEFAULT_STORAGE="fs",function(t){class e{constructor(t,e){this.type=t,this.id=e}hashCode(){return this.type+this.id.hashCode()}equals(t){return t==this||t instanceof e&&this.type==t.type&&this.id.equals(t.id)}static forRootIdentity(i){return new e(t.Key.TYPE_ROOT_IDENTITY,new class{equals(t){return t===i}compareTo(t){return i.localeCompare(t)}hashCode(){return tB(i)}})}static forRootIdentityPrivateKey(i){return new e(t.Key.TYPE_ROOT_IDENTITY_PRIVATEKEY,new class{constructor(){this.key=i}equals(t){return t===this.key}compareTo(t){return this.key<t?-1:this.key>t?1:0}hashCode(){return tB(this.key)}})}static forDidDocument(i){return new e(t.Key.TYPE_DID_DOCUMENT,i)}static forDidMetadata(i){return new e(t.Key.TYPE_DID_METADATA,i)}static forDidPrivateKey(i){return new e(t.Key.TYPE_DID_PRIVATEKEY,i)}static forCredential(i){return new e(t.Key.TYPE_CREDENTIAL,i)}static forCredentialMetadata(i){return new e(t.Key.TYPE_CREDENTIAL_METADATA,i)}}e.TYPE_ROOT_IDENTITY=0,e.TYPE_ROOT_IDENTITY_PRIVATEKEY=1,e.TYPE_DID_DOCUMENT=16,e.TYPE_DID_METADATA=17,e.TYPE_DID_PRIVATEKEY=18,e.TYPE_CREDENTIAL=32,e.TYPE_CREDENTIAL_METADATA=33,t.Key=e;class i extends tP{constructor(t=null){super(),this.document=null,this.credentials=[],this.privatekeys=[],this.created=null,this.fingerprint=null,this.type=i.DID_EXPORT,this.id=t}getId(){return this.id}getDocument(){return this.document.content}setDocument(e){this.document=new t.DIDExport.Document(e,e.getMetadata().isEmpty()?null:e.getMetadata())}getCredentials(){if(null==this.credentials)return[];let t=[];for(let e of this.credentials)t.push(e.content);return t}addCredential(t){null==this.credentials&&(this.credentials=[]),this.credentials.push(new i.Credential(t,t.getMetadata().isEmpty()?null:t.getMetadata()))}getPrivateKeys(){return null!=this.privatekeys?this.privatekeys:[]}addPrivatekey(e,i,r,n){null==this.privatekeys&&(this.privatekeys=[]);let o=new t.DIDExport.PrivateKey(e);o.setKey(i,r,n),this.privatekeys.push(o)}calculateFingerprint(t){let e=c("sha256");if(e.update(o.Buffer.from(t)),e.update(o.Buffer.from(this.type)),e.update(o.Buffer.from(this.id.toString())),e.update(o.Buffer.from(this.document.content.toString(!0))),this.document.metadata&&e.update(o.Buffer.from(this.document.metadata.toString(!0))),this.credentials)for(let t of this.credentials)e.update(o.Buffer.from(t.content.toString(!0))),t.metadata&&e.update(o.Buffer.from(t.metadata.toString(!0)));for(let t of this.privatekeys)e.update(o.Buffer.from(t.id.toString())),e.update(o.Buffer.from(t.key));e.update(o.Buffer.from(this.dateToString(this.created)));let i=e.digest();return eP.toUrlFormat(i.toString("base64"))}seal(t){let e=f();return e.set("milliseconds",0),this.created=e.toDate(),this.fingerprint=this.calculateFingerprint(t),this}verify(t){if(this.fingerprint!==this.calculateFingerprint(t))throw new tw("Invalid export data, fingerprint mismatch. "+this.id.toString())}toJSON(t=null){let e={};return e.type=this.type,e.id=this.id.toString(),e.document=this.document.toJSON(),this.credentials&&this.credentials.length>0&&(e.credential=Array.from(this.credentials,t=>t.toJSON())),this.privatekeys&&this.privatekeys.length>0&&(e.privateKey=Array.from(this.privatekeys,t=>t.toJSON())),e.created=this.dateToString(this.created),e.fingerprint=this.fingerprint,e}fromJSON(t,e=null){if(this.type=this.getString("type",t.type,{mandatory:!0,nullable:!1}),!this.type||this.type!==i.DID_EXPORT)throw new tw("Invalid export data, unknown type.");if(this.id=this.getDid("id",t.id,{mandatory:!0,nullable:!1}),!t.document)throw new tw("Invalid export data, missing document.");if(this.document=i.Document.parse(t.document),t.credential){if(!Array.isArray(t.credential))throw new tw("Invalid export data, invalid credentials.");this.credentials=Array.from(t.credential,t=>i.Credential.parse(t))}if(t.privateKey){if(!Array.isArray(t.privateKey))throw new tw("Invalid export data, invalid privatekeys.");this.privatekeys=Array.from(t.privateKey,t=>i.PrivateKey.parse(t))}this.created=this.getDate("created",t.created,{mandatory:!0,nullable:!1}),this.fingerprint=this.getString("fingerprint",t.fingerprint,{mandatory:!0,nullable:!1})}static parse(t,e=null){try{return tP.deserialize(t,i,e)}catch(t){throw t instanceof tw?t:new tw(t)}}}i.DID_EXPORT="did.elastos.export/2.0",t.DIDExport=i,function(e){class i extends tP{constructor(t=null,e=null){super(),this.content=t,this.metadata=e}toJSON(t=null){let e={};return e.content=this.content.toJSON(),this.metadata&&(e.metadata=this.metadata.toJSON()),e}fromJSON(t,e=null){if(!t.content)throw new tw("Invalid export data, missing document content");this.content=ee._parseOnly(t.content),t.metadata&&(this.metadata=tN.parse(t.metadata),this.content.setMetadata(this.metadata))}static parse(t,e=null){try{return tP.deserialize(t,i,e)}catch(t){throw t instanceof tw?t:new tw(t)}}}e.Document=i;class r extends tP{constructor(t=null,e=null){super(),this.content=t,this.metadata=e}toJSON(t=null){let e={};return e.content=this.content.toJSON(),this.metadata&&(e.metadata=this.metadata.toJSON()),e}fromJSON(t,e=null){if(!t.content)throw new tw("Invalid export data, missing credential content");this.content=t0.parse(t.content),t.metadata&&(this.metadata=tZ.parse(t.metadata),this.content.setMetadata(this.metadata))}static parse(t,e=null){try{return tP.deserialize(t,r,e)}catch(t){throw t instanceof tw?t:new tw(t)}}}e.Credential=r;class n extends tP{constructor(t=null){super(),this.id=t}getId(){return this.id}setId(t){this.id=t}getKey(e,i){return t.reEncrypt(this.key,e,i)}setKey(e,i,r){this.key=t.reEncrypt(e,i,r)}toJSON(t=null){return{id:this.id.toString(),key:this.key}}fromJSON(t,e=null){this.id=this.getDidUrl("id",t.id,{mandatory:!0,nullable:!1}),this.key=this.getString("key",t.key,{mandatory:!0,nullable:!1})}static parse(t,e=null){try{return tP.deserialize(t,n,e)}catch(t){throw t instanceof tw?t:new tw(t)}}}e.PrivateKey=n}(i=t.DIDExport||(t.DIDExport={}));class r extends tP{constructor(){super(),this.type=r.DID_EXPORT}getMnemonic(e,i){return null==this.mnemonic?null:t.reEncrypt(this.mnemonic,e,i)}setMnemonic(e,i,r){this.mnemonic=t.reEncrypt(e,i,r)}getPrivateKey(e,i){return t.reEncrypt(this.privatekey,e,i)}setPirvateKey(e,i,r){this.privatekey=t.reEncrypt(e,i,r)}getPublicKey(){return this.publickey}setPublicKey(t){this.publickey=t}getIndex(){return this.index}setIndex(t){this.index=t}isDefault(){return 1==this.default}setDefault(){this.default=!0}calculateFingerprint(t){let e=c("sha256");e.update(o.Buffer.from(t)),e.update(o.Buffer.from(this.type)),this.mnemonic&&e.update(o.Buffer.from(this.mnemonic)),e.update(o.Buffer.from(this.privatekey)),e.update(o.Buffer.from(this.publickey)),e.update(o.Buffer.from(this.index.toString())),e.update(o.Buffer.from(this.default.toString())),e.update(o.Buffer.from(this.dateToString(this.created)));let i=e.digest();return eP.toUrlFormat(i.toString("base64"))}seal(t){let e=f();return e.set("milliseconds",0),this.created=e.toDate(),this.fingerprint=this.calculateFingerprint(t),this}verify(t){if(this.fingerprint!==this.calculateFingerprint(t))throw new tw("Invalid export data, fingerprint mismatch.")}toJSON(t=null){return{type:this.type,mnemonic:this.mnemonic,privateKey:this.privatekey,publicKey:this.publickey,index:this.index.toString(),default:this.default.toString(),created:this.dateToString(this.created),fingerprint:this.fingerprint}}fromJSON(t,e=null){if(this.type=this.getString("type",t.type,{mandatory:!0,nullable:!1}),!this.type||this.type!==r.DID_EXPORT)throw new tw("Invalid export data, unknown type.");this.mnemonic=this.getString("mnemonic",t.mnemonic,{mandatory:!0,nullable:!1}),this.privatekey=this.getString("privateKey",t.privateKey,{mandatory:!0,nullable:!1}),this.publickey=this.getString("publicKey",t.publicKey,{mandatory:!0,nullable:!1});let i=this.getString("index",t.index,{mandatory:!0,nullable:!1});this.index=null!=i?Number.parseInt(i):0;let n=this.getString("default",t.default,{mandatory:!0,nullable:!1});this.default=!(!n||"true"!==n),this.created=this.getDate("created",t.created,{mandatory:!0,nullable:!1}),this.fingerprint=this.getString("fingerprint",t.fingerprint,{mandatory:!0,nullable:!1})}static parse(t,e=null){try{return tP.deserialize(t,r,e)}catch(t){throw t instanceof tw?t:new tw(t)}}}r.DID_EXPORT="did.elastos.export/2.0",t.RootIdentityExport=r}(e_||(e_={}));class eD{constructor(){}static create(t,e){return E(this,void 0,void 0,function*(){let i=new eD;if(i.self=t,e){if(!i.self.isAuthenticationKey(e))throw new q(e.toString()+" isn't the authentication key")}else if(null==(e=i.self.getDefaultPublicKeyId()))throw new q("Need explict sign key or effective controller");if(!(yield t.hasPrivateKey(e)))throw new q("No private key: "+e);return i.signKey=e,i})}static newWithDocument(t,e){return E(this,void 0,void 0,function*(){return tj(null!=t,"Invalid document"),e?e instanceof tV?yield eD.create(t,e):yield eD.create(t,tV.from(e,t.getSubject())):yield eD.create(t)})}static newWithDID(t,e,i){return E(this,void 0,void 0,function*(){tj(null!=t,"Invalid did"),tj(null!=e,"Invalid store");let r=yield e.loadDid(t);return i?i instanceof tV?yield eD.create(r,i):yield eD.create(r,tV.from(i,t)):yield eD.create(r)})}getDid(){return this.self.getSubject()}getDocument(){return this.self}getSignKey(){return this.signKey}sign(t,e){return this.self.signWithId(this.signKey,t,e)}issueFor(t){return tj(null!=t,"Invalid did"),t instanceof tz?new t0.Builder(this,t):new t0.Builder(this,tz.from(t))}}class eT{constructor(t){this.buffer=t,this.position=0}static wrap(t){let e=new Uint8Array(t);for(let i=0;i<t.length;++i)e[i]=t[i];return new eT(e)}static allocate(t){return new eT(new Uint8Array(t))}hasRemaining(){return this.size()>this.position}size(){return this.buffer.length}reallocate(){let t=new Uint8Array(2*this.size());t.set(this.buffer),this.buffer=t}shrink(){return this.buffer=this.buffer.subarray(0,this.position),this.buffer}put(t){this.buffer.length<this.position+1&&this.reallocate(),this.buffer[this.position++]=t}get(t){return null==t&&(t=this.position,this.position+=1),this.buffer.length<t+1?0:this.buffer[t]}putShort(t){if(65535<t)throw t+" is over short value";this.put(255&t),this.put((65280&t)>>8)}getShort(t){if(null==t&&(t=this.position,this.position+=2),this.buffer.length<t+2)return 0;let e=this.buffer[t];return(this.buffer[t+1]<<8)+e}putInt(t){if(4294967295<t)throw t+" is over integer value";this.put(255&t),this.put((65280&t)>>8),this.put((16711680&t)>>16),this.put((4278190080&t)>>24)}getInt(t){if(t>this.size()+4)throw new tv;if(null==t&&(t=this.position,this.position+=4),this.buffer.length<t+4)return 0;let e=this.buffer[t],i=this.buffer[t+1],r=this.buffer[t+2];return(this.buffer[t+3]<<24)+(r<<16)+(i<<8)+e}readInt(){if(!this.hasRemaining())throw new tv("Buffer exhausted");let t=this.position;return this.position+=4,this.getInt(t)}putString(t){let e=this.stringToUtf8Bytes(t);for(let t=0;t<e.length;t++)this.put(e[t]);this.put(0)}getString(t){let e,i=[];for(null==t&&(t=this.position);!(this.buffer.length<t+1)&&0!==(e=this.get(t++));)i.push(e);return this.position=t,this.utf8BytesToString(i)}stringToUtf8Bytes(t){let e=new Uint8Array(4*t.length),i=0,r=0;for(;i<t.length;){let n;let o=t.charCodeAt(i++);if(o>=55296&&o<=56319){let e=t.charCodeAt(i++);if(!(e>=56320&&e<=57343))return null;n=1024*(o-55296)+65536+(e-56320)}else n=o;n<128?e[r++]=n:n<2048?(e[r++]=n>>>6|192,e[r++]=63&n|128):n<65536?(e[r++]=n>>>12|224,e[r++]=n>>6&63|128,e[r++]=63&n|128):n<2097152&&(e[r++]=n>>>18|240,e[r++]=n>>12&63|128,e[r++]=n>>6&63|128,e[r++]=63&n|128)}return e.subarray(0,r)}utf8BytesToString(t){let e,i,r,n,o="",s=0;for(;s<t.length;)(e=(i=t[s++])<128?i:i>>5==6?(31&i)<<6|63&(r=t[s++]):i>>4==14?(15&i)<<12|(63&(r=t[s++]))<<6|63&(n=t[s++]):(7&i)<<18|(63&(r=t[s++]))<<12|(63&(n=t[s++]))<<6|63&t[s++])<65536?o+=String.fromCharCode(e):(e-=65536,o+=String.fromCharCode(55296|e>>10,56320|1023&e));return o}}function eA(t){return s.createHash("md5").update(t).digest("hex")}class ex{static hashTwice(t){let e=c("sha256").update(t).digest();return c("sha256").update(e).digest()}static sha256ripemd160(t){let e=c("sha256").update(t).digest();return c("ripemd160").update(e).digest()}static encodeToString(...t){let e=t.reduce((t,e)=>o.Buffer.concat([t,e]),o.Buffer.from(""));return c("sha256").update(e).digest().toString()}static encodeToBuffer(...t){let e=t.reduce((t,e)=>o.Buffer.concat([t,e]),o.Buffer.from(""));return c("sha256").update(e).digest()}}class eO{static sign(t,e){let i=new u.ec("p256").keyFromPrivate(t,"hex").sign(e);return o.Buffer.from(i.r.toString("hex",64)+i.s.toString("hex",64),"hex")}static signData(t,...e){return this.sign(t,ex.encodeToBuffer(...e))}static verify(t,e,i){let r=new u.ec("p256").keyFromPublic(t,"hex"),n={r:e.slice(0,32).toString("hex"),s:e.slice(32).toString("hex")};return r.verify(i,n)}static verifyData(t,e,...i){return this.verify(t,e,ex.encodeToBuffer(...i))}static sha256Digest(...t){return ex.encodeToBuffer(...t)}}class eP{static fromString(t){let e=o.Buffer.from(t,"utf-8").toString("base64");return this.convertToURI(e)}static fromHex(t){return this.encode(t)}static fromUrlFormat(t){return this.convertFromURI(t)}static toUrlFormat(t){return this.convertToURI(t)}static toHex(t){return this.decode(t)}static toString(t){let e=t;return e.endsWith("=")||(e=this.convertFromURI(e)),o.Buffer.from(e,"base64").toString("utf-8")}static decode(t){let e=t;return e.endsWith("=")||(e=this.convertFromURI(e)),o.Buffer.from(e,"base64").toString("hex")}static encode(t){let e=o.Buffer.from(t,"hex").toString("base64");return this.convertToURI(e)}static convertToURI(t){return t.replace(/[+/]/g,t=>"+"==t?"-":"_").replace(/=+$/m,"")}static convertFromURI(t){return t.replace(/[-_]/g,t=>"-"==t?"+":"/")+"="}}var eR="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function ek(){throw Error("setTimeout has not been defined")}function eN(){throw Error("clearTimeout has not been defined")}var eC=ek,eF=eN;function eL(t){if(eC===setTimeout)return setTimeout(t,0);if((eC===ek||!eC)&&setTimeout)return eC=setTimeout,setTimeout(t,0);try{return eC(t,0)}catch(e){try{return eC.call(null,t,0)}catch(e){return eC.call(this,t,0)}}}"function"==typeof eR.setTimeout&&(eC=setTimeout),"function"==typeof eR.clearTimeout&&(eF=clearTimeout);var eM,ej,eK,eU,eB,ez,eV,eq,eW=[],eY=!1,eH=-1;function eJ(){eY&&eq&&(eY=!1,eq.length?eW=eq.concat(eW):eH=-1,eW.length&&eX())}function eX(){if(!eY){var t=eL(eJ);eY=!0;for(var e=eW.length;e;){for(eq=eW,eW=[];++eH<e;)eq&&eq[eH].run();eH=-1,e=eW.length}eq=null,eY=!1,function(t){if(eF===clearTimeout)return clearTimeout(t);if((eF===eN||!eF)&&clearTimeout)return eF=clearTimeout,clearTimeout(t);try{eF(t)}catch(e){try{return eF.call(null,t)}catch(e){return eF.call(this,t)}}}(t)}}function eG(t){var e=Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];eW.push(new eZ(t,e)),1!==eW.length||eY||eL(eX)}function eZ(t,e){this.fun=t,this.array=e}eZ.prototype.run=function(){this.fun.apply(null,this.array)};var eQ,e$=eR.performance||{},e0=(e$.now||e$.mozNow||e$.msNow||e$.oNow||e$.webkitNow,{env:{}}),e1={exports:{}},e2={},e5={},e3=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var t={},e=Symbol("test"),i=Object(e);if("string"==typeof e||"[object Symbol]"!==Object.prototype.toString.call(e)||"[object Symbol]"!==Object.prototype.toString.call(i))return!1;for(e in t[e]=42,t)return!1;if("function"==typeof Object.keys&&0!==Object.keys(t).length||"function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(t).length)return!1;var r=Object.getOwnPropertySymbols(t);if(1!==r.length||r[0]!==e||!Object.prototype.propertyIsEnumerable.call(t,e))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var n=Object.getOwnPropertyDescriptor(t,e);if(42!==n.value||!0!==n.enumerable)return!1}return!0},e6=function(){return e3()&&!!Symbol.toStringTag},e8="undefined"!=typeof Symbol&&Symbol,e4={foo:{}},e7=Object,e9=Array.prototype.slice,it=Object.prototype.toString,ie=Function.prototype.bind||function(t){var e=this;if("function"!=typeof e||"[object Function]"!==it.call(e))throw TypeError("Function.prototype.bind called on incompatible "+e);for(var i,r=e9.call(arguments,1),n=Math.max(0,e.length-r.length),o=[],s=0;s<n;s++)o.push("$"+s);if(i=Function("binder","return function ("+o.join(",")+"){ return binder.apply(this,arguments); }")(function(){if(this instanceof i){var n=e.apply(this,r.concat(e9.call(arguments)));return Object(n)===n?n:this}return e.apply(t,r.concat(e9.call(arguments)))}),e.prototype){var a=function(){};a.prototype=e.prototype,i.prototype=new a,a.prototype=null}return i},ii={}.hasOwnProperty,ir=Function.prototype.call,io=ir.bind?ir.bind(ii):function(t,e){return ir.call(ii,t,e)},is=SyntaxError,ia=Function,il=TypeError,iu=function(t){try{return ia('"use strict"; return ('+t+").constructor;")()}catch(t){}},ic=Object.getOwnPropertyDescriptor,ih=function(){throw new il},id=ic?function(){try{return ih}catch(t){try{return ic(arguments,"callee").get}catch(t){return ih}}}():ih,ip="function"==typeof e8&&"function"==typeof Symbol&&"symbol"==typeof e8("foo")&&"symbol"==typeof Symbol("bar")&&e3(),iy={__proto__:e4}.foo===e4.foo&&!(({__proto__:null})instanceof e7),ig=Object.getPrototypeOf||(iy?function(t){return t.__proto__}:null),iv={},im="undefined"!=typeof Uint8Array&&ig?ig(Uint8Array):eQ,iw={"%AggregateError%":"undefined"==typeof AggregateError?eQ:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?eQ:ArrayBuffer,"%ArrayIteratorPrototype%":ip&&ig?ig([][Symbol.iterator]()):eQ,"%AsyncFromSyncIteratorPrototype%":eQ,"%AsyncFunction%":iv,"%AsyncGenerator%":iv,"%AsyncGeneratorFunction%":iv,"%AsyncIteratorPrototype%":iv,"%Atomics%":"undefined"==typeof Atomics?eQ:Atomics,"%BigInt%":"undefined"==typeof BigInt?eQ:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?eQ:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?eQ:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?eQ:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?eQ:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?eQ:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?eQ:FinalizationRegistry,"%Function%":ia,"%GeneratorFunction%":iv,"%Int8Array%":"undefined"==typeof Int8Array?eQ:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?eQ:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?eQ:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":ip&&ig?ig(ig([][Symbol.iterator]())):eQ,"%JSON%":"object"==typeof JSON?JSON:eQ,"%Map%":"undefined"==typeof Map?eQ:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&ip&&ig?ig((new Map)[Symbol.iterator]()):eQ,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?eQ:Promise,"%Proxy%":"undefined"==typeof Proxy?eQ:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?eQ:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?eQ:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&ip&&ig?ig((new Set)[Symbol.iterator]()):eQ,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?eQ:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":ip&&ig?ig(""[Symbol.iterator]()):eQ,"%Symbol%":ip?Symbol:eQ,"%SyntaxError%":is,"%ThrowTypeError%":id,"%TypedArray%":im,"%TypeError%":il,"%Uint8Array%":"undefined"==typeof Uint8Array?eQ:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?eQ:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?eQ:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?eQ:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?eQ:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?eQ:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?eQ:WeakSet},iS=function t(e){var i;if("%AsyncFunction%"===e)i=iu("async function () {}");else if("%GeneratorFunction%"===e)i=iu("function* () {}");else if("%AsyncGeneratorFunction%"===e)i=iu("async function* () {}");else if("%AsyncGenerator%"===e){var r=t("%AsyncGeneratorFunction%");r&&(i=r.prototype)}else if("%AsyncIteratorPrototype%"===e){var n=t("%AsyncGenerator%");n&&ig&&(i=ig(n.prototype))}return iw[e]=i,i},ib={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},iE=ie.call(Function.call,Array.prototype.concat),iI=ie.call(Function.apply,Array.prototype.splice),i_=ie.call(Function.call,String.prototype.replace),iD=ie.call(Function.call,String.prototype.slice),iT=ie.call(Function.call,RegExp.prototype.exec),iA=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,ix=/\\(\\)?/g,iO=function(t,e){var i,r=t;if(io(ib,r)&&(r="%"+(i=ib[r])[0]+"%"),io(iw,r)){var n=iw[r];if(n===iv&&(n=iS(r)),void 0===n&&!e)throw new il("intrinsic "+t+" exists, but is not available. Please file an issue!");return{alias:i,name:r,value:n}}throw new is("intrinsic "+t+" does not exist!")},iP=function(t,e){if("string"!=typeof t||0===t.length)throw new il("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof e)throw new il('"allowMissing" argument must be a boolean');if(null===iT(/^%?[^%]*%?$/,t))throw new is("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var i=function(t){var e=iD(t,0,1),i=iD(t,-1);if("%"===e&&"%"!==i)throw new is("invalid intrinsic syntax, expected closing `%`");if("%"===i&&"%"!==e)throw new is("invalid intrinsic syntax, expected opening `%`");var r=[];return i_(t,iA,function(t,e,i,n){r[r.length]=i?i_(n,ix,"$1"):e||t}),r}(t),r=i.length>0?i[0]:"",n=iO("%"+r+"%",e),o=n.name,s=n.value,a=!1,l=n.alias;l&&(r=l[0],iI(i,iE([0,1],l)));for(var u=1,c=!0;u<i.length;u+=1){var h=i[u],d=iD(h,0,1),f=iD(h,-1);if(('"'===d||"'"===d||"`"===d||'"'===f||"'"===f||"`"===f)&&d!==f)throw new is("property names with quotes must have matching quotes");if("constructor"!==h&&c||(a=!0),io(iw,o="%"+(r+="."+h)+"%"))s=iw[o];else if(null!=s){if(!(h in s)){if(!e)throw new il("base intrinsic for "+t+" exists, but the property is not available.");return}if(ic&&u+1>=i.length){var p=ic(s,h);s=(c=!!p)&&"get"in p&&!("originalValue"in p.get)?p.get:s[h]}else c=io(s,h),s=s[h];c&&!a&&(iw[o]=s)}}return s},iR={exports:{}};!function(t){var e=iP("%Function.prototype.apply%"),i=iP("%Function.prototype.call%"),r=iP("%Reflect.apply%",!0)||ie.call(i,e),n=iP("%Object.getOwnPropertyDescriptor%",!0),o=iP("%Object.defineProperty%",!0),s=iP("%Math.max%");if(o)try{o({},"a",{value:1})}catch(t){o=null}t.exports=function(t){var e=r(ie,i,arguments);return n&&o&&n(e,"length").configurable&&o(e,"length",{value:1+s(0,t.length-(arguments.length-1))}),e};var a=function(){return r(ie,e,arguments)};o?o(t.exports,"apply",{value:a}):t.exports.apply=a}(iR);var ik=iR.exports,iN=ik(iP("String.prototype.indexOf")),iC=function(t,e){var i=iP(t,!!e);return"function"==typeof i&&iN(t,".prototype.")>-1?ik(i):i},iF=e6(),iL=iC("Object.prototype.toString"),iM=function(t){return!(iF&&t&&"object"==typeof t&&Symbol.toStringTag in t)&&"[object Arguments]"===iL(t)},ij=function(t){return!!iM(t)||null!==t&&"object"==typeof t&&"number"==typeof t.length&&t.length>=0&&"[object Array]"!==iL(t)&&"[object Function]"===iL(t.callee)},iK=function(){return iM(arguments)}();iM.isLegacyArguments=ij;var iU,iB,iz,iV=iK?iM:ij,iq=Object.prototype.toString,iW=Function.prototype.toString,iY=/^\s*(?:function)?\*/,iH=e6(),iJ=Object.getPrototypeOf,iX=function(t){if("function"!=typeof t)return!1;if(iY.test(iW.call(t)))return!0;if(!iH)return"[object GeneratorFunction]"===iq.call(t);if(!iJ)return!1;if(void 0===iU){var e=function(){if(!iH)return!1;try{return Function("return function*() {}")()}catch(t){}}();iU=!!e&&iJ(e)}return iJ(t)===iU},iG=Function.prototype.toString,iZ="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof iZ&&"function"==typeof Object.defineProperty)try{iB=Object.defineProperty({},"length",{get:function(){throw iz}}),iz={},iZ(function(){throw 42},null,iB)}catch(t){t!==iz&&(iZ=null)}else iZ=null;var iQ=/^\s*class\b/,i$=function(t){try{var e=iG.call(t);return iQ.test(e)}catch(t){return!1}},i0=function(t){try{return!i$(t)&&(iG.call(t),!0)}catch(t){return!1}},i1=Object.prototype.toString,i2="function"==typeof Symbol&&!!Symbol.toStringTag,i5=!(0 in[,]),i3=function(){return!1};if("object"==typeof document){var i6=document.all;i1.call(i6)===i1.call(document.all)&&(i3=function(t){if((i5||!t)&&(void 0===t||"object"==typeof t))try{var e=i1.call(t);return("[object HTMLAllCollection]"===e||"[object HTML document.all class]"===e||"[object HTMLCollection]"===e||"[object Object]"===e)&&null==t("")}catch(t){}return!1})}var i8=iZ?function(t){if(i3(t))return!0;if(!t||"function"!=typeof t&&"object"!=typeof t)return!1;try{iZ(t,null,iB)}catch(t){if(t!==iz)return!1}return!i$(t)&&i0(t)}:function(t){if(i3(t))return!0;if(!t||"function"!=typeof t&&"object"!=typeof t)return!1;if(i2)return i0(t);if(i$(t))return!1;var e=i1.call(t);return!("[object Function]"!==e&&"[object GeneratorFunction]"!==e&&!/^\[object HTML/.test(e))&&i0(t)},i4=Object.prototype.toString,i7=Object.prototype.hasOwnProperty,i9=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],rt="undefined"==typeof globalThis?eu:globalThis,re=iP("%Object.getOwnPropertyDescriptor%",!0);if(re)try{re([],"length")}catch(t){re=null}var ri=re,rr=function(t,e,i){var r;if(!i8(e))throw TypeError("iterator must be a function");arguments.length>=3&&(r=i),"[object Array]"===i4.call(t)?function(t,e,i){for(var r=0,n=t.length;r<n;r++)i7.call(t,r)&&(null==i?e(t[r],r,t):e.call(i,t[r],r,t))}(t,e,r):"string"==typeof t?function(t,e,i){for(var r=0,n=t.length;r<n;r++)null==i?e(t.charAt(r),r,t):e.call(i,t.charAt(r),r,t)}(t,e,r):function(t,e,i){for(var r in t)i7.call(t,r)&&(null==i?e(t[r],r,t):e.call(i,t[r],r,t))}(t,e,r)},rn=iR.exports,ro=iC("Object.prototype.toString"),rs=e6(),ra="undefined"==typeof globalThis?eu:globalThis,rl=function(){for(var t=[],e=0;e<i9.length;e++)"function"==typeof rt[i9[e]]&&(t[t.length]=i9[e]);return t}(),ru=iC("String.prototype.slice"),rc=Object.getPrototypeOf,rh=iC("Array.prototype.indexOf",!0)||function(t,e){for(var i=0;i<t.length;i+=1)if(t[i]===e)return i;return -1},rd={__proto__:null};rr(rl,rs&&ri&&rc?function(t){var e=new ra[t];if(Symbol.toStringTag in e){var i=rc(e),r=ri(i,Symbol.toStringTag);r||(r=ri(rc(i),Symbol.toStringTag)),rd["$"+t]=rn(r.get)}}:function(t){var e=new ra[t];rd["$"+t]=rn(e.slice)});var rf=function(t){if(!t||"object"!=typeof t)return!1;if(!rs){var e,i,r=ru(ro(t),8,-1);return rh(rl,r)>-1?r:"Object"===r&&(i=!1,rr(rd,function(e,r){if(!i)try{e(t),i=ru(r,1)}catch(t){}}),i)}return ri?(e=!1,rr(rd,function(i,r){if(!e)try{"$"+i(t)===r&&(e=ru(r,1))}catch(t){}}),e):null},rp=function(t){return!!rf(t)};!function(t){function e(t){return t.call.bind(t)}var i="undefined"!=typeof BigInt,r="undefined"!=typeof Symbol,n=e(Object.prototype.toString),o=e(Number.prototype.valueOf),s=e(String.prototype.valueOf),a=e(Boolean.prototype.valueOf);if(i)var l=e(BigInt.prototype.valueOf);if(r)var u=e(Symbol.prototype.valueOf);function c(t,e){if("object"!=typeof t)return!1;try{return e(t),!0}catch(t){return!1}}function h(t){return"[object Map]"===n(t)}function d(t){return"[object Set]"===n(t)}function f(t){return"[object WeakMap]"===n(t)}function p(t){return"[object WeakSet]"===n(t)}function y(t){return"[object ArrayBuffer]"===n(t)}function g(t){return"undefined"!=typeof ArrayBuffer&&(y.working?y(t):t instanceof ArrayBuffer)}function v(t){return"[object DataView]"===n(t)}function m(t){return"undefined"!=typeof DataView&&(v.working?v(t):t instanceof DataView)}t.isArgumentsObject=iV,t.isGeneratorFunction=iX,t.isTypedArray=rp,t.isPromise=function(t){return"undefined"!=typeof Promise&&t instanceof Promise||null!==t&&"object"==typeof t&&"function"==typeof t.then&&"function"==typeof t.catch},t.isArrayBufferView=function(t){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(t):rp(t)||m(t)},t.isUint8Array=function(t){return"Uint8Array"===rf(t)},t.isUint8ClampedArray=function(t){return"Uint8ClampedArray"===rf(t)},t.isUint16Array=function(t){return"Uint16Array"===rf(t)},t.isUint32Array=function(t){return"Uint32Array"===rf(t)},t.isInt8Array=function(t){return"Int8Array"===rf(t)},t.isInt16Array=function(t){return"Int16Array"===rf(t)},t.isInt32Array=function(t){return"Int32Array"===rf(t)},t.isFloat32Array=function(t){return"Float32Array"===rf(t)},t.isFloat64Array=function(t){return"Float64Array"===rf(t)},t.isBigInt64Array=function(t){return"BigInt64Array"===rf(t)},t.isBigUint64Array=function(t){return"BigUint64Array"===rf(t)},h.working="undefined"!=typeof Map&&h(new Map),t.isMap=function(t){return"undefined"!=typeof Map&&(h.working?h(t):t instanceof Map)},d.working="undefined"!=typeof Set&&d(new Set),t.isSet=function(t){return"undefined"!=typeof Set&&(d.working?d(t):t instanceof Set)},f.working="undefined"!=typeof WeakMap&&f(new WeakMap),t.isWeakMap=function(t){return"undefined"!=typeof WeakMap&&(f.working?f(t):t instanceof WeakMap)},p.working="undefined"!=typeof WeakSet&&p(new WeakSet),t.isWeakSet=function(t){return p(t)},y.working="undefined"!=typeof ArrayBuffer&&y(new ArrayBuffer),t.isArrayBuffer=g,v.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&v(new DataView(new ArrayBuffer(1),0,1)),t.isDataView=m;var w="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function S(t){return"[object SharedArrayBuffer]"===n(t)}function b(t){return void 0!==w&&(void 0===S.working&&(S.working=S(new w)),S.working?S(t):t instanceof w)}function E(t){return c(t,o)}function I(t){return c(t,s)}function _(t){return c(t,a)}function D(t){return i&&c(t,l)}function T(t){return r&&c(t,u)}t.isSharedArrayBuffer=b,t.isAsyncFunction=function(t){return"[object AsyncFunction]"===n(t)},t.isMapIterator=function(t){return"[object Map Iterator]"===n(t)},t.isSetIterator=function(t){return"[object Set Iterator]"===n(t)},t.isGeneratorObject=function(t){return"[object Generator]"===n(t)},t.isWebAssemblyCompiledModule=function(t){return"[object WebAssembly.Module]"===n(t)},t.isNumberObject=E,t.isStringObject=I,t.isBooleanObject=_,t.isBigIntObject=D,t.isSymbolObject=T,t.isBoxedPrimitive=function(t){return E(t)||I(t)||_(t)||D(t)||T(t)},t.isAnyArrayBuffer=function(t){return"undefined"!=typeof Uint8Array&&(g(t)||b(t))},["isProxy","isExternal","isModuleNamespaceObject"].forEach(function(e){Object.defineProperty(t,e,{enumerable:!1,value:function(){throw Error(e+" is not supported in userland")}})})}(e5);var ry=function(t){return t&&"object"==typeof t&&"function"==typeof t.copy&&"function"==typeof t.fill&&"function"==typeof t.readUInt8},rg={exports:{}};"function"==typeof Object.create?rg.exports=function(t,e){e&&(t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:rg.exports=function(t,e){if(e){t.super_=e;var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t}};var rv={};function rm(t){return(rm="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function rw(t){return(rw=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function rS(t,e){return(rS=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}!function(t){var e=Object.getOwnPropertyDescriptors||function(t){for(var e=Object.keys(t),i={},r=0;r<e.length;r++)i[e[r]]=Object.getOwnPropertyDescriptor(t,e[r]);return i},i=/%[sdj%]/g;t.format=function(t){if(!g(t)){for(var e=[],r=0;r<arguments.length;r++)e.push(s(arguments[r]));return e.join(" ")}r=1;for(var n=arguments,o=n.length,a=String(t).replace(i,function(t){if("%%"===t)return"%";if(r>=o)return t;switch(t){case"%s":return String(n[r++]);case"%d":return Number(n[r++]);case"%j":try{return JSON.stringify(n[r++])}catch(t){return"[Circular]"}default:return t}}),l=n[r];r<o;l=n[++r])p(l)||!w(l)?a+=" "+l:a+=" "+s(l);return a},t.deprecate=function(e,i){if(void 0!==e0&&!0===e0.noDeprecation)return e;if(void 0===e0)return function(){return t.deprecate(e,i).apply(this,arguments)};var r=!1;return function(){return r||(console.error(i),r=!0),e.apply(this,arguments)}};var r={},n=/^$/;if(e0.env.NODE_DEBUG){var o=e0.env.NODE_DEBUG;n=RegExp("^"+(o=o.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase())+"$","i")}function s(e,i){var r={seen:[],stylize:l};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),f(i)?r.showHidden=i:i&&t._extend(r,i),v(r.showHidden)&&(r.showHidden=!1),v(r.depth)&&(r.depth=2),v(r.colors)&&(r.colors=!1),v(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=a),u(r,e,r.depth)}function a(t,e){var i=s.styles[e];return i?"\x1b["+s.colors[i][0]+"m"+t+"\x1b["+s.colors[i][1]+"m":t}function l(t,e){return t}function u(e,i,r){if(e.customInspect&&i&&E(i.inspect)&&i.inspect!==t.inspect&&(!i.constructor||i.constructor.prototype!==i)){var n,o,s=i.inspect(r,e);return g(s)||(s=u(e,s,r)),s}var a=function(t,e){if(v(e))return t.stylize("undefined","undefined");if(g(e)){var i="'"+JSON.stringify(e).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return t.stylize(i,"string")}return y(e)?t.stylize(""+e,"number"):f(e)?t.stylize(""+e,"boolean"):p(e)?t.stylize("null","null"):void 0}(e,i);if(a)return a;var l=Object.keys(i),w=(_={},l.forEach(function(t,e){_[t]=!0}),_);if(e.showHidden&&(l=Object.getOwnPropertyNames(i)),b(i)&&(l.indexOf("message")>=0||l.indexOf("description")>=0))return c(i);if(0===l.length){if(E(i)){var I=i.name?": "+i.name:"";return e.stylize("[Function"+I+"]","special")}if(m(i))return e.stylize(RegExp.prototype.toString.call(i),"regexp");if(S(i))return e.stylize(Date.prototype.toString.call(i),"date");if(b(i))return c(i)}var _,D,A="",x=!1,O=["{","}"];return d(i)&&(x=!0,O=["[","]"]),E(i)&&(A=" [Function"+(i.name?": "+i.name:"")+"]"),m(i)&&(A=" "+RegExp.prototype.toString.call(i)),S(i)&&(A=" "+Date.prototype.toUTCString.call(i)),b(i)&&(A=" "+c(i)),0!==l.length||x&&0!=i.length?r<0?m(i)?e.stylize(RegExp.prototype.toString.call(i),"regexp"):e.stylize("[Object]","special"):(e.seen.push(i),D=x?function(t,e,i,r,n){for(var o=[],s=0,a=e.length;s<a;++s)T(e,String(s))?o.push(h(t,e,i,r,String(s),!0)):o.push("");return n.forEach(function(n){n.match(/^\d+$/)||o.push(h(t,e,i,r,n,!0))}),o}(e,i,r,w,l):l.map(function(t){return h(e,i,r,w,t,x)}),e.seen.pop(),n=A,o=O,D.reduce(function(t,e){return e.indexOf("\n"),t+e.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?o[0]+(""===n?"":n+"\n ")+" "+D.join(",\n  ")+" "+o[1]:o[0]+n+" "+D.join(", ")+" "+o[1]):O[0]+A+O[1]}function c(t){return"["+Error.prototype.toString.call(t)+"]"}function h(t,e,i,r,n,o){var s,a,l;if((l=Object.getOwnPropertyDescriptor(e,n)||{value:e[n]}).get?a=l.set?t.stylize("[Getter/Setter]","special"):t.stylize("[Getter]","special"):l.set&&(a=t.stylize("[Setter]","special")),T(r,n)||(s="["+n+"]"),a||(0>t.seen.indexOf(l.value)?(a=p(i)?u(t,l.value,null):u(t,l.value,i-1)).indexOf("\n")>-1&&(a=o?a.split("\n").map(function(t){return"  "+t}).join("\n").substr(2):"\n"+a.split("\n").map(function(t){return"   "+t}).join("\n")):a=t.stylize("[Circular]","special")),v(s)){if(o&&n.match(/^\d+$/))return a;(s=JSON.stringify(""+n)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=t.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=t.stylize(s,"string"))}return s+": "+a}function d(t){return Array.isArray(t)}function f(t){return"boolean"==typeof t}function p(t){return null===t}function y(t){return"number"==typeof t}function g(t){return"string"==typeof t}function v(t){return void 0===t}function m(t){return w(t)&&"[object RegExp]"===I(t)}function w(t){return"object"==typeof t&&null!==t}function S(t){return w(t)&&"[object Date]"===I(t)}function b(t){return w(t)&&("[object Error]"===I(t)||t instanceof Error)}function E(t){return"function"==typeof t}function I(t){return Object.prototype.toString.call(t)}function _(t){return t<10?"0"+t.toString(10):t.toString(10)}t.debuglog=function(e){if(!r[e=e.toUpperCase()]){if(n.test(e)){var i=e0.pid;r[e]=function(){var r=t.format.apply(t,arguments);console.error("%s %d: %s",e,i,r)}}else r[e]=function(){}}return r[e]},t.inspect=s,s.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},s.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.types=e5,t.isArray=d,t.isBoolean=f,t.isNull=p,t.isNullOrUndefined=function(t){return null==t},t.isNumber=y,t.isString=g,t.isSymbol=function(t){return"symbol"==typeof t},t.isUndefined=v,t.isRegExp=m,t.types.isRegExp=m,t.isObject=w,t.isDate=S,t.types.isDate=S,t.isError=b,t.types.isNativeError=b,t.isFunction=E,t.isPrimitive=function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},t.isBuffer=ry;var D=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function T(t,e){return Object.prototype.hasOwnProperty.call(t,e)}t.log=function(){var e,i;console.log("%s - %s",(i=[_((e=new Date).getHours()),_(e.getMinutes()),_(e.getSeconds())].join(":"),[e.getDate(),D[e.getMonth()],i].join(" ")),t.format.apply(t,arguments))},t.inherits=rg.exports,t._extend=function(t,e){if(!e||!w(e))return t;for(var i=Object.keys(e),r=i.length;r--;)t[i[r]]=e[i[r]];return t};var A="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function x(t,e){if(!t){var i=Error("Promise was rejected with a falsy value");i.reason=t,t=i}return e(t)}t.promisify=function(t){if("function"!=typeof t)throw TypeError('The "original" argument must be of type Function');if(A&&t[A]){var i;if("function"!=typeof(i=t[A]))throw TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(i,A,{value:i,enumerable:!1,writable:!1,configurable:!0}),i}function i(){for(var e,i,r=new Promise(function(t,r){e=t,i=r}),n=[],o=0;o<arguments.length;o++)n.push(arguments[o]);n.push(function(t,r){t?i(t):e(r)});try{t.apply(this,n)}catch(t){i(t)}return r}return Object.setPrototypeOf(i,Object.getPrototypeOf(t)),A&&Object.defineProperty(i,A,{value:i,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(i,e(t))},t.promisify.custom=A,t.callbackify=function(t){if("function"!=typeof t)throw TypeError('The "original" argument must be of type Function');function i(){for(var e=[],i=0;i<arguments.length;i++)e.push(arguments[i]);var r=e.pop();if("function"!=typeof r)throw TypeError("The last argument must be of type Function");var n=this,o=function(){return r.apply(n,arguments)};t.apply(this,e).then(function(t){eG(o.bind(null,null,t))},function(t){eG(x.bind(null,t,o))})}return Object.setPrototypeOf(i,Object.getPrototypeOf(t)),Object.defineProperties(i,e(t)),i}}(rv);var rb,rE,rI={};function r_(t,e,i){i||(i=Error);var r=function(i){function r(i,n,o){var s,a;return function(t,e){if(!(t instanceof e))throw TypeError("Cannot call a class as a function")}(this,r),(s=(a=rw(r).call(this,"string"==typeof e?e:e(i,n,o)))&&("object"===rm(a)||"function"==typeof a)?a:function(t){if(void 0===t)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(this)).code=t,s}return function(t,e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&rS(t,e)}(r,i),r}(i);rI[t]=r}function rD(t,e){if(Array.isArray(t)){var i=t.length;return t=t.map(function(t){return String(t)}),i>2?"one of ".concat(e," ").concat(t.slice(0,i-1).join(", "),", or ")+t[i-1]:2===i?"one of ".concat(e," ").concat(t[0]," or ").concat(t[1]):"of ".concat(e," ").concat(t[0])}return"of ".concat(e," ").concat(String(t))}function rT(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function rA(t,e){return e&&("object"===rN(e)||"function"==typeof e)?e:rx(t)}function rx(t){if(void 0===t)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function rO(t){var e="function"==typeof Map?new Map:void 0;return(rO=function(t){if(null===t||-1===Function.toString.call(t).indexOf("[native code]"))return t;if("function"!=typeof t)throw TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return rP(t,arguments,rk(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),rR(i,t)})(t)}function rP(t,e,i){return(rP=!function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?function(t,e,i){var r=[null];r.push.apply(r,e);var n=new(Function.bind.apply(t,r));return i&&rR(n,i.prototype),n}:Reflect.construct).apply(null,arguments)}function rR(t,e){return(rR=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function rk(t){return(rk=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function rN(t){return(rN="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}r_("ERR_AMBIGUOUS_ARGUMENT",'The "%s" argument is ambiguous. %s',TypeError),r_("ERR_INVALID_ARG_TYPE",function(t,e,i){if(void 0===rb&&(rb=null),rb("string"==typeof t,"'name' must be a string"),"string"==typeof e&&(n="not ",e.substr(!o||o<0?0:+o,n.length)===n)?(r="must not be",e=e.replace(/^not /,"")):r="must be",a=" argument",(void 0===l||l>t.length)&&(l=t.length),t.substring(l-a.length,l)===a)s="The ".concat(t," ").concat(r," ").concat(rD(e,"type"));else{var r,n,o,s,a,l,u,c=("number"!=typeof u&&(u=0),u+1>t.length||-1===t.indexOf(".",u))?"argument":"property";s='The "'.concat(t,'" ').concat(c," ").concat(r," ").concat(rD(e,"type"))}return s+". Received type ".concat(rm(i))},TypeError),r_("ERR_INVALID_ARG_VALUE",function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"is invalid";void 0===rE&&(rE=rv);var r=rE.inspect(e);return r.length>128&&(r="".concat(r.slice(0,128),"...")),"The argument '".concat(t,"' ").concat(i,". Received ").concat(r)},TypeError),r_("ERR_INVALID_RETURN_VALUE",function(t,e,i){var r;return r=i&&i.constructor&&i.constructor.name?"instance of ".concat(i.constructor.name):"type ".concat(rm(i)),"Expected ".concat(t,' to be returned from the "').concat(e,'"')+" function but got ".concat(r,".")},TypeError),r_("ERR_MISSING_ARGS",function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];void 0===rb&&(rb=null),rb(e.length>0,"At least one arg needs to be specified");var r="The ",n=e.length;switch(e=e.map(function(t){return'"'.concat(t,'"')}),n){case 1:r+="".concat(e[0]," argument");break;case 2:r+="".concat(e[0]," and ").concat(e[1]," arguments");break;default:r+=e.slice(0,n-1).join(", ")+", and ".concat(e[n-1]," arguments")}return"".concat(r," must be specified")},TypeError),e2.codes=rI;var rC=rv.inspect,rF=e2.codes.ERR_INVALID_ARG_TYPE;function rL(t,e,i){return(void 0===i||i>t.length)&&(i=t.length),t.substring(i-e.length,i)===e}var rM={deepStrictEqual:"Expected values to be strictly deep-equal:",strictEqual:"Expected values to be strictly equal:",strictEqualObject:'Expected "actual" to be reference-equal to "expected":',deepEqual:"Expected values to be loosely deep-equal:",equal:"Expected values to be loosely equal:",notDeepStrictEqual:'Expected "actual" not to be strictly deep-equal to:',notStrictEqual:'Expected "actual" to be strictly unequal to:',notStrictEqualObject:'Expected "actual" not to be reference-equal to "expected":',notDeepEqual:'Expected "actual" not to be loosely deep-equal to:',notEqual:'Expected "actual" to be loosely unequal to:',notIdentical:"Values identical but not reference-equal:"};function rj(t){var e=Object.keys(t),i=Object.create(Object.getPrototypeOf(t));return e.forEach(function(e){i[e]=t[e]}),Object.defineProperty(i,"message",{value:t.message}),i}function rK(t){return rC(t,{compact:!1,customInspect:!1,depth:1e3,maxArrayLength:1/0,showHidden:!1,breakLength:1/0,showProxy:!1,sorted:!0,getters:!0})}var rU,rB=function(t){var e,i;function r(t){if(function(t,e){if(!(t instanceof e))throw TypeError("Cannot call a class as a function")}(this,r),"object"!==rN(t)||null===t)throw new rF("options","Object",t);var e,i=t.message,n=t.operator,o=t.stackStartFn,s=t.actual,a=t.expected,l=Error.stackTraceLimit;if(Error.stackTraceLimit=0,null!=i)e=rA(this,rk(r).call(this,String(i)));else if("object"===rN(s)&&null!==s&&"object"===rN(a)&&null!==a&&"stack"in s&&s instanceof Error&&"stack"in a&&a instanceof Error&&(s=rj(s),a=rj(a)),"deepStrictEqual"===n||"strictEqual"===n)e=rA(this,rk(r).call(this,function(t,e,i){var r="",n="",o=0,s="",a=!1,l=rK(t),u=l.split("\n"),c=rK(e).split("\n"),h=0,d="";if("strictEqual"===i&&"object"===rN(t)&&"object"===rN(e)&&null!==t&&null!==e&&(i="strictEqualObject"),1===u.length&&1===c.length&&u[0]!==c[0]){var f=u[0].length+c[0].length;if(f<=10){if(!("object"===rN(t)&&null!==t||"object"===rN(e)&&null!==e||0===t&&0===e))return"".concat(rM[i],"\n\n")+"".concat(u[0]," !== ").concat(c[0],"\n")}else if("strictEqualObject"!==i&&f<80){for(;u[0][h]===c[0][h];)h++;h>2&&(d="\n  ".concat(function(t,e){if(e=Math.floor(e),0==t.length||0==e)return"";var i=t.length*e;for(e=Math.floor(Math.log(e)/Math.log(2));e;)t+=t,e--;return t+t.substring(0,i-t.length)}(" ",h),"^"),h=0)}}for(var p=u[u.length-1],y=c[c.length-1];p===y&&(h++<2?s="\n  ".concat(p).concat(s):r=p,u.pop(),c.pop(),0!==u.length&&0!==c.length);)p=u[u.length-1],y=c[c.length-1];var g=Math.max(u.length,c.length);if(0===g){var v=l.split("\n");if(v.length>30)for(v[26]="".concat("","...").concat("");v.length>27;)v.pop();return"".concat(rM.notIdentical,"\n\n").concat(v.join("\n"),"\n")}h>3&&(s="\n".concat("","...").concat("").concat(s),a=!0),""!==r&&(s="\n  ".concat(r).concat(s),r="");var m=0,w=rM[i]+"\n".concat("","+ actual").concat(""," ").concat("","- expected").concat(""),S=" ".concat("","...").concat(""," Lines skipped");for(h=0;h<g;h++){var b=h-o;if(u.length<h+1)b>1&&h>2&&(b>4?(n+="\n".concat("","...").concat(""),a=!0):b>3&&(n+="\n  ".concat(c[h-2]),m++),n+="\n  ".concat(c[h-1]),m++),o=h,r+="\n".concat("","-").concat(""," ").concat(c[h]),m++;else if(c.length<h+1)b>1&&h>2&&(b>4?(n+="\n".concat("","...").concat(""),a=!0):b>3&&(n+="\n  ".concat(u[h-2]),m++),n+="\n  ".concat(u[h-1]),m++),o=h,n+="\n".concat("","+").concat(""," ").concat(u[h]),m++;else{var E=c[h],I=u[h],_=I!==E&&(!rL(I,",")||I.slice(0,-1)!==E);_&&rL(E,",")&&E.slice(0,-1)===I&&(_=!1,I+=","),_?(b>1&&h>2&&(b>4?(n+="\n".concat("","...").concat(""),a=!0):b>3&&(n+="\n  ".concat(u[h-2]),m++),n+="\n  ".concat(u[h-1]),m++),o=h,n+="\n".concat("","+").concat(""," ").concat(I),r+="\n".concat("","-").concat(""," ").concat(E),m+=2):(n+=r,r="",1!==b&&0!==h||(n+="\n  ".concat(I),m++))}if(m>20&&h<g-2)return"".concat(w).concat(S,"\n").concat(n,"\n").concat("","...").concat("").concat(r,"\n")+"".concat("","...").concat("")}return"".concat(w).concat(a?S:"","\n").concat(n).concat(r).concat(s).concat(d)}(s,a,n)));else if("notDeepStrictEqual"===n||"notStrictEqual"===n){var u=rM[n],c=rK(s).split("\n");if("notStrictEqual"===n&&"object"===rN(s)&&null!==s&&(u=rM.notStrictEqualObject),c.length>30)for(c[26]="".concat("","...").concat("");c.length>27;)c.pop();e=1===c.length?rA(this,rk(r).call(this,"".concat(u," ").concat(c[0]))):rA(this,rk(r).call(this,"".concat(u,"\n\n").concat(c.join("\n"),"\n")))}else{var h=rK(s),d="",f=rM[n];"notDeepEqual"===n||"notEqual"===n?(h="".concat(rM[n],"\n\n").concat(h)).length>1024&&(h="".concat(h.slice(0,1021),"...")):(d="".concat(rK(a)),h.length>512&&(h="".concat(h.slice(0,509),"...")),d.length>512&&(d="".concat(d.slice(0,509),"...")),"deepEqual"===n||"equal"===n?h="".concat(f,"\n\n").concat(h,"\n\nshould equal\n\n"):d=" ".concat(n," ").concat(d)),e=rA(this,rk(r).call(this,"".concat(h).concat(d)))}return Error.stackTraceLimit=l,e.generatedMessage=!i,Object.defineProperty(rx(e),"name",{value:"AssertionError [ERR_ASSERTION]",enumerable:!1,writable:!0,configurable:!0}),e.code="ERR_ASSERTION",e.actual=s,e.expected=a,e.operator=n,Error.captureStackTrace&&Error.captureStackTrace(rx(e),o),e.name="AssertionError",rA(e)}return function(t,e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&rR(t,e)}(r,rO(Error)),e=[{key:"toString",value:function(){return"".concat(this.name," [").concat(this.code,"]: ").concat(this.message)}},{key:rC.custom,value:function(t,e){return rC(this,function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),r.forEach(function(e){var r;r=i[e],e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r})}return t}({},e,{customInspect:!1,depth:0}))}}],rT(r.prototype,e),i&&rT(r,i),r}(),rz=Object.prototype.toString,rV=function(t){var e=rz.call(t),i="[object Arguments]"===e;return i||(i="[object Array]"!==e&&null!==t&&"object"==typeof t&&"number"==typeof t.length&&t.length>=0&&"[object Function]"===rz.call(t.callee)),i};if(!Object.keys){var rq=Object.prototype.hasOwnProperty,rW=Object.prototype.toString,rY=Object.prototype.propertyIsEnumerable,rH=!rY.call({toString:null},"toString"),rJ=rY.call(function(){},"prototype"),rX=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],rG=function(t){var e=t.constructor;return e&&e.prototype===t},rZ={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},rQ=function(){if("undefined"==typeof window)return!1;for(var t in window)try{if(!rZ["$"+t]&&rq.call(window,t)&&null!==window[t]&&"object"==typeof window[t])try{rG(window[t])}catch(t){return!0}}catch(t){return!0}return!1}();rU=function(t){var e=null!==t&&"object"==typeof t,i="[object Function]"===rW.call(t),r=rV(t),n=e&&"[object String]"===rW.call(t),o=[];if(!e&&!i&&!r)throw TypeError("Object.keys called on a non-object");var s=rJ&&i;if(n&&t.length>0&&!rq.call(t,0))for(var a=0;a<t.length;++a)o.push(String(a));if(r&&t.length>0)for(var l=0;l<t.length;++l)o.push(String(l));else for(var u in t)s&&"prototype"===u||!rq.call(t,u)||o.push(String(u));if(rH)for(var c=function(t){if("undefined"==typeof window||!rQ)return rG(t);try{return rG(t)}catch(t){return!1}}(t),h=0;h<rX.length;++h)c&&"constructor"===rX[h]||!rq.call(t,rX[h])||o.push(rX[h]);return o}}var r$=rU,r0=Array.prototype.slice,r1=Object.keys,r2=r1?function(t){return r1(t)}:r$,r5=Object.keys;r2.shim=function(){return Object.keys?function(){var t=Object.keys(arguments);return t&&t.length===arguments.length}(1,2)||(Object.keys=function(t){return rV(t)?r5(r0.call(t)):r5(t)}):Object.keys=r2,Object.keys||r2};var r3=iP("%Object.defineProperty%",!0),r6=function(){if(r3)try{return r3({},"a",{value:1}),!0}catch(t){}return!1};r6.hasArrayLengthDefineBug=function(){if(!r6())return null;try{return 1!==r3([],"length",{value:1}).length}catch(t){return!0}};var r8=r6()&&iP("%Object.defineProperty%",!0),r4=iP("%SyntaxError%"),r7=iP("%TypeError%"),r9="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),nt=Object.prototype.toString,ne=Array.prototype.concat,ni=function(t,e,i){if(!t||"object"!=typeof t&&"function"!=typeof t)throw new r7("`obj` must be an object or a function`");if("string"!=typeof e&&"symbol"!=typeof e)throw new r7("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new r7("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new r7("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new r7("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new r7("`loose`, if provided, must be a boolean");var r=arguments.length>3?arguments[3]:null,n=arguments.length>4?arguments[4]:null,o=arguments.length>5?arguments[5]:null,s=arguments.length>6&&arguments[6],a=!!ri&&ri(t,e);if(r8)r8(t,e,{configurable:null===o&&a?a.configurable:!o,enumerable:null===r&&a?a.enumerable:!r,value:i,writable:null===n&&a?a.writable:!n});else{if(!s&&(r||n||o))throw new r4("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");t[e]=i}},nr=r6(),nn=function(t,e,i,r){if(e in t){if(!0===r){if(t[e]===i)return}else if("function"!=typeof r||"[object Function]"!==nt.call(r)||!r())return}nr?ni(t,e,i,!0):ni(t,e,i)},no=function(t,e){var i=arguments.length>2?arguments[2]:{},r=r2(e);r9&&(r=ne.call(r,Object.getOwnPropertySymbols(e)));for(var n=0;n<r.length;n+=1)nn(t,r[n],e[r[n]],i[r[n]])};no.supportsDescriptors=!!nr;var ns=function(t){return t!=t},na=function(t,e){return 0===t&&0===e?1/t==1/e:t===e||!(!ns(t)||!ns(e))},nl=function(){return"function"==typeof Object.is?Object.is:na},nu=(0,iR.exports)(nl(),Object);no(nu,{getPolyfill:nl,implementation:na,shim:function(){var t=nl();return no(Object,{is:t},{is:function(){return Object.is!==t}}),t}});var nc=function(t){return t!=t},nh=function(){return Number.isNaN&&Number.isNaN(NaN)&&!Number.isNaN("a")?Number.isNaN:nc},nd=(0,iR.exports)(nh(),Number);function nf(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=[],r=!0,n=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done)&&(i.push(s.value),!e||i.length!==e);r=!0);}catch(t){n=!0,o=t}finally{try{r||null==a.return||a.return()}finally{if(n)throw o}}return i}(t,e)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance")}()}function np(t){return(np="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}no(nd,{getPolyfill:nh,implementation:nc,shim:function(){var t=nh();return no(Number,{isNaN:t},{isNaN:function(){return Number.isNaN!==t}}),t}});var ny=void 0!==/a/g.flags,ng=function(t){var e=[];return t.forEach(function(t){return e.push(t)}),e},nv=function(t){var e=[];return t.forEach(function(t,i){return e.push([i,t])}),e},nm=Object.is?Object.is:nu,nw=Object.getOwnPropertySymbols?Object.getOwnPropertySymbols:function(){return[]},nS=Number.isNaN?Number.isNaN:nd;function nb(t){return t.call.bind(t)}var nE=nb(Object.prototype.hasOwnProperty),nI=nb(Object.prototype.propertyIsEnumerable),n_=nb(Object.prototype.toString),nD=rv.types,nT=nD.isAnyArrayBuffer,nA=nD.isArrayBufferView,nx=nD.isDate,nO=nD.isMap,nP=nD.isRegExp,nR=nD.isSet,nk=nD.isNativeError,nN=nD.isBoxedPrimitive,nC=nD.isNumberObject,nF=nD.isStringObject,nL=nD.isBooleanObject,nM=nD.isBigIntObject,nj=nD.isSymbolObject,nK=nD.isFloat32Array,nU=nD.isFloat64Array;function nB(t){if(0===t.length||t.length>10)return!0;for(var e=0;e<t.length;e++){var i=t.charCodeAt(e);if(i<48||i>57)return!0}return 10===t.length&&t>=4294967296}function nz(t){return Object.keys(t).filter(nB).concat(nw(t).filter(Object.prototype.propertyIsEnumerable.bind(t)))}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */function nV(t,e){if(t===e)return 0;for(var i=t.length,r=e.length,n=0,o=Math.min(i,r);n<o;++n)if(t[n]!==e[n]){i=t[n],r=e[n];break}return i<r?-1:r<i?1:0}function nq(t,e,i,r){if(t===e)return 0!==t||!i||nm(t,e);if(i){if("object"!==np(t))return"number"==typeof t&&nS(t)&&nS(e);if("object"!==np(e)||null===t||null===e||Object.getPrototypeOf(t)!==Object.getPrototypeOf(e))return!1}else{if(null===t||"object"!==np(t))return(null===e||"object"!==np(e))&&t==e;if(null===e||"object"!==np(e))return!1}var n=n_(t);if(n!==n_(e))return!1;if(Array.isArray(t)){if(t.length!==e.length)return!1;var o=nz(t),s=nz(e);return o.length===s.length&&nY(t,e,i,r,1,o)}if("[object Object]"===n&&(!nO(t)&&nO(e)||!nR(t)&&nR(e)))return!1;if(nx(t)){if(!nx(e)||Date.prototype.getTime.call(t)!==Date.prototype.getTime.call(e))return!1}else if(nP(t)){if(!nP(e)||!(ny?t.source===e.source&&t.flags===e.flags:RegExp.prototype.toString.call(t)===RegExp.prototype.toString.call(e)))return!1}else if(nk(t)||t instanceof Error){if(t.message!==e.message||t.name!==e.name)return!1}else{if(nA(t)){if(!i&&(nK(t)||nU(t))){if(!function(t,e){if(t.byteLength!==e.byteLength)return!1;for(var i=0;i<t.byteLength;i++)if(t[i]!==e[i])return!1;return!0}(t,e))return!1}else if(t.byteLength!==e.byteLength||0!==nV(new Uint8Array(t.buffer,t.byteOffset,t.byteLength),new Uint8Array(e.buffer,e.byteOffset,e.byteLength)))return!1;var a=nz(t),l=nz(e);return a.length===l.length&&nY(t,e,i,r,0,a)}if(nR(t))return!(!nR(e)||t.size!==e.size)&&nY(t,e,i,r,2);if(nO(t))return!(!nO(e)||t.size!==e.size)&&nY(t,e,i,r,3);if(nT(t)){if(t.byteLength!==e.byteLength||0!==nV(new Uint8Array(t),new Uint8Array(e)))return!1}else if(nN(t)&&(nC(t)?!(nC(e)&&nm(Number.prototype.valueOf.call(t),Number.prototype.valueOf.call(e))):nF(t)?!nF(e)||String.prototype.valueOf.call(t)!==String.prototype.valueOf.call(e):nL(t)?!nL(e)||Boolean.prototype.valueOf.call(t)!==Boolean.prototype.valueOf.call(e):nM(t)?!nM(e)||BigInt.prototype.valueOf.call(t)!==BigInt.prototype.valueOf.call(e):!nj(e)||Symbol.prototype.valueOf.call(t)!==Symbol.prototype.valueOf.call(e)))return!1}return nY(t,e,i,r,0)}function nW(t,e){return e.filter(function(e){return nI(t,e)})}function nY(t,e,i,r,n,o){if(5==arguments.length){o=Object.keys(t);var s=Object.keys(e);if(o.length!==s.length)return!1}for(var a=0;a<o.length;a++)if(!nE(e,o[a]))return!1;if(i&&5==arguments.length){var l=nw(t);if(0!==l.length){var u=0;for(a=0;a<l.length;a++){var c=l[a];if(nI(t,c)){if(!nI(e,c))return!1;o.push(c),u++}else if(nI(e,c))return!1}var h=nw(e);if(l.length!==h.length&&nW(e,h).length!==u)return!1}else{var d=nw(e);if(0!==d.length&&0!==nW(e,d).length)return!1}}if(0===o.length&&(0===n||1===n&&0===t.length||0===t.size))return!0;if(void 0===r)r={val1:new Map,val2:new Map,position:0};else{var f=r.val1.get(t);if(void 0!==f){var p=r.val2.get(e);if(void 0!==p)return f===p}r.position++}r.val1.set(t,r.position),r.val2.set(e,r.position);var y=function(t,e,i,r,n,o){var s=0;if(2===o){if(!function(t,e,i,r){for(var n=null,o=ng(t),s=0;s<o.length;s++){var a=o[s];if("object"===np(a)&&null!==a)null===n&&(n=new Set),n.add(a);else if(!e.has(a)){if(i||!function(t,e,i){var r=nJ(i);return null!=r?r:e.has(r)&&!t.has(r)}(t,e,a))return!1;null===n&&(n=new Set),n.add(a)}}if(null!==n){for(var l=ng(e),u=0;u<l.length;u++){var c=l[u];if("object"===np(c)&&null!==c){if(!nH(n,c,i,r))return!1}else if(!i&&!t.has(c)&&!nH(n,c,i,r))return!1}return 0===n.size}return!0}(t,e,i,n))return!1}else if(3===o){if(!function(t,e,i,r){for(var n=null,o=nv(t),s=0;s<o.length;s++){var a=nf(o[s],2),l=a[0],u=a[1];if("object"===np(l)&&null!==l)null===n&&(n=new Set),n.add(l);else{var c=e.get(l);if(void 0===c&&!e.has(l)||!nq(u,c,i,r)){if(i||!function(t,e,i,r,n){var o=nJ(i);if(null!=o)return o;var s=e.get(o);return!(void 0===s&&!e.has(o)||!nq(r,s,!1,n))&&!t.has(o)&&nq(r,s,!1,n)}(t,e,l,u,r))return!1;null===n&&(n=new Set),n.add(l)}}}if(null!==n){for(var h=nv(e),d=0;d<h.length;d++){var f=nf(h[d],2),p=(l=f[0],f[1]);if("object"===np(l)&&null!==l){if(!nX(n,t,l,p,i,r))return!1}else if(!(i||t.has(l)&&nq(t.get(l),p,!1,r)||nX(n,t,l,p,!1,r)))return!1}return 0===n.size}return!0}(t,e,i,n))return!1}else if(1===o)for(;s<t.length;s++){if(!nE(t,s)){if(nE(e,s))return!1;for(var a=Object.keys(t);s<a.length;s++){var l=a[s];if(!nE(e,l)||!nq(t[l],e[l],i,n))return!1}return a.length===Object.keys(e).length}if(!nE(e,s)||!nq(t[s],e[s],i,n))return!1}for(s=0;s<r.length;s++){var u=r[s];if(!nq(t[u],e[u],i,n))return!1}return!0}(t,e,i,o,r,n);return r.val1.delete(t),r.val2.delete(e),y}function nH(t,e,i,r){for(var n=ng(t),o=0;o<n.length;o++){var s=n[o];if(nq(e,s,i,r))return t.delete(s),!0}return!1}function nJ(t){switch(np(t)){case"undefined":return null;case"object":return;case"symbol":return!1;case"string":t=+t;case"number":if(nS(t))return!1}return!0}function nX(t,e,i,r,n,o){for(var s=ng(t),a=0;a<s.length;a++){var l=s[a];if(nq(i,l,n,o)&&nq(r,e.get(l),n,o))return t.delete(l),!0}return!1}var nG={isDeepEqual:function(t,e){return nq(t,e,!1)},isDeepStrictEqual:function(t,e){return nq(t,e,!0)}};function nZ(t){return(nZ="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var nQ,n$,n0=e2.codes,n1=n0.ERR_AMBIGUOUS_ARGUMENT,n2=n0.ERR_INVALID_ARG_TYPE,n5=n0.ERR_INVALID_ARG_VALUE,n3=n0.ERR_INVALID_RETURN_VALUE,n6=n0.ERR_MISSING_ARGS,n8=rv.inspect,n4=rv.types,n7=n4.isPromise,n9=n4.isRegExp,ot=Object.assign?Object.assign:function(t,e){if(null==t)throw TypeError("Cannot convert first argument to object");for(var i=Object(t),r=1;r<arguments.length;r++){var n=arguments[r];if(null!=n)for(var o=Object.keys(Object(n)),s=0,a=o.length;s<a;s++){var l=o[s],u=Object.getOwnPropertyDescriptor(n,l);void 0!==u&&u.enumerable&&(i[l]=n[l])}}return i},oe=Object.is?Object.is:nu;function oi(){nQ=nG.isDeepEqual,n$=nG.isDeepStrictEqual}var or=!1,on=e1.exports=ol,oo={};function os(t){if(t.message instanceof Error)throw t.message;throw new rB(t)}function oa(t,e,i,r){if(!i){var n=!1;if(0===e)n=!0,r="No value argument passed to `assert.ok()`";else if(r instanceof Error)throw r;var o=new rB({actual:i,expected:!0,message:r,operator:"==",stackStartFn:t});throw o.generatedMessage=n,o}}function ol(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];oa.apply(void 0,[ol,e.length].concat(e))}on.fail=function t(e,i,r,n,o){var s,a=arguments.length;if(0===a?s="Failed":1===a?(r=e,e=void 0):(!1===or&&(or=!0,console.warn.bind(console)("assert.fail() with more than one argument is deprecated. Please use assert.strictEqual() instead or only pass a message.","DeprecationWarning","DEP0094")),2===a&&(n="!=")),r instanceof Error)throw r;var l={actual:e,expected:i,operator:void 0===n?"fail":n,stackStartFn:o||t};void 0!==r&&(l.message=r);var u=new rB(l);throw s&&(u.message=s,u.generatedMessage=!0),u},on.AssertionError=rB,on.ok=ol,on.equal=function t(e,i,r){if(arguments.length<2)throw new n6("actual","expected");e!=i&&os({actual:e,expected:i,message:r,operator:"==",stackStartFn:t})},on.notEqual=function t(e,i,r){if(arguments.length<2)throw new n6("actual","expected");e==i&&os({actual:e,expected:i,message:r,operator:"!=",stackStartFn:t})},on.deepEqual=function t(e,i,r){if(arguments.length<2)throw new n6("actual","expected");void 0===nQ&&oi(),nQ(e,i)||os({actual:e,expected:i,message:r,operator:"deepEqual",stackStartFn:t})},on.notDeepEqual=function t(e,i,r){if(arguments.length<2)throw new n6("actual","expected");void 0===nQ&&oi(),nQ(e,i)&&os({actual:e,expected:i,message:r,operator:"notDeepEqual",stackStartFn:t})},on.deepStrictEqual=function t(e,i,r){if(arguments.length<2)throw new n6("actual","expected");void 0===nQ&&oi(),n$(e,i)||os({actual:e,expected:i,message:r,operator:"deepStrictEqual",stackStartFn:t})},on.notDeepStrictEqual=function t(e,i,r){if(arguments.length<2)throw new n6("actual","expected");void 0===nQ&&oi(),n$(e,i)&&os({actual:e,expected:i,message:r,operator:"notDeepStrictEqual",stackStartFn:t})},on.strictEqual=function t(e,i,r){if(arguments.length<2)throw new n6("actual","expected");oe(e,i)||os({actual:e,expected:i,message:r,operator:"strictEqual",stackStartFn:t})},on.notStrictEqual=function t(e,i,r){if(arguments.length<2)throw new n6("actual","expected");oe(e,i)&&os({actual:e,expected:i,message:r,operator:"notStrictEqual",stackStartFn:t})};var ou=function t(e,i,r){var n=this;!function(t,e){if(!(t instanceof e))throw TypeError("Cannot call a class as a function")}(this,t),i.forEach(function(t){t in e&&(void 0!==r&&"string"==typeof r[t]&&n9(e[t])&&e[t].test(r[t])?n[t]=r[t]:n[t]=e[t])})};function oc(t,e,i,r){if("function"!=typeof e){if(n9(e))return e.test(t);if(2==arguments.length)throw new n2("expected",["Function","RegExp"],e);if("object"!==nZ(t)||null===t){var n=new rB({actual:t,expected:e,message:i,operator:"deepStrictEqual",stackStartFn:r});throw n.operator=r.name,n}var o=Object.keys(e);if(e instanceof Error)o.push("name","message");else if(0===o.length)throw new n5("error",e,"may not be an empty object");return void 0===nQ&&oi(),o.forEach(function(n){"string"==typeof t[n]&&n9(e[n])&&e[n].test(t[n])||function(t,e,i,r,n,o){if(!(i in t)||!n$(t[i],e[i])){if(!r){var s=new ou(t,n),a=new ou(e,n,t),l=new rB({actual:s,expected:a,operator:"deepStrictEqual",stackStartFn:o});throw l.actual=t,l.expected=e,l.operator=o.name,l}os({actual:t,expected:e,message:r,operator:o.name,stackStartFn:o})}}(t,e,n,i,o,r)}),!0}return void 0!==e.prototype&&t instanceof e||!Error.isPrototypeOf(e)&&!0===e.call({},t)}function oh(t){if("function"!=typeof t)throw new n2("fn","Function",t);try{t()}catch(t){return t}return oo}function od(t){return n7(t)||null!==t&&"object"===nZ(t)&&"function"==typeof t.then&&"function"==typeof t.catch}function of(t){return Promise.resolve().then(function(){var e;if("function"==typeof t){if(!od(e=t()))throw new n3("instance of Promise","promiseFn",e)}else{if(!od(t))throw new n2("promiseFn",["Function","Promise"],t);e=t}return Promise.resolve().then(function(){return e}).then(function(){return oo}).catch(function(t){return t})})}function op(t,e,i,r){if("string"==typeof i){if(4==arguments.length)throw new n2("error",["Object","Error","Function","RegExp"],i);if("object"===nZ(e)&&null!==e){if(e.message===i)throw new n1("error/message",'The error message "'.concat(e.message,'" is identical to the message.'))}else if(e===i)throw new n1("error/message",'The error "'.concat(e,'" is identical to the message.'));r=i,i=void 0}else if(null!=i&&"object"!==nZ(i)&&"function"!=typeof i)throw new n2("error",["Object","Error","Function","RegExp"],i);if(e===oo){var n="";i&&i.name&&(n+=" (".concat(i.name,")")),n+=r?": ".concat(r):".";var o="rejects"===t.name?"rejection":"exception";os({actual:void 0,expected:i,operator:t.name,message:"Missing expected ".concat(o).concat(n),stackStartFn:t})}if(i&&!oc(e,i,r,t))throw e}function oy(t,e,i,r){if(e!==oo){if("string"==typeof i&&(r=i,i=void 0),!i||oc(e,i)){var n=r?": ".concat(r):".",o="doesNotReject"===t.name?"rejection":"exception";os({actual:e,expected:i,operator:t.name,message:"Got unwanted ".concat(o).concat(n,"\n")+'Actual message: "'.concat(e&&e.message,'"'),stackStartFn:t})}throw e}}on.throws=function t(e){for(var i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];op.apply(void 0,[t,oh(e)].concat(r))},on.rejects=function t(e){for(var i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];return of(e).then(function(e){return op.apply(void 0,[t,e].concat(r))})},on.doesNotThrow=function t(e){for(var i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];oy.apply(void 0,[t,oh(e)].concat(r))},on.doesNotReject=function t(e){for(var i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];return of(e).then(function(e){return oy.apply(void 0,[t,e].concat(r))})},on.ifError=function t(e){if(null!=e){var i="ifError got unwanted exception: ";"object"===nZ(e)&&"string"==typeof e.message?0===e.message.length&&e.constructor?i+=e.constructor.name:i+=e.message:i+=n8(e);var r=new rB({actual:e,expected:null,operator:"ifError",message:i,stackStartFn:t}),n=e.stack;if("string"==typeof n){var o=n.split("\n");o.shift();for(var s=r.stack.split("\n"),a=0;a<o.length;a++){var l=s.indexOf(o[a]);if(-1!==l){s=s.slice(0,l);break}}r.stack="".concat(s.join("\n"),"\n").concat(o.join("\n"))}throw r}},on.strict=ot(function t(){for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];oa.apply(void 0,[t,i.length].concat(i))},on,{equal:on.strictEqual,deepEqual:on.deepStrictEqual,notEqual:on.notStrictEqual,notDeepEqual:on.notDeepStrictEqual}),on.strict.strict=on.strict;var og="the public key could not be parsed or is invalid",ov="nonce generation function failed or private key is invalid";let om=new u.ec("p256"),ow=om.curve;function oS(t){return om.keyFromPublic(t)}let ob=o.Buffer.from("Bitcoin seed","utf8"),oE={private:76066276,public:76067358};class oI{constructor(t){this.versions=t||oE,this.depth=0,this.index=0,this._privateKey=null,this._publicKey=null,this.chainCode=null,this._fingerprint=0,this.parentFingerprint=0}static fromMasterSeed(t,e){let i=s.createHmac("sha512",ob).update(t).digest(),r=i.slice(0,32),n=i.slice(32),o=new oI(e);return o.chainCode=n,o.privateKey=r,o}static fromExtendedKey(t,e){let i=new oI(e=e||oE),r=a.decode(t),n=r.readUInt32BE(0);e1.exports.ok(n===e.private||n===e.public,"Version mismatch: does not match private or public"),i.depth=r.readUInt8(4),i.parentFingerprint=r.readUInt32BE(5),i.index=r.readUInt32BE(9),i.chainCode=r.slice(13,45);let o=r.slice(45);return 0===o.readUInt8(0)?(e1.exports.ok(n===e.private,"Version mismatch: version does not match private"),i.privateKey=o.slice(1,33)):(e1.exports.ok(n===e.public,"Version mismatch: version does not match public"),i.publicKey=o.slice(0,33)),i}static fromJSON(t){return oI.fromExtendedKey(t.xpriv)}get fingerprint(){return this._fingerprint}get identifier(){return this._identifier}get pubKeyHash(){return this.identifier}get privateKey(){return this._privateKey}set privateKey(t){if(null===t)throw Error("Can not directly set privateKey to null.");e1.exports.equal(t.length,32,"Private key must be 32 bytes."),e1.exports.ok(!0===function(t){let e=new l(t);return 0>e.cmp(ow.n)&&!e.isZero()}(t),"Invalid private key"),this._privateKey=t,this._publicKey=function(t,e){let i=new l(t);if(i.cmp(ow.n)>=0||i.isZero())throw Error("private was invalid, try again");return o.Buffer.from(om.keyFromPrivate(t).getPublic(e,"true"))}(t,!0),this._identifier=oD(this.publicKey),this._fingerprint=this._identifier.slice(0,4).readUInt32BE(0)}get publicKey(){return this._publicKey}set publicKey(t){if(null===t)throw Error("Can not directly set privateKey to null.");e1.exports.ok(33===t.length||65===t.length,"Public key must be 33 or 65 bytes."),e1.exports.ok(!0==(null!==oS(t)),"Invalid public key"),this._publicKey=function(t,e){let i=oS(t);if(null===i)throw Error(og);return o.Buffer.from(i.getPublic(e,"true"))}(t,!0),this._identifier=oD(this.publicKey),this._fingerprint=this._identifier.slice(0,4).readUInt32BE(0),this._privateKey=null}get privateExtendedKey(){return this._privateKey?a.encode(o_(this,this.versions.private,o.Buffer.concat([o.Buffer.alloc(1,0),this.privateKey]))):null}get publicExtendedKey(){return a.encode(o_(this,this.versions.public,this.publicKey))}derive(t){if("m"===t||"M"===t||"m'"===t||"M'"===t)return this;let e=t.split("/"),i=this;return e.forEach(function(t,e){if(0===e)return void e1.exports.ok(/^[mM]{1}/.test(t),'Path must start with "m" or "M"');let r=t.length>1&&"'"===t[t.length-1],n=parseInt(t,10);e1.exports.ok(n<oI.HARDENED_OFFSET,"Invalid index"),r&&(n+=oI.HARDENED_OFFSET),i=i.deriveChild(n)}),i}deriveChild(t){let e;let i=t>=oI.HARDENED_OFFSET,r=o.Buffer.allocUnsafe(4);if(r.writeUInt32BE(t,0),i){e1.exports.ok(this.privateKey,"Could not derive hardened child key");let t=this.privateKey,i=o.Buffer.alloc(1,0);t=o.Buffer.concat([i,t]),e=o.Buffer.concat([t,r])}else e=o.Buffer.concat([this.publicKey,r]);let n=s.createHmac("sha512",this.chainCode).update(e).digest(),a=n.slice(0,32),u=n.slice(32),c=new oI(this.versions);if(this.privateKey)try{c.privateKey=function(t,e){let i=new l(e);if(i.cmp(ow.n)>=0||(i.iadd(new l(t)),i.cmp(ow.n)>=0&&i.isub(ow.n),i.isZero()))throw Error("tweak out of range or resulting private key is invalid");return i.toArrayLike(o.Buffer,"be",32)}(this.privateKey,a)}catch(e){return this.deriveChild(t+1)}else try{c.publicKey=function(t,e,i){let r=oS(t);if(null===r)throw Error(og);if((e=new l(e)).cmp(ow.n)>=0)throw Error("tweak out of range or resulting public key is invalid");return o.Buffer.from(ow.g.mul(e).add(r.getPublic()).encode(!0,i))}(this.publicKey,a,!0)}catch(e){return this.deriveChild(t+1)}return c.chainCode=u,c.depth=this.depth+1,c.parentFingerprint=this.fingerprint,c.index=t,c}sign(t){return function(t,e,i,r){if("function"==typeof i){let n=i;i=function(i){let s=n(t,e,null,r,i);if(!o.Buffer.isBuffer(s)||32!==s.length)throw Error(ov);return new l(s)}}let n=new l(e);if(n.cmp(ow.n)>=0||n.isZero())throw Error(ov);let s=om.sign(t,e,{canonical:!0,k:i,pers:r});return{signature:o.Buffer.concat([s.r.toArrayLike(o.Buffer,"be",32),s.s.toArrayLike(o.Buffer,"be",32)]),recovery:s.recoveryParam}}(t,this.privateKey).signature}verify(t,e){return function(t,e,i){if(t.length%2!=0)throw Error("Wrong message length");let r={r:e.slice(0,32),s:e.slice(32,64)},n=new l(r.r),o=new l(r.s);if(n.cmp(ow.n)>=0||o.cmp(ow.n)>=0)throw Error("couldn't parse signature");if(1===o.cmp(om.nh)||n.isZero()||o.isZero())return!1;let s=oS(i);if(null===s)throw Error(og);return om.verify(t,r,{x:s.getPublic().x,y:s.getPublic().y})}(t,e,this.publicKey)}toJSON(){return{xpriv:this.privateExtendedKey,xpub:this.publicExtendedKey}}}function o_(t,e,i){let r=o.Buffer.allocUnsafe(78);r.writeUInt32BE(e,0),r.writeUInt8(t.depth,4);let n=t.depth?t.parentFingerprint:0;return r.writeUInt32BE(n,5),r.writeUInt32BE(t.index,9),t.chainCode.copy(r,13),i.copy(r,45),r}function oD(t){let e=s.createHash("sha256").update(t).digest();return s.createHash("rmd160").update(e).digest()}oI.HARDENED_OFFSET=2147483648;class oT{static decode(t){return a.decode(t)}static encode(t){return a.encode(t)}}class oA{constructor(t){this.key=t}static newWithMnemonic(t,e){let i=oO.toSeed(t,e);return oA.newWithSeed(i)}static newWithSeed(t){return oA.newWithKey(oI.fromMasterSeed(t))}static newWithKey(t){return new oA(t)}getPrivateKeyBytes(){return this.key.privateKey}getPrivateKeyBase58(){return oT.encode(this.getPrivateKeyBytes())}getPublicKeyBytes(){return this.key.publicKey}getPublicKeyBase58(){return oT.encode(this.getPublicKeyBytes())}serialize(){return oT.decode(this.serializeBase58())}serializeBase58(){let t=oT.decode(this.key.privateExtendedKey),e=o.Buffer.alloc(82);return t.copy(e),ex.hashTwice(t).copy(e,78,0,4),oT.encode(e)}serializePublicKey(){return oT.decode(this.serializePublicKeyBase58())}serializePublicKeyBase58(){let t=oT.decode(this.key.publicExtendedKey),e=o.Buffer.alloc(82);return t.copy(e),ex.hashTwice(t).copy(e,78,0,4),oT.encode(e)}static deserialize(t){return this.deserializeBase58(oT.encode(t))}static deserializeBase58(t){return new oA(oI.fromExtendedKey(t))}static transformBip32HeaderToBuffer(t){let e=o.Buffer.alloc(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=255&t,e}static paddingToExtendedPrivateKey(t){let e=o.Buffer.alloc(oA.EXTENDED_PRIVATEKEY_BYTES);oA.transformBip32HeaderToBuffer(this.bip32HeaderP2PKHpriv).copy(e),t.copy(e,46,0,32);let i=o.Buffer.alloc(78);return e.copy(i,0,0,78),ex.hashTwice(i).copy(e,78,0,4),e}static paddingToExtendedPublicKey(t){let e=o.Buffer.alloc(oA.EXTENDED_PUBLICKEY_BYTES);oA.transformBip32HeaderToBuffer(this.bip32HeaderP2PKHpub).copy(e),t.copy(e,45,0,33);let i=o.Buffer.alloc(78);return e.copy(i,0,0,78),ex.hashTwice(i).copy(e,78,0,4),e}deriveWithPath(t){return new oA(this.key.derive(t))}deriveWithIndex(t,e=!1){return e&&(t+=oA.HARDENED_BIT),new oA(this.key.deriveChild(t))}static getRedeemScript(t){let e=o.Buffer.alloc(35);return e[0]=33,t.copy(e,1),e[34]=oA.PADDING_STANDARD,e}static getBinAddressFromBuffer(t){let e=this.getRedeemScript(t),i=ex.sha256ripemd160(e),r=o.Buffer.alloc(i.length+1);r[0]=oA.PADDING_IDENTITY,i.copy(r,1),i=ex.hashTwice(r);let n=o.Buffer.alloc(r.length+4);return r.copy(n,0),i.copy(n,r.length,0,4),n}getBinAddress(){return oA.getBinAddressFromBuffer(this.getPublicKeyBytes())}getAddress(){let t=this.getBinAddress();return oT.encode(t)}static toAddress(t){return oT.encode(this.getBinAddressFromBuffer(t))}static isAddressValid(t){let e=oT.decode(t);if(25!=e.length||e[0]!=oA.PADDING_IDENTITY)return!1;let i=ex.hashTwice(o.Buffer.from(e.toString("hex").substr(0,21)));return i[0]==e[21]&&i[1]==e[22]&&i[2]==e[23]&&i[3]==e[24]}wipe(){}}oA.PUBLICKEY_BYTES=33,oA.PRIVATEKEY_BYTES=32,oA.SEED_BYTES=64,oA.EXTENDED_KEY_BYTES=82,oA.EXTENDED_PRIVATEKEY_BYTES=oA.EXTENDED_KEY_BYTES,oA.EXTENDED_PUBLICKEY_BYTES=oA.EXTENDED_KEY_BYTES,oA.HARDENED_BIT=2147483648,oA.PADDING_IDENTITY=103,oA.PADDING_STANDARD=173,oA.bip32HeaderP2PKHpub=76067358,oA.bip32HeaderP2PKHpriv=76066276,oA.bip32HeaderP2WPKHpub=78792518,oA.bip32HeaderP2WPKHpriv=78791436,oA.DERIVE_PATH_PREFIX="m/44'/0'/0'/0/",oA.PRE_DERIVED_PUBLICKEY_PATH="m/44'/0'/0'";class ox{static generateKeyAndIv(t){let e=o.Buffer.from(t,"utf-8"),i=s.createHash("md5").update(e).digest(),r=s.createHash("md5").update(i).update(e).digest(),n=s.createHash("md5").update(r).update(e).digest();return{key:o.Buffer.concat([i,r]),iv:n}}static encrypt(t,e){let{key:i,iv:r}=ox.generateKeyAndIv(e),n=s.createCipheriv("aes-256-cbc",i,r);return o.Buffer.concat([n.update(t),n.final()])}static decrypt(t,e){let{key:i,iv:r}=this.generateKeyAndIv(e),n=s.createDecipheriv("aes-256-cbc",i,r);return o.Buffer.concat([n.update(t),n.final()])}static encryptToBase64(t,e){let i=this.encrypt(t,e);return eP.toUrlFormat(i.toString("base64"))}static decryptFromBase64(t,e){let i=o.Buffer.from(eP.fromUrlFormat(t),"base64");return ox.decrypt(i,e)}}class oO{constructor(t=oO.ENGLISH){if(this.language=t,!(t in oO.WORDLISTS))throw new x("Unsupported language for mnemonic "+t)}static getInstance(t=oO.ENGLISH){return null!==t&&""!==t||(t=oO.ENGLISH),new oO(t)}generate(t){return t?(0,h.JJ)(t,oO.WORDLISTS[this.language]):(0,h.OF)(oO.TWELVE_WORDS_ENTROPY,null,oO.WORDLISTS[this.language])}isValid(t){return tj(null!=t&&""!==t,"Invalid mnemonic"),t=t.normalize("NFKD"),(0,h._I)(t,oO.WORDLISTS[this.language])}static getLanguage(t){for(let e of(tj(null!=t&&""!==t,"Invalid menmonic"),t=t.normalize("NFKD"),Object.keys(oO.WORDLISTS)))if(new oO(e).isValid(t))return e;return null}static checkIsValid(t){return tj(null!=t&&""!==t,"Invalid menmonic"),null!=this.getLanguage(t)}static toSeed(t,e){return tj(null!=t&&""!==t,"Invalid menmonic"),null==e&&(e=""),t=t.normalize("NFKD"),e=e.normalize("NFKD"),(0,h.Z1)(t,e)}}oO.DEFAULT=null,oO.CHINESE_SIMPLIFIED="chinese_simplified",oO.CHINESE_TRADITIONAL="chinese_traditional",oO.CZECH="czech",oO.ENGLISH="english",oO.FRENCH="french",oO.ITALIAN="italian",oO.JAPANESE="japanese",oO.KOREAN="korean",oO.SPANISH="spanish",oO.TWELVE_WORDS_ENTROPY=128,oO.WORDLISTS={english:h.ET.english,czech:h.ET.czech,chinese_simplified:h.ET.chinese_simplified,chinese_traditional:h.ET.chinese_traditional,french:h.ET.french,italian:h.ET.italian,japanese:h.ET.japanese,spanish:h.ET.spanish,korean:h.ET.korean};class oP{constructor(t,e){let i=t instanceof oP?t.getAbsolutePath():t;e&&(i+=oP.SEPARATOR+e),i.startsWith("/")||i.startsWith("./")||":"===i[1]||(i="./"+i),this.fullPath=i}static exists(t){return"string"==typeof t&&(t=new oP(t)),t.exists()}static isFile(t){return"string"==typeof t&&(t=new oP(t)),t.isFile()}static isDirectory(t){return"string"==typeof t&&(t=new oP(t)),t.isDirectory()}getStats(){return this.fileStats?this.fileStats:this.exists()?ew(this.fullPath):null}exists(){return ef(this.fullPath)}length(){return this.exists()?this.getStats().size:0}getAbsolutePath(){return this.fullPath}getName(){return this.fullPath.includes(oP.SEPARATOR)?this.fullPath.substring(this.fullPath.lastIndexOf(oP.SEPARATOR)+1):this.fullPath}getParentDirectory(){let t=this.getParentDirectoryName();return t?new oP(t):null}getParentDirectoryName(){return this.fullPath.includes(oP.SEPARATOR)?this.fullPath.substring(0,this.fullPath.lastIndexOf(oP.SEPARATOR)):this.isDirectory?this.fullPath:""}isDirectory(){return!!this.exists()&&this.getStats().isDirectory()}isFile(){return!!this.exists()&&this.getStats().isFile()}list(){return this.exists()&&this.getStats().isDirectory()?ey(this.fullPath):null}listFiles(){if(!this.exists()||!this.getStats().isDirectory())return null;let t=[];return this.list().forEach(e=>{t.push(new oP(this.getAbsolutePath()+"/"+e))}),t}writeText(t){this.exists()&&!this.getStats().isFile()||("string"==typeof t?eb(this.fullPath,t,{encoding:"utf-8"}):eb(this.fullPath,t))}readText(t=!0){return this.exists()?t?eg(this.fullPath,{encoding:"utf-8"}):eg(this.fullPath):null}rename(t){if(this.exists()){let e=this.fullPath.includes(oP.SEPARATOR)&&!t.includes(oP.SEPARATOR)?this.getParentDirectoryName+oP.SEPARATOR+t:t;ev(this.fullPath,e)}}createFile(t){this.exists()&&!t||(eb(this.fullPath,"",{encoding:"utf-8"}),this.fileStats=void 0)}createDirectory(t){this.exists()&&!t||(this.mkdirpath(this.fullPath),this.fileStats=void 0)}mkdirpath(t){if(!ef(t))try{ep(t)}catch(i){let e=v.dirname(t);if(e===t)throw i;this.mkdirpath(e),this.mkdirpath(t)}}delete(){this.exists()&&(this.isDirectory()?this.deleteDirectory(this.fullPath):eE(this.fullPath),this.fileStats=void 0)}deleteDirectory(t){ef(t)&&(ey(t).forEach((e,i)=>{let r=v.join(t,e);eS(r).isDirectory()?this.deleteDirectory(r):eE(r)}),em(t))}toString(){return this.fullPath}}oP.SEPARATOR="/";class oR{constructor(){}static getInstance(){return oR.instance||(oR.instance=new oR),oR.instance}merge(t,e){return e}}class ok extends tP{constructor(){super()}constructWithOperation(t){this.header=ok.Header.newWithPreviousTxId(t,null)}constructWithPreviousTxId(t,e){this.header=ok.Header.newWithPreviousTxId(t,e)}constructWithTransferTicket(t,e){this.header=ok.Header.newWithTransferTicket(t,e)}constructWithIDChainRequest(t){this.header=t.header,this.payload=t.payload,this.proof=t.proof}getHeader(){return this.header}getOperation(){return this.header.getOperation()}getPayload(){return this.payload}setPayload(t){this.payload=t}getProof(){return this.proof}setProof(t){this.proof=t}getSigningInputs(){let t=this.getOperation().equals(ok.Operation.UPDATE)?this.header.getPreviousTxid():"",e=this.getOperation().equals(ok.Operation.TRANSFER)?this.header.getTicket():"";return[o.Buffer.from(this.header.getSpecification()),o.Buffer.from(this.header.getOperation().toString()),o.Buffer.from(t),o.Buffer.from(e),o.Buffer.from(this.payload)]}isValid(){return E(this,void 0,void 0,function*(){let t=this.proof.getVerificationMethod(),e=yield this.getSignerDocument();if(null==e||!e.isGenuine())return!1;if(this.getOperation().equals(ok.Operation.DEACTIVATE)){if(!e.isAuthenticationKey(t)&&!e.isAuthorizationKey(t))return!1}else if(!e.isAuthenticationKey(t))return!1;return e.verify(this.proof.getVerificationMethod(),this.proof.getSignature(),...this.getSigningInputs())})}toJSON(t=null){return{header:this.header.toJSON(),payload:this.payload,proof:this.proof.toJSON()}}fromJSON(t,e=null){if(!t.header)throw new V("Missing header");if(this.header=ok.Header.parse(t.header),!t.payload)throw new V("Missing payload");if(this.payload=this.getString("payload",t.payload,{mandatory:!0,nullable:!1}),!t.proof)throw new V("Missing proof");this.proof=ok.Proof.parse(t.proof),this.sanitize()}}ok.DID_SPECIFICATION="elastos/did/1.0",ok.CREDENTIAL_SPECIFICATION="elastos/credential/1.0",function(t){var e;class i{constructor(t,e){this.name=t,this.specification=e}getSpecification(){return this.specification}toString(){return this.name}static fromString(t){return i[t.toUpperCase()]}equals(t){return this.name===t.name}}t.Operation=i,(e=i=t.Operation||(t.Operation={})).CREATE=new e("create",t.DID_SPECIFICATION),e.UPDATE=new e("update",t.DID_SPECIFICATION),e.TRANSFER=new e("transfer",t.DID_SPECIFICATION),e.DEACTIVATE=new e("deactivate",t.DID_SPECIFICATION),e.DECLARE=new e("declare",t.CREDENTIAL_SPECIFICATION),e.REVOKE=new e("revoke",t.CREDENTIAL_SPECIFICATION);class r extends tP{constructor(t=null){super(),this.specification=t}static newWithPreviousTxId(t,e){let i=new r(t.getSpecification());return i.operation=t,i.previousTxid=e,i}static newWithTransferTicket(t,e){tj(null!=e,"Invalid ticket");let i=new r(t.getSpecification());i.operation=t;let n=e.toString(!0);return i.ticket=eP.fromString(n),i.transferTicket=e,i}getSpecification(){return this.specification}getOperation(){return this.operation}getPreviousTxid(){return this.previousTxid}getTicket(){return this.ticket}getTransferTicket(){if(this.ticket&&!this.transferTicket){let t=eP.toString(this.ticket);try{this.transferTicket=es.parse(t)}catch(t){throw new _("Invalid ticket",t)}}return this.transferTicket}toJSON(t=null){let e={};return e.specification=this.specification,e.operation=this.operation.toString(),this.previousTxid&&(e.previousTxid=this.previousTxid),this.ticket&&(e.ticket=this.ticket),e}fromJSON(t,e=null){this.specification=this.getString("specification",t.specification,{mandatory:!0,nullable:!1});let r=this.getString("operation",t.operation,{mandatory:!0,nullable:!1});this.operation=i.fromString(r),this.previousTxid=this.getString("previousTxid",t.previousTxid,{mandatory:!1,nullable:!1,defaultValue:null}),this.ticket=this.getString("ticket",t.ticket,{mandatory:!1,nullable:!1,defaultValue:null})}static parse(t,e=null){try{return tP.deserialize(t,r,e)}catch(t){throw t instanceof V?t:new V(t)}}}t.Header=r;class n extends tP{constructor(t=null,e=null,i=tQ.DEFAULT_PUBLICKEY_TYPE){super(),this.type=null!=i?i:tQ.DEFAULT_PUBLICKEY_TYPE,this.verificationMethod=t,this.signature=e}getType(){return this.type}getVerificationMethod(){return this.verificationMethod}qualifyVerificationMethod(t){null==this.verificationMethod.getDid()&&(this.verificationMethod=tV.from(this.verificationMethod,t))}getSignature(){return this.signature}toJSON(t=null){return{type:this.type,verificationMethod:this.verificationMethod.toString(),signature:this.signature}}fromJSON(t,e=null){this.type=this.getString("type",t.type,{mandatory:!1,defaultValue:tQ.DEFAULT_PUBLICKEY_TYPE,nullable:!1}),this.verificationMethod=this.getDidUrl("verificationMethod",t.verificationMethod,{mandatory:!0,nullable:!1}),this.signature=this.getString("signature",t.signature,{mandatory:!0,nullable:!1})}static parse(t,e=null){try{return tP.deserialize(t,n,e)}catch(t){throw t instanceof V?t:new V(t)}}}t.Proof=n}(ok||(ok={}));class oN extends tP{constructor(t=null,e=null){super(),this.requestId=t,this.method=e}getRequestId(){return this.requestId}getMethod(){return this.method}setParameters(t){this.params=t}getParameters(){return this.params}hashCode(){return tB(this.method)+this.params.hashCode()}equals(t){return t instanceof oN&&this.method===t.method&&this.params===t.params}toJSON(t=null){return{id:this.requestId,method:this.method,params:[this.params.toJSON(null)]}}fromJSON(t,e=null){if(this.requestId=super.getString("id",t.id,{mandatory:!1,nullable:!0}),this.method=this.getString("method",t.method,{mandatory:!0,nullable:!1}),!t.params)throw new J("Missing parameters");if(!Array.isArray(t.params))throw new J("Invalid parameters");this.params=this.paramsFromJson(t.params[0])}}oN.ID="id",oN.METHOD="method",oN.PARAMETERS="params",(oN||(oN={})).Parameters=class extends tP{};class oC{constructor(t,e){this.code=t,this.message=e}}class oF extends tP{constructor(t=null,e=null){super(),this.jsonrpc=oF.JSON_RPC_VERSION,this.id=t,e instanceof oC?this.error=new oF.JsonRpcError(e.code,e.message):e instanceof oF.JsonRpcError?this.error=e:this.result=e}getResponseId(){return this.id}getErrorCode(){return this.error.getCode()}getErrorMessage(){return this.error.getMessage()}getResult(){return this.result}toJSON(t=null){let e={};return e.id=this.id,e.jsonrpc=this.jsonrpc,this.result&&(e.result=this.result.toJSON(null)),this.error&&(e.error=this.error.toJSON()),e}fromJSON(t,e=null){if(this.id=this.getString("id",t.id,{mandatory:!1,nullable:!0,defaultValue:null}),this.jsonrpc=this.getString("jsonrpc",t.jsonrpc,{mandatory:!0,nullable:!1}),null==this.jsonrpc||this.jsonrpc!==oF.JSON_RPC_VERSION)throw new X("Invalid JsonRPC version");if(!t.result&&!t.error)throw new X("Missing response data");t.result&&(this.result=this.resultFromJson(t.result)),t.error&&(this.error=oF.JsonRpcError.parse(t.error))}}oF.JSON_RPC_VERSION="2.0",function(t){class e extends tP{constructor(t=0,e=null,i=null){super(),this.code=t,this.message=e,this.data=i}getCode(){return this.code}getMessage(){return this.message}getData(){return this.data}toJSON(t=null){return{code:this.code,message:this.message,data:this.data}}fromJSON(t,e=null){this.code=this.getNumber("code",t.code,{mandatory:!0,nullable:!1,defaultValue:0}),this.message=this.getString("message",t.message,{mandatory:!1,nullable:!0}),this.data=this.getString("data",t.data,{mandatory:!1,nullable:!0})}static parse(t,i=null){try{return tP.deserialize(t,e,i)}catch(t){throw t instanceof X?t:new X(t)}}}t.JsonRpcError=e,t.Result=class extends tP{}}(oF||(oF={}));class oL extends oN{constructor(t=null){super(t,oL.METHOD_NAME)}setParameters(t,e=!1){t instanceof tz?super.setParameters(new oM(t,e)):t instanceof oM?super.setParameters(t):super.setParameters(new oM(tz.from(t),e))}getDid(){return this.getParameters().did}isResolveAll(){return this.getParameters().all}toString(){let t=new tV.Builder(this.getParameters().did);return t.setQueryParameter(oL.PARAMETER_ALL,this.getParameters().all?"true":"false"),t.build().toString()}paramsFromJson(t){return oM.parse(t)}static parse(t,e=null){try{return tP.deserialize(t,oL,e)}catch(t){throw t instanceof J?t:new J(t)}}}oL.PARAMETER_DID="did",oL.PARAMETER_ALL="all",oL.METHOD_NAME="did_resolveDID";class oM extends oN.Parameters{constructor(t=null,e=!1){super(),this.did=t,this.all=e}hashCode(){return this.did.hashCode()+tB(this.all)}equals(t){return t instanceof oM&&!!this.did.equals(t.did)&&this.all==t.all}toJSON(t=null){let e={};return e.did=this.did.toString(),this.all&&!0===this.all&&(e.all=this.all),e}fromJSON(t,e=null){this.did=super.getDid("did",t.did,{mandatory:!0,nullable:!1}),this.all=this.getBoolean("all",t.all,{mandatory:!1,nullable:!1,defaultValue:!1})}static parse(t,e=null){try{return tP.deserialize(t,oM,e)}catch(t){throw t instanceof J?t:new J(t)}}}class oj{constructor(t,e){this.name=e,this.value=t}getValue(){return this.value}static fromValue(t){switch(String(t)){case"0":return oj.VALID;case"2":return oj.REVOKED;case"3":return oj.NOT_FOUND;default:throw new _("Invalid CredentialBiographyStatus")}}toString(){return this.name.toLowerCase()}equals(t){return this.value==t.value}}(r=oj||(oj={})).VALID=new r(0,"valid"),r.REVOKED=new r(2,"revoked"),r.NOT_FOUND=new r(3,"not_found");class oK extends oF.Result{constructor(t=null,e=null){super(),this.id=t,this.status=e}getId(){return this.id}setStatus(t){this.status=t}getStatus(){return this.status}getTransactionCount(){return null!=this.txs?this.txs.length:0}getTransaction(t){return null!=this.txs?this.txs[t]:null}getAllTransactions(){return null!=this.txs?this.txs:[]}addTransaction(t){null==this.txs&&(this.txs=[]),this.txs.push(t)}toJSON(t=null){let e={};return e.id=this.id.toString(),e.status=this.status.toString(),this.txs&&this.txs.length>0&&(e.transaction=Array.from(this.txs,t=>t.toJSON())),e}fromJSON(t,e=null){this.id=this.getDidUrl("id",t.id,{mandatory:!0,nullable:!1});let i=this.getNumber("status",t.status,{mandatory:!0,nullable:!1});if(this.status=oj.fromValue(i),this.status.equals(oj.NOT_FOUND)){if(t.transaction)throw new Y("Should not include transaction")}else{if(!t.transaction)throw new Y("Missing transaction");if(!Array.isArray(t.transaction)||0==t.transaction.length)throw new Y("Invalid transaction");this.txs=Array.from(t.transaction,t=>oH.parse(t))}}static parse(t,e=null){try{return tP.deserialize(t,oK,e)}catch(t){throw t instanceof Y?t:new Y(t)}}}class oU extends oF{constructor(t=null,e=null){super(t,e)}resultFromJson(t){return oK.parse(t)}static parse(t,e=null){try{return tP.deserialize(t,oU,e)}catch(t){throw t instanceof X?t:new X(t)}}}class oB extends tP{constructor(t=null,e=null,i=null){super(),this.txId=t,this.timestamp=e,this.request=i}getTransactionId(){return this.txId}getTimestamp(){return this.timestamp}getRequest(){return this.request}toJSON(t=null){return{txid:this.txId,timestamp:this.dateToString(this.timestamp),operation:this.request.toJSON()}}fromJSON(t,e=null){if(this.txId=this.getString("txid",t.txid,{mandatory:!0,nullable:!1}),this.timestamp=this.getDate("timestamp",t.timestamp,{mandatory:!0,nullable:!1}),!t.operation)throw new W("Missing request");this.request=this.requestFromJSON(t.operation)}}oB.TXID="txid",oB.TIMESTAMP="timestamp",oB.OPERATION="operation";class oz extends ok{static newWithOperation(t){let e=new oz;return e.constructWithOperation(t),e}static newWithPreviousTxId(t,e){let i=new oz;return i.constructWithPreviousTxId(t,e),i}static newWithTransferTicket(t,e){let i=new oz;return i.constructWithTransferTicket(t,e),i}static newWithDIDRequest(t){let e=new oz;e.constructWithIDChainRequest(t),e.did=t.did,e.doc=t.doc}static create(t,e,i){return E(this,void 0,void 0,function*(){let r=oz.newWithOperation(ok.Operation.CREATE);r.setPayload(t);try{yield r.seal(e,i)}catch(t){throw new k(t)}return r})}static update(t,e,i,r){return E(this,void 0,void 0,function*(){let n=oz.newWithPreviousTxId(ok.Operation.UPDATE,e);n.setPayload(t);try{yield n.seal(i,r)}catch(t){throw new k(t)}return n})}static transfer(t,e,i,r){return E(this,void 0,void 0,function*(){let n=oz.newWithTransferTicket(ok.Operation.TRANSFER,e);n.setPayload(t);try{yield n.seal(i,r)}catch(t){throw new k(t)}return n})}static deactivate(t,e,i){return E(this,void 0,void 0,function*(){let r=oz.newWithOperation(ok.Operation.DEACTIVATE);r.setPayload(t);try{yield r.seal(e,i)}catch(t){throw new k(t)}return r})}static deactivateTarget(t,e,i,r,n){return E(this,void 0,void 0,function*(){let o=oz.newWithOperation(ok.Operation.DEACTIVATE);o.setPayload(t);try{yield o.sealTarget(e,i,r,n)}catch(t){}return o})}getPreviousTxid(){return this.getHeader().getPreviousTxid()}getTransferTicket(){return this.getHeader().getTransferTicket()}getDid(){return this.did}getDocument(){return this.doc}setPayload(t){if(t instanceof ee){if(this.doc=t,this.did=this.doc.getSubject(),this.getHeader().getOperation().equals(ok.Operation.DEACTIVATE))super.setPayload(this.doc.getSubject().toString());else{let t=this.doc.toString(!0),e=o.Buffer.from(t,"utf-8");this.setPayload(eP.fromString(e.toString()))}}else super.setPayload(t)}sanitize(){let t=this.getHeader();if(null==t)throw new V("Missing header");if(null==t.getSpecification())throw new V("Missing specification");if(t.getSpecification()!==oz.DID_SPECIFICATION)throw new V("Unsupported specification");let e=t.getOperation();if(e.equals(ok.Operation.CREATE));else if(e.equals(ok.Operation.UPDATE)){if(null==t.getPreviousTxid()||""===t.getPreviousTxid())throw new V("Missing previousTxid")}else if(e.equals(ok.Operation.TRANSFER)){if(null==t.getTicket()||""===t.getTicket())throw new V("Missing ticket")}else if(!e.equals(ok.Operation.DEACTIVATE))throw new V("Invalid operation "+t.getOperation().toString());let i=this.getPayload();if(null==i||""===i)throw new V("Missing payload");let r=this.getProof();if(null==r)throw new V("Missing proof");try{if(t.getOperation().equals(ok.Operation.DEACTIVATE))this.did=new tz(i);else{let t=eP.toString(i);this.doc=ee._parseOnly(t),this.did=this.doc.getSubject()}}catch(t){throw new V("Invalid payload",t)}r.qualifyVerificationMethod(this.did)}seal(t,e){return E(this,void 0,void 0,function*(){if(!this.doc.isAuthenticationKey(t))throw new q("Not an authentication key.");if(null==this.getPayload()||""===this.getPayload())throw new V("Missing payload");let i=yield this.doc.signWithId(t,e,...this.getSigningInputs());this.setProof(new oz.Proof(t,i))})}sealTarget(t,e,i,r){return E(this,void 0,void 0,function*(){if(!this.doc.isAuthorizationKey(t))throw new q("Not an authorization key: "+t);if(!e.isAuthenticationKey(i))throw new q("Not an authentication key: "+i);if(!this.getPayload()||null==this.getPayload())throw new V("Missing payload");let n=yield e.signWithId(i,r,...this.getSigningInputs());this.setProof(new oz.Proof(t,n))})}getSignerDocument(){return E(this,void 0,void 0,function*(){return null==this.doc?this.doc=yield this.did.resolve():this.doc.isCustomizedDid()&&(yield this.doc.resolveControllers()),this.doc})}static parse(t,e=null){try{return tP.deserialize(t,oz,e)}catch(t){throw t instanceof V?t:new V(t)}}}class oV extends oB{constructor(t=null,e=null,i=null){super(t,e,i)}getDid(){return this.getRequest().getDid()}requestFromJSON(t){return oz.parse(t)}static parse(t,e=null){try{return tP.deserialize(t,oV,e)}catch(t){throw t instanceof W?t:new W(t)}}}class oq extends oN{constructor(t=null){super(t,oq.METHOD_NAME)}setParameters(t,e=null){t instanceof oW?super.setParameters(t):super.setParameters(new oW(t,e))}getId(){return this.getParameters().id}getIssuer(){return this.getParameters().issuer}toString(){let t=new tV.Builder(this.getParameters().id);return null!=this.getParameters().issuer&&t.setQueryParameter(oq.PARAMETER_ISSUER,this.getParameters().issuer.toString()),t.build().toString()}paramsFromJson(t){return oW.parse(t)}static parse(t,e=null){try{return tP.deserialize(t,oq,e)}catch(t){throw t instanceof J?t:new J(t)}}}oq.PARAMETER_ID="id",oq.PARAMETER_ISSUER="issuer",oq.METHOD_NAME="did_resolveCredential";class oW extends oN.Parameters{constructor(t=null,e=null){super(),this.id=t,this.issuer=e}hashCode(){let t=this.id.hashCode();return null!=this.issuer&&(t+=this.issuer.hashCode()),t}equals(t){if(!(t instanceof oW)||!this.id.equals(t.id))return!1;let e=null!=this.issuer?this.issuer:this.id.getDid(),i=null!=t.issuer?t.issuer:t.id.getDid();return e.equals(i)}toJSON(t=null){let e={};return e.id=this.id.toString(),this.issuer&&(e.issuer=this.issuer.toString()),e}fromJSON(t,e=null){this.id=super.getDidUrl("id",t.id,{mandatory:!0,nullable:!1}),this.issuer=this.getDid("issuer",t.issuer,{mandatory:!1,nullable:!0,defaultValue:null})}static parse(t,e=null){try{return tP.deserialize(t,oW,e)}catch(t){throw t instanceof J?t:new J(t)}}}class oY extends ok{constructor(){super()}static newWithOperation(t){let e=new oY;return e.constructWithOperation(t),e}static newWithCredentialRequest(t){let e=new oY;return e.constructWithIDChainRequest(t),e.id=t.id,e.vc=t.vc,e.signer=t.signer,e}static declare(t,e,i,r){return E(this,void 0,void 0,function*(){let n=oY.newWithOperation(ok.Operation.DECLARE);n.setPayload(t),n.setSigner(e);try{yield n.seal(e,i,r)}catch(t){throw new k(t)}return n})}static revoke(t,e,i,r){return E(this,void 0,void 0,function*(){let n=oY.newWithOperation(ok.Operation.REVOKE);n.setPayload(t),n.setSigner(e);try{yield n.seal(e,i,r)}catch(t){throw new k(t)}return n})}setSigner(t){this.signer=t}getCredentialId(){return this.id}getCredential(){return this.vc}setPayload(t){if(t instanceof t0){if(this.id=t.getId(),this.vc=t,this.getHeader().getOperation().equals(ok.Operation.DECLARE)){let e=t.toString(!0);this.setPayload(eP.fromString(e))}else this.getHeader().getOperation().equals(ok.Operation.REVOKE)&&this.setPayload(t.getId().toString())}else t instanceof tV?(this.id=t,this.vc=null,super.setPayload(t.toString())):super.setPayload(t)}sanitize(){let t=this.getHeader();if(null==t)throw new V("Missing header");if(null==t.getSpecification())throw new V("Missing specification");if(t.getSpecification()!==oY.CREDENTIAL_SPECIFICATION)throw new V("Unsupported specification");if(!t.getOperation().equals(ok.Operation.DECLARE)&&!t.getOperation().equals(ok.Operation.REVOKE))throw new V("Invalid operation "+t.getOperation());let e=this.getPayload();if(null==e||""===e)throw new V("Missing payload");let i=this.getProof();if(null==i)throw new V("Missing proof");try{if(t.getOperation().equals(ok.Operation.DECLARE)){let t=eP.toString(e);this.vc=t0.parse(t),this.id=this.vc.getId()}else this.id=tV.from(e)}catch(t){throw new V("Invalid payload",t)}i.qualifyVerificationMethod(this.id.getDid())}seal(t,e,i){return E(this,void 0,void 0,function*(){if(!t.isAuthenticationKey(e))throw new q("Not an authentication key.");if(null==this.getPayload()||""===this.getPayload())throw new V("Missing payload");let r=yield t.signWithId(e,i,...this.getSigningInputs());this.setProof(new ok.Proof(e,r))})}getSignerDocument(){return E(this,void 0,void 0,function*(){return null!=this.signer||(this.getOperation().equals(ok.Operation.DECLARE)?this.signer=yield this.getCredential().getSubject().getId().resolve():this.signer=yield this.getProof().getVerificationMethod().getDid().resolve()),this.signer})}static parse(t,e=null){try{return tP.deserialize(t,oY,e)}catch(t){throw t instanceof V?t:new V(t)}}}class oH extends oB{constructor(t=null,e=null,i=null){super(t,e,i)}getId(){return this.getRequest().getCredentialId()}requestFromJSON(t){return oY.parse(t)}static parse(t,e=null){try{return tP.deserialize(t,oH,e)}catch(t){throw t instanceof W?t:new W(t)}}}class oJ extends oN{constructor(t=null){super(t,oJ.METHOD_NAME)}setParameters(t,e=0,i=0){t instanceof tz?super.setParameters(new oX(t,e,i)):super.setParameters(t)}getDid(){return this.getParameters().did}getSkip(){return this.getParameters().skip}getLimit(){return this.getParameters().limit}toString(){let t=new tV.Builder(this.getParameters().did);return t.setPath("/credentials"),t.setQueryParameter(oJ.PARAMETER_SKIP,this.getParameters().skip.toFixed()),t.setQueryParameter(oJ.PARAMETER_LIMIT,this.getParameters().limit.toFixed()),t.build().toString()}paramsFromJson(t){return oX.parse(t)}static parse(t,e=null){try{return tP.deserialize(t,oJ,e)}catch(t){throw t instanceof J?t:new J(t)}}}oJ.PARAMETER_DID="did",oJ.PARAMETER_SKIP="skip",oJ.PARAMETER_LIMIT="limit",oJ.METHOD_NAME="did_listCredentials";class oX extends oN.Parameters{constructor(t=null,e=0,i=0){super(),this.did=t,this.skip=e,this.limit=i}hashCode(){return this.did.hashCode()+(tB(this.skip)+tB(this.limit))}equals(t){return t instanceof oX&&!!this.did.equals(t.did)&&this.skip==t.skip&&this.limit==t.limit}toJSON(t=null){let e={};return e.did=this.did.toString(),this.skip&&0!=this.skip&&(e.skip=this.skip),this.limit&&0!=this.limit&&(e.limit=this.limit),e}fromJSON(t,e=null){this.did=super.getDid("did",t.did,{mandatory:!0,nullable:!1}),this.skip=this.getNumber("skip",t.skip,{mandatory:!1,nullable:!1,defaultValue:0}),this.limit=this.getNumber("limit",t.limit,{mandatory:!1,nullable:!1,defaultValue:0})}static parse(t,e=null){try{return tP.deserialize(t,oX,e)}catch(t){throw t instanceof J?t:new J(t)}}}class oG extends oF.Result{constructor(t=null){super(),this.did=t}getDid(){return this.did}getCredentialIds(){return null!=this.credentialIds?this.credentialIds:[]}size(){return null!=this.credentialIds?this.credentialIds.length:0}getCredentialId(t){return null!=this.credentialIds?this.credentialIds[t]:null}addCredentialId(t){null==this.credentialIds&&(this.credentialIds=[]),this.credentialIds.push(t)}toJSON(t=null){let e={};return e.did=this.did.toString(),this.credentialIds&&this.credentialIds.length>0&&(e.credentials=Array.from(this.credentialIds,t=>t.toString())),e}fromJSON(t,e=null){if(this.did=super.getDid("did",t.did,{mandatory:!0,nullable:!1}),t.credentials){if(!Array.isArray(t.credentials))throw new Y("Invalid credential list");t.credentials.length>0&&(this.credentialIds=Array.from(t.credentials,t=>new tV(String(t))))}}static parse(t,e=null){try{return tP.deserialize(t,oG,e)}catch(t){throw t instanceof Y?t:new Y(t)}}}oG.DEFAULT_SIZE=128,oG.MAX_SIZE=512;class oZ{constructor(t,e){this.name=e,this.value=t}getValue(){return this.value}static fromValue(t){switch(String(t)){case"0":return oZ.VALID;case"2":return oZ.DEACTIVATED;case"3":return oZ.NOT_FOUND;default:throw new _("Invalid DIDBiographyStatus")}}toString(){return this.name.toLowerCase()}equals(t){return this.value==t.value}}(n=oZ||(oZ={})).VALID=new n(0,"valid"),n.DEACTIVATED=new n(2,"deactivated"),n.NOT_FOUND=new n(3,"not_found");class oQ extends oF.Result{constructor(t=null){super(),this.did=t}getDid(){return this.did}setStatus(t){this.status=t}getStatus(){return this.status}getTransactionCount(){return null!=this.txs?this.txs.length:0}getTransaction(t){return null!=this.txs?this.txs[t]:null}getAllTransactions(){return null!=this.txs?this.txs:[]}addTransaction(t){null==this.txs&&(this.txs=[]),this.txs.push(t)}toJSON(t=null){let e={};return e.did=this.did.toString(),e.status=this.status.toString(),this.txs&&this.txs.length>0&&(e.transaction=Array.from(this.txs,t=>t.toJSON())),e}fromJSON(t,e=null){this.did=super.getDid("did",t.did,{mandatory:!0,nullable:!1});let i=this.getNumber("status",t.status,{mandatory:!0,nullable:!1});if(this.status=oZ.fromValue(i),this.status.equals(oZ.NOT_FOUND)){if(t.transaction)throw new Y("Should not include transaction")}else{if(!t.transaction)throw new Y("Missing transaction");if(!Array.isArray(t.transaction)||0==t.transaction.length)throw new Y("Invalid transaction");this.txs=Array.from(t.transaction,t=>oV.parse(t))}}static parse(t,e=null){try{return tP.deserialize(t,oQ,e)}catch(t){throw t instanceof Y?t:new Y(t)}}}class o$ extends oF{constructor(t=null,e=null){super(t,e)}resultFromJson(t){return oG.parse(t)}static parse(t,e=null){try{return tP.deserialize(t,o$,e)}catch(t){throw t instanceof X?t:new X(t)}}}class o0 extends oF{constructor(t=null,e=null){super(t,e)}resultFromJson(t){return oQ.parse(t)}static parse(t,e=null){try{return tP.deserialize(t,o0,e)}catch(t){throw t instanceof X?t:new X(t)}}}let o1=new b("DIDBackend");class o2{constructor(t,e,i,r){e<0&&(e=0),i<0&&(i=0),r<0&&(r=0),this.adapter=t,this.cache=new o8({maxItems:i,maxAge:r/1e3,asyncLoader:t=>E(this,void 0,void 0,function*(){return{value:yield this.resolve(t)}})}),o1.info("DID backend initialized, cache(init:{}, max:{}, ttl:{})",e,i,r/1e3)}static initialize(t,e=o2.DEFAULT_CACHE_INITIAL_CAPACITY,i=o2.DEFAULT_CACHE_MAX_CAPACITY,r=o2.DEFAULT_CACHE_TTL){tj(null!=t,"Invalid adapter"),tj(e<=i,"Invalid cache capacity"),e=e<i?e:i,this.instance=new o2(t,e,i,r)}static getInstance(){return tj(null!=this.instance,"The DIDBackend was not initialized. Please call DIDBackend.initialize() with a valid DIDAdapter (i.e. new DefaultDIDAdapter()) first."),this.instance}static isInitialized(){return null!==this.instance}generateRequestId(){return(0,s.randomBytes)(16).toString("hex")}getAdapter(){return this.adapter}setResolveHandle(t){this.resolveHandle=t}resolve(t){return E(this,void 0,void 0,function*(){let e=t.serialize(!0);o1.trace("Resolving request: "+e);let i=yield this.getAdapter().resolve(e);if(o1.trace("Resolving response: "+JSON.stringify(i)),null==i)throw new A("Unknown error, got null result.");let r=null;try{switch(t.getMethod()){case oL.METHOD_NAME:r=o0.parse(i,o0);break;case oq.METHOD_NAME:r=oU.parse(i,oU);break;case oJ.METHOD_NAME:r=o$.parse(i,o$);break;default:throw o1.error("INTERNAL - unknown resolve method '{}'",t.getMethod()),new A("Unknown resolve method: "+t.getMethod())}}catch(t){throw new A(t)}if(null==r.getResponseId()||r.getResponseId()!==t.getRequestId())throw new A("Mismatched resolve result with request.");if(null!=r.getResult())return r.getResult();throw new A("Server error("+r.getErrorCode()+"): "+r.getErrorMessage())})}resolveDidBiography(t,e=!0,i=!1){return E(this,void 0,void 0,function*(){o1.info("Resolving DID {}, all={}...",t.toString(),e);let r=new oL(this.generateRequestId());r.setParameters(t,e),i&&this.cache.invalidate(r);try{return yield this.cache.getAsync(r)}catch(t){throw new A(t)}})}resolveDid(t,e=!1){return E(this,void 0,void 0,function*(){if(o1.debug("Resolving DID {}...",t.toString()),null!=this.resolveHandle){let e=this.resolveHandle.resolve(t);if(null!=e)return e}let i=yield this.resolveDidBiography(t,!1,e),r=null;if(i.getStatus().equals(oZ.VALID))r=i.getTransaction(0);else if(i.getStatus().equals(oZ.DEACTIVATED)){if(2!=i.getTransactionCount())throw new A("Invalid DID biography, wrong transaction count.");if(!(r=i.getTransaction(0)).getRequest().getOperation().equals(ok.Operation.DEACTIVATE))throw new A("Invalid DID biography, wrong status.");let t=i.getTransaction(1).getRequest().getDocument();if(null==t)throw new A("Invalid DID biography, invalid trancations.");let e=new class extends oz{constructor(t){super(),this.constructWithIDChainRequest(t)}getSignerDocument(){return E(this,void 0,void 0,function*(){let e=null==this.getDocument()?t:this.getDocument();return e.isCustomizedDid()&&(yield e.resolveControllers()),e})}}(r.getRequest());if(!(yield e.isValid()))throw new A("Invalid DID biography, transaction signature mismatch.");r=i.getTransaction(1)}else if(i.getStatus().equals(oZ.NOT_FOUND))return null;if(!r.getRequest().getOperation().equals(ok.Operation.CREATE)&&!r.getRequest().getOperation().equals(ok.Operation.UPDATE)&&!r.getRequest().getOperation().equals(ok.Operation.TRANSFER))throw new A("Invalid ID transaction, unknown operation.");if(!(yield r.getRequest().isValid()))throw new A("Invalid ID transaction, signature mismatch.");let n=r.getRequest().getDocument().clone();yield n.resolveControllers();let o=n.getMetadata();return o.setTransactionId(r.getTransactionId()),o.setSignature(n.getProof().getSignature()),o.setPublished(r.getTimestamp()),i.getStatus().equals(oZ.DEACTIVATED)&&o.setDeactivated(!0),n})}resolveUntrustedDid(t,e){return E(this,void 0,void 0,function*(){if(o1.debug("Resolving untrusted DID {}...",t.toString()),null!=this.resolveHandle){let e=this.resolveHandle.resolve(t);if(null!=e)return e}let i=yield this.resolveDidBiography(t,!1,e),r=null;switch(i.getStatus().getValue()){case oZ.VALID.getValue():r=i.getTransaction(0);break;case oZ.DEACTIVATED.getValue():if(2!=i.getTransactionCount())throw new A("Invalid DID biography, wrong transaction count.");if((r=i.getTransaction(0)).getRequest().getOperation()!=ok.Operation.DEACTIVATE)throw new A("Invalid DID biography, wrong status.");if(null==i.getTransaction(1).getRequest().getDocument())throw new A("Invalid DID biography, invalid trancations.");r=i.getTransaction(1);break;case oZ.NOT_FOUND.getValue():return null}if(r.getRequest().getOperation()!=ok.Operation.CREATE&&r.getRequest().getOperation()!=ok.Operation.UPDATE&&r.getRequest().getOperation()!=ok.Operation.TRANSFER)throw new A("Invalid ID transaction, unknown operation.");let n=r.getRequest().getDocument().clone();yield n.resolveControllers();let o=n.getMetadata();return o.setTransactionId(r.getTransactionId()),o.setSignature(n.getProof().getSignature()),o.setPublished(r.getTimestamp()),i.getStatus()==oZ.DEACTIVATED&&o.setDeactivated(!0),n})}resolveCredentialBiography(t,e=null,i=!1){o1.info("Resolving credential {}, issuer={}...",t,e);let r=new oq(this.generateRequestId());r.setParameters(t,e),i&&this.cache.invalidate(r);try{return this.cache.getAsync(r)}catch(t){throw new A(t)}}resolveCredential(t,e=null,i=!1){return E(this,void 0,void 0,function*(){o1.debug("Resolving credential {}...",t);let r=yield this.resolveCredentialBiography(t,e,i),n=null;if(r.getStatus().equals(oj.VALID))n=r.getTransaction(0);else if(r.getStatus().equals(oj.REVOKED)){if(!(n=r.getTransaction(0)).getRequest().getOperation().equals(ok.Operation.REVOKE))throw new A("Invalid credential biography, wrong status.");if(1>r.getTransactionCount()||r.getTransactionCount()>2)throw new A("Invalid credential biography, transaction signature mismatch.");if(1==r.getTransactionCount()){if(!(yield n.getRequest().isValid()))throw new A("Invalid credential biography, transaction signature mismatch.");return null}{let t=r.getTransaction(1).getRequest().getCredential(),e=new class extends oY{constructor(t){super(),this.constructWithIDChainRequest(t)}getCredential(){return t}}(n.getRequest());if(!(yield e.isValid()))throw new A("Invalid credential biography, transaction signature mismatch.")}n=r.getTransaction(1)}else if(r.getStatus().equals(oj.NOT_FOUND))return null;if(!n.getRequest().getOperation().equals(ok.Operation.DECLARE))throw new A("Invalid credential transaction, unknown operation.");if(!(yield n.getRequest().isValid()))throw new A("Invalid credential transaction, signature mismatch.");let o=n.getRequest().getCredential(),s=new tZ(o.getId());return s.setTransactionId(n.getTransactionId()),s.setPublished(n.getTimestamp()),r.getStatus()==oj.REVOKED&&s.setRevoked(!0),o.setMetadata(s),o})}listCredentials(t,e,i){return E(this,void 0,void 0,function*(){o1.info("List credentials for {}",t);let r=new oJ(this.generateRequestId());r.setParameters(t,e,i);let n=yield this.resolve(r);return null==n||0==n.size()?null:n.getCredentialIds()})}createTransaction(t,e){return E(this,void 0,void 0,function*(){o1.info("Create ID transaction...");let i=t.serialize(!0);o1.trace("Transaction payload: '{}'",i),null==e&&(e=this.getAdapter()),yield e.createIdTransaction(i,null),o1.info("ID transaction complete.")})}invalidDidCache(t){let e=new oL(this.generateRequestId());e.setParameters(t,!0),this.cache.invalidate(e),e.setParameters(t,!1),this.cache.invalidate(e)}invalidCredentialCache(t,e){let i=new oq(this.generateRequestId());i.setParameters(t,e),this.cache.invalidate(i),null!=e&&(i.setParameters(t,null),this.cache.invalidate(i))}clearCache(){this.cache.invalidateAll()}createDid(t,e,i,r){return E(this,void 0,void 0,function*(){let n=yield oz.create(t,e,i);yield this.createTransaction(n,r),this.invalidDidCache(t.getSubject())})}updateDid(t,e,i,r,n){return E(this,void 0,void 0,function*(){let o=yield oz.update(t,e,i,r);yield this.createTransaction(o,n),this.invalidDidCache(t.getSubject())})}transferDid(t,e,i,r,n){return E(this,void 0,void 0,function*(){let o=yield oz.transfer(t,e,i,r);yield this.createTransaction(o,n),this.invalidDidCache(t.getSubject())})}deactivateDid(t,e,i,r){return E(this,void 0,void 0,function*(){let n=yield oz.deactivate(t,e,i);yield this.createTransaction(n,r),this.invalidDidCache(t.getSubject())})}deactivateTargetDid(t,e,i,r,n,o){return E(this,void 0,void 0,function*(){let s=yield oz.deactivateTarget(t,e,i,r,n);yield this.createTransaction(s,o),this.invalidDidCache(t.getSubject())})}declareCredential(t,e,i,r,n){return E(this,void 0,void 0,function*(){let o=yield oY.declare(t,e,i,r);yield this.createTransaction(o,n),this.invalidCredentialCache(t.getId(),null),this.invalidCredentialCache(t.getId(),t.getIssuer())})}revokeCredential(t,e,i,r,n){return E(this,void 0,void 0,function*(){if(t instanceof t0){let o=yield oY.revoke(t,e,i,r);yield this.createTransaction(o,n),this.invalidCredentialCache(t.getId(),null),this.invalidCredentialCache(t.getId(),t.getIssuer())}else{let o=yield oY.revoke(t,e,i,r);yield this.createTransaction(o,n),this.invalidCredentialCache(t,null),this.invalidCredentialCache(t,e.getSubject())}})}}o2.DEFAULT_CACHE_INITIAL_CAPACITY=16,o2.DEFAULT_CACHE_MAX_CAPACITY=64,o2.DEFAULT_CACHE_TTL=6e5,o2.instance=null;let o5=new b("DefaultDIDAdapter");class o3{constructor(t){tj(t&&null!=t,"Invalid resolver URL");let e=null;switch(t.toLowerCase()){case"mainnet":t=o3.MAINNET_RPC_ENDPOINTS[0],e=o3.MAINNET_RPC_ENDPOINTS;break;case"testnet":t=o3.TESTNET_RPC_ENDPOINTS[0],e=o3.TESTNET_RPC_ENDPOINTS}try{this.rpcEndpoint=new URL(t)}catch(t){throw new _("Invalid resolver URL",t)}e&&this.checkNetwork(e).then(()=>{o5.info("finished the network check")}).catch(t=>{o5.error("check the network error: "+t)})}checkEndpoint(t){return E(this,void 0,void 0,function*(){let e={},i=Date.now();e.id=i,e.jsonrpc="2.0",e.method="eth_blockNumber";let r,n=JSON.stringify(e),o=Date.now();try{r=yield this.performRequest(t,n);let e=Date.now()-o;if(r.id!=i)throw new t_("Invalid JSON RPC id.");let s=r.result;s.startsWith("0x")&&(s=s.substring(2));let a=parseInt(s,16);return new o3.CheckResult(t,e,a)}catch(e){return o5.info("Checking the resolver {}...error",t),o3.CheckResult.from(t)}})}checkNetwork(t){return E(this,void 0,void 0,function*(){let e=[],i=[];for(let r of t){let t=this.checkEndpoint(new URL(r)).then(t=>{e.push(t)});i.push(t)}try{yield Promise.all(i)}catch(t){}e.length>0&&t1.sort(e);let r=e[0];r.available()&&(this.rpcEndpoint=r.endpoint)})}performRequest(t,e){return new Promise((i,r)=>{m({method:"post",url:t.toString(),maxRedirects:5,headers:{"Content-Type":"application/json",Accept:"application/json"},data:e,timeout:6e3}).then(t=>{t.status>=200&&t.status<400?i(t.data):r(new tp("HTTP error"))}).catch(t=>{r(new tp("HTTP timeout."))})})}resolve(t){return E(this,void 0,void 0,function*(){tj(t&&null!=t,"Invalid request");try{return yield this.performRequest(this.rpcEndpoint,t)}catch(t){throw new tf("Network error: "+t)}})}createIdTransaction(t,e){throw new td("Not implemented")}}o3.MAINNET_RPC_ENDPOINTS=["https://api.elastos.io/eid","https://api.trinity-tech.io/eid"],o3.TESTNET_RPC_ENDPOINTS=["https://api-testnet.elastos.io/eid","https://api-testnet.trinity-tech.io/eid"],function(t){class e{constructor(t,e,i){this.endpoint=t,this.latency=e,this.lastBlock=i}static from(t){return new e(t,-1,-1)}equals(t){return 0==this.compareTo(t)}compareTo(t){if(null==t)return -1;if(t.latency<0&&this.latency<0)return 0;if(t.latency<0||this.latency<0)return this.latency<0?1:-1;let i=t.lastBlock.valueOf()-this.lastBlock.valueOf();return Math.abs(i)-e.MAX_DIFF>0||this.latency==t.latency?i>0?1:-1:this.latency-t.latency}available(){return this.latency>=0}}e.MAX_DIFF=10,t.CheckResult=e}(o3||(o3={}));class o6 extends o3{constructor(t){super(new URL("/resolve",new URL(t)).toString()),this.serverURL=new URL(t),this.idtxEndpoint=new URL("/idtx",this.serverURL)}createIdTransaction(t,e){return E(this,void 0,void 0,function*(){tj(null!==t&&t.length>0,"Invalid payload");try{yield this.performRequest(this.idtxEndpoint,t)}catch(t){throw new tm("Create ID transaction failed.",t)}})}resetData(){return E(this,void 0,void 0,function*(){let t=new URL("/reset",this.serverURL);yield this.performRequest(t)})}}class o8{constructor(t={}){this.count=0,this.items=new Map,this.first=null,this.last=null,this.options=Object.assign({maxItems:void 0,maxAge:void 0,loader:void 0},t),this.invalidateAll()}put(t,e,i){this.putInternal(t,e,i)}putInternal(t,e,i){let r=this.getHash(t),n=this.items.get(r);if(n)n.value=e;else{let r=this.getHash(t);n={key:t,value:e,prev:null,next:null,meta:i},this.items.set(r,n),this.count++}return this.options.maxAge&&(n.expires=Date.now()/1e3+this.options.maxAge),this.promote(n),this.options.maxItems&&this.count>this.options.maxItems&&this.invalidate(this.last.key),n}getHash(t){return"string"==typeof t?t:t.hashCode().toString()}get(t,e){let i=this.getHash(t),r=this.items.get(i);if(r&&r.expires&&Date.now()/1e3>=r.expires&&(this.invalidate(t),r=null),!r){let i=null;if(e?i=e:this.options.loader&&(i=this.options.loader),i){let{value:e,meta:n}=i(t);null!=e&&(r=this.putInternal(t,e,n))}if(!r)return null}return this.promote(r),r.value}getAsync(t,e){return E(this,void 0,void 0,function*(){let i=this.getHash(t),r=this.items.get(i);if(r&&r.expires&&Date.now()/1e3>=r.expires&&(this.invalidate(t),r=null),!r){let i=null;if(e?i=e:this.options.asyncLoader&&(i=this.options.asyncLoader),i){let{value:e,meta:n}=yield i(t);null!=e&&(r=this.putInternal(t,e,n))}if(!r)return null}return this.promote(r),r.value})}invalidateAll(t){t?this.items.forEach((e,i,r)=>{t(e.key)&&this.invalidate(e.key)}):(this.items.clear(),this.first=null,this.last=null,this.count=0)}invalidate(t){let e=this.getHash(t),i=this.items.get(e);return!!i&&(this.count--,this.items.delete(e),i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),i===this.first&&(this.first=i.next),i===this.last&&(this.last=i.prev),!0)}has(t){let e=this.getHash(t),i=this.items.get(e);return!!i&&!(i.expires&&Date.now()/1e3>=i.expires)}promote(t){t!==this.first&&(t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.last&&(this.last=t.prev),t.prev=null,t.next=this.first,this.first&&(this.first.prev=t),this.first=t,this.last||(this.last=t))}getMeta(t){let e=this.getHash(t),i=this.items.get(e);return i?i.expires&&Date.now()/1e3>=i.expires?(this.invalidate(t),null):(this.promote(i),i.meta):null}}if("undefined"!=typeof window){if("elastos_did_ver"in window)throw Error("Elastos DID sdk("+window.elastos_did_ver+") already loaded.");window.elastos_did_ver="2.3.1"}}}]);