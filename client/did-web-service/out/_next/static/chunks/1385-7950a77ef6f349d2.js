"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1385],{7045:function(e,t,n){var i,r,a,s=n(2265);function l(){return(l=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}t.Z=function(e){return s.createElement("svg",l({xmlns:"http://www.w3.org/2000/svg",fill:"#fff",className:"account_svg__icon",viewBox:"0 0 1024 1024"},e),i||(i=s.createElement("path",{d:"M962.4 1012.8s0 .8 0 0H988h-25.6zM704 338.4c0-143.2-115.2-260-258.4-260s-258.4 116.8-258.4 260 116 260 258.4 260S704 481.6 704 338.4zm-472 0C232 220 328 124 445.6 124s213.6 96 213.6 214.4-96 214.4-213.6 214.4S232 456.8 232 338.4z"})),r||(r=s.createElement("path",{d:"M456.8 621.6c196.8 0 361.6 136 394.4 324h45.6C863.2 732 677.6 576.8 456 576.8 234.4 576.8 49.6 732 15.2 945.6h45.6c35.2-188.8 199.2-324 396-324z"})),a||(a=s.createElement("path",{d:"m770.4 578.4-24-8.8 20.8-14.4c65.6-46.4 104.8-122.4 103.2-202.4-1.6-128-102.4-232.8-228-241.6v47.2c100 8.8 180 92.8 180.8 194.4.8 52.8-19.2 102.4-56 140.8-36.8 37.6-86.4 59.2-139.2 60-24.8 0-50.4 0-75.2 1.6-15.2 1.6-41.6 0-54.4 9.6-1.6.8-3.2 0-4.8 0l-9.6 12c-.8 1.6-2.4 3.2-4 4.8.8 1.6-.8 16 0 17.6 12 4 71.2 0 156.8 2.4C816 603.2 963.2 762.4 977.6 940l47.2 3.2c-9.6-156-108-310.4-254.4-364.8z"})))}},87127:function(e,t,n){var i,r=n(2265);function a(){return(a=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}t.Z=function(e){return r.createElement("svg",a({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 -2.5 20 20"},e),i||(i=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M10 12.474 0 3.649V15h20V3.649l-10 8.825Zm.001-2.662L0 .981V0h20v.981l-9.999 8.831Z"})))}},12131:function(e,t,n){n.d(t,{c:function(){return l}});var i=n(57437),r=n(6882),a=n(49050),s=n(57042);let l=e=>{let{leftIcon:t,size:n="medium",mode:l="default",onClick:o,children:c,busy:d=!1,disabled:u=!1,className:h}=e,y=(0,i.jsx)(r.Z,{size:16});return(0,i.jsx)("div",{className:(0,s.Z)("flex",h),children:(0,i.jsx)(a.Z,{className:"flex-1",startIcon:d?y:t,disabled:d||u,size:n,color:"default"===l?"primary":"error",variant:"contained",onClick:o,children:c})})}},57135:function(e,t,n){n.d(t,{au:function(){return x},HL:function(){return T},lJ:function(){return $},NX:function(){return E}});var i,r,a=n(57437),s=n(451),l=n(66533),o=n(48023),c=n(10530),d=n(22079),u=n(43226),h=n(51385),y=n(21290),g=n(3883),p=n(52856),v=n(69990),f=n(2265),w=n(27524),m=n(50676),I=n(12131);let b=e=>{let{onConfirm:t,disabled:n}=e,[i]=(0,s.V)(v.jU),r=null==i?void 0:i.get("security"),l=async()=>{let e=await r.unlockPasskeyLocally();t(e)};return(0,a.jsxs)("div",{className:"flex flex-row gap-4 bg-gray-100 mt-4 p-4 items-center",children:[(0,a.jsxs)("p",{className:"uppercase text-xs",children:["Browser",(0,a.jsx)("br",{}),"authentication"]}),(0,a.jsx)(I.c,{onClick:l,disabled:n,children:"Unlock with passkey"})]})};var D=n(67212);let k=e=>{let{onConfirm:t,disabled:n}=e,[i,r]=(0,f.useState)("");return(0,a.jsxs)("div",{className:"flex flex-row gap-4 bg-gray-100 mt-4 p-4",children:[(0,a.jsxs)("p",{className:"uppercase text-xs",children:["master",(0,a.jsx)("br",{}),"password"]}),(0,a.jsx)(D.Z,{label:"Your password",autoFocus:!0,type:"password",name:"master-password",variant:"outlined",size:"small",onChange:e=>{r(e.currentTarget.value)},disabled:n}),(0,a.jsx)(I.c,{onClick:()=>{t(i)},disabled:n||!i,children:"Continue"})]})},S=(0,f.createContext)({actions:null,setActions:null}),C=new w.x;function x(e){let[t,n]=(0,f.useState)(null);return(0,a.jsxs)(S.Provider,{value:{actions:t,setActions:n},children:[e.children,(0,a.jsx)(A,{})]})}let A=()=>{let{actions:e,setActions:t}=(0,f.useContext)(S),[n]=(0,s.V)(v.jU),i=null==n?void 0:n.get("security"),[r]=(0,s.V)(null==i?void 0:i.passwordKeys$),[l]=(0,s.V)(null==i?void 0:i.passkeyKeys$),{promptMasterKeyUnlock:o}=$(),h=()=>{t(null)};return(0,f.useEffect)(()=>{let e=C.subscribe(e=>{j(e,o)});return()=>e.unsubscribe()},[o]),(0,a.jsx)(d.Z,{open:!!e,disablePortal:!0,onClose:()=>{var t;null===(t=e.onUnlockKey)||void 0===t||t.call(e,null),h()},children:(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsx)(u.Z,{variant:"h4",children:"Content unlock needed!"}),(0,a.jsxs)(u.Z,{color:"#666",fontSize:14,children:["Your encrypted data needs to be unlocked so we can display it.",(0,a.jsx)("br",{}),"We can't do this without your interaction."]}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)(k,{onConfirm:t=>{var n;null===(n=e.onUnlockKey)||void 0===n||n.call(e,{type:c.J.PASSWORD,keyId:"unused-for-now-for-passwords",key:t}),h()},disabled:(null==r?void 0:r.length)==0})}),(0,a.jsx)("div",{className:"my-4 text-center text-xs",children:"or"}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)(b,{onConfirm:t=>{var n;null===(n=e.onUnlockKey)||void 0===n||n.call(e,t),h()},disabled:(null==l?void 0:l.length)==0})})]})})};(i=r||(r={}))[i.Idle=0]="Idle",i[i.UnlockCancelled=1]="UnlockCancelled";let P=new m.X(r.Idle);function E(){let[e]=(0,s.V)(P),[t,n]=(0,f.useState)(!0),[i,a]=(0,f.useState)(!1);return(0,f.useEffect)(()=>{switch(e){case r.Idle:n(!0),a(!1);break;case r.UnlockCancelled:n(!1),a(!0)}},[e]),{unlockerIsIdle:t,unlockerIsCancelled:i}}let $=()=>{let{setActions:e}=(0,f.useContext)(S),[t]=(0,s.V)(v.jU);return{promptMasterKeyUnlock:()=>new Promise(t=>{e({onUnlockKey:t})}),retryUnlock:()=>T(()=>t.get("security").checkRemoteUnlockStatus())}};async function T(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,i=new Promise((t,n)=>{P.next(r.Idle),C.next({method:e,resolve:t,reject:n})}).catch(e=>{if(t&&(0,p.L)(e));else throw e});return await i||n}async function j(e,t){try{let t=await (0,h.Pt)(()=>e.method());e.resolve(t)}catch(n){if(n instanceof l._&&(0,p.z)(n)){g.k.warn("security","This method call requires unlock authorization from the user. Prompting");let n=await t();if(n){await (0,y.wo)(n);let t=await T(e.method);e.resolve(t)}else P.next(r.UnlockCancelled),g.k.warn("security","Unlock operation cancelled by user"),e.reject(l._.newClientError(o.XF.UnlockKeyCancelled,"CANCELLED"))}else g.k.error("security","Unhandler callWithUnlock() exception:",n)}}},451:function(e,t,n){n.d(t,{V:function(){return r}});var i=n(2265);let r=e=>{let[t,n]=(0,i.useState)(null==e?void 0:e.getValue()),[r,a]=(0,i.useState)();return(0,i.useEffect)(()=>{if(!e){n(null);return}let t=e.subscribe({next:e=>{n(e)},error:a});return()=>t.unsubscribe()},[e]),[t]}},29281:function(e,t,n){var i,r;n.d(t,{T:function(){return i}}),(r=i||(i={})).VC_CREATED="VC_CREATED",r.VC_IMPORTED="VC_IMPORTED",r.VC_SHARED="VC_SHARED",r.VC_SIGNED_BY_THIRD_APP="VC_SIGNED_BY_THIRD_APP",r.DID_CREATED="DID_CREATED",r.DID_DELETED="DID_DELETED",r.SIGNED_IN="SIGNED_IN"},99617:function(e,t,n){n.d(t,{A:function(){return c}});var i=n(10530),r=n(20708),a=n(69990),s=n(1859),l=n(6598);let o=new l.R;class c{static async fromJson(e){return o.get(e.id,{create:async function(){return new c},fill:async function(t){Object.assign(t,e),t.createdAt=new Date(e.createdAt),t.lastUsedAt=new Date(e.lastUsedAt)}})}isCurrentBrowser(){return this.key===(0,r.Z$)()}equals(e){return this.id===(null==e?void 0:e.id)}constructor(){this.activeShadowKey$=new s.P(null,async()=>{a.jU.subscribe(e=>null==e?void 0:e.get("security").shadowKeys$.subscribe(e=>{this.activeShadowKey$.next(e.find(e=>{var t;return e.type===i.J.WEBAUTHN&&(null===(t=e.browser)||void 0===t?void 0:t.equals(this))}))}))})}}},69144:function(e,t,n){n.d(t,{C:function(){return o},q:function(){return l}});var i=n(59606),r=n(35324),a=n(1968),s=n(5676);async function l(e){let t;let{VerifiableCredential:n}=await (0,r.hS)(),l=n.parse(e.verifiableCredential),o=(0,i.m7)(l.type);return Object.assign(t=o?new s.E(o):new a.h,e),t.createdAt=new Date(e.createdAt),t.verifiableCredential=l,t.prepareForDisplay(),t}async function o(e){let t;let n=(0,i.m7)(e.type);return(t=n?new s.E(n):new a.h).verifiableCredential=e,t.prepareForDisplay(),t}},1968:function(e,t,n){n.d(t,{h:function(){return w}});var i=n(7045),r=n(90786),a=n(17041),s=n(59606),l=n(53932),o=n(87401),c=n(8106),d=n(3883),u=n(1859);let h=(e,t)=>{t=(t=t.replace(/\[(\w+)\]/g,".$1")).replace(/^\./,"");let n=t.split(".");for(let t=0,i=n.length;t<i;++t){let i=n[t];if(!(i in e))return;e=e[i]}return e};var y=n(9177),g=n(50676),p=n(57437),v=n(87127);let f={name:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),email:(0,p.jsx)(v.Z,{style:{width:35,height:35,color:"white"}}),birthDate:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),nationality:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),gender:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),telephone:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),nickname:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),birthPlace:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),occupation:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),education:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),interests:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),description:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),url:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),discord:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),linkedin:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),facebook:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),instagram:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),twitter:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),snapchat:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),telegram:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),wechat:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),weibo:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),twitch:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),elaAddress:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),wallet:(0,p.jsx)(i.Z,{style:{width:35,height:35}}),default:(0,p.jsx)(i.Z,{style:{width:35,height:35}})};class w{prepareForDisplay(){this.prepareDisplayTitle(),this.prepareDisplayValue(),this.prepareIcon()}getDisplayableCredentialTitle(){let e=this.verifiableCredential.getSubject();if(!("displayable"in e))return null;this.displayTitle=e.displayable.title}prepareDisplayTitle(){let e=this.getDisplayableCredentialTitle();if(e)this.displayTitle=e;else{let e=this.verifiableCredential.getId().getFragment();this.displayTitle=(0,y.fm)(e)}}getDisplayableCredentialDescription(){let e=this.verifiableCredential.getSubject().getProperties();if(!("displayable"in e))return null;{let t=e.displayable.description;if(t){let n=t.match(/\${([a-zA-Z0-9.]+)}/g),i=n?Array.from(n):[],r=t;for(let t of i){let n=t.match(/\${([a-zA-Z0-9.]+)}/);if(n&&n.length>1){let i=n[1],a=h(e,i);r=r.replace(t,a)}}return r}}}prepareDisplayValue(){let e=this.getDisplayableCredentialDescription();if(e)this.displayValue=e;else{let e=this.getValueItems();if(e.length<=1){var t;this.displayValue=null===(t=e[0])||void 0===t?void 0:t.value}else this.displayValue=JSON.stringify(e)}}getDisplayValue(){return this.displayValue}async prepareIcon(){var e;l.B.value;let t=this.verifiableCredential.getSubject().getProperties();if(this.hasRemotePictureToFetch()){if(t.avatar&&(null===(e=t.avatar)||void 0===e?void 0:e.data)){let e=t.avatar.data;if(e.startsWith("hive://")){let t=await (0,a.L)(e);t?(d.k.log("credential","Got picture data from hive"),this.representativeIcon$.next(t)):(d.k.log("idencredentialtity","Got empty picture data from the hive cache service (real picture may come later)"),this.representativeIcon$.next(null)),this.loadIconWithFallback()}else console.warn("Unhandled avatar credentials format")}}else{if("displayable"in t)this.representativeIcon$.next(t.displayable.icon);else{let e=this.verifiableCredential.getType(),t=(0,s.m7)(e),n=null==t?void 0:t.key,i=f[n];this.representativeIcon$.next(i)}this.loadIconWithFallback()}}loadIconWithFallback(){if(null==this.representativeIcon$.value&&this.representativeIcon$.next(this.getFallbackIcon()),(0,y.Y5)(this.representativeIcon$.value))return;let e=new Image;e.crossOrigin="anonymous",e.onload=()=>{var t;this.representativeIcon$.next(e.src),null===(t=this.onIconReadyCallback)||void 0===t||t.call(this,this.representativeIcon$.value)},e.onerror=()=>{var e;this.representativeIcon$.next(this.getFallbackIcon()),null===(e=this.onIconReadyCallback)||void 0===e||e.call(this,this.representativeIcon$.value)},e.src=this.representativeIcon$.value}getFallbackIcon(){return this.isUserAvatar(),i.Z}hasRemotePictureToFetch(){let e=this.verifiableCredential.getId().getFragment();return"avatar"===e}isUserAvatar(){let e=this.verifiableCredential.getId().getFragment();return"avatar"===e}getDisplayableTitle(){return this.displayTitle}onIconReady(e){this.onIconReadyCallback=e}getSubject(){return this.verifiableCredential.getSubject()}getFragment(){return this.verifiableCredential.getId().getFragment()}getTypes(){return this.verifiableCredential.getType()}getId(){return this.verifiableCredential.getId()}isSensitiveCredential(){return this.verifiableCredential.getType().indexOf("SensitiveCredential")>=0}selfIssued(){return this.verifiableCredential.getIssuer().toString()===o.D.getActiveIdentityId()}getIssuer(){return this.verifiableCredential.getIssuer().toString()}async fetchIssuerInfo(){let e=this.verifiableCredential.getIssuer().toString();d.k.log("credential","fetchIssuerInfo:",e);let t=null,n=null,i=await c.n.isPublished(e);i&&(t=await c.n.getIssuerName(e),n=await c.n.getIssuerAvatar(e));let r={avatarIcon:n,didString:e,name:t,isPublished:i};return d.k.log("credential","got issuer info:",r),r}async verifyCredential(){return await r.N.verifyCredential(this.verifiableCredential)}equals(e){return this.id===e.id}constructor(){this.issuerInfo$=new u.P(null,()=>this.fetchIssuerInfo()),this.isConform$=new u.P(null,()=>this.verifyCredential()),this.representativeIcon$=new g.X(null),this.id=null,this.createdAt=null,this.displayValue=null,this.onIconReadyCallback=null,this.getValueItems=()=>{let e=this.verifiableCredential.getId().getFragment();if("avatar"===e)return null;let t=this.verifiableCredential.getSubject().getProperties();return Object.keys(t).filter(e=>"id"!=e).filter(e=>"displayable"!=e).sort().map(e=>{let n="";return"wallet"==e?(n="wallet",t[e]):"gender"==e?"M"==t[e]||"male"==t[e]?n="male":("F"==t[e]||"female"==t[e])&&(n="female"):n=""!=t[e].toString()?t[e].toString():"not set",{name:e,value:n}})}}}},5676:function(e,t,n){n.d(t,{E:function(){return a}});var i=n(9177),r=n(1968);class a extends r.h{prepareDisplayTitle(){let e=this.getDisplayableCredentialTitle();e?this.displayTitle=e:this.displayTitle=(0,i.fm)(this.profileInfo.key)}prepareDisplayValue(){this.displayValue=this.profileInfo.options.converter.toDisplayableValue(this)}getProfileInfo(){return this.profileInfo}constructor(e){super(),this.profileInfo=e}}},66533:function(e,t,n){n.d(t,{_:function(){return i}});class i{static fromJson(e){if(!i.isCustomException(e))return null;let t=new i;return Object.assign(t,e),t.timestamp=new Date(e.timestamp),t}static isCustomException(e){return"object"==typeof e&&"source"in e&&"api"===e.source}static newClientError(e,t){let n=new i;return n.message=t,n.appExceptionCode=e,n.statusCode=-1,n.timestamp=new Date,n.source="client",n}}},48023:function(e,t,n){var i,r,a,s,l,o,c,d;n.d(t,{Wg:function(){return i},XF:function(){return s},gs:function(){return r}}),(l=i||(i={}))[l.SomethingTodo=10101]="SomethingTodo",l[l.AuthError=10102]="AuthError",l[l.EmailAlreadyExists=10103]="EmailAlreadyExists",l[l.EmailNotExists=10104]="EmailNotExists",l[l.AuthKeyNotExists=10105]="AuthKeyNotExists",l[l.Unspecific=10199]="Unspecific",(o=r||(r={}))[o.DatabaseError=10201]="DatabaseError",o[o.InvalidKeyRingConfig=10202]="InvalidKeyRingConfig",o[o.KeyRingNotExists=10203]="KeyRingNotExists",o[o.KeyNotExists=10204]="KeyNotExists",o[o.InvalidChallengeId=10205]="InvalidChallengeId",o[o.InvalidAuthKey=10206]="InvalidAuthKey",o[o.CanNotRemoveKey=10207]="CanNotRemoveKey",o[o.WebAuthnVerifyError=20208]="WebAuthnVerifyError",o[o.WrongPassword=10209]="WrongPassword",o[o.Unauthorized=10210]="Unauthorized",(c=a||(a={}))[c.DIDStorageError=10301]="DIDStorageError",c[c.MnemonicError=10302]="MnemonicError",c[c.DIDAlreadyExists=10303]="DIDAlreadyExists",c[c.DIDNotExists=10304]="DIDNotExists",c[c.CredentialAlreadyExists=10305]="CredentialAlreadyExists",c[c.CredentialNotExists=10306]="CredentialNotExists",c[c.InvalidCredential=10307]="InvalidCredential",c[c.DIDNotUpToDateError=10308]="DIDNotUpToDateError",c[c.DIDTransactionError=10309]="DIDTransactionError",c[c.NetworkError=10310]="NetworkError",(d=s||(s={}))[d.OtherApolloError=10901]="OtherApolloError",d[d.OtherAxiosError=10902]="OtherAxiosError",d[d.UnlockKeyCancelled=10903]="UnlockKeyCancelled"},1349:function(e,t,n){n.d(t,{E:function(){return i}});class i extends Error{}},10343:function(e,t,n){n.d(t,{h:function(){return i}});class i extends Error{}},18093:function(e,t,n){n.d(t,{t:function(){return i}});let i="\n  id\n  key\n  createdAt\n  lastUsedAt\n  userAgent\n  name\n"},5344:function(e,t,n){n.d(t,{j:function(){return r}});var i=n(18093);let r="\n  createdAt\n  updatedAt\n  keyId\n  key\n  type\n  browser { ".concat(i.t," }\n")},10530:function(e,t,n){var i,r;n.d(t,{J:function(){return i}}),(r=i||(i={})).PASSWORD="PASSWORD",r.WEBAUTHN="WEBAUTHN"},95640:function(e,t,n){n.d(t,{M:function(){return s}});var i=n(99617),r=n(6598);let a=new r.R;class s{static async fromJson(e){return a.get(e.keyId,{create:async()=>new s,async fill(t){Object.assign(t,e),t.createdAt=new Date(e.createdAt),t.updatedAt=new Date(e.updatedAt),e.browser&&(t.browser=await i.A.fromJson(e.browser))}})}equals(e){return this.keyId===e.keyId}}},63863:function(e,t,n){n.d(t,{lu:function(){return w},zl:function(){return v},qR:function(){return f}});var i=n(60230),r=n(23965),a=n(48023);class s{static fromJson(e,t){let n=Object.assign(new s,e);return n.user=t,n}}var l=n(51385),o=n(76506),c=n(3883),d=n(1859);function u(){let e=(0,i._)(["\n                query FetchUserEmails {\n                  fetchUserEmails {\n                    ","\n                  }\n                }\n                "]);return u=function(){return e},e}function h(){let e=(0,i._)(["\n                query RemoveUserEmail($id: String!) {\n                  removeUserEmail(id: $id)\n                }\n                "]);return h=function(){return e},e}function y(){let e=(0,i._)(["\n                mutation BindOauthEmail($email: String!) {\n                  bindOauthEmail(email: $email)\n                }\n                "]);return y=function(){return e},e}function g(){let e=(0,i._)(["\n                    mutation CheckEmailBind($authKey: String!) {\n                        checkEmailBind(authKey: $authKey) { accessToken refreshToken }\n                    }\n                "]);return g=function(){return e},e}function p(){let e=(0,i._)(["\n                    mutation BindWithEmailAddress($emailAddress: String!) {\n                        bindWithEmailAddress(emailAddress: $emailAddress) { success }\n                    }\n                "]);return p=function(){return e},e}function v(e){return e.appExceptionCode===a.Wg.EmailAlreadyExists}function f(e){return e.appExceptionCode===a.Wg.EmailNotExists}class w{async fetchUserEmails(){var e;c.k.log("user","Fetching user emails.");let t=await (0,l.Pt)(async()=>(await (0,o.W)()).query({query:(0,r.Ps)(u(),"id email createdAt")}));return(null==t?void 0:null===(e=t.data)||void 0===e?void 0:e.fetchUserEmails)?t.data.fetchUserEmails.map(e=>s.fromJson(e,this.user)):(console.error("user","can not fetch user emails."),null)}async removeUserEmail(e){var t,n;c.k.log("user","remove user email.");let i=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(h()),variables:{id:e}}));return(null==i?void 0:null===(t=i.data)||void 0===t?void 0:t.removeUserEmail)||console.error("user","can not remove user email."),null==i?void 0:null===(n=i.data)||void 0===n?void 0:n.removeUserEmail}async bindOauthEmail(e){var t;c.k.log("user","Bind oauth email address");let n=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(y()),variables:{email:e}}));return(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.bindOauthEmail)||c.k.error("user","Failed from bindOauthEmail api."),null==n?void 0:n.data.bindOauthEmail}async checkRawEmailBind(e){var t;c.k.log("user","Checking temporary authentication key for email bind.");let n=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(g()),variables:{authKey:e}}));return null!=n&&null!==(t=n.data)&&void 0!==t&&!!t.checkEmailBind||(c.k.error("Failed to check email bind"),!1)}async bindWithEmailAddress(e){c.k.log("user","Sending request to authentication by email"),await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(p()),variables:{emailAddress:e}}))}constructor(e){this.user=e,this.userEmails$=new d.P([],()=>this.fetchUserEmails())}}},8062:function(e,t,n){n.d(t,{n:function(){return R}});var i=n(60230),r=n(23965);let a="id type content createdAt";var s=n(29281),l=n(62067),o=n.n(l);class c{static fromJson(e){let t=new c;return Object.assign(t,e)}getCreatedAtStr(){return o()(this.createdAt).format("DD-MMM-YYYY HH:mm:ss")}getDescription(){switch(this.type){case s.T.SIGNED_IN:if("RAW_EMAIL"===this.content.type)return"Signed in with raw email.";if("OAUTH_MICROSOFT"===this.content.type)return"Signed in with Microsoft oauth email.";return"Signed in with handled type ".concat(this.content.type);case s.T.DID_CREATED:return"DID ".concat(this.content.did," created");case s.T.DID_DELETED:return"DID ".concat(this.content.did," deleted");case s.T.VC_CREATED:return"Verified credential created from DID ".concat(this.content.did);case s.T.VC_IMPORTED:return"Verified credential imported to DID ".concat(this.content.did)}return""}}var d=n(76506),u=n(3883),h=n(1859);function y(){let e=(0,i._)(["\n        query Activities {\n            activities {\n                ","\n            }\n        } "]);return y=function(){return e},e}function g(){let e=(0,i._)(["\n        mutation CreateActivity($input: CreateActivityInput!) {\n            createActivity(input: $input) {\n                ","\n            }\n        } "]);return g=function(){return e},e}function p(){let e=(0,i._)(["\n        mutation UpdateActivity($input: UpdateActivityInput!) {\n            updateActivity(input: $input) {\n                ","\n            }\n        } "]);return p=function(){return e},e}class v{async fetchActivities(){u.k.log("activity","Fetch activities");let{data:e}=await (await (0,d.W)()).query({query:(0,r.Ps)(y(),a)});if(e)return u.k.log("activity","Get activities",e.activities),e.activities.map(e=>c.fromJson(e));throw Error("Can not get activities.")}async createActivity(e,t){var n;u.k.log("activity","Create activity");let i=await (await (0,d.W)()).mutate({mutation:(0,r.Ps)(g(),a),variables:{input:{type:e,content:t}}});return(null==i?void 0:null===(n=i.data)||void 0===n?void 0:n.createActivity)?(u.k.log("activity","Create activities",i.data.createActivity),c.fromJson(i.data.createActivity)):(u.k.error("activity","Failed to create activity"),null)}async updateActivity(e,t,n){var i;u.k.log("activity","Update activity");let s=await (await (0,d.W)()).mutate({mutation:(0,r.Ps)(p(),a),variables:{input:{id:e,type:t,content:n}}});if(null==s?void 0:null===(i=s.data)||void 0===i?void 0:i.activity)return u.k.log("activity","Update activities",s.data.activity),c.fromJson(s.data.activity);throw Error("Can not update activity.")}constructor(e){this.user=e,this.activities$=new h.P([],()=>this.fetchActivities())}}var f=n(63863),w=n(51385),m=n(9177),I=n(50676),b=n(18093),D=n(99617);function k(){let e=(0,i._)(["\n        query ListBrowsers {\n          browsers {\n            ","\n          }\n        }\n      "]);return k=function(){return e},e}function S(){let e=(0,i._)(["\n        mutation deleteBrowser($browserId: String!) {\n          deleteBrowser(browserId: $browserId)\n        }\n      "]);return S=function(){return e},e}class C{async fetchBrowsers(){var e;u.k.log("devices","Fetching user browsers");let t=await (0,w.Pt)(async()=>(await (0,d.W)()).query({query:(0,r.Ps)(k(),b.t)}));if(null==t?void 0:null===(e=t.data)||void 0===e?void 0:e.browsers){let e=await Promise.all(t.data.browsers.map(e=>D.A.fromJson(e)));return u.k.log("browsers","Fetched browsers:",e),e}return null}async deleteBrowser(e){var t;u.k.log("browsers","Deleting browser");let n=await (0,w.Pt)(async()=>(await (0,d.W)()).mutate({mutation:(0,r.Ps)(S()),variables:{browserId:e}}));if(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.deleteBrowser)return this.browsers$.next(this.browsers$.value.filter(t=>t.id!=e)),!0;throw Error("Failed to delete Browser")}constructor(e){this.user=e,this.browsers$=new h.P([],()=>this.fetchBrowsers())}}var x=n(12540),A=n(87401);class P{async createIdentity(e){u.k.log("identities","Creating a new identity",e);let t=(0,x.zV)(),n=await A.D.createIdentity(e,t);return this.identities$.next([n,...this.identities$.value]),n}async deleteIdentity(e){u.k.log("identities","Deleting identity");let t=await A.D.deleteIdentity(e);return this.identities$.next(this.identities$.value.filter(t=>t.did!=e)),t}async createDIDPublishTransaction(e){return u.k.log("identities","Creating identity publication transaction"),await A.D.createDIDPublishTransaction(e)}async publishIdentity(e,t){return u.k.log("identities","Publishing identity"),await A.D.publishIdentity(e,t)}async fetchIdentities(){return u.k.log("identities","Fetching identities"),A.D.listIdentities()}constructor(e){this.user=e,this.identities$=new h.P([],()=>this.fetchIdentities())}}var E=n(57135),$=n(5344),T=n(95640),j=n(10530),U=n(21290),F=n(2512),_=n(45685),N=n(67133).Buffer;function O(){let e=(0,i._)(["\n        query FetchShadowKeys {\n          userKeys {\n            ","\n          }\n        }\n      "]);return O=function(){return e},e}function K(){let e=(0,i._)(["\n          query CheckMasterKeyLock {\n            checkMasterKeyLock\n          }\n        "]);return K=function(){return e},e}class W{async fetchShadowKeys(){var e;u.k.log("devices","Fetching shadow keys");let t=await (0,w.Pt)(async()=>(await (0,d.W)()).query({query:(0,r.Ps)(O(),$.j)}));if(null==t?void 0:null===(e=t.data)||void 0===e?void 0:e.userKeys){let e=await Promise.all(t.data.userKeys.map(e=>T.M.fromJson(e)));return u.k.log("security","Fetched user shadow keys:",e),e}return null}async bindPassword(e){let t;if(u.k.log("keyring","Binding password"),this.isPasswordBound())t=await (0,U.Cp)(e);else{let n={type:j.J.PASSWORD,key:e,keyId:"unused-for-now-for-passwords"};t=[await (0,U.cI)(n)]}return!!t&&(this.deletePasswordShadowKey(),t.forEach(e=>this.upsertShadowKey(e)),!0)}async bindPasskey(){let e=await (0,U.Dk)(),t=await this.pkCredentialCreationOptions(e,this.user.name$.value),n=await (0,F.RQ)(t[1]),i={type:j.J.WEBAUTHN,keyId:n.id,key:JSON.stringify(n),challengeId:e.id},r=await (0,U.cI)(i);return!!r&&(this.upsertShadowKey(r),!0)}async unlockPasskeyLocally(){u.k.log("Keyring","start unlock passkey...");let e=await (0,U.Dk)(),t=await this.pkCredentialCreationOptions(e,null),n=await (0,F.oz)(t[0],!1),i={type:j.J.WEBAUTHN,keyId:n.id,key:JSON.stringify(n),challengeId:e.id};return u.k.log("Keyring","start unlock passkey, attResp: ",n),i}async pkCredentialCreationOptions(e,t){let n="didweb.trinity-tech.io",i=new TextEncoder,r=i.encode(e.content),a={challenge:N.from(r).toString(),allowCredentials:[],rpId:n,userVerification:"required",timeout:6e4},s={user:{id:t,name:t,displayName:t},pubKeyCredParams:[{type:"public-key",alg:-7}],rp:{id:n,name:"DID web app"},challenge:e.content};return[a,s]}upsertShadowKey(e){let t=this.shadowKeys$.value;this.shadowKeys$.next([...t.filter(t=>!t.equals(e)),e])}deletePasswordShadowKey(){let e=this.shadowKeys$.value;this.shadowKeys$.next([...e.filter(e=>e.type!==j.J.PASSWORD)])}isPasswordBound(){var e;return!!(null===(e=this.shadowKeys$.value)||void 0===e?void 0:e.find(e=>e.type===j.J.PASSWORD))}isThisBrowserBound(){var e;return!!(null===(e=this.passkeyKeys$.value)||void 0===e?void 0:e.find(e=>{var t;return null===(t=e.browser)||void 0===t?void 0:t.isCurrentBrowser()}))}async checkRemoteUnlockStatus(){return(0,w.Pt)(async()=>{await (await (0,d.W)()).query({query:(0,r.Ps)(K())})})}ensureMasterKeyUnlocked(){return(0,E.HL)(async()=>(await this.checkRemoteUnlockStatus(),!0),!0,!1)}constructor(e){this.user=e,this.shadowKeys$=new h.P(null,()=>this.fetchShadowKeys()),this.passwordKeys$=new h.P(null,async()=>{this.shadowKeys$.pipe((0,_.U)(e=>null==e?void 0:e.filter(e=>e.type===j.J.PASSWORD))).subscribe(this.passwordKeys$)}),this.passkeyKeys$=new h.P(null,async()=>{this.shadowKeys$.pipe((0,_.U)(e=>null==e?void 0:e.filter(e=>e.type===j.J.WEBAUTHN))).subscribe(this.passkeyKeys$)})}}var V=n(6598);let L=new V.R;function B(){let e=(0,i._)(["\n          mutation UpdateUserProperty($input: UserPropertyInput!) {\n            updateUserProperty(input: $input)\n          }\n        "]);return B=function(){return e},e}class R{static async fromJson(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return L.get(e.id,{create:async()=>new R,async fill(t){t.fillFromJson(e),t.createdAt=new Date(e.createdAt),t.nameInitials$.next((0,m.OX)(e.name)),t.name$.next(e.name)}},t)}toJson(){return{id:this.id,type:this.type,name:this.name$.value,nameInitials:(0,m.OX)(this.name$.value),createdAt:this.createdAt.toISOString()}}get(e){if(!this.features.has(e))throw Error("Unhandled user feature '".concat(e,"'"));return this.features.get(e)}addFeature(e,t){if(!this.features.has(e))return this.features.set(e,t),t}fillFromJson(e){Object.assign(this,e)}equals(e){return!!e&&this.id===e.id}async updateUserName(e){var t;u.k.log("user","Updating user name.");let n=await (0,w.Pt)(async()=>(await (0,d.W)()).mutate({mutation:(0,r.Ps)(B()),variables:{input:{name:e}}})),i=null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.updateUserProperty;return i&&(this.name$.next(e),u.k.log("user","User name updated successfully.")),i}constructor(){this.name$=new I.X(null),this.nameInitials$=new I.X(null),this.features=new Map,this.addFeature("email",new f.lu(this)),this.addFeature("identity",new P(this)),this.addFeature("browser",new C(this)),this.addFeature("security",new W(this)),this.addFeature("activity",new v(this))}}},20708:function(e,t,n){n.d(t,{Pd:function(){return l},Z$:function(){return o}});var i=n(175),r=n(3883),a=n(16421);let s="browser-client-key";function l(e){var t;let n;try{n=(0,i.Z)(e)}catch(e){r.k.error("browser","Access token received from the backend cannot be decoded!");return}if(!n.browserKey)throw Error("Abnormal state: no browser key found in the access token!");let l=o();if(l&&l!==n.browserKey)throw localStorage.removeItem(s),(0,a.w7)(),Error("State error! Browser key ".concat(l," is different from access token browser key ").concat(n.browserKey," !"));t=n.browserKey,localStorage.setItem(s,t)}function o(){return localStorage.getItem(s)}},21417:function(e,t,n){n.d(t,{l:function(){return i}});let i=new class{init(e){this.config=e}get(e){if(!this.config)throw Error("The config service has not been initialized yet. Make sure to call configService.init() first");return this.config[e]}}},90786:function(e,t,n){n.d(t,{N:function(){return y}});class i{static async loadOrCreate(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100,r=new i(e,n,t);return await r.load(),r}set(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this.items.findIndex(t=>t.key==e),r={key:e,timeValue:n,data:t};-1===i?this.items.push(r):this.items[i]=r,this.items.sort((e,t)=>0===e.timeValue?-1:0===t.timeValue?1:e.timeValue>t.timeValue?-1:e.timeValue<t.timeValue?1:0)}remove(e){let t=this.items.findIndex(t=>t.key==e);t>=0&&this.items.splice(t,1)}get(e){return this.items.find(t=>t.key==e)}values(){return this.items}size(){return this.items.length}async save(){let e=this.items.slice(0,Math.min(this.items.length,this.maxItemsOnDisk)),t="cache"+this.name;localStorage.setItem(t,JSON.stringify(e))}async load(){let e="cache"+this.name,t=localStorage.getItem(e);t&&(this.items=JSON.parse(t))}async delete(){let e="cache"+this.name;localStorage.removeItem(e)}constructor(e,t,n){this.name=e,this.maxItemsOnDisk=t,this.storeGlobally=n}}var r=n(85300),a=n(3883),s=n(35324),l=n(13952),o=n.n(l),c=n(62067),d=n.n(c),u=n(69810),h=n.n(u);let y=new class{async init(){this.contextsCache=await i.loadOrCreate("credentialcontextpayloads",!0)}async resolveExpandedCredentialTypeIdentifiers(e){let t=null;try{t=e.toJSON()}catch(e){return a.k.warn("credentialtypes","Credential could not be parsed, returning empty types"),[]}if(!("@context"in t)||0!==t["@context"].indexOf("https://www.w3.org/2018/credentials/v1"))return[];try{let e=await o().expand(t,{documentLoader:this.buildElastosJsonLdDocLoader()});if(e&&e.length>0){let t=e[0];return Array.isArray(t["@type"])?t["@type"]:[t["@type"]]}console.log("error")}catch(e){a.k.warn("credentialtypes","Credential could not be expanded, returning empty types.",e)}return[]}async resolveTypesWithContexts(e){let t=null;try{if(t=e.toJSON(),!("@context"in t)||0!==t["@context"].indexOf("https://www.w3.org/2018/credentials/v1"))return[];let n=t["@context"],i=[];for(let e of n){let t=await this.fetchContext(e);if(!t){a.k.warn("credentialtypes","Failed to fetch credential type context for",e);continue}"@context"in t&&i.push({url:e,payload:t})}let r=[];for(let t of e.getType()){let e=i.find(e=>Object.keys(e.payload["@context"]).indexOf(t)>=0);e&&r.push({context:e.url,shortType:t})}return r}catch(e){return a.k.warn("credentialtypes","Credential could not be parsed or , returning empty types.",e),[]}}async fetchContext(e){let t=this.contextsCache.get(e);return t?t.data:this.fetchContextQueue.add(async()=>{if(e.startsWith("http"))try{let t=await fetch(e),n=await t.json();return this.contextsCache.set(e,n,d()().unix()),n}catch(e){return a.k.warn("credentialtypes","Failed to get payload from context.",e),null}else{if(!e.startsWith("did:"))return a.k.log("credentialtypes","Unsupported credential context url",e),null;let{publisher:t,shortType:n}=this.extractEIDContext(e);if(!t)return a.k.warn("credentialtypes","Failed to extract publisher from context",e),null;let i=await r._.fetchOrAwaitDIDDocumentWithStatus(t);if(!i.document)return null;{let r="".concat(t,"#").concat(n),a=await this.getContextPayloadFromDIDDocument(i.document,r);return this.contextsCache.set(e,a,d()().unix()),a}}})}extractEIDContext(e){let t=new RegExp(/^did:\/\/elastos\/([a-zA-Z0-9]+)\/([a-zA-Z0-9]+)/),n=t.exec(e);return!n||n.length<3?(a.k.warn("credentialtypes","Invalid url format, cannot find credential publisher and ID"),null):{publisher:"did:elastos:".concat(n[1]),shortType:n[2]}}async getContextPayloadFromDIDDocument(e,t){let n=e.getService(t);if(!n)return a.k.warn("credentialtypes","The DID document has no service with ID: "+t),null;let i=n.getServiceEndpoint(),{DIDURL:r}=await (0,s.hS)(),l=this.getCredentialById(e,new r(i));if(!l)return a.k.warn("credentialtypes","The DID document has no credential context credential that matches (service id, credential id): ",t,i),null;let o=l.getSubject().getProperties();return"definition"in o&&"@context"in o.definition?o.definition:(a.k.warn("credentialtypes","Credential ".concat(i," found but no definition/@context in the subject. Invalid format."),o),null)}buildElastosJsonLdDocLoader(){return(e,t)=>new Promise(async(t,n)=>{try{if(e.startsWith("did")){let n=await this.fetchContext(e);t({contextUrl:null,documentUrl:e,document:n})}else{let n=o().documentLoaders.xhr(),i=await n(e);t(i)}}catch(e){n(e)}})}async verifyCredential(e){try{let t=e.toJSON();if("object"!=typeof t)return a.k.warn("credentialtypes","verifyCredential false 331"),!1;if(!("@context"in t)||0!==t["@context"].indexOf("https://www.w3.org/2018/credentials/v1")||!("credentialSubject"in t)||!("proof"in t))return!1;let n=await o().compact(t,t["@context"],{documentLoader:this.buildElastosJsonLdDocLoader()});if(n){"credentialSubject"in n&&"string"!=typeof n.credentialSubject||(n.credentialSubject={id:n.credentialSubject});let{modifiedDoc:e,warningsGenerated:i}=this.addMissingFieldsToCompactHtmlResult(t,n);if(!i)return!0}}catch(e){a.k.warn("credentialtypes","verifyCredential error",e)}return!1}addMissingFieldsToCompactHtmlResult(e,t){let n=!1,i=Object.assign({},t);for(let r of Object.keys(e.credentialSubject))r in t.credentialSubject||(i.credentialSubject["MISSING_KEY_"+r]="This field is missing in credential types",n=!0);for(let r of Object.keys(e.proof))r in t.proof||(i.proof["MISSING_KEY_"+r]="This field is missing in credential types",n=!0);return{modifiedDoc:i,warningsGenerated:n}}getCredentialById(e,t){let n=e.getCredentials();return n.find(e=>t.getFragment()==e.getId().getFragment())}constructor(){this.fetchContextQueue=new(h())(1)}}},51385:function(e,t,n){n.d(t,{Pt:function(){return w},rs:function(){return g}});var i=n(17205),r=n(66533),a=n(48023),s=n(1349),l=n(10343),o=n(63863),c=n(81630),d=n(21704),u=n(27524),h=n(3883),y=n(52856);let g=new u.x;function p(e){return h.k.error("apollo","Client error",e),r._.newClientError(a.XF.OtherApolloError,e.message)}function v(e){return h.k.error("apollo","Protocol error",e),r._.newClientError(a.XF.OtherApolloError,e.message)}function f(e){var t;let n=e.path,i=e.originalError||(null===(t=e.extensions)||void 0===t?void 0:t.originalError),s=r._.fromJson(i);return s?((0,y.z)(s)?h.k.warn("graphql","Master key needs to be unlocked"):h.k.error("graphql","Custom API exception when calling GraphQL method:",n,i),s):(h.k.error("graphql","GraphQL error when calling GraphQL method:",n,e),r._.newClientError(a.XF.OtherApolloError,e.message))}async function w(e,t){try{let t=await e();return t}catch(D){let e;if(D instanceof r._&&(e=[D]),D instanceof i.cA){var n,u,w;let t;t=(t=(t=(t=[]).concat(null===(n=D.clientErrors)||void 0===n?void 0:n.map(p))).concat(null===(u=D.graphQLErrors)||void 0===u?void 0:u.map(f))).concat(null===(w=D.protocolErrors)||void 0===w?void 0:w.map(v)),D.networkError&&(t=t.concat(function(e){let t=[];return"ServerError"===e.name?"object"==typeof e.result&&e.result.forEach(e=>{var n;null===(n=e.errors)||void 0===n||n.forEach(e=>{h.k.error("graphql","GraphQL server network error:",e.message),t.push(r._.newClientError(a.XF.OtherApolloError,e.message))})}):(h.k.error("graphql","GraphQL network error:",e),t.push(r._.newClientError(a.XF.OtherApolloError,e.message))),t}(D.networkError))),e=t}else D instanceof d.__?e=[f(D)]:D instanceof c.AxiosError?e=[function(e){let t=r._.fromJson(e.response.data);return t?(h.k.error("axios","Axios app exception",t),t):(h.k.error("Unhandled axios error:",e),r._.newClientError(a.XF.OtherAxiosError,e.message))}(D)]:h.k.error("Unhandled error:",D);e.map(e=>{g.next(e)});let m=e.find(e=>(0,y.z)(e));if(m)throw m;let I=e.find(e=>(0,o.zl)(e));if(I)throw new s.E;let b=e.find(e=>(0,o.qR)(e));if(b)throw new l.h;return t||null}}},76506:function(e,t,n){n.d(t,{W:function(){return v}});var i=n(14456),r=n(23139),a=n(79977),s=n(29526),l=n(15740),o=n(2594),c=n(85932),d=n(16421),u=n(69810),h=n.n(u),y=n(20708),g=n(21417);let p=new class{async init(){return this.queue.add(()=>{if(this.initialized)return;let e=new l.A({uri:"".concat(g.l.get("backendUrl"),"/graphql"),batchMax:30,batchInterval:50}),t=(0,c.q)(e=>{let{graphQLErrors:t,networkError:n,operation:r,forward:a}=e;if(t){if(!localStorage.getItem("access_token"))return;for(let e of t)switch(e.extensions.code){case"UNAUTHENTICATED":return(0,i.p)((0,d.g$)().catch(e=>{})).filter(e=>!!e).flatMap(e=>{let t=r.getContext().headers;return r.setContext({headers:{...t,authorization:"Bearer ".concat(e)}}),a(r)});case"INVALID_REFRESH_TOKEN":(0,d.JA)()}}}),n=(0,o.v)((e,t)=>{let{headers:n}=t,i=localStorage.getItem("access_token"),r=(0,y.Z$)();return{headers:{...n,authorization:i?"Bearer ".concat(i):"",...r&&{"x-browser-key":r}}}});this.apolloClient=new r.f({link:(0,a.D)([t,n,e]),cache:new s.h}),this.initialized=!0})}constructor(){this.initialized=!1,this.queue=new(h())(1)}},v=async()=>(await p.init(),p.apolloClient)},17041:function(e,t,n){n.d(t,{L:function(){return c}});var i=n(53932),r=n(3883),a=n(78330),s=n(78212),l=n(54860);let o=(0,s.S)()&&new a.J("hive-pictures",async(e,t)=>(r.k.log("hive","Cache miss for hive url picture, fetching"),d(t.hiveScriptUrl,t.identity)));function c(e){let t=i.B.value;return t?o.get(e+t.did,{hiveScriptUrl:e,identity:t}):null}async function d(e,t){if(!e)return null;let n=await u(e,t);return n?(0,l.Ik)(n):""}async function u(e,t){e=e.replace("params={empty:0}",'params={"empty":0}');try{r.k.log("hive","Calling script url to download file",e);let n=await t.get("hive").getVaultService(),i=await n.getScriptingService().downloadFileByHiveUrl(e);if(!i||0===i.length)return r.k.warn("hive","Got empty data while fetching hive script picture",e),null;return r.k.log("hive","Got data after fetching hive script picture",e,"data length:",i.length),i}catch(t){return r.k.warn("hive","Failed to download hive asset at ",e,t),null}}},12540:function(e,t,n){n.d(t,{zV:function(){return u},AX:function(){return d},gM:function(){return o}});var i=n(3883),r=n(78212),a=n(35324),s=n(69810),l=n.n(s);let o=new(l())(1),c=["https://hive1.trinity-tech.io","https://hive2.trinity-tech.io","https://hive3.trinity-tech.io"];function d(){(0,r.S)()&&(0,a.pH)().then(e=>{let{Logger:t,AppContext:n,DIDResolverAlreadySetupException:r}=e;try{t.setDefaultLevel(t.WARNING),n.setupResolver("mainnet","/anyfakedir/browserside/for/didstores")}catch(e){e instanceof r||i.k.error("hive","AppContext.setupResolver() exception:",e)}})}function u(){let e=Math.floor(Math.random()*c.length);return c[e]}},7845:function(e,t,n){var i,r;n.d(t,{V:function(){return i}}),(r=i||(i={}))[r.NotChecked=0]="NotChecked",r[r.Subscribing=1]="Subscribing",r[r.ReadyToUse=2]="ReadyToUse",r[r.UnknownError=3]="UnknownError"},59606:function(e,t,n){n.d(t,{Pr:function(){return u},m7:function(){return d},yd:function(){return c}});class i{setup(e){if(0>=e.indexOf("#"))this.shortType=e,this.context=null,this.longType=null;else{let t=e.split("#");this.context=t[0],this.shortType=t[1],this.longType=e}}getContext(){return this.context}getShortType(){return this.shortType}getLongType(){return this.longType}isLongType(){return!!this.longType}containedIn(e){return e.includes(this.getLongType())||e.includes(this.getShortType())}constructor(e){this.type=e,this.setup(e)}}var r=n(57969);class a{getInfo(e){return d(e.verifiableCredential.getType())}getEditionType(){return this.editionType}constructor(e){this.editionType=e}}class s extends a{toEditableValue(e){return e.verifiableCredential.getSubject().getProperty(this.subjectKey)}toDisplayableValue(e){return e.verifiableCredential.getSubject().getProperty(this.subjectKey)}toSubject(e){return{[this.subjectKey]:e}}constructor(e){super(r.E.SingleLineString),this.subjectKey=e}}var l=n(9177);let o=[new r.h("name",new i("https://ns.elastos.org/credentials/profile/name/v1#NameCredential"),{converter:new s("name")}),new r.h("avatar",new i("https://webservice.org#AvatarCredential"),{converter:new class extends a{toEditableValue(e){return e.verifiableCredential.getSubject().getProperty(this.subjectKey)}toDisplayableValue(e){return null}toSubject(e){return this.buildAvatar(e.mimeType,"elastoshive",e.hiveDownloadScriptUrl)}buildAvatar(e,t,n){return{avatar:{"content-type":e,type:t,data:n}}}constructor(e){super(r.E.Undefined),this.subjectKey=e}}("avatar")}),new r.h("email",new i("https://ns.elastos.org/credentials/profile/email/v1#EmailCredential"),{multipleInstancesAllowed:!0,converter:new s("email")}),new r.h("birthDate",new i("https://ns.elastos.org/credentials/profile/birthDate/v1#BirthDateCredential"),{multipleInstancesAllowed:!0,converter:new class extends a{toEditableValue(e){let t=e.verifiableCredential.getSubject().getProperty(this.subjectKey);return new Date(t)}toDisplayableValue(e){return(0,l.r2)(e.verifiableCredential.getSubject().getProperty(this.subjectKey))}toSubject(e){return{[this.subjectKey]:e.toISOString()}}constructor(e){super(r.E.Date),this.subjectKey=e}}("birthDate")}),new r.h("nationality",new i("did://elastos/iUq76mi2inkZfqqbHkovbcDkzEkAh2dKrb/ISONationalityCredential#ISONationalityCredential"),{multipleInstancesAllowed:!0,converter:new class extends a{toEditableValue(e){return e.verifiableCredential.getSubject().getProperty(this.subjectKey)}toDisplayableValue(e){return e.verifiableCredential.getSubject().getProperty(this.subjectKey).label}toSubject(e){return{[this.subjectKey]:e}}constructor(e){super(r.E.Country),this.subjectKey=e}}("nationality")}),new r.h("gender",new i("https://ns.elastos.org/credentials/profile/nationality/v1#GenderCredential"),{multipleInstancesAllowed:!0,converter:new class extends a{toEditableValue(e){return(0,l.aD)(e.verifiableCredential.getSubject().getProperty(this.subjectKey))}toDisplayableValue(e){return(0,l.aD)(e.verifiableCredential.getSubject().getProperty(this.subjectKey))}toSubject(e){return{[this.subjectKey]:(0,l.OX)(e)}}constructor(e){super(r.E.Gender),this.subjectKey=e}}("gender")}),new r.h("telephone",new i("https://ns.elastos.org/credentials/profile/telephone/v1#TelephoneCredential"),{multipleInstancesAllowed:!0,converter:new s("telephone")}),new r.h("nickname",new i("https://ns.elastos.org/credentials/profile/nickname/v1#NicknameCredential"),{multipleInstancesAllowed:!0,converter:new s("nickname")}),new r.h("birthPlace",new i("https://ns.elastos.org/credentials/profile/birthPlace/v1#BirthPlaceCredential"),{multipleInstancesAllowed:!0,converter:new s("birthPlace")}),new r.h("occupation",new i("https://ns.elastos.org/credentials/profile/occupation/v1#OccupationCredential"),{multipleInstancesAllowed:!0,converter:new s("occupation")}),new r.h("education",new i("https://ns.elastos.org/credentials/profile/education/v1#EducationCredential"),{multipleInstancesAllowed:!0,converter:new s("education")}),new r.h("interests",new i("https://ns.elastos.org/credentials/profile/interests/v1#InterestsCredential"),{multipleInstancesAllowed:!0,converter:new s("interests")}),new r.h("description",new i("https://ns.elastos.org/credentials/profile/description/v1#DescriptionCredential"),{multipleInstancesAllowed:!0,converter:new s("description")}),new r.h("url",new i("https://ns.elastos.org/credentials/profile/url/v1#URLCredential"),{multipleInstancesAllowed:!0,converter:new s("url")}),new r.h("discord",new i("https://ns.elastos.org/credentials/social/discord/v1#DiscordCredential"),{multipleInstancesAllowed:!0,converter:new s("discord")}),new r.h("linkedin",new i("https://ns.elastos.org/credentials/social/linkedin/v1#LinkedinCredential"),{multipleInstancesAllowed:!0,converter:new s("linkedin")}),new r.h("facebook",new i("https://ns.elastos.org/credentials/social/facebook/v1#FacebookCredential"),{multipleInstancesAllowed:!0,converter:new s("facebook")}),new r.h("instagram",new i("https://ns.elastos.org/credentials/social/instagram/v1#InstagramCredential"),{multipleInstancesAllowed:!0,converter:new s("instagram")}),new r.h("twitter",new i("https://ns.elastos.org/credentials/social/twitter/v1#TwitterCredential"),{multipleInstancesAllowed:!0,converter:new s("twitter")}),new r.h("snapchat",new i("https://ns.elastos.org/credentials/social/snapchat/v1#SnapchatCredential"),{multipleInstancesAllowed:!0,converter:new s("snapchat")}),new r.h("telegram",new i("https://ns.elastos.org/credentials/social/telegram/v1#TelegramCredential"),{multipleInstancesAllowed:!0,converter:new s("telegram")}),new r.h("wechat",new i("https://ns.elastos.org/credentials/social/wechat/v1#WechatCredential"),{multipleInstancesAllowed:!0,converter:new s("wechat")}),new r.h("weibo",new i("https://ns.elastos.org/credentials/social/weibo/v1#WeiboCredential"),{multipleInstancesAllowed:!0,converter:new s("weibo")}),new r.h("twitch",new i("https://ns.elastos.org/credentials/social/twitch/v1#TwitchCredential"),{multipleInstancesAllowed:!0,converter:new s("twitch")}),new r.h("elaAddress",new i("https://ns.elastos.org/credentials/elaAddress/v1#ElaAddressCredential"),{multipleInstancesAllowed:!0,converter:new s("elaAddress")}),new r.h("wallet",new i("https://ns.elastos.org/credentials/wallet/v1#WalletCredential"),{isSensitive:!0,multipleInstancesAllowed:!0,converter:new s("wallet")})];function c(){return o}function d(e){return o.find(t=>{var n;return null===(n=t.type)||void 0===n?void 0:n.containedIn(e)})}function u(e){return o.find(t=>t.key===e)}},57969:function(e,t,n){n.d(t,{E:function(){return r},h:function(){return o}});var i,r,a=n(40218),s=n.n(a);(i=r||(r={}))[i.SingleLineString=0]="SingleLineString",i[i.MultiLineText=1]="MultiLineText",i[i.Date=2]="Date",i[i.Country=3]="Country",i[i.Gender=4]="Gender",i[i.Undefined=5]="Undefined";let l={defaultSubject:"",isSensitive:!1,multipleInstancesAllowed:!1,converter:null};class o{getConverter(){return this.options.converter}typesForCreation(){return[this.type.getLongType()]}constructor(e,t,n={converter:null}){this.key=e,this.type=t,this.options=n,n=s()({},l,n)}}},85300:function(e,t,n){n.d(t,{_:function(){return u}});var i=n(17041),r=n(3883),a=n(35324),s=n(69810),l=n.n(s),o=n(50676),c=n(87401);class d{get(e){if(!this.documentsSubjects.has(e)){let t=new o.X({checking:!1,checked:!1,document:null});this.documentsSubjects.set(e,t)}return this.documentsSubjects.get(e)}set(e,t,n,i){this.documentsSubjects.get(e).next({checking:t,checked:n,document:i})}constructor(){this.documentsSubjects=new Map}}let u=new class{async fetchActiveUserOnlineDIDDocument(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=c.D.getActiveIdentityId(),n=await this.resolveDIDWithoutDIDStore(t,e);return r.k.log("Identity","Resolved on chain document: ",n),this.onlineDIDDocumentsStatus.set(t,!1,!0,n),n}resolveDIDWithoutDIDStore(e,t){return this.resolveDIDQueue.add(async()=>{let{DIDBackend:n,DID:i}=await (0,a.hS)();r.k.log("Identity","Resolving DID without DID store",e,t);let s=new i(e);return n.getInstance().resolveDid(s,t)})}fetchOrAwaitDIDDocumentWithStatus(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.onlineDIDDocumentsStatus.get(e);return new Promise(async i=>{if(n.value.checking){let e=n.subscribe(t=>{t.checked&&(e.unsubscribe(),i(t))})}else if(!n.value.checked||t){this.onlineDIDDocumentsStatus.set(e,!0,!1,null);let a=await this.resolveDIDWithoutDIDStore(e,t);r.k.log("Identity","Resolved on chain document: ",a),this.onlineDIDDocumentsStatus.set(e,!1,!0,a),i(n.value)}else i(n.value)})}async getRepresentativeIcon(e){let{DIDURL:t}=await (0,a.hS)();if(!e)return null;let n=null,r=e.getCredentials(),s=this.getCredentialsByType(r,"ApplicationCredential");if(s&&s.length>0){let e=s[0].getSubject().getProperties();"iconUrl"in e&&(n=e.iconUrl)}if(!n){let e=this.getCredentialsByType(r,"AvatarCredential");if(!e||0===e.length){let n=this.getCredentialById(r,new t("#avatar"));n&&e.push(n)}if(e&&e.length>0){let t=e[0].getSubject().getProperties();if("avatar"in t&&"object"==typeof t.avatar){let e=t.avatar;"type"in e&&"elastoshive"===e.type&&(n=e.data)}}}return n?(0,i.L)(n):null}async getRepresentativeOwnerName(e){let{DIDURL:t}=await (0,a.hS)();if(!e)return null;let n=null,i=e.getCredentials(),r=this.getCredentialsByType(i,"ApplicationCredential");if(r&&r.length>0){let e=r[0].getSubject().getProperties();"name"in e&&(n=e.name)}if(!n){let e=this.getCredentialsByType(i,"NameCredential");if(e&&e.length>0){let t=e[0].getSubject().getProperties();"name"in t&&(n=t.name)}}if(!n){let e=this.getCredentialById(i,new t("#name"));if(e){let t=e.getSubject().getProperties();"name"in t&&(n=t.name)}}return n}getCredentialsByType(e,t){return null==e?void 0:e.filter(e=>e.getType().indexOf(t)>=0)}getCredentialById(e,t){return e.find(e=>t.getFragment()==e.getId().getFragment())}constructor(){this.onlineDIDDocumentsStatus=new d,this.resolveDIDQueue=new(l())(1),this.network="mainnet",(0,a.hS)().then(e=>{let{DIDBackend:t,DefaultDIDAdapter:n}=e;t.initialize(new n(this.network))})}}},53932:function(e,t,n){n.d(t,{B:function(){return r}});var i=n(50676);let r=new i.X(null)},87401:function(e,t,n){n.d(t,{D:function(){return eg}});var i,r,a=n(60230),s=n(23965);let l="\n  id\n  createdAt\n  verifiableCredential\n",o="\n  did\n  createdAt\n  lastUsedAt\n";var c=n(69144),d=n(57135),u=n(51385),h=n(76506),y=n(62067),g=n.n(y),p=n(50676),v=n(3883),f=n(1859);class w{async createCredential(e,t,n,i){this.ensureCredentialsFetched(),v.k.log("credentials","Creating credential",e,t,n,i);let r=await (0,d.HL)(()=>this.identity.provider.createCredential(this.identity.did,e,t,n,i));return this.credentials$.next([r,...this.credentials$.value]),r}async issueCredential(e,t,n,i,r){return this.ensureCredentialsFetched(),v.k.log("credentials","Issuing credential",e,t,n,i,r),(0,d.HL)(()=>this.identity.provider.issueCredential(this.identity.did,e,t,n,i,r))}async importCredential(e){this.ensureCredentialsFetched(),v.k.log("credentials","Importing credential",e);let t=await (0,d.HL)(()=>this.identity.provider.importCredential(this.identity.did,e),!0,null);return this.credentials$.next([t,...this.credentials$.value]),t}async fetchCredentials(){return v.k.log("credentials","Fetching credentials",this.identity.did),(0,d.HL)(()=>this.identity.provider.listCredentials(this.identity.did))}async deleteCredential(e){var t;this.ensureCredentialsFetched(),v.k.log("credentials","Deleting credential");let n=await (0,d.HL)(()=>this.identity.provider.deleteCredential(e.id));return this.credentials$.next(null===(t=this.credentials$.value)||void 0===t?void 0:t.filter(t=>t.id!=e.id)),n}ensureCredentialsFetched(){if(!this.credentials$.value)throw Error("Don't try to add/delete/edit credentials before the credentials list is fetched!")}constructor(e){this.identity=e,this.credentials$=new f.P(null,()=>this.fetchCredentials())}}var m=n(35324),I=n(69810),b=n.n(I);let D=new(b())(1),k=new(b())(1);class S{async getExistingAppIdentityCredential(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return D.add(async()=>{v.k.log("did","Trying to get an existing app ID credential from storage");let t=await this.getOrCreateAppInstanceDID(e);if(!t)return null;let n=t.did,i=n.toString()+"#app-id-credential",r=await t.didStore.loadCredential(i);if(r){let e=g()(await r.getExpirationDate());if(e.isBefore(g()().subtract(1,"hours")))return v.k.log("did","Existing credential is expired or almost expired - renewing it"),null;v.k.log("did","Returning existing app id credential found in app's local storage",r)}else v.k.log("did","No app id credential found for id",i,"in store",t.didStore);return r})}async getOrCreateAppInstanceDID(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=null,n=null,i=null;return k.add(async()=>{v.k.log("did","Getting or creating app instance DID");try{let r=await this.getExistingAppInstanceDIDInfo(e);if(r&&(t=await this.openDidStore(r.storeId)))try{n=await this.loadDID(t,r.didString),i=r.storePassword}catch(e){v.k.error("did",e)}if(!t||!n){v.k.log("did","No app instance DID found. Creating a new one");let r=await this.createNewAppInstanceDID(e);t=r.didStore,n=r.did,i=r.storePassword}return await this.loadDIDCredentials(t,n),{did:n,didStore:t,storePassword:i}}catch(e){v.k.error("did",e)}})}async getExistingAppInstanceDIDInfo(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e?"_".concat(e):"",n=this.identity.get("storage"),i=await n.get("appinstancedidstoreid"+t,null),r=await n.get("appinstancedidstring"+t,null),a=await n.get("appinstancedidstorepassword"+t,null);return i&&r?{storeId:i,didString:r,storePassword:a}:null}fastCreateDID(e){return v.k.log("did","Fast DID creation with language "+e),new Promise(async(t,n)=>{try{let{Mnemonic:n,DIDStore:i,RootIdentity:r}=await (0,m.hS)(),a=await n.getInstance(e).generate(),s=this.generateRandomDIDStoreId(),l=await i.open(s),o=this.generateRandomPassword(),c=await r.createFromMnemonic(a,null,l,o),d=await c.newDid(o);t({didStoreId:s,didStore:l,did:d.getSubject(),storePassword:o})}catch(e){n(e)}})}generateRandomPassword(){return this.generateRandomDIDStoreId()}generateRandomDIDStoreId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6,t=16,n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),i=[];if(t=t||n.length,e)for(let r=0;r<e;r++)i[r]=n[0|Math.random()*t];else{let e;i[8]=i[13]=i[18]=i[23]="-",i[14]="4";for(let t=0;t<36;t++)i[t]||(e=0|16*Math.random(),i[t]=n[19==t?3&e|8:e])}return i.join("")}async createNewAppInstanceDID(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,{Mnemonic:t}=await (0,m.hS)(),n=await this.fastCreateDID(t.ENGLISH);return await this.saveAppInstanceDIDInfo(e,n.didStoreId,n.did.toString(),n.storePassword),{didStore:n.didStore,didStoreId:n.didStoreId,did:n.did,storePassword:n.storePassword}}async saveAppInstanceDIDInfo(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0;v.k.log("did","Saving app instance DID info for store "+t+" and did "+n+" and app did "+e);let r=e?"_".concat(e):"",a=this.identity.get("storage");await a.set("appinstancedidstoreid"+r,t),await a.set("appinstancedidstring"+r,n),await a.set("appinstancedidstorepassword"+r,i)}openDidStore(e){return new Promise(async t=>{try{let{DIDStore:n}=await (0,m.hS)(),i=await n.open(e);t(i)}catch(e){t(null)}})}loadDID(e,t){return new Promise(async(n,i)=>{try{let r=await e.loadDid(t);r?n(r.getSubject()):i("Null DIDDocument loaded for did string "+e)}catch(e){i(e)}})}loadDIDCredentials(e,t){return new Promise(async(n,i)=>{try{let i=await e.listCredentials(t.toString()),r=[];for(let t of i)r.push(await e.loadCredential(t));n(r)}catch(e){i(e)}})}constructor(e){this.identity=e}}var C=n(12540),x=n(7845),A=n(6598),P=n(70163);function E(e,t){return new Promise(n=>{let i=e.pipe((0,P.h)(e=>e===t)).subscribe(e=>{setTimeout(()=>i.unsubscribe(),0),n()})})}var $=n(74548),T=n.n($);class j{async getVaultService(){await this.awaitHiveVaultReady();let e=await this.getHiveAppContext(),{Vault:t}=await (0,m.pH)();return new t(e,null)}awaitHiveVaultReady(){return E(this.vaultStatus$,x.V.ReadyToUse)}getActiveUserSubscriptionServices(){return v.k.log("hive","Getting subscription services for",this.identity.did),this.getSubscriptionService()}async addRandomHiveVaultServiceToDIDDocument(){let e=(0,C.zV)();if(e)return await this.removeHiveVaultServiceFromDIDDocument(),await eg.addDIDDocumentService(this.identity.did,"#hivevault","HiveVault",e),!0;throw Error("Hive node address cannot be null")}async removeHiveVaultServiceFromDIDDocument(){return eg.removeDIDDocumentService(this.identity.did,"#hivevault")}documentHasVault(e){let t=e.getService("vault");return null!=t}getDocumentVaultProviderUrl(e){let t=e.getService("#hivevault");return t.serviceEndpoint}async getVaultInfo(){let e=await this.getSubscriptionService();return e.checkSubscription()}async subscribeToHiveProvider(e){v.k.log("hive","Subscribing to hive provider",e);let t=null;try{t=await this.getVaultInfo()}catch(e){}if(t)return!0;{v.k.log("hive","subscribeToHiveProvider(): no vault info, subscribing");let e=await this.getSubscriptionService();if(!(t=await e.subscribe()))return v.k.error("hive","Failed to create vault on the hive node"),!1;await this.retrieveVaultStatus()}let n=await this.getVaultService();if(n)try{v.k.log("hive","Calling an api on the hive vault to make sure everything is fine"),n=await this.getVaultService();let e=await n.getAppStats();if(e)return v.k.log("hive","Vault API could be called, all good!"),this.retrieveVaultStatus(),!0;v.k.error("hive","Error while calling a test hive vault API. No data returned")}catch(e){v.k.error("hive","Exception while calling a test vault API:",e)}else v.k.error("hive","NULL vault returned, unable to get the vault for this DID.");return!1}async retrieveVaultStatus(){let{VaultNotFoundException:e}=await (0,m.pH)();await this.identity.get("publication").awaitIdentityPublished(),v.k.log("hive","Looking for vault status"),this.vaultStatus$.next(x.V.NotChecked);let{ServiceEndpoint:t}=await (0,m.pH)();v.k.log("hive","Retrieving vault of current user's DID "+this.identity.did);let n=await this.getHiveAppContext(),i=new t(n),r=await i.getProviderAddress();this.vaultAddress$.next(r);try{let e=await this.getSubscriptionService();await e.checkSubscription(),this.vaultStatus$.next(x.V.ReadyToUse),v.k.log("hive","Vault status retrieval completed")}catch(t){if(!(t instanceof e))return v.k.error("hive","Unknown exception while retrieving vault status:",t),this.emitUnknownErrorStatus(),null;await this.subscribeToHiveProvider(r)}}emitUnknownErrorStatus(){v.k.log("hive","Emiting unknown error status"),this.vaultStatus$.next(x.V.UnknownError)}async getSubscriptionService(){let{VaultSubscription:e}=await (0,m.pH)(),t=await this.getHiveAppContext();return new e(t)}async getScriptingService(){let{ScriptingService:e,ServiceEndpoint:t}=await (0,m.pH)(),n=await this.getHiveAppContext(),i=new t(n);return new e(i)}handleVaultAuthenticationChallenge(e){return this.generateAuthPresentationJWT(e)}getThisAppDID(){return"did:elastos:iddh53iyg3Eyrq4AFiA8tCULpEqUyu49td"}async getHiveAppContextProvider(){return C.gM.add(async()=>{let e=this.getThisAppDID(),t=await this.identity.get("did").getOrCreateAppInstanceDID(e),n=await t.didStore.loadDid(t.did.toString());return{getLocalDataDir:()=>"/",getAppInstanceDocument:()=>n,getAuthorization:e=>{v.k.log("hive","Receiving hive client authentication challenge");try{return this.handleVaultAuthenticationChallenge(e)}catch(e){return v.k.error("hive","Exception in authentication handler:",e),null}}}})}async getHiveAppContext(){return this.appContextCache.get(this.identity.did,{create:async()=>{let{AppContext:e}=await (0,m.pH)();v.k.log("hive","Getting app context for",this.identity.did);let t=await this.getHiveAppContextProvider();return e.build(t,this.identity.did,"did:elastos:iddh53iyg3Eyrq4AFiA8tCULpEqUyu49td")}})}async generateAuthPresentationJWT(e){let t=this.getThisAppDID();v.k.log("hive","Starting process to generate hive auth presentation JWT");try{let{JWTParserBuilder:i,VerifiablePresentation:r,JWTHeader:a}=await (0,m.hS)(),s=(await new i().setAllowedClockSkewSeconds(300).build().parse(e)).getBody();if(null==s)throw Error("Invalid jwt token as authorization.");if(!s.getIssuer()||!s.get("nonce"))throw Error("The received authentication JWT token does not contain iss or nonce");let l=s.get("nonce"),o=s.getIssuer();v.k.log("hive","Getting app instance DID");let c=await this.identity.get("did").getOrCreateAppInstanceDID(t),d=c.did;v.k.log("hive","App instance DID:",d);let u=await this.identity.get("did").getExistingAppInstanceDIDInfo(t);v.k.log("hive","Getting app identity credential");let h=await this.identity.get("did").getExistingAppIdentityCredential(t);if(!h&&(v.k.log("hive","Empty app id credential. Trying to generate a new one"),!(h=await this.generateAppIdCredential())))return v.k.warn("hive","Failed to generate a new App ID credential"),null;v.k.log("hive","Creating DID presentation response for Hive authentication challenge");let y=await r.createFor(d.toString(),null,c.didStore),g=await y.credentials(h).realm(o).nonce(l).seal(u.storePassword);if(g){v.k.log("hive","Opening DID store to create a JWT for presentation:",g.toJSON());let e=(await Promise.all([n.e(3988),n.e(8366)]).then(n.bind(n,11920))).DID,t=await e.DIDHelper.openDidStore(u.storeId);v.k.log("hive","Loading DID document",u.didString);let i=await t.loadDid(u.didString);v.k.log("hive","App instance DID document",i.toJSON()),v.k.log("hive","Creating JWT");let r=await i.jwtBuilder().addHeader(a.TYPE,a.JWT_TYPE).addHeader("version","1.0").setSubject("DIDAuthResponse").setAudience(s.getIssuer()).setIssuedAt(T()().unix()).setExpiration(T()().add(3,"month").unix()).setNotBefore(T()().subtract(3,"minutes").unix()).claimsWithJson("presentation",g.toString(!0)).sign(u.storePassword);return v.k.log("hive","JWT created for presentation:",r),r}throw Error("No presentation generated")}catch(e){throw Error("The received authentication JWT token signature cannot be verified or failed to verify: ".concat(e,". Is the hive back-end DID published? Are you on the right network?"))}}async generateAppIdCredential(){let e=this.getThisAppDID(),t=await this.identity.get("did").getOrCreateAppInstanceDID(e);if(!t)return null;let n=t.did;v.k.log("hive","Starting to generate a new App ID credential.");try{let i=await this.generateApplicationIDCredential(n.toString(),e);if(i)return v.k.log("hive","App ID credential generated:",i),await t.didStore.storeCredential(i),v.k.log("hive","Storing app ID credential into DID store:",t.didStore,i),i;return null}catch(e){return null}}async generateApplicationIDCredential(e,t){return C.gM.add(async()=>{let n={appInstanceDid:e,appDid:t};v.k.log("hive","Asking the identity provider to generate app ID credential for appInstanceDid:",e,"appDid:",t);try{return(0,d.HL)(async()=>{let t=await this.identity.provider.issueCredential(this.identity.did,e,"#app-id-credential",["https://elastos.org/fakecontext#AppIdCredential"],g()().add(30,"days").toDate(),n);return t},!0,null)}catch(e){return v.k.error("identity","Failed to issue the app id credential...",e),null}})}constructor(e){this.identity=e,this.vaultStatus$=new f.P(null,async()=>{this.retrieveVaultStatus()}),this.vaultAddress$=new p.X(null),this.appContextCache=new A.R}}var U=n(5676),F=n(59606),_=n(78330),N=n(78212),O=n(44853),K=n.n(O),W=n(72440),V=n.n(W),L=n(45685),B=n(21417),R=n(54860),H=n(67133).Buffer;async function J(e,t){let{FileDownloadExecutable:n}=await (0,m.pH)(),i=new Date().getTime(),r=t.type,a="identity/avatar/"+i,s=await (0,R.EX)(t),l=await (0,R.hv)(s,300),o=await e.get("hive").getVaultService(),c=await o.getFilesService().upload(a,H.from(l),{onProgress:()=>{}},!1);v.k.log("profile","Completed avatar upload to hive",c);let d="getMainIdentityAvatar"+i,u=await e.get("hive").getScriptingService();await u.registerScript(d,new n(d,a).setOutput(!0),void 0,!0,!0);let h=B.l.get("appDid"),y="hive://"+e.did+"@"+h+"/"+d+"?params={}";return v.k.log("identity","Generated avatar url:",y),{mimeType:r,avatarHiveURL:y}}let M=(0,N.S)()&&new _.J("identity-info-names"),q=(0,N.S)()&&new _.J("identity-info-icons");class z{get name$(){return M.listen(this.identity.did)}get icon$(){return q.listen(this.identity.did)}setActiveCredential(e){this.activeCredential$.next(e)}refreshIdentityName(){let e=this.getName();this.name$.next(e),M.put(this.identity.did,e)}refreshIdentityIcon(){var e;let t=null===(e=this.avatarCredential$.value)||void 0===e?void 0:e.representativeIcon$.value;"string"==typeof t?(this.icon$.next(t),q.put(this.identity.did,t)):(this.icon$.next(null),q.put(this.identity.did,null))}async createInitialNameCredential(e){let t=(0,F.Pr)("name");return(0,d.HL)(async()=>!!await this.createProfileCredential(null,t.typesForCreation(),t.key,e))}async createProfileCredential(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,r=[];return(0,u.Pt)(async()=>{let a;a=e||this.identity.did+"#"+n+function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8;return K()(Array(e),()=>"".concat(V()(1,10))).join("")}();let s=(0,F.m7)(t);r.push(s.type.getLongType());let l=g()().add(5,"years").toDate(),o=s.options.converter.toSubject(i);return this.identity.get("credentials").createCredential(a,r,l,o)},null)}async updateProfileCredential(e,t){let n=e.verifiableCredential.getId().toString(),i=(0,F.m7)(e.verifiableCredential.getType()),r=await this.identity.get("credentials").deleteCredential(e);if(!r)return!1;let a=await this.createProfileCredential(n,i.typesForCreation(),i.key,t);return!!a}getName(){var e;let t=null===(e=this.profileCredentials$.value)||void 0===e?void 0:e.find(e=>"name"===e.getProfileInfo().key);return t?t.getDisplayValue():null}async upsertIdentityAvatar(e){let t=await J(this.identity,e);if(t){let e=(0,F.Pr)("avatar"),n={mimeType:t.mimeType,hiveDownloadScriptUrl:t.avatarHiveURL};await this.deleteAvatarCredential(),await this.createProfileCredential("#avatar",e.typesForCreation(),e.key,n)}else console.log("Failed to upload avatar to hive")}async deleteAvatarCredential(){let e=this.avatarCredential$.value;e&&await this.identity.get("credentials").deleteCredential(e)}constructor(e){this.identity=e,this.activeCredential$=new p.X(null),this.profileCredentials$=new f.P(null,async()=>{this.identity.get("credentials").credentials$.pipe((0,L.U)(e=>null==e?void 0:e.filter(e=>e instanceof U.E))).subscribe(e=>{this.profileCredentials$.next(e),this.refreshIdentityName()})}),this.avatarCredential$=new f.P(null,async()=>{this.profileCredentials$.subscribe(e=>{let t=null==e?void 0:e.find(e=>"avatar"===e.verifiableCredential.getId().getFragment());null==t||t.representativeIcon$.subscribe(e=>{this.refreshIdentityIcon()}),this.avatarCredential$.next(t),this.refreshIdentityIcon()})})}}(i=r||(r={})).UNPUBLISHED="UNPUBLISHED",i.PUBLISHING="PUBLISHING",i.PUBLISHED="PUBLISHED",i.FAILED_TO_PUBLISH="FAILED_TO_PUBLISH";class Z{async startCheckingPublicationStatus(){try{for(;this.shouldContinueCheckingStatus();)await this.fetchPublicationStatus(this.identity.did),await new Promise(e=>{setTimeout(()=>{e()},2e3)})}catch(e){v.k.error("Exception while fetching identity publication status",e)}}shouldContinueCheckingStatus(){let e=this.publicationStatus$.value;return!e||e===r.UNPUBLISHED||e===r.PUBLISHING}async fetchPublicationStatus(e){let t=await eg.getPublicationStatus(e);v.k.log("publication","Got publication status",null==t?void 0:t.state),this.publicationStatus$.next(null==t?void 0:t.state)}awaitIdentityPublished(){return E(this.publicationStatus$,r.PUBLISHED)}constructor(e){this.identity=e,this.publicationStatus$=new f.P(null,async()=>{this.startCheckingPublicationStatus()})}}let G="identity_storage_index";class X{async lazyLoadIndex(){if(this.index)return;let e=await localStorage.getItem(G)||null;this.index=e?JSON.parse(e):[]}async saveIndex(){await localStorage.setItem(G,JSON.stringify(this.index))}async set(e,t){await this.lazyLoadIndex();let n=this.getFullKey(e);return this.index.includes(n)||(this.index.push(n),await this.saveIndex()),localStorage.setItem(n,t)}async get(e,t){await this.lazyLoadIndex();let n=this.getFullKey(e);return localStorage.getItem(n)||t}async unset(e){let t=this.getFullKey(e);return localStorage.removeItem(t)}async clean(){for(let e of(await this.lazyLoadIndex(),this.index))await localStorage.removeItem(e);this.index=[],await this.saveIndex()}getFullKey(e){return this.identity.did+"_"+e}setJSON(e,t){return this.set(e,JSON.stringify(t))}async getJSON(e,t){return JSON.parse(await this.get(e,JSON.stringify(t)))}constructor(e){this.identity=e,this.index=null}}function Y(){let e=(0,a._)(["\n        mutation markIdentityInUse($identityDid: String!) {\n          markIdentityInUse(identityDid: $identityDid)\n        }\n      "]);return Y=function(){return e},e}class Q{static async fromJson(e,t){let n=new Q;return Object.assign(n,e),n.createdAt=new Date(e.createdAt),n.lastUsedAt$.next(new Date(e.lastUsedAt)),n.provider=t,n}get(e){if(!this.features.has(e))throw Error("Unhandled user feature '".concat(e,"'"));return this.features.get(e)}addFeature(e,t){if(!this.features.has(e))return this.features.set(e,t),t}createVerifiablePresentation(e,t,n){return(0,d.HL)(()=>this.provider.createVerifiablePresentation(this.did,e,t,n),!0)}equals(e){return this.did===e.did}async markIdentityInUse(e){var t;let n=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(Y()),variables:{identityDid:e}}));return this.lastUsedAt$.next(g()().toDate()),null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.markIdentityInUse}constructor(){this.lastUsedAt$=new p.X(null),this.features=new Map,this.addFeature("credentials",new w(this)),this.addFeature("profile",new z(this)),this.addFeature("did",new S(this)),this.addFeature("hive",new j(this)),this.addFeature("storage",new X(this)),this.addFeature("publication",new Z(this))}}function ee(){let e=(0,a._)(["\n          mutation createIdentity($input: CreateIdentityInput!) {\n            createIdentity(input: $input) {\n              ","\n            }\n          }\n        "]);return ee=function(){return e},e}function et(){let e=(0,a._)(["\n        mutation deleteIdentity($identityDid: String!) {\n          deleteIdentity(identityDid: $identityDid)\n        }\n      "]);return et=function(){return e},e}function en(){let e=(0,a._)(["\n        query ListIdentities {\n          identities {\n            ","\n          }\n        }\n      "]);return en=function(){return e},e}function ei(){let e=(0,a._)(["\n        mutation createDIDPublishTransaction($identityDid: String!) {\n          createDIDPublishTransaction(identityDid: $identityDid) {\n            ","\n          }\n        }\n      "]);return ei=function(){return e},e}function er(){let e=(0,a._)(["\n        mutation publishIdentity($identityDid: String!, $payload: String!) {\n          publishIdentity(input: { identityDid: $identityDid, payload: $payload}) {\n            ","\n          }\n        }\n      "]);return er=function(){return e},e}function ea(){let e=(0,a._)(["\n        mutation getPublicationStatus($identityDid: String!) {\n          getPublicationStatus(input: { identityDid: $identityDid}) {\n            state\n          }\n        }\n      "]);return ea=function(){return e},e}function es(){let e=(0,a._)(["\n        mutation createCredential($identityDid: String!, $credentialId: String!, $types: Json!, $expirationDate: String!, $properties: Json!) {\n          createCredential(input: { identityDid: $identityDid, credentialId: $credentialId, types: $types, expirationDate: $expirationDate, properties: $properties}) {\n            ","\n          }\n        }\n      "]);return es=function(){return e},e}function el(){let e=(0,a._)(["\n        mutation issueCredential($identityDid: String!, $subjectDid: String!, $credentialId: String!, $types: Json!, $expirationDate: String!, $properties: Json!) {\n          issueCredential(input: { identityDid: $identityDid, subjectDid: $subjectDid, credentialId: $credentialId, types: $types, expirationDate: $expirationDate, properties: $properties}) {\n            ","\n          }\n        }\n      "]);return el=function(){return e},e}function eo(){let e=(0,a._)(["\n        mutation importCredential($identityDid: String!, $credentialString: String!) {\n          importCredential(input: { identityDid: $identityDid, credentialString: $credentialString}) {\n            ","\n          }\n        }\n      "]);return eo=function(){return e},e}function ec(){let e=(0,a._)(["\n        query ListCredentials($identityDid: String!) {\n          credentials(identityDid: $identityDid) {\n            ","\n          }\n        }\n      "]);return ec=function(){return e},e}function ed(){let e=(0,a._)(["\n        mutation deleteCredential($id: String!) {\n          deleteCredential(id: $id)\n        }\n      "]);return ed=function(){return e},e}function eu(){let e=(0,a._)(["\n        mutation createVerifiablePresentation($identityDid: String!, $credentials: Json!, $realm: String!, $nonce: String!) {\n          createVerifiablePresentation(input: { identityDid: $identityDid, credentials: $credentials, realm: $realm, nonce: $nonce}) {\n            ","\n          }\n        }\n      "]);return eu=function(){return e},e}class eh{async createIdentity(e,t){var n;let i={name:e,hiveVaultProvider:t},r=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(ee(),o),variables:{input:i}}));if(null==r?void 0:null===(n=r.data)||void 0===n?void 0:n.createIdentity)return Q.fromJson(r.data.createIdentity,this);throw Error("Failed to create DID")}async deleteIdentity(e){var t;let n=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(et()),variables:{identityDid:e}}));if(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.deleteIdentity)return!0;throw Error("Failed to delete DID")}async listIdentities(){var e;let t=await (0,u.Pt)(async()=>(await (0,h.W)()).query({query:(0,s.Ps)(en(),o)}));if(null==t?void 0:null===(e=t.data)||void 0===e?void 0:e.identities){let e=await Promise.all(t.data.identities.map(e=>Q.fromJson(e,this)));return v.k.log("custodial-provider","Fetched identities:",e),e}return null}async createDIDPublishTransaction(e){var t;let n=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(ei(),"\n  payload\n"),variables:{identityDid:e}}));if(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.createDIDPublishTransaction.payload)return null==n?void 0:n.data.createDIDPublishTransaction.payload;throw Error("Failed to create transaction")}async publishIdentity(e,t){var n;let i=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(er(),"\n  publicationId\n"),variables:{identityDid:e,payload:t}}));if(null==i?void 0:null===(n=i.data)||void 0===n?void 0:n.publishIdentity.publicationId)return null==i?void 0:i.data.publishIdentity.publicationId;throw Error("Failed to publish DID")}async getPublicationStatus(e){var t;let n=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(ea()),variables:{identityDid:e}}));if(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.getPublicationStatus)return n.data.getPublicationStatus;throw Error("Failed to get publication status")}async createCredential(e,t,n,i,r){var a;let o=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(es(),l),variables:{identityDid:e,credentialId:t,types:n,expirationDate:i,properties:r}}));return(null==o?void 0:null===(a=o.data)||void 0===a?void 0:a.createCredential)?(0,c.q)(o.data.createCredential):null}async issueCredential(e,t,n,i,r,a){var l;let{VerifiableCredential:o}=await (0,m.hS)(),c=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(el(),"\n  verifiableCredential\n"),variables:{identityDid:e,subjectDid:t,credentialId:n,types:i,expirationDate:r,properties:a}}));return(null==c?void 0:null===(l=c.data)||void 0===l?void 0:l.issueCredential)?o.parse(c.data.issueCredential.verifiableCredential):null}async importCredential(e,t){var n;let i=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(eo(),l),variables:{identityDid:e,credentialString:t.toString()}}));return(null==i?void 0:null===(n=i.data)||void 0===n?void 0:n.importCredential)?(0,c.q)(i.data.importCredential):null}async listCredentials(e){var t;let n=await (0,u.Pt)(async()=>(await (0,h.W)()).query({query:(0,s.Ps)(ec(),l),variables:{identityDid:e}}));if(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.credentials){let e=await Promise.all(n.data.credentials.map(e=>(0,c.q)(e)));return v.k.log("custodial-provider","Fetched credentials:",e),e}return null}async deleteCredential(e){var t;let n=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(ed()),variables:{id:e}}));if(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.deleteCredential)return!0;throw Error("Failed to delete Credential")}async createVerifiablePresentation(e,t,n,i){var r;let{VerifiablePresentation:a}=await (0,m.hS)(),l=[];t.forEach(e=>{l.push(e.toJSON())});let o=await (0,u.Pt)(async()=>(await (0,h.W)()).mutate({mutation:(0,s.Ps)(eu(),"\n  verifiablePresentation\n"),variables:{identityDid:e,credentials:l,realm:n,nonce:i}}));return(null==o?void 0:null===(r=o.data)||void 0===r?void 0:r.createVerifiablePresentation)?a.parse(o.data.createVerifiablePresentation.verifiablePresentation):null}addDIDDocumentService(e,t,n,i,r){throw Error("Method not implemented.")}removeDIDDocumentService(e,t){throw Error("Method not implemented.")}}var ey=n(53932);let eg=new class{createIdentity(e,t){return this.provider.createIdentity(e,t)}deleteIdentity(e){return this.provider.deleteIdentity(e)}createDIDPublishTransaction(e){return this.provider.createDIDPublishTransaction(e)}publishIdentity(e,t){return this.provider.publishIdentity(e,t)}getPublicationStatus(e){return this.provider.getPublicationStatus(e)}async setActiveIdentity(e){if(!e){ey.B.next(null),this.activeIdentityId="",localStorage.setItem("activeIdentityId","");return}try{await e.markIdentityInUse(e.did)}catch(e){}ey.B.next(e),this.activeIdentityId=e.did,localStorage.setItem("activeIdentityId",this.activeIdentityId)}getActiveIdentityId(){return this.activeIdentityId||(this.activeIdentityId=this.loadActiveIdentityId()),this.activeIdentityId}loadActiveIdentityId(){return localStorage.getItem("activeIdentityId")}restoreActiveIdentity(e){if(!ey.B.value){if(this.getActiveIdentityId()){let t=this.findIdentityByDID(this.activeIdentityId,e);this.setActiveIdentity(t);return}e.length>0&&eg.setActiveIdentity(e[0])}}findIdentityByDID(e,t){let n=null==t?void 0:t.find(t=>t.did===e);return n}async listIdentities(){let e=await this.provider.listIdentities();return this.restoreActiveIdentity(e),e}addDIDDocumentService(e,t,n,i,r){return this.provider.addDIDDocumentService(e,t,n,i,r)}removeDIDDocumentService(e,t){return this.provider.removeDIDDocumentService(e,t)}constructor(){this.provider=new eh,this.activeIdentityId=""}}},8106:function(e,t,n){n.d(t,{n:function(){return a}});var i=n(3883),r=n(85300);let a=new class{async getIssuerName(e){let t=await this.fetchDIDDocument(e);return await r._.getRepresentativeOwnerName(t)}async getIssuerAvatar(e){let t=await this.fetchDIDDocument(e),n=await r._.getRepresentativeIcon(t);return n?(i.k.log("identity","dataUrl",n),n):null}async isPublished(e){let t=await this.fetchDIDDocument(e);return!!t}async fetchDIDDocument(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e="did:elastos:iqjN3CLRjd7a4jGCZe6B3isXyeLy7KKDuK";let n=await r._.fetchOrAwaitDIDDocumentWithStatus(e,t);return n.checked?n.document:null}}},9581:function(e,t,n){n.d(t,{Z:function(){return r}});var i=n(27524);let r=new i.x},21290:function(e,t,n){n.d(t,{Cp:function(){return v},Dk:function(){return w},cI:function(){return p},wo:function(){return f}});var i=n(60230),r=n(23965),a=n(5344),s=n(95640),l=n(51385),o=n(76506),c=n(3883),d=n(9581);function u(){let e=(0,i._)(["\n        mutation bindKey($newKey: AuthKeyInput!) {\n          bindKey(newKey: $newKey) {\n            ","\n          }\n        }\n      "]);return u=function(){return e},e}function h(){let e=(0,i._)(["\n        mutation ChangePassword($newPassword: String!) {\n          changePassword(newPassword: $newPassword) {\n            ","\n          }\n        }\n      "]);return h=function(){return e},e}function y(){let e=(0,i._)(["\n          mutation unlockMasterKey($authKey: AuthKeyInput!) {\n            unlockMasterKey(authKey: $authKey)\n          }\n        "]);return y=function(){return e},e}function g(){let e=(0,i._)(["\n      query GenerateChallenge {\n        generateChallenge{\n          id,\n          content\n        }\n    }\n    "]);return g=function(){return e},e}async function p(e){var t,n;c.k.log("keyring","Binding key");let i=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(u(),a.j),variables:{newKey:e}}),null);if(null==i||null===(t=i.data)||void 0===t||!t.bindKey)return c.k.error("keyring","Failed to bind key"),null;{let e=await s.M.fromJson(null==i?void 0:null===(n=i.data)||void 0===n?void 0:n.bindKey);return c.k.log("keyring","Key bound successfully"),e}}async function v(e){var t,n;c.k.log("keyring","Changing password");let i=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(h(),a.j),variables:{newPassword:e}}),null);if(null==i||null===(t=i.data)||void 0===t||!t.changePassword)return null;{let e=await Promise.all(null==i?void 0:null===(n=i.data)||void 0===n?void 0:n.changePassword.map(e=>s.M.fromJson(e)));return c.k.log("keyring","Password changed successfully",e),e}}async function f(e){var t;c.k.log("security","Trying to unlock master key");let n=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(y()),variables:{authKey:e}}),null);return null!=n&&null!==(t=n.data)&&void 0!==t&&!!t.unlockMasterKey&&(c.k.log("security","Master key unlocked successfully"),d.Z.next(!0),!0)}async function w(){c.k.log("passkey","get challenge to generate passkey");let e=await (0,l.Pt)(async()=>(await (0,o.W)()).query({query:(0,r.Ps)(g()),fetchPolicy:"network-only",variables:{}}));if(e){var t,n;let i=null===(t=e.data)||void 0===t?void 0:t.generateChallenge.id,r=null===(n=e.data)||void 0===n?void 0:n.generateChallenge.content;return{id:i,content:r}}throw Error("Can not get challenge by generateChallenge api.")}},3883:function(e,t,n){n.d(t,{k:function(){return l},m:function(){return o}});var i=n(62067),r=n.n(i);let a={default:"#008730",hive:"#5226af",did:"#06c4ce",connectivity:"#d17506"};function s(e){return a[e]||a.default}let l=new class{init(e){this.originalConsole=e,this.originalDebugLog=this.originalConsole.log,this.originalDebugWarn=this.originalConsole.warn,this.originalDebugErr=this.originalConsole.error}log(e){for(var t,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];let l=s(e);null===(t=this.originalDebugLog)||void 0===t||t.apply(this.originalConsole,["%c"+r()(new Date().getTime()).format("HH:mm:ss.SSS")+" "+e.toUpperCase()+"*","background: ".concat(l,"; color: #FFF; font-weight:bold; padding:5px;"),...i])}warn(e){for(var t,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];let l=s(e);null===(t=this.originalDebugWarn)||void 0===t||t.apply(this.originalConsole,["%c"+r()(new Date().getTime()).format("HH:mm:ss.SSS")+" "+e.toUpperCase()+"*","background: ".concat(l,"; color: #FFF; font-weight:bold; padding:5px;"),...i])}error(e){for(var t,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];let l=s(e);null===(t=this.originalDebugErr)||void 0===t||t.apply(this.originalConsole,["%c"+r()(new Date().getTime()).format("HH:mm:ss.SSS")+" "+e.toUpperCase()+"*","background: ".concat(l,"; color: #FFF; font-weight:bold; padding:5px;"),...i])}test(e){for(var t,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];let l=s(e);null===(t=this.originalDebugLog)||void 0===t||t.apply(this.originalConsole,["%c"+r()(new Date().getTime()).format("HH:mm:ss.SSS")+" "+e.toUpperCase()+"* TEST","background: ".concat(l,"; color: #FFF; font-weight:bold; padding:5px;"),...i])}constructor(){this.originalConsole=null}};class o{log(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];l.log.apply(l,["connectivity",...t])}warn(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];l.warn.apply(l,["connectivity",...t])}error(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];l.error.apply(l,["connectivity",...t])}}},52856:function(e,t,n){n.d(t,{L:function(){return a},z:function(){return r}});var i=n(48023);function r(e){return e.appExceptionCode===i.gs.Unauthorized}function a(e){return e.appExceptionCode===i.XF.UnlockKeyCancelled}},69990:function(e,t,n){n.d(t,{M6:function(){return s},jU:function(){return a}});var i=n(8062),r=n(1859);let a=new r.P(null,async()=>{{let e=localStorage.getItem("authenticated_user");return e?i.n.fromJson(JSON.parse(e)):null}});function s(){return a.value}},16421:function(e,t,n){n.d(t,{X:function(){return $},bB:function(){return O},kv:function(){return U},jF:function(){return N},h3:function(){return W},U:function(){return K},JA:function(){return _},g$:function(){return F},HA:function(){return P},w7:function(){return j},y1:function(){return x}});var i=n(60230),r=n(23965),a=n(10530),s=n(8062),l=n(20708),o=n(51385),c=n(76506),d=n(21290),u=n(3883),h=n(2512),y=n(69810),g=n.n(y),p=n(69990),v=n(67133).Buffer;function f(){let e=(0,i._)(["\n        mutation SignUp($input: SignUpInput!) {\n          signUp(input: $input) { accessToken refreshToken }\n        }\n      "]);return f=function(){return e},e}function w(){let e=(0,i._)(["\n        query GetSelfUser {\n          getSelfUser { "," }\n        }\n      "]);return w=function(){return e},e}function m(){let e=(0,i._)(["\n      mutation RequestEmailAuthentication($emailAddress: String!) {\n        requestEmailAuthentication(emailAddress: $emailAddress) { success }\n      }\n    "]);return m=function(){return e},e}function I(){let e=(0,i._)(["\n        mutation CheckEmailAuthentication($authKey: String!) {\n          checkEmailAuthentication(authKey: $authKey) { accessToken refreshToken }\n        }\n      "]);return I=function(){return e},e}function b(){let e=(0,i._)(["\n        mutation RefreshToken($token: String!) {\n          refreshToken(refreshTokenInput: { refreshToken: $token }) { accessToken }\n        }\n      "]);return b=function(){return e},e}function D(){let e=(0,i._)(["\n        query signInWithPasskey ($authKey: AuthKeyInput!) {\n          signInWithPasskey (authKey: $authKey) {\n            accessToken,\n            refreshToken\n          }\n        }\n      "]);return D=function(){return e},e}function k(){let e=(0,i._)(["\n        mutation OauthMSSignIn($input: MsSignInInput!) {\n          oauthMSSignIn(input: $input) { accessToken refreshToken }\n        }\n      "]);return k=function(){return e},e}function S(){let e=(0,i._)(["\n        mutation OauthMSBindEmail($input: MsBindEmailInput!) {\n          oauthMSBindEmail(input: $input)\n        }\n      "]);return S=function(){return e},e}let C=new(g())(1);async function x(e){u.k.log("user","Sign up user, creating new user entry");let t={name:e},n=await (0,o.Pt)(async()=>(await (0,c.W)()).mutate({mutation:(0,r.Ps)(f()),variables:{input:t}}));if(null==n||!n.data||!n.data.signUp)return u.k.error("user","failed to sign up."),null;{let{accessToken:e,refreshToken:t}=n.data.signUp;return T(e,t)}}async function A(e){localStorage.setItem("authenticated_user",JSON.stringify(e)),p.jU.next(await s.n.fromJson(e))}async function P(e){return A(e.toJson())}async function E(e,t){return C.add(async()=>{var n,i;u.k.log("users","Fetching self user profile"),e&&localStorage.setItem("access_token",e),t&&localStorage.setItem("refresh_token",t);let a=await (0,o.Pt)(async()=>(await (0,c.W)()).query({query:(0,r.Ps)(w(),"id name createdAt")}));if(null==a?void 0:null===(n=a.data)||void 0===n?void 0:n.getSelfUser){let e=null==a?void 0:null===(i=a.data)||void 0===i?void 0:i.getSelfUser,t=await s.n.fromJson(e);return await A(e),u.k.log("users","user from fetchSelfUser():",t),t}throw Error("no data got from fetchSelfUser()")})}async function $(e){u.k.log("user","Sending request to authentication by email"),await (0,o.Pt)(async()=>(await (0,c.W)()).mutate({mutation:(0,r.Ps)(m()),variables:{emailAddress:e}}))}async function T(e,t){let n=localStorage.getItem("access_token"),i=localStorage.getItem("refresh_token");localStorage.setItem("access_token",e),localStorage.setItem("refresh_token",t);try{let t=await E(e);return await (0,l.Pd)(e),t}catch(e){return u.k.error("userService","failed to fetch user info.: ",e),localStorage.setItem("access_token",n),localStorage.setItem("refresh_token",i),null}}function j(){localStorage.removeItem("authenticated_user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),p.jU.next(null)}async function U(e){u.k.log("user","Checking temporary authentication key");try{var t;let n=await (0,o.Pt)(async()=>(await (0,c.W)()).mutate({mutation:(0,r.Ps)(I()),variables:{authKey:e}}));if(null==n||null===(t=n.data)||void 0===t||!t.checkEmailAuthentication)return!1;{let{accessToken:e,refreshToken:t}=n.data.checkEmailAuthentication;return await T(e,t),!0}}catch(e){return u.k.warn("user","Exception while checking temporary auth key. Key expired?"),null}}async function F(){var e;let t=localStorage.getItem("refresh_token");if(!t){_();return}let n=await (0,o.Pt)(async()=>(await (0,c.W)()).mutate({mutation:(0,r.Ps)(b()),variables:{token:t}}));if(null==n?void 0:null===(e=n.data)||void 0===e?void 0:e.refreshToken){u.k.log("user","Got refreshed access token");let{accessToken:e}=n.data.refreshToken;return localStorage.setItem("access_token",e),await (0,l.Pd)(e),p.jU.next((0,p.M6)()),e}throw Error("Can not get access token by refresh token.")}function _(){localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("authenticated_user"),window.location.href="/dashboard"}function N(){let e=localStorage.getItem("access_token");return e&&""!==e}async function O(){var e,t,n,i,s,l;u.k.log("user","Authenticating with passkey");let y=await (0,d.Dk)(),g=function(e){let t=new TextEncoder,n=t.encode(e.content),i={challenge:v.from(n).toString(),allowCredentials:[],rpId:"didweb.trinity-tech.io",userVerification:"required",timeout:6e4};return i}(y),p=await (0,h.oz)(g,!1),f={type:a.J.WEBAUTHN,keyId:p.id,key:JSON.stringify(p),challengeId:y.id},w=await (0,o.Pt)(async()=>(await (0,c.W)()).query({query:(0,r.Ps)(D()),variables:{authKey:f},fetchPolicy:"network-only"}));if(null==w||null===(t=w.data)||void 0===t||null===(e=t.signInWithPasskey)||void 0===e||!e.accessToken)return u.k.error("Failed to sign in with passkey."),!1;{let e=null==w?void 0:null===(i=w.data)||void 0===i?void 0:null===(n=i.signInWithPasskey)||void 0===n?void 0:n.accessToken,t=null==w?void 0:null===(l=w.data)||void 0===l?void 0:null===(s=l.signInWithPasskey)||void 0===s?void 0:s.refreshToken;return await T(e,t),!0}}async function K(e){u.k.log("user","oauth MS sign in.");let t={code:e},n=await (0,o.Pt)(async()=>(await (0,c.W)()).mutate({mutation:(0,r.Ps)(k()),variables:{input:t}}));if(null==n||!n.data||!n.data.oauthMSSignIn)return u.k.error("user","failed to oauth MS sign in."),null;{let{accessToken:e,refreshToken:t}=n.data.oauthMSSignIn;return T(e,t)}}async function W(e){u.k.log("user","oauth MS bind email.");let t={code:e},n=await (0,o.Pt)(async()=>(await (0,c.W)()).mutate({mutation:(0,r.Ps)(S()),variables:{input:t}}));return null!=n&&!!n.data&&!!n.data.oauthMSBindEmail||(u.k.error("user","failed to oauth MS bind email."),!1)}},1859:function(e,t,n){n.d(t,{P:function(){return c}});var i,r,a=n(9581),s=n(3883),l=n(52856),o=n(50676);(i=r||(r={}))[i.NotCalled=0]="NotCalled",i[i.Called=1]="Called",i[i.FailedUnlock=2]="FailedUnlock",i[i.Failed=3]="Failed";class c extends o.X{hasInitializer(){return!!this.initializer}subscribe(e,t,n){return this.fetchedOrFetching||(this.fetchedOrFetching=!0,this.callInitializer()),super.subscribe(...arguments)}callInitializer(){this.initializer&&this.initializer().then(e=>{e&&(this.next(e),this.initializerState.next(r.Called))}).catch(e=>{(0,l.L)(e)?(this.masterKeyUnlockSub||(console.log("SUB"),this.masterKeyUnlockSub=a.Z.subscribe(()=>{console.log("CB",this.initializerState.value.toString()),(this.initializerState.value===r.NotCalled||this.initializerState.value===r.FailedUnlock)&&this.callInitializer()})),this.initializerState.next(r.FailedUnlock)):(s.k.error("AdvancedBehaviorSubject",e),this.initializerState.next(r.Failed))})}constructor(e,t){super(e),this.initializer=t,this.fetchedOrFetching=!1,this.initializerState=new o.X(r.NotCalled)}}},6598:function(e,t,n){n.d(t,{R:function(){return s}});var i=n(3883),r=n(69810),a=n.n(r);class s{async get(e,t){let n=!(arguments.length>2)||void 0===arguments[2]||arguments[2];return n&&this.has(e)?this.cache[e]:(n||null===e||i.k.warn("cache","Forcing to not use cache for key:",e,". This could create duplicate objects that don't update well everywhere"),t)?this.loadQueue.add(async()=>{var i,r;if(n&&this.has(e)){let n=this.cache[e];return await (null==t?void 0:null===(r=t.fill)||void 0===r?void 0:r.call(t,n)),n}{if(!t)return null;let n=await t.create();return await (null===(i=t.fill)||void 0===i?void 0:i.call(t,n)),this.cache[e]=n,n}}):null}has(e){return e in this.cache}constructor(){this.cache={},this.loadQueue=new(a())(1)}}},78330:function(e,t,n){n.d(t,{J:function(){return l}});class i{getObjectStore(e){return this.db.then(t=>{let n=t.transaction(this.storeName,e);return n.objectStore(this.storeName)})}get(e){return this.getObjectStore("readonly").then(t=>new Promise((n,i)=>{let r=t.get(e);r.onerror=()=>i(r.error),r.onsuccess=()=>n(r.result)}))}put(e,t){return this.getObjectStore("readwrite").then(n=>new Promise((i,r)=>{let a=n.put(t,e);a.onerror=()=>r(a.error),a.onsuccess=()=>i()}))}constructor(e){this.storeName=e,this.db=new Promise((t,n)=>{let i=indexedDB.open(e);i.onerror=()=>n(i.error),i.onsuccess=()=>{i.result.objectStoreNames.contains(e)&&t(i.result)},i.onupgradeneeded=()=>{i.result.objectStoreNames.contains(e)||i.result.createObjectStore(e),t(i.result)}})}}var r=n(69810),a=n.n(r),s=n(50676);class l{async get(e,t){return this.queue.add(async()=>{let n=await this.db.get(e);return!n&&this.cacheMissCallback&&(n=await this.cacheMissCallback(e,t))&&await this.db.put(e,n),n})}async put(e,t){await this.db.put(e,t),this.getListener(e).next(t)}listen(e,t){return this.getListener(e,t)}getListener(e,t){return e in this.listeners||(this.listeners[e]=new s.X(null),this.get(e,t).then(t=>this.listeners[e].next(t))),this.listeners[e]}constructor(e,t){this.cacheMissCallback=t,this.queue=new(a())(1),this.listeners={},this.db=new i(e)}}},78212:function(e,t,n){n.d(t,{S:function(){return i}});function i(){return!0}},35324:function(e,t,n){n.d(t,{hS:function(){return r},pH:function(){return a}});let i={},r=async()=>(i["@elastosfoundation/did-js-sdk"]||(i["@elastosfoundation/did-js-sdk"]=await Promise.all([n.e(9787),n.e(9443),n.e(8218),n.e(3874),n.e(5294)]).then(n.bind(n,26588))),i["@elastosfoundation/did-js-sdk"]),a=async()=>(i["@elastosfoundation/hive-js-sdk"]||(i["@elastosfoundation/hive-js-sdk"]=await Promise.all([n.e(9787),n.e(9443),n.e(8218),n.e(3874),n.e(475),n.e(8827)]).then(n.bind(n,20475))),i["@elastosfoundation/hive-js-sdk"])},54860:function(e,t,n){n.d(t,{EX:function(){return c},Ik:function(){return l},hv:function(){return o}});var i=n(3883),r=n(35698),a=n(67133).Buffer;let s=[{mime:"image/png",pattern:[137,80,78,71]},{mime:"image/jpeg",pattern:[255,216,255]},{mime:"image/gif",pattern:[71,73,70,56]},{mime:"image/webp",pattern:[82,73,70,70,void 0,void 0,void 0,void 0,87,69,66,80,86,80]}],l=async e=>{if(!e)return"";let t=await function(e){if("string"==typeof e){var t;t=e,e=a.from(t,"base64")}let n=Math.max(...s.map(e=>e.pattern.length)),i=new Blob([e.slice(0,n)]),r=new FileReader,l=new Promise(e=>{r.onloadend=t=>{if("loadend"==t.type){if(!t||!r.result){e(null);return}let n=new Uint8Array(r.result),i=s.find(e=>e.pattern.every((e,t)=>!e||n[t]===e));i?e(i.mime):e(null)}}});return r.readAsArrayBuffer(i),l}(e);if(!t)return i.k.warn("pictures","Unable to extract picture mime type. If the picture invalid?"),null;let n=a.from(e).toString("base64");return"data:".concat(t,";base64,").concat(n)},o=(e,t)=>new Promise((n,i)=>{let a=new Image;a.src=e,a.onload=()=>{let e=document.createElement("canvas"),i=a.width,s=a.height;i>=s&&i>t?(s*=t/i,i=t):s>t&&(i*=t/s,s=t),e.width=i,e.height=s;let l=e.getContext("2d");l.drawImage(a,0,0,i,s);let o=l.canvas.toDataURL();n((0,r.u0)(o))},a.onerror=e=>i(e)}),c=e=>new Promise((t,n)=>{let i=new FileReader;i.onload=()=>{t(i.result)},i.onerror=e=>{n(e)},i.readAsDataURL(e)})},9177:function(e,t,n){function i(e){return e.charAt(0).toUpperCase()+e.slice(1)}function r(e,t){return(null==e?void 0:e.length)>t?e.substring(0,t/2-1)+"..."+e.substring(e.length-(t/2-1),e.length):e}function a(e){return null==e?null:i(e.split(" ").map(e=>e[0]).join(""))}function s(e){if(!/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{1,3})?Z)$/.test(e))return e;let t=new Date(e),n=navigator.language,i=new Intl.DateTimeFormat(n),r=i.format(t);return r}function l(e){return null==e?null:"M"===e?"male":"F"===e?"female":e}function o(e){return"string"!=typeof e}n.d(t,{OX:function(){return a},Sy:function(){return r},Y5:function(){return o},aD:function(){return l},fm:function(){return i},r2:function(){return s}})}}]);