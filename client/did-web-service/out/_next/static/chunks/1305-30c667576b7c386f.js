(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1305],{80950:function(){},46601:function(){},89214:function(){},8623:function(){},7748:function(){},85568:function(){},75992:function(){},78110:function(){},56619:function(){},24654:function(){},77108:function(){},52361:function(){},94616:function(){},12131:function(e,t,n){"use strict";n.d(t,{c:function(){return l}});var i=n(57437),r=n(6882),a=n(35551),s=n(57042);let l=e=>{let{leftIcon:t,size:n="medium",mode:l="default",onClick:o,children:u,busy:c=!1,disabled:d=!1,className:h}=e,y=(0,i.jsx)(r.Z,{size:16});return(0,i.jsx)("div",{className:(0,s.Z)("flex",h),children:(0,i.jsx)(a.Z,{className:"flex-1",startIcon:c?y:t,disabled:c||d,size:n,color:"default"===l?"primary":"error",variant:"contained",onClick:o,children:u})})}},57135:function(e,t,n){"use strict";n.d(t,{au:function(){return g},lJ:function(){return v}});var i=n(57437),r=n(451),a=n(10530),s=n(22079),l=n(43226),o=n(69990),u=n(2265),c=n(12131);let d=e=>{let{onConfirm:t,disabled:n}=e,[a]=(0,r.V)((0,o.jU)()),s=null==a?void 0:a.get("security"),l=async()=>{let e=await s.unlockPasskeyLocally();t(e)};return(0,i.jsxs)("div",{className:"flex flex-row gap-4 bg-gray-100 mt-4 p-4 items-center",children:[(0,i.jsxs)("p",{className:"uppercase text-xs",children:["Browser",(0,i.jsx)("br",{}),"authentication"]}),(0,i.jsx)(c.c,{onClick:l,disabled:n,children:"Unlock with passkey"})]})};var h=n(67212);let y=e=>{let{onConfirm:t,disabled:n}=e,r=(0,u.createRef)();return(0,i.jsxs)("div",{className:"flex flex-row gap-4 bg-gray-100 mt-4 p-4",children:[(0,i.jsxs)("p",{className:"uppercase text-xs",children:["master",(0,i.jsx)("br",{}),"password"]}),(0,i.jsx)(h.Z,{label:"Your password",inputRef:r,autoFocus:!0,type:"password",name:"master-password",variant:"outlined",size:"small",disabled:n}),(0,i.jsx)(c.c,{onClick:()=>{let e=r.current.value;t(e)},disabled:n,children:"Continue"})]})},f=(0,u.createContext)({actions:null,setActions:null});function g(e){let[t,n]=(0,u.useState)(null);return(0,i.jsxs)(f.Provider,{value:{actions:t,setActions:n},children:[e.children,(0,i.jsx)(p,{})]})}let p=()=>{let{actions:e,setActions:t}=(0,u.useContext)(f),[n]=(0,r.V)((0,o.jU)()),c=null==n?void 0:n.get("security"),[h]=(0,r.V)(null==c?void 0:c.passwordKeys$),[g]=(0,r.V)(null==c?void 0:c.passkeyKeys$),p=()=>{t(null)};return(0,i.jsx)(s.Z,{open:!!e,disablePortal:!0,onClose:()=>{var t;null===(t=e.onUnlockKey)||void 0===t||t.call(e,null),p()},children:(0,i.jsxs)("div",{className:"p-4",children:[(0,i.jsx)(l.Z,{variant:"h4",children:"Content unlock needed!"}),(0,i.jsxs)(l.Z,{color:"#666",fontSize:14,children:["Your encrypted data needs to be unlocked so we can display it.",(0,i.jsx)("br",{}),"We can't do this without your interaction."]}),(0,i.jsx)("div",{className:"mt-4",children:(0,i.jsx)(y,{onConfirm:t=>{var n;null===(n=e.onUnlockKey)||void 0===n||n.call(e,{type:a.J.PASSWORD,keyId:"unused-for-now-for-passwords",key:t}),p()},disabled:(null==h?void 0:h.length)==0})}),(0,i.jsx)("div",{className:"my-4 text-center text-xs",children:"or"}),(0,i.jsx)("div",{className:"mt-4",children:(0,i.jsx)(d,{onConfirm:t=>{var n;null===(n=e.onUnlockKey)||void 0===n||n.call(e,t),p()},disabled:(null==g?void 0:g.length)==0})})]})})},v=()=>{let{setActions:e}=(0,u.useContext)(f);return{promptMasterKeyUnlock:()=>new Promise(t=>{e({onUnlockKey:t})})}}},99617:function(e,t,n){"use strict";n.d(t,{A:function(){return u}});var i=n(10530),r=n(20708),a=n(69990),s=n(18961),l=n(6598);let o=new l.R;class u{get activeShadowKey$(){return this._activeShadowKey$.getSubject()}static async fromJson(e){return o.get(e.id,{create:async function(){return new u},fill:async function(t){Object.assign(t,e),t.createdAt=new Date(e.createdAt),t.lastUsedAt=new Date(e.lastUsedAt)}})}isCurrentBrowser(){return this.id===(0,r.NN)()}equals(e){return this.id===(null==e?void 0:e.id)}constructor(){this._activeShadowKey$=new s.h(null,async()=>{(0,a.jU)().subscribe(e=>null==e?void 0:e.get("security").shadowKeys$.subscribe(e=>{this.activeShadowKey$.next(e.find(e=>{var t;return e.type===i.J.WEBAUTHN&&(null===(t=e.browser)||void 0===t?void 0:t.equals(this))}))}))})}}},69144:function(e,t,n){"use strict";n.d(t,{C:function(){return o},q:function(){return l}});var i=n(26588),r=n(59606),a=n(43900),s=n(5676);async function l(e){let t;let n=i.VerifiableCredential.parse(e.verifiableCredential),l=(0,r.m7)(n.type);return Object.assign(t=l?new s.E(l):new a.h,e),t.createdAt=new Date(e.createdAt),t.verifiableCredential=n,t.prepareForDisplay(),t}async function o(e){let t;let n=(0,r.m7)(e.type);return(t=n?new s.E(n):new a.h).verifiableCredential=e,t.prepareForDisplay(),t}},43900:function(e,t,n){"use strict";n.d(t,{h:function(){return j}});var i=n(26588);class r{static async loadOrCreate(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100,i=new r(e,n,t);return await i.load(),i}set(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this.items.findIndex(t=>t.key==e),r={key:e,timeValue:n,data:t};-1===i?this.items.push(r):this.items[i]=r,this.items.sort((e,t)=>0===e.timeValue?-1:0===t.timeValue?1:e.timeValue>t.timeValue?-1:e.timeValue<t.timeValue?1:0)}remove(e){let t=this.items.findIndex(t=>t.key==e);t>=0&&this.items.splice(t,1)}get(e){return this.items.find(t=>t.key==e)}values(){return this.items}size(){return this.items.length}async save(){let e=this.items.slice(0,Math.min(this.items.length,this.maxItemsOnDisk)),t="cache"+this.name;localStorage.setItem(t,JSON.stringify(e))}async load(){let e="cache"+this.name,t=localStorage.getItem(e);t&&(this.items=JSON.parse(t))}async delete(){let e="cache"+this.name;localStorage.removeItem(e)}constructor(e,t,n){this.name=e,this.maxItemsOnDisk=t,this.storeGlobally=n}}var a=n(3883);class s{getObjectStore(e){return this.db.then(t=>{let n=t.transaction(this.storeName,e);return n.objectStore(this.storeName)})}get(e){return this.getObjectStore("readonly").then(t=>new Promise((n,i)=>{let r=t.get(e);r.onerror=()=>i(r.error),r.onsuccess=()=>n(r.result)}))}put(e,t){return this.getObjectStore("readwrite").then(n=>new Promise((i,r)=>{let a=n.put(t,e);a.onerror=()=>r(a.error),a.onsuccess=()=>i()}))}constructor(e,t,n){this.storeName=t,this.db=new Promise((t,i)=>{let r=indexedDB.open(e);r.onerror=()=>i(r.error),r.onsuccess=()=>t(r.result),r.onupgradeneeded=()=>n(r.result)})}}var l=n(69810),o=n.n(l),u=n(78212),c=n(54860),d=n(12540);let h=(0,u.S)()&&new class{async get(e,t){return this.queue.add(async()=>{let n=await this.db.get(e);return!n&&(n=await this.cacheMissCallback(e,t))&&await this.db.put(e,n),n})}constructor(e,t){this.cacheMissCallback=t,this.queue=new(o())(1),this.db=new s("picture-cache",e,t=>{t.objectStoreNames.contains(e)||t.createObjectStore(e)})}}("hive-pictures",async(e,t)=>(a.k.log("hive","Cache miss for hive url picture, fetching"),f(t.hiveScriptUrl,t.did)));function y(e,t){return h.get(e+t,{hiveScriptUrl:e,did:t})}async function f(e,t){if(!e)return null;let n=await g(e,t);return n?(0,c.Ik)(n):""}async function g(e,t){e=e.replace("params={empty:0}",'params={"empty":0}');try{a.k.log("hive","Calling script url to download file",e);let n=await (0,d.no)(t),i=await n.getScriptingService().downloadFileByHiveUrl(e);if(!i||0===i.length)return a.k.warn("hive","Got empty data while fetching hive script picture",e),null;return a.k.log("hive","Got data after fetching hive script picture",e,"data length:",i.length),i}catch(t){return a.k.warn("hive","Failed to download hive asset at ",e,t),null}}var p=n(50676),v=n(51639);class w{get(e){if(!this.documentsSubjects.has(e)){let t=new p.X({checking:!1,checked:!1,document:null});this.documentsSubjects.set(e,t)}return this.documentsSubjects.get(e)}set(e,t,n,i){this.documentsSubjects.get(e).next({checking:t,checked:n,document:i})}constructor(){this.documentsSubjects=new Map}}let m=new class{async fetchActiveUserOnlineDIDDocument(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=v.D.getActiveIdentityId(),n=await this.resolveDIDWithoutDIDStore(t,e);return a.k.log("Identity","Resolved on chain document: ",n),this.onlineDIDDocumentsStatus.set(t,!1,!0,n),n}resolveDIDWithoutDIDStore(e,t){return this.resolveDIDQueue.add(async()=>{a.k.log("Identity","Resolving DID without DID store",e,t);let n=new i.DID(e);return i.DIDBackend.getInstance().resolveDid(n,t)})}fetchOrAwaitDIDDocumentWithStatus(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.onlineDIDDocumentsStatus.get(e);return new Promise(async i=>{if(n.value.checking){let e=n.subscribe(t=>{t.checked&&(e.unsubscribe(),i(t))})}else if(!n.value.checked||t){this.onlineDIDDocumentsStatus.set(e,!0,!1,null);let r=await this.resolveDIDWithoutDIDStore(e,t);a.k.log("Identity","Resolved on chain document: ",r),this.onlineDIDDocumentsStatus.set(e,!1,!0,r),i(n.value)}else i(n.value)})}getRepresentativeIcon(e){if(!e)return null;let t=null,n=e.getCredentials(),r=this.getCredentialsByType(n,"ApplicationCredential");if(r&&r.length>0){let e=r[0].getSubject().getProperties();"iconUrl"in e&&(t=e.iconUrl)}if(!t){let e=this.getCredentialsByType(n,"AvatarCredential");if(!e||0===e.length){let t=this.getCredentialById(n,new i.DIDURL("#avatar"));t&&e.push(t)}if(e&&e.length>0){let n=e[0].getSubject().getProperties();if("avatar"in n&&"object"==typeof n.avatar){let e=n.avatar;"type"in e&&"elastoshive"===e.type&&(t=e.data)}}}return t?y(t,e.getSubject().toString()):null}getRepresentativeOwnerName(e){if(!e)return null;let t=null,n=e.getCredentials(),r=this.getCredentialsByType(n,"ApplicationCredential");if(r&&r.length>0){let e=r[0].getSubject().getProperties();"name"in e&&(t=e.name)}if(!t){let e=this.getCredentialsByType(n,"NameCredential");if(e&&e.length>0){let n=e[0].getSubject().getProperties();"name"in n&&(t=n.name)}}if(!t){let e=this.getCredentialById(n,new i.DIDURL("#name"));if(e){let n=e.getSubject().getProperties();"name"in n&&(t=n.name)}}return t}getCredentialsByType(e,t){return null==e?void 0:e.filter(e=>e.getType().indexOf(t)>=0)}getCredentialById(e,t){return e.find(e=>t.getFragment()==e.getId().getFragment())}constructor(){this.onlineDIDDocumentsStatus=new w,this.resolveDIDQueue=new(o())(1),this.network="mainnet",i.DIDBackend.initialize(new i.DefaultDIDAdapter(this.network))}};var I=n(13952),b=n.n(I),k=n(62067),D=n.n(k);let S=new class{async init(){this.contextsCache=await r.loadOrCreate("credentialcontextpayloads",!0)}async resolveExpandedCredentialTypeIdentifiers(e){let t=null;try{t=e.toJSON()}catch(e){return a.k.warn("credentialtypes","Credential could not be parsed, returning empty types"),[]}if(!("@context"in t)||0!==t["@context"].indexOf("https://www.w3.org/2018/credentials/v1"))return[];try{let e=await b().expand(t,{documentLoader:this.buildElastosJsonLdDocLoader()});if(e&&e.length>0){let t=e[0];return Array.isArray(t["@type"])?t["@type"]:[t["@type"]]}console.log("error")}catch(e){a.k.warn("credentialtypes","Credential could not be expanded, returning empty types.",e)}return[]}async resolveTypesWithContexts(e){let t=null;try{if(t=e.toJSON(),!("@context"in t)||0!==t["@context"].indexOf("https://www.w3.org/2018/credentials/v1"))return[];let n=t["@context"],i=[];for(let e of n){let t=await this.fetchContext(e);if(!t){a.k.warn("credentialtypes","Failed to fetch credential type context for",e);continue}"@context"in t&&i.push({url:e,payload:t})}let r=[];for(let t of e.getType()){let e=i.find(e=>Object.keys(e.payload["@context"]).indexOf(t)>=0);e&&r.push({context:e.url,shortType:t})}return r}catch(e){return a.k.warn("credentialtypes","Credential could not be parsed or , returning empty types.",e),[]}}async fetchContext(e){let t=this.contextsCache.get(e);return t?t.data:this.fetchContextQueue.add(async()=>{if(e.startsWith("http"))try{let t=await fetch(e),n=await t.json();return this.contextsCache.set(e,n,D()().unix()),n}catch(e){return a.k.warn("credentialtypes","Failed to get payload from context.",e),null}else{if(!e.startsWith("did:"))return a.k.log("credentialtypes","Unsupported credential context url",e),null;let{publisher:t,shortType:n}=this.extractEIDContext(e);if(!t)return a.k.warn("credentialtypes","Failed to extract publisher from context",e),null;let i=await m.fetchOrAwaitDIDDocumentWithStatus(t);if(!i.document)return null;{let r="".concat(t,"#").concat(n),a=this.getContextPayloadFromDIDDocument(i.document,r);return this.contextsCache.set(e,a,D()().unix()),a}}})}extractEIDContext(e){let t=new RegExp(/^did:\/\/elastos\/([a-zA-Z0-9]+)\/([a-zA-Z0-9]+)/),n=t.exec(e);return!n||n.length<3?(a.k.warn("credentialtypes","Invalid url format, cannot find credential publisher and ID"),null):{publisher:"did:elastos:".concat(n[1]),shortType:n[2]}}getContextPayloadFromDIDDocument(e,t){let n=e.getService(t);if(!n)return a.k.warn("credentialtypes","The DID document has no service with ID: "+t),null;let r=n.getServiceEndpoint(),s=this.getCredentialById(e,new i.DIDURL(r));if(!s)return a.k.warn("credentialtypes","The DID document has no credential context credential that matches (service id, credential id): ",t,r),null;let l=s.getSubject().getProperties();return"definition"in l&&"@context"in l.definition?l.definition:(a.k.warn("credentialtypes","Credential ".concat(r," found but no definition/@context in the subject. Invalid format."),l),null)}buildElastosJsonLdDocLoader(){return(e,t)=>new Promise(async(t,n)=>{try{if(e.startsWith("did")){let n=await this.fetchContext(e);t({contextUrl:null,documentUrl:e,document:n})}else{let n=b().documentLoaders.xhr(),i=await n(e);t(i)}}catch(e){n(e)}})}async verifyCredential(e){try{let t=e.toJSON();if("object"!=typeof t)return a.k.warn("credentialtypes","verifyCredential false 331"),!1;if(!("@context"in t)||0!==t["@context"].indexOf("https://www.w3.org/2018/credentials/v1")||!("credentialSubject"in t)||!("proof"in t))return!1;let n=await b().compact(t,t["@context"],{documentLoader:this.buildElastosJsonLdDocLoader()});if(n){"credentialSubject"in n&&"string"!=typeof n.credentialSubject||(n.credentialSubject={id:n.credentialSubject});let{modifiedDoc:e,warningsGenerated:i}=this.addMissingFieldsToCompactHtmlResult(t,n);if(!i)return!0}}catch(e){a.k.warn("credentialtypes","verifyCredential error",e)}return!1}addMissingFieldsToCompactHtmlResult(e,t){let n=!1,i=Object.assign({},t);for(let r of Object.keys(e.credentialSubject))r in t.credentialSubject||(i.credentialSubject["MISSING_KEY_"+r]="This field is missing in credential types",n=!0);for(let r of Object.keys(e.proof))r in t.proof||(i.proof["MISSING_KEY_"+r]="This field is missing in credential types",n=!0);return{modifiedDoc:i,warningsGenerated:n}}getCredentialById(e,t){let n=e.getCredentials();return n.find(e=>t.getFragment()==e.getId().getFragment())}constructor(){this.fetchContextQueue=new(o())(1)}};var C=n(59606),x=n(53932);let E=new class{async getIssuerName(e){let t=await this.fetchDIDDocument(e);return await m.getRepresentativeOwnerName(t)}async getIssuerAvatar(e){let t=await this.fetchDIDDocument(e),n=await m.getRepresentativeIcon(t);return n?(a.k.log("identity","dataUrl",n),n):null}async isPublished(e){let t=await this.fetchDIDDocument(e);return!!t}async fetchDIDDocument(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e="did:elastos:iqjN3CLRjd7a4jGCZe6B3isXyeLy7KKDuK";let n=await m.fetchOrAwaitDIDDocumentWithStatus(e,t);return n.checked?n.document:null}};var P=n(18961);let $=(e,t)=>{t=(t=t.replace(/\[(\w+)\]/g,".$1")).replace(/^\./,"");let n=t.split(".");for(let t=0,i=n.length;t<i;++t){let i=n[t];if(!(i in e))return;e=e[i]}return e};var A=n(9177);class j{get issuerInfo$(){return this._issuerInfo$.getSubject()}get isConform$(){return this._isConform$.getSubject()}prepareForDisplay(){this.prepareDisplayTitle(),this.prepareDisplayValue(),this.prepareIcon()}getDisplayableCredentialTitle(){let e=this.verifiableCredential.getSubject();if(!("displayable"in e))return null;this.displayTitle=e.displayable.title}prepareDisplayTitle(){let e=this.getDisplayableCredentialTitle();if(e)this.displayTitle=e;else{let e=this.verifiableCredential.getId().getFragment();this.displayTitle=(0,A.fm)(e)}}getDisplayableCredentialDescription(){let e=this.verifiableCredential.getSubject().getProperties();if(!("displayable"in e))return null;{let t=e.displayable.description;if(t){let n=t.match(/\${([a-zA-Z0-9.]+)}/g),i=n?Array.from(n):[],r=t;for(let t of i){let n=t.match(/\${([a-zA-Z0-9.]+)}/);if(n&&n.length>1){let i=n[1],a=$(e,i);r=r.replace(t,a)}}return r}}}prepareDisplayValue(){let e=this.getDisplayableCredentialDescription();if(e)this.displayValue=e;else{let e=this.getValueItems();if(e.length<=1){var t;this.displayValue=null===(t=e[0])||void 0===t?void 0:t.value}else this.displayValue=JSON.stringify(e)}}getDisplayValue(){return this.displayValue}async prepareIcon(){var e;let t=x.B.value,n=this.verifiableCredential.getSubject().getProperties();if(this.hasRemotePictureToFetch()){if(n.avatar&&(null===(e=n.avatar)||void 0===e?void 0:e.data)){let e=n.avatar.data;if(e.startsWith("hive://")){a.k.log("credential","Refreshing picture from hive url",e);let n=await y(e,t.did);n?(a.k.log("credential","Got picture data from hive"),this.representativeIcon$.next(n)):(a.k.log("idencredentialtity","Got empty picture data from the hive cache service (real picture may come later)"),this.representativeIcon$.next(null)),this.loadIconWithFallback()}else console.warn("Unhandled avatar credentials format")}}else{if("displayable"in n)this.representativeIcon$.next(n.displayable.icon);else{let e=this.verifiableCredential.getId().getFragment(),t=(0,C.m7)([e]);e=(null==t?void 0:t.key)||"finger-print",this.representativeIcon$.next("/assets/identity/smallIcons/dark/".concat(e,".svg"))}this.loadIconWithFallback()}}loadIconWithFallback(){null==this.representativeIcon$.value&&this.representativeIcon$.next(this.getFallbackIcon());let e=new Image;e.crossOrigin="anonymous",e.onload=()=>{var t;this.representativeIcon$.next(e.src),null===(t=this.onIconReadyCallback)||void 0===t||t.call(this,this.representativeIcon$.value)},e.onerror=()=>{var e;this.representativeIcon$.next(this.getFallbackIcon()),null===(e=this.onIconReadyCallback)||void 0===e||e.call(this,this.representativeIcon$.value)},e.src=this.representativeIcon$.value}getFallbackIcon(){return this.isUserAvatar()?"assets/identity/smallIcons/dark/name.svg":"assets/identity/smallIcons/dark/finger-print.svg"}hasRemotePictureToFetch(){let e=this.verifiableCredential.getId().getFragment();return"avatar"===e}isUserAvatar(){let e=this.verifiableCredential.getId().getFragment();return"avatar"===e}getDisplayableTitle(){return this.displayTitle}onIconReady(e){this.onIconReadyCallback=e}getSubject(){return this.verifiableCredential.getSubject()}getFragment(){return this.verifiableCredential.getId().getFragment()}getTypes(){return this.verifiableCredential.getType()}getId(){return this.verifiableCredential.getId()}isSensitiveCredential(){return this.verifiableCredential.getType().indexOf("SensitiveCredential")>=0}selfIssued(){return this.verifiableCredential.getIssuer().toString()===v.D.getActiveIdentityId()}getIssuer(){return this.verifiableCredential.getIssuer().toString()}async fetchIssuerInfo(){let e=this.verifiableCredential.getIssuer().toString();a.k.log("credential","fetchIssuerInfo:",e);let t=null,n=null,i=await E.isPublished(e);i&&(t=await E.getIssuerName(e),n=await E.getIssuerAvatar(e));let r={avatarIcon:n,didString:e,name:t,isPublished:i};return a.k.log("credential","got issuer info:",r),r}async verifyCredential(){return await S.verifyCredential(this.verifiableCredential)}equals(e){return this.id===e.id}constructor(){this._issuerInfo$=new P.h(null,()=>this.fetchIssuerInfo()),this._isConform$=new P.h(null,()=>this.verifyCredential()),this.representativeIcon$=new p.X(null),this.id=null,this.createdAt=null,this.displayValue=null,this.onIconReadyCallback=null,this.getValueItems=()=>{let e=this.verifiableCredential.getId().getFragment();if("avatar"===e)return null;let t=this.verifiableCredential.getSubject().getProperties();return Object.keys(t).filter(e=>"id"!=e).filter(e=>"displayable"!=e).sort().map(e=>{let n="";return"wallet"==e?(n="wallet",t[e]):"gender"==e?"M"==t[e]||"male"==t[e]?n="male":("F"==t[e]||"female"==t[e])&&(n="female"):n=""!=t[e].toString()?t[e].toString():"not set",{name:e,value:n}})}}}},5676:function(e,t,n){"use strict";n.d(t,{E:function(){return a}});var i=n(9177),r=n(43900);class a extends r.h{prepareDisplayTitle(){let e=this.getDisplayableCredentialTitle();e?this.displayTitle=e:this.displayTitle=(0,i.fm)(this.profileInfo.key)}prepareDisplayValue(){this.displayValue=this.profileInfo.options.converter.toDisplayableValue(this)}getProfileInfo(){return this.profileInfo}constructor(e){super(),this.profileInfo=e}}},66533:function(e,t,n){"use strict";n.d(t,{_:function(){return i}});class i{static fromJson(e){if(!i.isCustomException(e))return null;let t=new i;return Object.assign(t,e),t.timestamp=new Date(e.timestamp),t}static isCustomException(e){return"object"==typeof e&&"source"in e&&"api"===e.source}static newClientError(e,t){let n=new i;return n.message=t,n.appExceptionCode=e,n.statusCode=-1,n.timestamp=new Date,n.source="client",n}}},48023:function(e,t,n){"use strict";var i,r,a,s,l,o,u,c;n.d(t,{Wg:function(){return i},XF:function(){return s},gs:function(){return r}}),(l=i||(i={}))[l.SomethingTodo=10101]="SomethingTodo",l[l.AuthError=10102]="AuthError",l[l.EmailAlreadyExists=10103]="EmailAlreadyExists",l[l.EmailNotExists=10104]="EmailNotExists",l[l.AuthKeyNotExists=10105]="AuthKeyNotExists",l[l.Unspecific=10199]="Unspecific",(o=r||(r={}))[o.DatabaseError=10201]="DatabaseError",o[o.InvalidKeyRingConfig=10202]="InvalidKeyRingConfig",o[o.KeyRingNotExists=10203]="KeyRingNotExists",o[o.KeyNotExists=10204]="KeyNotExists",o[o.InvalidChallengeId=10205]="InvalidChallengeId",o[o.InvalidAuthKey=10206]="InvalidAuthKey",o[o.CanNotRemoveKey=10207]="CanNotRemoveKey",o[o.WebAuthnVerifyError=20208]="WebAuthnVerifyError",o[o.WrongPassword=10209]="WrongPassword",o[o.Unauthorized=10210]="Unauthorized",(u=a||(a={}))[u.DIDStorageError=10301]="DIDStorageError",u[u.MnemonicError=10302]="MnemonicError",u[u.DIDAlreadyExists=10303]="DIDAlreadyExists",u[u.DIDNotExists=10304]="DIDNotExists",u[u.CredentialAlreadyExists=10305]="CredentialAlreadyExists",u[u.CredentialNotExists=10306]="CredentialNotExists",u[u.InvalidCredential=10307]="InvalidCredential",u[u.DIDNotUpToDateError=10308]="DIDNotUpToDateError",u[u.DIDTransactionError=10309]="DIDTransactionError",u[u.NetworkError=10310]="NetworkError",(c=s||(s={}))[c.OtherApolloError=10901]="OtherApolloError",c[c.OtherAxiosError=10902]="OtherAxiosError"},1349:function(e,t,n){"use strict";n.d(t,{E:function(){return i}});class i extends Error{}},10343:function(e,t,n){"use strict";n.d(t,{h:function(){return i}});class i extends Error{}},18093:function(e,t,n){"use strict";n.d(t,{t:function(){return i}});let i="\n  id\n  createdAt\n  lastUsedAt\n  userAgent\n  name\n"},5344:function(e,t,n){"use strict";n.d(t,{j:function(){return r}});var i=n(18093);let r="\n  createdAt\n  updatedAt\n  keyId\n  key\n  type\n  browser { ".concat(i.t," }\n")},10530:function(e,t,n){"use strict";var i,r;n.d(t,{J:function(){return i}}),(r=i||(i={})).PASSWORD="PASSWORD",r.WEBAUTHN="WEBAUTHN"},95640:function(e,t,n){"use strict";n.d(t,{M:function(){return s}});var i=n(99617),r=n(6598);let a=new r.R;class s{static async fromJson(e){return a.get(e.keyId,{create:async()=>new s,async fill(t){Object.assign(t,e),t.createdAt=new Date(e.createdAt),t.updatedAt=new Date(e.updatedAt),e.browser&&(t.browser=await i.A.fromJson(e.browser))}})}equals(e){return this.keyId===e.keyId}}},63863:function(e,t,n){"use strict";n.d(t,{lu:function(){return w},zl:function(){return p},qR:function(){return v}});var i=n(60230),r=n(23965),a=n(48023);class s{static fromJson(e,t){let n=Object.assign(new s,e);return n.user=t,n}}var l=n(51385),o=n(76506),u=n(3883),c=n(18961);function d(){let e=(0,i._)(["\n                query FetchUserEmails {\n                  fetchUserEmails {\n                    ","\n                  }\n                }\n                "]);return d=function(){return e},e}function h(){let e=(0,i._)(["\n                query RemoveUserEmail($id: String!) {\n                  removeUserEmail(id: $id)\n                }\n                "]);return h=function(){return e},e}function y(){let e=(0,i._)(["\n                mutation BindOauthEmail($email: String!) {\n                  bindOauthEmail(email: $email)\n                }\n                "]);return y=function(){return e},e}function f(){let e=(0,i._)(["\n                    mutation CheckEmailBind($authKey: String!) {\n                        checkEmailBind(authKey: $authKey) { accessToken refreshToken }\n                    }\n                "]);return f=function(){return e},e}function g(){let e=(0,i._)(["\n                    mutation BindWithEmailAddress($emailAddress: String!) {\n                        bindWithEmailAddress(emailAddress: $emailAddress) { success }\n                    }\n                "]);return g=function(){return e},e}function p(e){return e.appExceptionCode===a.Wg.EmailAlreadyExists}function v(e){return e.appExceptionCode===a.Wg.EmailNotExists}class w{get userEmails$(){return this._userEmails$.getSubject()}async fetchUserEmails(){u.k.log("user","list user emails.");let{data:e}=await (0,l.Pt)(async()=>(await (0,o.W)()).query({query:(0,r.Ps)(d(),"id email createdAt")}));return(null==e?void 0:e.fetchUserEmails)?e.fetchUserEmails.map(e=>s.fromJson(e,this.user)):(console.error("user","can not fetch user emails."),null)}async removeUserEmail(e){u.k.log("user","remove user email.");let{data:t}=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(h()),variables:{id:e}})),n=t&&t.removeUserEmail;return n||console.error("user","can not remove user email."),n}async bindOauthEmail(e){u.k.log("user","Bind oauth email address");let{data:t}=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(y()),variables:{email:e}})),n=t&&t.bindOauthEmail;return n||u.k.error("user","Failed from bindOauthEmail api."),n}async checkEmailBind(e){u.k.log("user","Checking temporary authentication key for email bind.");let{data:t}=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(f()),variables:{authKey:e}})),n=!!(t&&t.checkEmailBind);return n||u.k.error("Failed to check email bind"),n}async bindWithEmailAddress(e){u.k.log("user","Sending request to authentication by email"),await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(g()),variables:{emailAddress:e}}))}constructor(e){this.user=e,this._userEmails$=new c.h([],()=>this.fetchUserEmails())}}},81316:function(e,t,n){"use strict";n.d(t,{n:function(){return j}});var i=n(60230),r=n(23965),a=n(63863),s=n(51385),l=n(76506),o=n(3883),u=n(9177),c=n(50676),d=n(18093),h=n(99617),y=n(18961);function f(){let e=(0,i._)(["\n        query ListBrowsers {\n          browsers {\n            ","\n          }\n        }\n      "]);return f=function(){return e},e}class g{get browsers$(){return this._browsers$.getSubject()}async fetchBrowsers(){o.k.log("devices","Fetching user browsers");let{data:e}=await (0,s.Pt)(async()=>(await (0,l.W)()).query({query:(0,r.Ps)(f(),d.t)}));if(e&&e.browsers){let t=await Promise.all(e.browsers.map(e=>h.A.fromJson(e)));return o.k.log("browsers","Fetched browsers:",t),t}return null}constructor(e){this.user=e,this._browsers$=new y.h([],()=>this.fetchBrowsers())}}var p=n(12540),v=n(51639);class w{get identities$(){return this._identities$.getSubject()}async createIdentity(e){o.k.log("identities","Creating a new identity",e);let t=(0,p.zV)(),n=await v.D.createIdentity(e,t);return this.identities$.next([n,...this.identities$.value]),n}async deleteIdentity(e){o.k.log("identities","Deleting identity");let t=await v.D.deleteIdentity(e);return this.identities$.next(this.identities$.value.filter(t=>t.did!=e)),t}async createDIDPublishTransaction(e){return o.k.log("identities","Creating identity publication transaction"),await v.D.createDIDPublishTransaction(e)}async publishIdentity(e,t){return o.k.log("identities","Publishing identity"),await v.D.publishIdentity(e,t)}async fetchIdentities(){return o.k.log("identities","Fetching identities"),v.D.listIdentities()}constructor(e){this.user=e,this._identities$=new y.h([],()=>this.fetchIdentities())}}var m=n(5344),I=n(95640),b=n(10530),k=n(21290),D=n(2512),S=n(45685),C=n(67133).Buffer;function x(){let e=(0,i._)(["\n        query FetchShadowKeys {\n          userKeys {\n            ","\n          }\n        }\n      "]);return x=function(){return e},e}class E{get shadowKeys$(){return this._shadowKeys$.getSubject()}get passwordKeys$(){return this._passwordKeys$.getSubject()}get passkeyKeys$(){return this._passkeyKeys$.getSubject()}async fetchShadowKeys(){var e;o.k.log("devices","Fetching shadow keys");let t=await (0,s.Pt)(async()=>(await (0,l.W)()).query({query:(0,r.Ps)(x(),m.j)}));if(null==t?void 0:null===(e=t.data)||void 0===e?void 0:e.userKeys){let e=await Promise.all(t.data.userKeys.map(e=>I.M.fromJson(e)));return o.k.log("security","Fetched user shadow keys:",e),e}return null}async bindPassword(e){let t;if(o.k.log("keyring","Binding password"),this.isPasswordBound())t=await (0,k.Cp)(e);else{let n={type:b.J.PASSWORD,key:e,keyId:"unused-for-now-for-passwords"};t=[await (0,k.cI)(n)]}return!!t&&(this.deletePasswordShadowKey(),t.forEach(e=>this.upsertShadowKey(e)),!0)}async bindPasskey(){let e=await (0,k.Dk)(),t=await this.pkCredentialCreationOptions(e,this.user.name$.value),n=await (0,D.RQ)(t[1]),i={type:b.J.WEBAUTHN,keyId:n.id,key:JSON.stringify(n),challengeId:e.id},r=await (0,k.cI)(i);return!!r&&(this.upsertShadowKey(r),!0)}async unlockPasskeyLocally(){o.k.log("Keyring","start unlock passkey...");let e=await (0,k.Dk)(),t=await this.pkCredentialCreationOptions(e,null),n=await (0,D.oz)(t[0],!1),i={type:b.J.WEBAUTHN,keyId:n.id,key:JSON.stringify(n),challengeId:e.id};return o.k.log("Keyring","start unlock passkey, attResp: ",n),i}async pkCredentialCreationOptions(e,t){let n="localhost",i=new TextEncoder,r=i.encode(e.content),a={challenge:C.from(r).toString(),allowCredentials:[],rpId:n,userVerification:"required",timeout:6e4},s={user:{id:t,name:t,displayName:t},pubKeyCredParams:[{type:"public-key",alg:-7}],rp:{id:n,name:"DID web app"},challenge:e.content};return[a,s]}upsertShadowKey(e){let t=this.shadowKeys$.value;this.shadowKeys$.next([...t.filter(t=>!t.equals(e)),e])}deletePasswordShadowKey(){let e=this.shadowKeys$.value;this.shadowKeys$.next([...e.filter(e=>e.type!==b.J.PASSWORD)])}isPasswordBound(){var e;return!!(null===(e=this.shadowKeys$.value)||void 0===e?void 0:e.find(e=>e.type===b.J.PASSWORD))}isThisBrowserBound(){var e;return!!(null===(e=this.passkeyKeys$.value)||void 0===e?void 0:e.find(e=>{var t;return null===(t=e.browser)||void 0===t?void 0:t.isCurrentBrowser()}))}constructor(e){this.user=e,this._shadowKeys$=new y.h(null,()=>this.fetchShadowKeys()),this._passwordKeys$=new y.h(null,async()=>{this.shadowKeys$.pipe((0,S.U)(e=>null==e?void 0:e.filter(e=>e.type===b.J.PASSWORD))).subscribe(this.passwordKeys$)}),this._passkeyKeys$=new y.h(null,async()=>{this.shadowKeys$.pipe((0,S.U)(e=>null==e?void 0:e.filter(e=>e.type===b.J.WEBAUTHN))).subscribe(this.passkeyKeys$)})}}var P=n(6598);let $=new P.R;function A(){let e=(0,i._)(["\n        mutation UpdateUserProperty($input: UserPropertyInput!) {\n          updateUserProperty(input: $input)\n        } "]);return A=function(){return e},e}class j{static async fromJson(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return $.get(e.id,{create:async()=>new j,async fill(t){t.fillFromJson(e),t.createdAt=new Date(e.createdAt),t.nameInitials$.next((0,u.OX)(e.name)),t.name$.next(e.name)}},t)}toJson(){return{id:this.id,type:this.type,name:this.name$.value,nameInitials:(0,u.OX)(this.name$.value),createdAt:this.createdAt.toISOString()}}get(e){if(!this.features.has(e))throw Error("Unhandled user feature '".concat(e,"'"));return this.features.get(e)}addFeature(e,t){if(!this.features.has(e))return this.features.set(e,t),t}fillFromJson(e){Object.assign(this,e)}equals(e){return!!e&&this.id===e.id}async updateUserName(e){o.k.log("user","update user name.");let{data:t}=await (0,s.Pt)(async()=>(await (0,l.W)()).mutate({mutation:(0,r.Ps)(A()),variables:{input:{name:e}}}));return this.name$.next(e),console.info("user","update user name successfully."),null==t?void 0:t.updateUserProperty}constructor(){this.name$=new c.X(null),this.nameInitials$=new c.X(null),this.features=new Map,this.addFeature("email",new a.lu(this)),this.addFeature("identity",new w(this)),this.addFeature("browser",new g(this)),this.addFeature("security",new E(this))}}},20708:function(e,t,n){"use strict";n.d(t,{NN:function(){return u},Ny:function(){return o}});var i=n(175),r=n(3883),a=n(69990),s=n(16421);let l="browser-client-id";function o(e){let t;try{t=(0,i.Z)(e)}catch(e){r.k.error("browser","Access token received from the backend cannot be decoded!");return}if(!t.browserId)throw Error("Abnormal state: no browser ID found in the access token!");let n=u();if(n&&n!==t.browserId)throw function(){let e=(0,a.M6)();if(!e)throw Error("Cannot delete the browser ID without active user!");localStorage.removeItem(e.id+l)}(),(0,s.w7)(),Error("State error! Browser ID ".concat(n," is different from access token browser ID ").concat(t.browserId," !"));!function(e){let t=(0,a.M6)();if(!t)throw Error("Cannot set the browser ID without active user!");localStorage.setItem(t.id+l,e)}(t.browserId)}function u(){let e=(0,a.M6)();return e?localStorage.getItem(e.id+l):null}},21417:function(e,t,n){"use strict";n.d(t,{l:function(){return i}});let i=new class{init(e){this.config=e}get(e){if(!this.config)throw Error("The config service has not been initialized yet. Make sure to call configService.init() first");return this.config[e]}}},51385:function(e,t,n){"use strict";n.d(t,{Pt:function(){return w},rs:function(){return f}});var i=n(17205),r=n(66533),a=n(48023),s=n(1349),l=n(10343),o=n(63863),u=n(81630),c=n(21704),d=n(34891),h=n(3883),y=n(52856);let f=new d.x;function g(e){return h.k.error("apollo","Client error",e),r._.newClientError(a.XF.OtherApolloError,e.message)}function p(e){return h.k.error("apollo","Protocol error",e),r._.newClientError(a.XF.OtherApolloError,e.message)}function v(e){var t;let n=e.path,i=e.originalError||(null===(t=e.extensions)||void 0===t?void 0:t.originalError),s=r._.fromJson(i);return s?(h.k.error("graphql","Custom API exception when calling GraphQL method:",n,i),s):(h.k.error("graphql","GraphQL error when calling GraphQL method:",n,e),r._.newClientError(a.XF.OtherApolloError,e.message))}async function w(e,t){try{let t=await e();return t}catch(m){let e;if(m instanceof i.cA){let t;t=(t=(t=(t=[]).concat(m.clientErrors.map(g))).concat(m.graphQLErrors.map(v))).concat(m.protocolErrors.map(p)),m.networkError&&(t=t.concat(function(e){let t=[];return"ServerError"===e.name?"object"==typeof e.result&&e.result.forEach(e=>{var n;null===(n=e.errors)||void 0===n||n.forEach(e=>{h.k.error("graphql","GraphQL server network error:",e.message),t.push(r._.newClientError(a.XF.OtherApolloError,e.message))})}):(h.k.error("graphql","GraphQL network error:",e),t.push(r._.newClientError(a.XF.OtherApolloError,e.message))),t}(m.networkError))),e=t}else m instanceof c.__?e=[v(m)]:m instanceof u.AxiosError?e=[function(e){let t=r._.fromJson(e.response.data);return t?(h.k.error("axios","Axios app exception",t),t):(h.k.error("Unhandled axios error:",e),r._.newClientError(a.XF.OtherAxiosError,e.message))}(m)]:h.k.error("Unhandled error:",m);e.map(e=>{f.next(e)});let n=e.find(e=>(0,y.z)(e));if(n)throw n;let d=e.find(e=>(0,o.zl)(e));if(d)throw new s.E;let w=e.find(e=>(0,o.qR)(e));if(w)throw new l.h;return t||null}}},76506:function(e,t,n){"use strict";n.d(t,{W:function(){return p}});var i=n(14456),r=n(23139),a=n(79977),s=n(29526),l=n(15740),o=n(2594),u=n(85932),c=n(16421),d=n(69810),h=n.n(d),y=n(20708),f=n(21417);let g=new class{async init(){return this.queue.add(()=>{if(this.initialized)return;let e=new l.A({uri:"".concat(f.l.get("backendUrl"),"/graphql"),batchMax:30,batchInterval:50}),t=(0,u.q)(e=>{let{graphQLErrors:t,networkError:n,operation:r,forward:a}=e;if(t){if(!localStorage.getItem("access_token"))return;for(let e of t)switch(e.extensions.code){case"UNAUTHENTICATED":return(0,i.p)((0,c.g$)().catch(e=>{})).filter(e=>!!e).flatMap(e=>{let t=r.getContext().headers;return r.setContext({headers:{...t,authorization:"Bearer ".concat(e)}}),a(r)});case"INVALID_REFRESH_TOKEN":(0,c.JA)()}}}),n=(0,o.v)((e,t)=>{let{headers:n}=t,i=localStorage.getItem("access_token"),r=(0,y.NN)();return{headers:{...n,authorization:i?"Bearer ".concat(i):"",...r&&{"x-browser-id":r}}}});this.apolloClient=new r.f({link:(0,a.D)([t,n,e]),cache:new s.h}),this.initialized=!0})}constructor(){this.initialized=!1,this.queue=new(h())(1)}},p=async()=>(await g.init(),g.apolloClient)},12540:function(e,t,n){"use strict";n.d(t,{iT:function(){return D},no:function(){return T},zV:function(){return U},M7:function(){return x},dD:function(){return C},NL:function(){return S},AX:function(){return m}});var i=n(26588),r=n(20475),a=n(53932),s=n(3883),l=n(6598),o=n(78212),u=n(35324),c=n(74548),d=n.n(c),h=n(62067),y=n.n(h),f=n(69810),g=n.n(f);let p=new(g())(1),v=["https://hive1.trinity-tech.io","https://hive2.trinity-tech.io","https://hive3.trinity-tech.io"],w=new l.R;function m(){if((0,o.S)())try{r.Logger.setDefaultLevel(r.Logger.WARNING),r.AppContext.setupResolver("'https://api.elastos.io/eid' # mainnet or testnet","/anyfakedir/browserside/for/didstores")}catch(e){e instanceof r.DIDResolverAlreadySetupException||s.k.error("hive","AppContext.setupResolver() exception:",e)}}let I=null;async function b(){if(I)return I;let{DID:e}=await (0,u.G)();return I=new e.DIDAccess}async function k(){return p.add(async()=>{let e=await b(),t=E(),n=await e.getOrCreateAppInstanceDID(t),i=await n.didStore.loadDid(n.did.toString());return{getLocalDataDir:()=>"/",getAppInstanceDocument:()=>i,getAuthorization:e=>{s.k.log("hive","Receiving hive client authentication challenge");try{return P(e)}catch(e){return s.k.error("hive","Exception in authentication handler:",e),null}}}})}async function D(e){return w.get(e,{async create(){let t=await k();return r.AppContext.build(t,e,"did:elastos:iddh53iyg3Eyrq4AFiA8tCULpEqUyu49td")}})}async function S(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=await D(e);return new r.Vault(n,t)}async function C(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=await D(e);return new r.VaultSubscription(n,t)}async function x(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];let t=await D(e),n=new r.ServiceEndpoint(t);return new r.ScriptingService(n)}function E(){return"did:elastos:iddh53iyg3Eyrq4AFiA8tCULpEqUyu49td"}async function P(e){let t=E();s.k.log("hive","Starting process to generate hive auth presentation JWT");try{let r=(await new i.JWTParserBuilder().setAllowedClockSkewSeconds(300).build().parse(e)).getBody();if(null==r)throw Error("Invalid jwt token as authorization.");if(!r.getIssuer()||!r.get("nonce"))throw Error("The received authentication JWT token does not contain iss or nonce");let a=r.get("nonce"),l=r.getIssuer();s.k.log("hive","Getting app instance DID");let o=await b(),u=await o.getOrCreateAppInstanceDID(t),c=u.did;s.k.log("hive","App instance DID:",c);let h=await o.getExistingAppInstanceDIDInfo(t);s.k.log("hive","Getting app identity credential");let y=await A(t);if(!y&&(s.k.log("hive","Empty app id credential. Trying to generate a new one"),!(y=await $())))return s.k.warn("hive","Failed to generate a new App ID credential"),null;s.k.log("hive","Creating DID presentation response for Hive authentication challenge");let f=await i.VerifiablePresentation.createFor(c.toString(),null,u.didStore),g=await f.credentials(y).realm(l).nonce(a).seal(h.storePassword);if(g){s.k.log("hive","Opening DID store to create a JWT for presentation:",g.toJSON());let e=(await n.e(7410).then(n.bind(n,37410))).DID,t=await e.DIDHelper.openDidStore(h.storeId);s.k.log("hive","Loading DID document",h.didString);let a=await t.loadDid(h.didString);s.k.log("hive","App instance DID document",a.toJSON()),s.k.log("hive","Creating JWT");let l=await a.jwtBuilder().addHeader(i.JWTHeader.TYPE,i.JWTHeader.JWT_TYPE).addHeader("version","1.0").setSubject("DIDAuthResponse").setAudience(r.getIssuer()).setIssuedAt(d()().unix()).setExpiration(d()().add(3,"month").unix()).setNotBefore(d()().subtract(3,"minutes").unix()).claimsWithJson("presentation",g.toString(!0)).sign(h.storePassword);return s.k.log("hive","JWT created for presentation:",l),l}throw Error("No presentation generated")}catch(e){throw Error("The received authentication JWT token signature cannot be verified or failed to verify: ".concat(e,". Is the hive back-end DID published? Are you on the right network?"))}}async function $(){let e=E(),t=await b(),n=await t.getOrCreateAppInstanceDID(e);if(!n)return null;let i=n.did;s.k.log("hive","Starting to generate a new App ID credential.");try{let t=await j(i.toString(),e);if(t)return s.k.log("hive","App ID credential generated:",t),await n.didStore.storeCredential(t),s.k.log("hive","Storing app ID credential into DID store:",n.didStore,t),t;return null}catch(e){return null}}async function A(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return p.add(async()=>{s.k.log("hive","Trying to get an existing app ID credential from storage");let t=await b(),n=await t.getOrCreateAppInstanceDID(e);if(!n)return null;let i=n.did,r=i.toString()+"#app-id-credential",a=await n.didStore.loadCredential(r);if(a){let e=y()(await a.getExpirationDate());if(e.isBefore(y()().subtract(1,"hours")))return s.k.log("hive","Existing credential is expired or almost expired - renewing it"),null;s.k.log("hive","Returning existing app id credential found in app's local storage",a)}else s.k.log("hive","No app id credential found for id",r,"in store",n.didStore);return a})}async function j(e,t){return p.add(async()=>{s.k.log("hive","Asking the identity provider to generate app ID credential for appInstanceDid:",e,"appDid:",t);try{let n=a.B.value,i=await n.provider.issueCredential(n.did,e,"#app-id-credential",["https://elastos.org/fakecontext#AppIdCredential"],y()().add(30,"days").toDate(),{appInstanceDid:e,appDid:t});return i}catch(e){return s.k.error("identity","Failed to issue the app id credential...",e),null}})}let T=async e=>{try{let t=await S(e);return t}catch(e){return s.k.error("hive",e),null}};function U(){let e=Math.floor(Math.random()*v.length);return v[e]}},7845:function(e,t,n){"use strict";var i,r;n.d(t,{V:function(){return i}}),(r=i||(i={}))[r.NotChecked=0]="NotChecked",r[r.Subscribing=1]="Subscribing",r[r.ReadyToUse=2]="ReadyToUse",r[r.UnknownError=3]="UnknownError"},51639:function(e,t,n){"use strict";n.d(t,{D:function(){return ee}});var i,r,a=n(60230),s=n(23965),l=n(26588);let o="\n  id\n  createdAt\n  verifiableCredential\n",u="\n  did\n  createdAt\n";var c=n(69144),d=n(3883),h=n(18961);class y{get credentials$(){return this._credentials$.getSubject()}async createCredential(e,t,n,i){d.k.log("credentials","Creating credential",e,t,n,i);let r=await this.identity.provider.createCredential(this.identity.did,e,t,n,i);return this.credentials$.next([r,...this.credentials$.value]),r}async issueCredential(e,t,n,i,r){d.k.log("credentials","Issuing credential",e,t,n,i,r);let a=await this.identity.provider.issueCredential(this.identity.did,e,t,n,i,r);return a}async importCredential(e){d.k.log("credentials","Importing credential",e);let t=await this.identity.provider.importCredential(this.identity.did,e);return this.credentials$.next([t,...this.credentials$.value]),t}async fetchCredentials(){return d.k.log("credentials","Fetching credentials",this.identity.did),this.identity.provider.listCredentials(this.identity.did)}async deleteCredential(e){d.k.log("credentials","Deleting credential");let t=await this.identity.provider.deleteCredential(e.id);return this.credentials$.next(this.credentials$.value.filter(t=>t.id!=e.id)),t}constructor(e){this.identity=e,this._credentials$=new h.h([],()=>this.fetchCredentials())}}var f=n(20475),g=n(12540),p=n(7845),v=n(35324),w=n(70163);function m(e,t){return new Promise(n=>{let i=e.pipe((0,w.h)(e=>e===t)).subscribe(e=>{setTimeout(()=>i.unsubscribe(),0),n()})})}var I=n(50676);class b{get vaultStatus$(){return this._vaultStatus$.getSubject()}async getVaultService(){return await this.awaitHiveVaultReady(),(0,g.NL)(this.identity.did)}awaitHiveVaultReady(){return m(this.vaultStatus$,p.V.ReadyToUse)}getActiveUserSubscriptionServices(){return d.k.log("hive","Getting subscription services for",this.identity.did),(0,g.dD)(this.identity.did)}async addRandomHiveVaultServiceToDIDDocument(){let e=(0,g.zV)();if(e)return await this.removeHiveVaultServiceFromDIDDocument(),await ee.addDIDDocumentService(this.identity.did,"#hivevault","HiveVault",e),!0;throw Error("Hive node address cannot be null")}async removeHiveVaultServiceFromDIDDocument(){return ee.removeDIDDocumentService(this.identity.did,"#hivevault")}documentHasVault(e){let t=e.getService("vault");return null!=t}getDocumentVaultProviderUrl(e){let t=e.getService("#hivevault");return t.serviceEndpoint}async getVaultInfo(){let e=await (0,g.dD)(this.identity.did);return e.checkSubscription()}async subscribeToHiveProvider(e){d.k.log("hive","Subscribing to hive provider",e);let t=this.identity.did,n=null;try{n=await this.getVaultInfo()}catch(e){}if(n)return!0;{d.k.log("hive","subscribeToHiveProvider(): no vault info, subscribing");let e=await (0,g.dD)(t);if(!(n=await e.subscribe()))return d.k.error("hive","Failed to create vault on the hive node"),!1}let i=await (0,g.NL)(t);if(i)try{d.k.log("hive","Calling an api on the hive vault to make sure everything is fine"),i=await (0,g.NL)(t);let e=await i.getAppStats();if(e)return d.k.log("hive","Vault API could be called, all good!"),this.retrieveVaultStatus(),!0;d.k.error("hive","Error while calling a test hive vault API. No data returned")}catch(e){d.k.error("hive","Exception while calling a test vault API:",e)}else d.k.error("hive","NULL vault returned, unable to get the vault for this DID.");return!1}async retrieveVaultStatus(){await this.identity.get("publication").awaitIdentityPublished(),d.k.log("hive","Looking for vault status"),this.vaultStatus$.next(p.V.NotChecked);let e=this.identity.did,{ServiceEndpoint:t}=await (0,v.p)();d.k.log("hive","Retrieving vault of current user's DID "+e);let n=await (0,g.iT)(e),i=new t(n),r=await i.getProviderAddress();this.vaultAddress$.next(r);try{let t=await (0,g.dD)(e);await t.checkSubscription(),this.vaultStatus$.next(p.V.ReadyToUse),d.k.log("hive","Vault status retrieval completed")}catch(e){if(!(e instanceof f.VaultNotFoundException))return d.k.error("hive","Unknown exception while retrieving vault status:",e),this.emitUnknownErrorStatus(),null;await this.subscribeToHiveProvider(r)}}emitUnknownErrorStatus(){d.k.log("hive","Emiting unknown error status"),this.vaultStatus$.next(p.V.UnknownError)}constructor(e){this.identity=e,this._vaultStatus$=new h.h(null,async()=>{this.retrieveVaultStatus()}),this.vaultAddress$=new I.X(null)}}var k=n(5676),D=n(59606),S=n(44853),C=n.n(S),x=n(72440),E=n.n(x),P=n(62067),$=n.n(P),A=n(45685),j=n(21417),T=n(54860),U=n(67133).Buffer;async function _(e,t){let n=new Date().getTime(),i=t.type,r="identity/avatar/"+n,a=await (0,T.EX)(t),s=await (0,T.hv)(a,300),l=await e.get("hive").getVaultService(),o=await l.getFilesService().upload(r,U.from(s),{onProgress:()=>{}},!1);d.k.log("profile","Completed avatar upload to hive",o);let u="getMainIdentityAvatar"+n,c=await (0,g.M7)(e.did);await c.registerScript(u,new f.FileDownloadExecutable(u,r).setOutput(!0),void 0,!0,!0);let h=j.l.get("appDid"),y="hive://"+e.did+"@"+h+"/"+u+"?params={}";return d.k.log("identity","Generated avatar url:",y),{mimeType:i,avatarHiveURL:y}}class N{get profileCredentials$(){return this._profileCredentials$.getSubject()}get avatarCredential$(){return this._avatarCredential$.getSubject()}get name$(){return this._name$.getSubject()}setActiveCredential(e){this.activeCredential$.next(e)}async createProfileCredential(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,r=[];try{let a;a=e||this.identity.did+"#"+n+function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8;return C()(Array(e),()=>"".concat(E()(1,10))).join("")}();let s=(0,D.m7)(t);r.push(s.type.getLongType());let l=$()().add(5,"years").toDate(),o=s.options.converter.toSubject(i);return this.identity.get("credentials").createCredential(a,r,l,o)}catch(e){return d.k.error("profile",e),null}}async updateProfileCredential(e,t){let n=e.verifiableCredential.getId().toString(),i=(0,D.m7)(e.verifiableCredential.getType());try{let r=await this.identity.get("credentials").deleteCredential(e);if(!r)return!1;let a=await this.createProfileCredential(n,i.typesForCreation(),i.key,t);return!!a}catch(e){return d.k.error("profile",e),!1}}async deleteProfileCredential(e){return!1}getName(){var e;let t=null===(e=this.profileCredentials$.value)||void 0===e?void 0:e.find(e=>"name"===e.getProfileInfo().key);return t?t.getDisplayValue():null}async upsertIdentityAvatar(e){let t=await _(this.identity,e);if(t){let e=(0,D.Pr)("avatar"),n={mimeType:t.mimeType,hiveDownloadScriptUrl:t.avatarHiveURL};await this.deleteAvatarCredential(),await this.createProfileCredential("#avatar",e.typesForCreation(),e.key,n)}else console.log("Failed to upload avatar to hive")}async deleteAvatarCredential(){let e=this.avatarCredential$.value;e&&await this.identity.get("credentials").deleteCredential(e)}constructor(e){this.identity=e,this.activeCredential$=new I.X(null),this._profileCredentials$=new h.h(null,async()=>{this.identity.get("credentials").credentials$.pipe((0,A.U)(e=>e.filter(e=>e instanceof k.E))).subscribe(e=>{this.profileCredentials$.next(e)})}),this._avatarCredential$=new h.h(null,async()=>{this.profileCredentials$.subscribe(e=>{this.avatarCredential$.next(null==e?void 0:e.find(e=>"avatar"===e.verifiableCredential.getId().getFragment()))})}),this._name$=new h.h(null,async()=>{this.profileCredentials$.subscribe(e=>{this.name$.next(this.getName())})})}}(i=r||(r={})).UNPUBLISHED="UNPUBLISHED",i.PUBLISHING="PUBLISHING",i.PUBLISHED="PUBLISHED",i.FAILED_TO_PUBLISH="FAILED_TO_PUBLISH";class F{get publicationStatus$(){return this._publicationStatus$.getSubject()}async startCheckingPublicationStatus(){try{for(;this.shouldContinueCheckingStatus();)await this.fetchPublicationStatus(this.identity.did),await new Promise(e=>{setTimeout(()=>{e()},2e3)})}catch(e){d.k.error("Exception while fetching identity publication status",e)}}shouldContinueCheckingStatus(){let e=this.publicationStatus$.value;return!e||e===r.UNPUBLISHED||e===r.PUBLISHING}async fetchPublicationStatus(e){let t=await ee.getPublicationStatus(e);d.k.log("publication","Got publication status",null==t?void 0:t.state),this.publicationStatus$.next(null==t?void 0:t.state)}awaitIdentityPublished(){return m(this.publicationStatus$,r.PUBLISHED)}constructor(e){this.identity=e,this._publicationStatus$=new h.h(null,async()=>{this.startCheckingPublicationStatus()})}}class K{static async fromJson(e,t){let n=new K;return Object.assign(n,e),n.createdAt=new Date(e.createdAt),n.provider=t,n}get(e){if(!this.features.has(e))throw Error("Unhandled user feature '".concat(e,"'"));return this.features.get(e)}addFeature(e,t){if(!this.features.has(e))return this.features.set(e,t),t}createVerifiablePresentation(e,t,n){return this.provider.createVerifiablePresentation(this.did,e,t,n)}equals(e){return this.did===e.did}constructor(){this.features=new Map,this.addFeature("credentials",new y(this)),this.addFeature("profile",new N(this)),this.addFeature("hive",new b(this)),this.addFeature("publication",new F(this))}}var O=n(51385),W=n(76506);function B(){let e=(0,a._)(["\n          mutation createIdentity($input: CreateIdentityInput!) {\n            createIdentity(input: $input) {\n              ","\n            }\n          }\n        "]);return B=function(){return e},e}function J(){let e=(0,a._)(["\n        mutation deleteIdentity($identityDid: String!) {\n          deleteIdentity(identityDid: $identityDid)\n        }\n      "]);return J=function(){return e},e}function R(){let e=(0,a._)(["\n        query ListIdentities {\n          identities {\n            ","\n          }\n        }\n      "]);return R=function(){return e},e}function V(){let e=(0,a._)(["\n        mutation createDIDPublishTransaction($identityDid: String!) {\n          createDIDPublishTransaction(identityDid: $identityDid) {\n            ","\n          }\n        }\n      "]);return V=function(){return e},e}function q(){let e=(0,a._)(["\n        mutation publishIdentity($identityDid: String!, $payload: String!) {\n          publishIdentity(input: { identityDid: $identityDid, payload: $payload}) {\n            ","\n          }\n        }\n      "]);return q=function(){return e},e}function L(){let e=(0,a._)(["\n        mutation getPublicationStatus($identityDid: String!) {\n          getPublicationStatus(input: { identityDid: $identityDid}) {\n            state\n          }\n        }\n      "]);return L=function(){return e},e}function M(){let e=(0,a._)(["\n        mutation createCredential($identityDid: String!, $credentialId: String!, $types: Json!, $expirationDate: String!, $properties: Json!) {\n          createCredential(input: { identityDid: $identityDid, credentialId: $credentialId, types: $types, expirationDate: $expirationDate, properties: $properties}) {\n            ","\n          }\n        }\n      "]);return M=function(){return e},e}function H(){let e=(0,a._)(["\n        mutation issueCredential($identityDid: String!, $subjectDid: String!, $credentialId: String!, $types: Json!, $expirationDate: String!, $properties: Json!) {\n          issueCredential(input: { identityDid: $identityDid, subjectDid: $subjectDid, credentialId: $credentialId, types: $types, expirationDate: $expirationDate, properties: $properties}) {\n            ","\n          }\n        }\n      "]);return H=function(){return e},e}function z(){let e=(0,a._)(["\n        mutation importCredential($identityDid: String!, $credentialString: String!) {\n          importCredential(input: { identityDid: $identityDid, credentialString: $credentialString}) {\n            ","\n          }\n        }\n      "]);return z=function(){return e},e}function G(){let e=(0,a._)(["\n        query ListCredentials($identityDid: String!) {\n          credentials(identityDid: $identityDid) {\n            ","\n          }\n        }\n      "]);return G=function(){return e},e}function X(){let e=(0,a._)(["\n        mutation deleteCredential($id: String!) {\n          deleteCredential(id: $id)\n        }\n      "]);return X=function(){return e},e}function Q(){let e=(0,a._)(["\n        mutation createVerifiablePresentation($identityDid: String!, $credentials: Json!, $realm: String!, $nonce: String!) {\n          createVerifiablePresentation(input: { identityDid: $identityDid, credentials: $credentials, realm: $realm, nonce: $nonce}) {\n            ","\n          }\n        }\n      "]);return Q=function(){return e},e}class Z{async createIdentity(e,t){let n={name:e,hiveVaultProvider:t},{data:i}=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(B(),u),variables:{input:n}}));if(null==i?void 0:i.createIdentity)return K.fromJson(i.createIdentity,this);throw Error("Failed to create DID")}async deleteIdentity(e){let{data:t}=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(J()),variables:{identityDid:e}}));if(null==t?void 0:t.deleteIdentity)return!0;throw Error("Failed to delete DID")}async listIdentities(){var e;let t=await (0,O.Pt)(async()=>(await (0,W.W)()).query({query:(0,s.Ps)(R(),u)}));if(null==t?void 0:null===(e=t.data)||void 0===e?void 0:e.identities){let e=await Promise.all(t.data.identities.map(e=>K.fromJson(e,this)));return d.k.log("custodial-provider","Fetched identities:",e),e}return null}async createDIDPublishTransaction(e){let{data:t}=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(V(),"\n  payload\n"),variables:{identityDid:e}}));if(null==t?void 0:t.createDIDPublishTransaction.payload)return t.createDIDPublishTransaction.payload;throw Error("Failed to create transaction")}async publishIdentity(e,t){let{data:n}=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(q(),"\n  publicationId\n"),variables:{identityDid:e,payload:t}}));if(null==n?void 0:n.publishIdentity.publicationId)return n.publishIdentity.publicationId;throw Error("Failed to publish DID")}async getPublicationStatus(e){let{data:t}=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(L()),variables:{identityDid:e}}));if(null==t?void 0:t.getPublicationStatus)return t.getPublicationStatus;throw Error("Failed to get publication status")}async createCredential(e,t,n,i,r){var a;let l=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(M(),o),variables:{identityDid:e,credentialId:t,types:n,expirationDate:i,properties:r}}));return(null==l?void 0:null===(a=l.data)||void 0===a?void 0:a.createCredential)?(0,c.q)(l.data.createCredential):null}async issueCredential(e,t,n,i,r,a){var o;let u=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(H(),"\n  verifiableCredential\n"),variables:{identityDid:e,subjectDid:t,credentialId:n,types:i,expirationDate:r,properties:a}}));return(null==u?void 0:null===(o=u.data)||void 0===o?void 0:o.issueCredential)?l.VerifiableCredential.parse(u.data.issueCredential.verifiableCredential):null}async importCredential(e,t){let{data:n}=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(z(),o),variables:{identityDid:e,credentialString:t.toString()}}));return n&&n.importCredential?(0,c.q)(n.importCredential):null}async listCredentials(e){let{data:t}=await (0,O.Pt)(async()=>(await (0,W.W)()).query({query:(0,s.Ps)(G(),o),variables:{identityDid:e}}));if(t&&t.credentials){let e=await Promise.all(t.credentials.map(e=>(0,c.q)(e)));return d.k.log("custodial-provider","Fetched credentials:",e),e}return null}async deleteCredential(e){var t;let n=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(X()),variables:{id:e}}));if(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.deleteCredential)return!0;throw Error("Failed to remove Credential")}async createVerifiablePresentation(e,t,n,i){let r=[];t.forEach(e=>{r.push(e.toJSON())});let{data:a}=await (0,O.Pt)(async()=>(await (0,W.W)()).mutate({mutation:(0,s.Ps)(Q(),"\n  verifiablePresentation\n"),variables:{identityDid:e,credentials:r,realm:n,nonce:i}}));return a&&a.createVerifiablePresentation?l.VerifiablePresentation.parse(a.createVerifiablePresentation.verifiablePresentation):null}addDIDDocumentService(e,t,n,i,r){throw Error("Method not implemented.")}removeDIDDocumentService(e,t){throw Error("Method not implemented.")}}var Y=n(53932);let ee=new class{createIdentity(e,t){return this.provider.createIdentity(e,t)}deleteIdentity(e){return this.provider.deleteIdentity(e)}createDIDPublishTransaction(e){return this.provider.createDIDPublishTransaction(e)}publishIdentity(e,t){return this.provider.publishIdentity(e,t)}getPublicationStatus(e){return this.provider.getPublicationStatus(e)}setActiveIdentity(e){if(!e){Y.B.next(null),this.activeIdentityId="",localStorage.setItem("activeIdentityId","");return}Y.B.next(e),this.activeIdentityId=e.did,localStorage.setItem("activeIdentityId",this.activeIdentityId)}getActiveIdentityId(){return this.activeIdentityId||(this.activeIdentityId=this.loadActiveIdentityId()),this.activeIdentityId}loadActiveIdentityId(){return localStorage.getItem("activeIdentityId")}restoreActiveIdentity(e){if(!Y.B.value){if(this.getActiveIdentityId()){let t=this.findIdentityByDID(this.activeIdentityId,e);this.setActiveIdentity(t);return}e.length>0&&ee.setActiveIdentity(e[0])}}findIdentityByDID(e,t){let n=null==t?void 0:t.find(t=>t.did===e);return n}async listIdentities(){let e=await this.provider.listIdentities();return this.restoreActiveIdentity(e),e}addDIDDocumentService(e,t,n,i,r){return this.provider.addDIDDocumentService(e,t,n,i,r)}removeDIDDocumentService(e,t){return this.provider.removeDIDDocumentService(e,t)}constructor(){this.provider=new Z,this.activeIdentityId=""}}},21290:function(e,t,n){"use strict";n.d(t,{Cp:function(){return g},Dk:function(){return v},cI:function(){return f},wo:function(){return p}});var i=n(60230),r=n(23965),a=n(5344),s=n(95640),l=n(51385),o=n(76506),u=n(3883);function c(){let e=(0,i._)(["\n        mutation bindKey($newKey: AuthKeyInput!) {\n          bindKey(newKey: $newKey) {\n            ","\n          }\n        }\n      "]);return c=function(){return e},e}function d(){let e=(0,i._)(["\n        mutation ChangePassword($newPassword: String!) {\n          changePassword(newPassword: $newPassword) {\n            ","\n          }\n        }\n      "]);return d=function(){return e},e}function h(){let e=(0,i._)(["\n          mutation unlockMasterKey($authKey: AuthKeyInput!) {\n            unlockMasterKey(authKey: $authKey)\n          }\n        "]);return h=function(){return e},e}function y(){let e=(0,i._)(["\n      query GenerateChallenge {\n        generateChallenge{\n          id,\n          content\n        }\n    }\n    "]);return y=function(){return e},e}async function f(e){var t,n;u.k.log("keyring","Binding key");let i=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(c(),a.j),variables:{newKey:e}}),null);if(null==i||null===(t=i.data)||void 0===t||!t.bindKey)return u.k.error("keyring","Failed to bind key"),null;{let e=await s.M.fromJson(null==i?void 0:null===(n=i.data)||void 0===n?void 0:n.bindKey);return u.k.log("keyring","Key bound successfully"),e}}async function g(e){var t,n;u.k.log("keyring","Changing password");let i=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(d(),a.j),variables:{newPassword:e}}),null);if(null==i||null===(t=i.data)||void 0===t||!t.changePassword)return null;{let e=await Promise.all(null==i?void 0:null===(n=i.data)||void 0===n?void 0:n.changePassword.map(e=>s.M.fromJson(e)));return u.k.log("keyring","Password changed successfully",e),e}}async function p(e){var t;u.k.log("security","Trying to unlock master key");let n=await (0,l.Pt)(async()=>(await (0,o.W)()).mutate({mutation:(0,r.Ps)(h()),variables:{authKey:e}}),null);return null!=n&&null!==(t=n.data)&&void 0!==t&&!!t.unlockMasterKey&&(u.k.log("security","Master key unlocked successfully"),!0)}async function v(){u.k.log("passkey","get challenge to generate passkey");let e=await (0,l.Pt)(async()=>(await (0,o.W)()).query({query:(0,r.Ps)(y()),fetchPolicy:"network-only",variables:{}}));if(e){var t,n;let i=null===(t=e.data)||void 0===t?void 0:t.generateChallenge.id,r=null===(n=e.data)||void 0===n?void 0:n.generateChallenge.content;return{id:i,content:r}}throw Error("Can not get challenge by generateChallenge api.")}},52856:function(e,t,n){"use strict";n.d(t,{h:function(){return d},z:function(){return c}});var i=n(57135),r=n(451),a=n(66533),s=n(48023),l=n(21290),o=n(3883),u=n(69990);function c(e){return e.appExceptionCode===s.gs.Unauthorized}function d(){let[e]=(0,r.V)((0,u.jU)()),{promptMasterKeyUnlock:t}=(0,i.lJ)(),n=async e=>{try{let t=await e();return t}catch(i){if(i instanceof a._&&c(i)){o.k.warn("security","This method call requires unlock authorization from the user. Prompting");let i=await t();if(i)return await (0,l.wo)(i),n(e);return o.k.warn("security","Unlock operation cancelled by user"),null}}};return{callWithUnlock:n}}},69990:function(e,t,n){"use strict";n.d(t,{M6:function(){return l},jU:function(){return s}});var i=n(81316),r=n(18961);let a=new r.h(null,async()=>{{let e=localStorage.getItem("authenticated_user");return e?i.n.fromJson(JSON.parse(e)):null}});function s(){return a.getSubject()}function l(){return s().value}},16421:function(e,t,n){"use strict";n.d(t,{X:function(){return A},bB:function(){return K},GC:function(){return U},jF:function(){return F},h3:function(){return W},U:function(){return O},JA:function(){return N},g$:function(){return _},HA:function(){return P},w7:function(){return T},y1:function(){return x}});var i=n(60230),r=n(23965),a=n(10530),s=n(81316),l=n(20708),o=n(51385),u=n(76506),c=n(21290),d=n(3883),h=n(2512),y=n(69810),f=n.n(y),g=n(69990),p=n(67133).Buffer;function v(){let e=(0,i._)(["\n        mutation SignUp($input: SignUpInput!) {\n          signUp(input: $input) { accessToken refreshToken }\n        }\n      "]);return v=function(){return e},e}function w(){let e=(0,i._)(["\n        query GetSelfUser {\n          getSelfUser { "," }\n        }\n      "]);return w=function(){return e},e}function m(){let e=(0,i._)(["\n      mutation RequestEmailAuthentication($emailAddress: String!) {\n        requestEmailAuthentication(emailAddress: $emailAddress) { success }\n      }\n    "]);return m=function(){return e},e}function I(){let e=(0,i._)(["\n        mutation CheckEmailAuthentication($authKey: String!) {\n          checkEmailAuthentication(authKey: $authKey) { accessToken refreshToken }\n        }\n      "]);return I=function(){return e},e}function b(){let e=(0,i._)(["\n        mutation RefreshToken($token: String!) {\n          refreshToken(refreshTokenInput: { refreshToken: $token }) { accessToken }\n        }\n      "]);return b=function(){return e},e}function k(){let e=(0,i._)(["\n        query signInWithPasskey ($authKey: AuthKeyInput!) {\n          signInWithPasskey (authKey: $authKey) {\n            accessToken,\n            refreshToken\n          }\n        }\n      "]);return k=function(){return e},e}function D(){let e=(0,i._)(["\n        mutation OauthMSSignIn($input: MsSignInInput!) {\n          oauthMSSignIn(input: $input) { accessToken refreshToken }\n        }\n      "]);return D=function(){return e},e}function S(){let e=(0,i._)(["\n        mutation OauthMSBindEmail($input: MsBindEmailInput!) {\n          oauthMSBindEmail(input: $input)\n        }\n      "]);return S=function(){return e},e}let C=new(f())(1);async function x(e){d.k.log("user","Sign up user, creating new user entry");let t={name:e},n=await (0,o.Pt)(async()=>(await (0,u.W)()).mutate({mutation:(0,r.Ps)(v()),variables:{input:t}}));if(null==n||!n.data||!n.data.signUp)return d.k.error("user","failed to sign up."),!1;{let{accessToken:e,refreshToken:t}=n.data.signUp;return j(e,t),!0}}async function E(e){localStorage.setItem("authenticated_user",JSON.stringify(e)),(0,g.jU)().next(await s.n.fromJson(e))}async function P(e){return E(e.toJson())}async function $(e,t){return C.add(async()=>{d.k.log("users","Fetching self user profile"),e&&localStorage.setItem("access_token",e),t&&localStorage.setItem("refresh_token",t);let{data:n}=await (0,o.Pt)(async()=>(await (0,u.W)()).query({query:(0,r.Ps)(w(),"id name createdAt")}));if(n){let e=n.getSelfUser,t=await s.n.fromJson(e);return await E(e),d.k.log("users","user from fetchSelfUser():",t),t}throw Error("no data got from fetchSelfUser()")})}async function A(e){d.k.log("user","Sending request to authentication by email"),await (0,o.Pt)(async()=>(await (0,u.W)()).mutate({mutation:(0,r.Ps)(m()),variables:{emailAddress:e}}))}async function j(e,t){let n=localStorage.getItem("access_token"),i=localStorage.getItem("refresh_token");localStorage.setItem("access_token",e),localStorage.setItem("refresh_token",t);try{let t=await $(e);return await (0,l.Ny)(e),t}catch(e){return d.k.error("userService","failed to fetch user info.: ",e),localStorage.setItem("access_token",n),localStorage.setItem("refresh_token",i),null}}function T(){localStorage.removeItem("authenticated_user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),(0,g.jU)().next(null)}async function U(e){d.k.log("user","Checking temporary authentication key");try{let{data:t}=await (0,o.Pt)(async()=>(await (0,u.W)()).mutate({mutation:(0,r.Ps)(I()),variables:{authKey:e}}));if(!t||!t.checkEmailAuthentication)return!1;{let{accessToken:e,refreshToken:n}=t.checkEmailAuthentication;return await j(e,n),!0}}catch(e){return d.k.warn("user","Exception while checking temporary auth key. Key expired?"),null}}async function _(){let e=localStorage.getItem("refresh_token");if(!e){N();return}let{data:t}=await (0,o.Pt)(async()=>(await (0,u.W)()).mutate({mutation:(0,r.Ps)(b()),variables:{token:e}}));if(t){d.k.log("user","Got refreshed access token");let{accessToken:e}=t.refreshToken;return localStorage.setItem("access_token",e),await (0,l.Ny)(e),(0,g.jU)().next((0,g.M6)()),e}throw Error("Can not get access token by refresh token.")}function N(){localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("authenticated_user"),window.location.href="/dashboard"}function F(){let e=localStorage.getItem("access_token");return e&&""!==e}async function K(){var e,t,n,i,s,l;d.k.log("user","Authenticating with passkey");let y=await (0,c.Dk)(),f=function(e){let t=new TextEncoder,n=t.encode(e.content),i={challenge:p.from(n).toString(),allowCredentials:[],rpId:"localhost",userVerification:"required",timeout:6e4};return i}(y),g=await (0,h.oz)(f,!1),v={type:a.J.WEBAUTHN,keyId:g.id,key:JSON.stringify(g),challengeId:y.id},w=await (0,o.Pt)(async()=>(await (0,u.W)()).query({query:(0,r.Ps)(k()),variables:{authKey:v},fetchPolicy:"network-only"}));if(null==w||null===(t=w.data)||void 0===t||null===(e=t.signInWithPasskey)||void 0===e||!e.accessToken)return d.k.error("Failed to sign in with passkey."),!1;{let e=null==w?void 0:null===(i=w.data)||void 0===i?void 0:null===(n=i.signInWithPasskey)||void 0===n?void 0:n.accessToken,t=null==w?void 0:null===(l=w.data)||void 0===l?void 0:null===(s=l.signInWithPasskey)||void 0===s?void 0:s.refreshToken;return await j(e,t),!0}}async function O(e){d.k.log("user","oauth MS sign in.");let t={code:e},n=await (0,o.Pt)(async()=>(await (0,u.W)()).mutate({mutation:(0,r.Ps)(D()),variables:{input:t}}));if(null==n||!n.data||!n.data.oauthMSSignIn)return d.k.error("user","failed to oauth MS sign in."),!1;{let{accessToken:e,refreshToken:t}=n.data.oauthMSSignIn;return j(e,t),!0}}async function W(e){d.k.log("user","oauth MS bind email.");let t={code:e},n=await (0,o.Pt)(async()=>(await (0,u.W)()).mutate({mutation:(0,r.Ps)(S()),variables:{input:t}}));return null!=n&&!!n.data&&!!n.data.oauthMSBindEmail||(d.k.error("user","failed to oauth MS bind email."),!1)}},6598:function(e,t,n){"use strict";n.d(t,{R:function(){return s}});var i=n(3883),r=n(69810),a=n.n(r);class s{async get(e,t){let n=!(arguments.length>2)||void 0===arguments[2]||arguments[2];return n&&this.has(e)?this.cache[e]:(n||null===e||i.k.warn("cache","Forcing to not use cache for key:",e,". This could create duplicate objects that don't update well everywhere"),t)?this.loadQueue.add(async()=>{var i,r;if(n&&this.has(e)){let n=this.cache[e];return await (null==t?void 0:null===(r=t.fill)||void 0===r?void 0:r.call(t,n)),n}{if(!t)return null;let n=await t.create();return await (null===(i=t.fill)||void 0===i?void 0:i.call(t,n)),this.cache[e]=n,n}}):null}has(e){return e in this.cache}constructor(){this.cache={},this.loadQueue=new(a())(1)}}},78212:function(e,t,n){"use strict";function i(){return!0}n.d(t,{S:function(){return i}})},35324:function(e,t,n){"use strict";n.d(t,{G:function(){return a},p:function(){return r}});let i={},r=async()=>(i["@elastosfoundation/hive-js-sdk"]||(i["@elastosfoundation/hive-js-sdk"]=await Promise.resolve().then(n.bind(n,20475))),i["@elastosfoundation/hive-js-sdk"]),a=async()=>(i["@elastosfoundation/elastos-connectivity-sdk-js"]||(i["@elastosfoundation/elastos-connectivity-sdk-js"]=await n.e(7410).then(n.bind(n,37410))),i["@elastosfoundation/elastos-connectivity-sdk-js"])},18961:function(e,t,n){"use strict";n.d(t,{h:function(){return r}});var i=n(50676);class r{getSubject(e){return this.fetchedOrFetching||(this.fetchedOrFetching=!0,this.initializer().then(e=>e&&this.subject.next(e))),this.subject}constructor(e,t){this.initializer=t,this.fetchedOrFetching=!1,this.subject=new i.X(e)}}},54860:function(e,t,n){"use strict";n.d(t,{EX:function(){return u},Ik:function(){return l},hv:function(){return o}});var i=n(3883),r=n(35698),a=n(67133).Buffer;let s=[{mime:"image/png",pattern:[137,80,78,71]},{mime:"image/jpeg",pattern:[255,216,255]},{mime:"image/gif",pattern:[71,73,70,56]},{mime:"image/webp",pattern:[82,73,70,70,void 0,void 0,void 0,void 0,87,69,66,80,86,80]}],l=async e=>{if(!e)return"";let t=await function(e){if("string"==typeof e){var t;t=e,e=a.from(t,"base64")}let n=Math.max(...s.map(e=>e.pattern.length)),i=new Blob([e.slice(0,n)]),r=new FileReader,l=new Promise(e=>{r.onloadend=t=>{if("loadend"==t.type){if(!t||!r.result){e(null);return}let n=new Uint8Array(r.result),i=s.find(e=>e.pattern.every((e,t)=>!e||n[t]===e));i?e(i.mime):e(null)}}});return r.readAsArrayBuffer(i),l}(e);if(!t)return i.k.warn("pictures","Unable to extract picture mime type. If the picture invalid?"),null;let n=a.from(e).toString("base64");return"data:".concat(t,";base64,").concat(n)},o=(e,t)=>new Promise((n,i)=>{let a=new Image;a.src=e,a.onload=()=>{let e=document.createElement("canvas"),i=a.width,s=a.height;i>=s&&i>t?(s*=t/i,i=t):s>t&&(i*=t/s,s=t),e.width=i,e.height=s;let l=e.getContext("2d");l.drawImage(a,0,0,i,s);let o=l.canvas.toDataURL();n((0,r.u0)(o))},a.onerror=e=>i(e)}),u=e=>new Promise((t,n)=>{let i=new FileReader;i.onload=()=>{t(i.result)},i.onerror=e=>{n(e)},i.readAsDataURL(e)})}}]);